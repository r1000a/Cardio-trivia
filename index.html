<!DOCTYPE html>
<html lang="es-UY">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>¿Quién quiere ser cardiólogo? - Episodio 1</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
            color: #e2e8f0;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow-x: hidden;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, transparent 20%, rgba(59, 130, 246, 0.15) 20%, rgba(59, 130, 246, 0.15) 21%, transparent 21%, transparent 30%, rgba(59, 130, 246, 0.1) 30%, rgba(59, 130, 246, 0.1) 31%, transparent 31%);
            background-size: 60px 60px;
            animation: rotate 180s linear infinite;
            opacity: 0.4;
            z-index: -1;
        }
        
        @keyframes rotate {
            to { transform: rotate(360deg); }
        }
        
        .container {
            width: 95%;
            max-width: 1200px;
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(20px);
            border: 2px solid rgba(59, 130, 246, 0.3);
            border-radius: 24px;
            padding: 24px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25), 0 0 0 1px rgba(59, 130, 246, 0.1);
            position: relative;
            z-index: 1;
            max-height: 95vh;
            overflow-y: auto;
        }
        
        /* Logos institucionales */
        .institutional-header {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 40px;
            margin-bottom: 20px;
            padding: 16px;
            background: rgba(30, 41, 59, 0.3);
            border-radius: 16px;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }
        
        .logo-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }
        
        .logo {
            height: 60px;
            width: auto;
            opacity: 0.9;
            transition: all 0.3s ease;
            filter: brightness(1.1);
        }
        
        .logo:hover {
            opacity: 1;
            transform: scale(1.05);
        }
        
        .logo-text {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            color: #94a3b8;
            text-align: center;
            font-weight: 500;
        }
        
        h1 {
            font-size: 2.75rem;
            font-weight: 700;
            text-align: center;
            background: linear-gradient(135deg, #60a5fa, #3b82f6, #2563eb);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 12px;
            letter-spacing: -0.025em;
        }
        
        h2 {
            font-size: 1.875rem;
            font-weight: 600;
            text-align: center;
            color: #60a5fa;
            margin-bottom: 24px;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .subtitle {
            font-family: 'JetBrains Mono', monospace;
            text-align: center;
            color: #94a3b8;
            font-size: 1.125rem;
            margin-bottom: 32px;
            letter-spacing: 0.05em;
            font-weight: 500;
        }
        
        .nav-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 32px;
            gap: 12px;
        }
        
        .nav-tab {
            background: rgba(30, 58, 138, 0.2);
            color: #e2e8f0;
            border: 2px solid rgba(59, 130, 246, 0.3);
            padding: 12px 24px;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: 'JetBrains Mono', monospace;
            font-weight: 500;
            font-size: 0.875rem;
        }
        
        .nav-tab.active {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.3);
            transform: translateY(-2px);
        }
        
        .nav-tab:hover:not(.active) {
            background: rgba(59, 130, 246, 0.2);
            border-color: rgba(59, 130, 246, 0.5);
            transform: translateY(-1px);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Admin Panel */
        .admin-panel {
            background: rgba(220, 38, 38, 0.1);
            border: 2px solid rgba(220, 38, 38, 0.3);
            border-radius: 16px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }
        
        .admin-password {
            width: 300px;
            padding: 12px;
            margin: 12px;
            background: rgba(15, 23, 42, 0.8);
            border: 2px solid rgba(220, 38, 38, 0.3);
            border-radius: 8px;
            color: #e2e8f0;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .admin-data {
            background: rgba(15, 23, 42, 0.6);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            max-height: 500px;
            overflow-y: auto;
        }
        
        /* Pantalla de inicio */
        #startScreen {
            text-align: center;
        }
        
        .form-group {
            margin: 24px 0;
            text-align: left;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-size: 1.125rem;
            font-weight: 500;
            color: #60a5fa;
        }
        
        input, select {
            width: 100%;
            padding: 16px;
            font-size: 1rem;
            background: rgba(30, 41, 59, 0.8);
            border: 2px solid rgba(59, 130, 246, 0.3);
            border-radius: 12px;
            color: #e2e8f0;
            font-family: 'Inter', sans-serif;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #3b82f6;
            background: rgba(30, 41, 59, 0.95);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .privacy-note {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 12px;
            padding: 16px;
            margin: 24px 0;
            font-size: 0.875rem;
            color: #94a3b8;
            line-height: 1.6;
        }
        
        .btn {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            border: none;
            padding: 14px 32px;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            margin: 8px;
            font-family: 'Inter', sans-serif;
            letter-spacing: 0.025em;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.3);
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
        }
        
        .btn-danger:hover {
            background: linear-gradient(135deg, #b91c1c, #991b1b);
        }
        
        /* Dashboard Público */
        .dashboard-section {
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 24px;
            margin: 24px 0;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin: 24px 0;
        }
        
        .stat-card {
            background: rgba(15, 23, 42, 0.6);
            border: 2px solid rgba(59, 130, 246, 0.2);
            border-radius: 16px;
            padding: 24px;
            text-align: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .stat-card:hover {
            border-color: rgba(59, 130, 246, 0.4);
            transform: translateY(-2px);
        }
        
        .stat-number {
            font-size: 2.5rem;
            color: #60a5fa;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .stat-label {
            color: #94a3b8;
            font-size: 1rem;
            font-weight: 500;
            margin-top: 8px;
        }
        
        .live-feed {
            background: rgba(15, 23, 42, 0.4);
            border-radius: 12px;
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .feed-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid rgba(59, 130, 246, 0.2);
            animation: fadeIn 0.5s ease-out;
        }
        
        .feed-item:last-child {
            border-bottom: none;
        }
        
        .feed-player {
            font-weight: 600;
            color: #60a5fa;
        }
        
        .feed-score {
            color: #3b82f6;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 500;
        }
        
        .feed-time {
            font-size: 0.75rem;
            color: #64748b;
        }
        
        /* Pantalla de juego */
        #gameScreen {
            display: none;
        }
        
        .game-header {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 24px;
            align-items: center;
            margin-bottom: 32px;
            padding: 24px;
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }
        
        .player-info, .game-stats, .comodines {
            font-family: 'JetBrains Mono', monospace;
            text-align: center;
        }
        
        .lives {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 12px;
        }
        
        .heart {
            font-size: 1.5rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            filter: drop-shadow(0 0 8px rgba(59, 130, 246, 0.5));
        }
        
        .heart.active {
            color: #60a5fa;
            transform: scale(1);
        }
        
        .heart.lost {
            color: #334155;
            transform: scale(0.8);
            filter: none;
        }
        
        .comodines {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .comodin {
            background: linear-gradient(135deg, #60a5fa, #3b82f6);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.875rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .comodin:hover:not(:disabled) {
            transform: scale(1.05) translateY(-1px);
            box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.3);
        }
        
        .comodin:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Timer */
        .timer-container {
            text-align: center;
            margin: 20px 0;
        }
        
        .timer {
            font-size: 2rem;
            font-weight: 700;
            color: #60a5fa;
            background: rgba(30, 41, 59, 0.8);
            padding: 12px 24px;
            border-radius: 50%;
            display: inline-block;
            min-width: 80px;
            border: 3px solid rgba(59, 130, 246, 0.3);
            font-family: 'JetBrains Mono', monospace;
        }
        
        .timer.warning {
            color: #f59e0b;
            border-color: #f59e0b;
            animation: pulse 0.5s infinite;
        }
        
        /* Pregunta y opciones */
        .question-container {
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(59, 130, 246, 0.2);
            border-radius: 16px;
            padding: 32px;
            margin: 24px 0;
        }
        
        .question {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 32px;
            line-height: 1.6;
            color: #e2e8f0;
            text-align: center;
        }
        
        .options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }
        
        .option {
            background: rgba(15, 23, 42, 0.6);
            border: 2px solid rgba(59, 130, 246, 0.3);
            padding: 20px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 1rem;
            text-align: left;
            line-height: 1.5;
            font-weight: 500;
        }
        
        .option:hover:not(.disabled) {
            background: rgba(59, 130, 246, 0.1);
            border-color: #3b82f6;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px -8px rgba(59, 130, 246, 0.3);
        }
        
        .option.correct {
            background: linear-gradient(135deg, #059669, #047857);
            border-color: #10b981;
            color: white;
            animation: correctAnimation 0.6s ease-out;
        }
        
        .option.incorrect {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            border-color: #ef4444;
            color: white;
            animation: shake 0.6s ease-out;
        }
        
        .option.disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .option.eliminated {
            opacity: 0.3;
            background: rgba(51, 65, 85, 0.6);
            cursor: not-allowed;
            text-decoration: line-through;
        }
        
        @keyframes correctAnimation {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-4px); }
            20%, 40%, 60%, 80% { transform: translateX(4px); }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Pantalla de nivel */
        #levelScreen {
            display: none;
            text-align: center;
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(59, 130, 246, 0.2);
            border-radius: 16px;
            padding: 32px;
            margin: 24px 0;
        }
        
        .level-title {
            font-size: 2.25rem;
            font-weight: 700;
            color: #60a5fa;
            margin-bottom: 24px;
        }
        
        .level-description {
            font-size: 1.25rem;
            color: #94a3b8;
            margin-bottom: 32px;
            line-height: 1.6;
            font-style: italic;
        }
        
        /* Pantalla de resultados */
        #resultsScreen {
            display: none;
            text-align: center;
        }
        
        .final-score {
            font-size: 3rem;
            font-weight: 700;
            background: linear-gradient(135deg, #60a5fa, #3b82f6);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 24px 0;
        }
        
        .level-name {
            font-size: 1.5rem;
            color: #94a3b8;
            margin: 24px 0;
            font-family: 'JetBrains Mono', monospace;
        }
        
        /* Rankings */
        .ranking-section {
            margin: 32px 0;
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }
        
        .ranking-title {
            font-size: 1.75rem;
            color: #60a5fa;
            margin-bottom: 24px;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
        }
        
        .top-players {
            display: grid;
            gap: 12px;
            margin-bottom: 24px;
        }
        
        .player-rank {
            display: grid;
            grid-template-columns: 60px 2fr auto auto;
            gap: 16px;
            padding: 16px;
            background: rgba(15, 23, 42, 0.6);
            border-radius: 12px;
            align-items: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .player-rank:hover {
            transform: translateY(-1px);
        }
        
        .player-rank.podium-1 {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(245, 158, 11, 0.1));
            border: 2px solid #fbbf24;
        }
        
        .player-rank.podium-2 {
            background: linear-gradient(135deg, rgba(156, 163, 175, 0.2), rgba(107, 114, 128, 0.1));
            border: 2px solid #9ca3af;
        }
        
        .player-rank.podium-3 {
            background: linear-gradient(135deg, rgba(194, 120, 3, 0.2), rgba(146, 64, 14, 0.1));
            border: 2px solid #c2750b;
        }
        
        .rank-number {
            font-size: 1.5rem;
            font-weight: 700;
            color: #60a5fa;
            text-align: center;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .rank-name {
            font-weight: 600;
            color: #e2e8f0;
        }
        
        .rank-score {
            font-family: 'JetBrains Mono', monospace;
            color: #3b82f6;
            font-weight: 600;
        }
        
        .rank-title {
            color: #94a3b8;
            font-size: 0.75rem;
            font-style: italic;
            margin-top: 4px;
            line-height: 1.2;
        }
        
        .rank-level {
            font-family: 'JetBrains Mono', monospace;
            color: #60a5fa;
            font-size: 0.875rem;
        }
        
        .horoscope-section {
            background: rgba(59, 130, 246, 0.1);
            border: 2px solid rgba(59, 130, 246, 0.3);
            border-radius: 16px;
            padding: 24px;
            margin: 32px 0;
            text-align: left;
        }
        
        .horoscope-title {
            color: #60a5fa;
            text-align: center;
            margin-bottom: 16px;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
        }
        
        .horoscope-text {
            font-size: 1.125rem;
            line-height: 1.7;
            color: #e2e8f0;
            font-style: italic;
        }
        
        .loading {
            text-align: center;
            color: #94a3b8;
            font-style: italic;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            h1 {
                font-size: 2.25rem;
            }
            
            .container {
                padding: 16px;
            }
            
            .institutional-header {
                flex-direction: column;
                gap: 20px;
            }
            
            .logo {
                height: 50px;
            }
            
            .game-header {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            .options {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .player-rank {
                grid-template-columns: 40px 2fr auto;
                gap: 12px;
            }
            
            .rank-level {
                display: none;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header institucional -->
        <div class="institutional-header">
            <div class="logo-container">
                <img src="logo-ccu.png" alt="Centro Cardiovascular Universitario" class="logo" id="logo-ccu">
                <div class="logo-text">Centro Cardiovascular<br>Universitario</div>
            </div>
            <div class="logo-container">
                <img src="logo-uac.png" alt="Unidad Académica de Cardiología" class="logo" id="logo-uac">
                <div class="logo-text">Unidad Académica<br>de Cardiología</div>
            </div>
        </div>
        
        <!-- Navegación -->
        <div class="nav-tabs">
            <div class="nav-tab active" onclick="showTab('dashboard')">📊 Dashboard</div>
            <div class="nav-tab" onclick="showTab('game')">🎮 Jugar</div>
            <div class="nav-tab" onclick="showTab('admin')">🔐 Admin</div>
        </div>
        
        <!-- Dashboard Público -->
        <div id="dashboard" class="tab-content active">
            <h1>🏥 Dashboard Público</h1>
            <p class="subtitle">ESTADÍSTICAS EN TIEMPO REAL</p>
            
            <!-- Estadísticas Generales -->
            <div class="dashboard-section">
                <h2>📈 Estadísticas Generales</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalJugadores">-</div>
                        <div class="stat-label">Total Jugadores</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="promedioScore">-</div>
                        <div class="stat-label">Puntaje Promedio</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="nivelMaximo">-</div>
                        <div class="stat-label">Nivel Máximo Alcanzado</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="jugadoresHoy">-</div>
                        <div class="stat-label">Jugadores Hoy</div>
                    </div>
                </div>
            </div>
            
            <!-- Top 10 Global -->
            <div class="dashboard-section">
                <h2>🏆 Top 10 Global</h2>
                <div class="top-players" id="topPlayers">
                    <div class="loading">Cargando rankings...</div>
                </div>
            </div>
            
            <!-- Feed en Vivo -->
            <div class="dashboard-section">
                <h2>🎮 Últimas Partidas</h2>
                <div class="live-feed" id="liveFeed">
                    <div class="loading">Cargando actividad reciente...</div>
                </div>
            </div>
        </div>
        
        <!-- Panel de Administración -->
        <div id="admin" class="tab-content">
            <h1>🔐 Panel de Administración</h1>
            <p class="subtitle">ACCESO RESTRINGIDO</p>
            
            <div class="admin-panel">
                <h2>🔒 Acceso Privado</h2>
                <p>Ingresa la contraseña para ver los datos de los participantes:</p>
                <input type="password" id="adminPassword" class="admin-password" placeholder="Contraseña de administrador">
                <br>
                <button class="btn" onclick="verifyAdmin()">Acceder</button>
                
                <div id="adminData" class="admin-data" style="display: none;">
                    <h3>📋 Registro Completo de Participantes</h3>
                    <button class="btn" onclick="exportAdminData()">📥 Descargar Excel</button>
                    <button class="btn btn-danger" onclick="clearAllData()">🗑️ Limpiar Datos</button>
                    
                    <div id="adminTable" style="margin-top: 20px;">
                        <!-- Tabla de admin se genera aquí -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Pantalla de Juego -->
        <div id="game" class="tab-content">
            <!-- Pantalla de inicio -->
            <div id="startScreen">
                <h1>¿Quién quiere ser cardiólogo?</h1>
                <p class="subtitle">EPISODIO 1: INSUFICIENCIA CARDÍACA</p>
                
                <div class="form-group">
                    <label for="playerName">Nombre completo:</label>
                    <input type="text" id="playerName" placeholder="Dr. Juan Pérez" required>
                </div>
                
                <div class="form-group">
                    <label for="playerId">Cédula de identidad:</label>
                    <input type="text" id="playerId" placeholder="1.234.567-8" required>
                </div>
                
                <div class="form-group">
                    <label for="playerPseudonym">Pseudónimo público:</label>
                    <input type="text" id="playerPseudonym" placeholder="CardioMaster2025" required>
                </div>
                
                <div class="privacy-note">
                    🔒 <strong>Privacidad:</strong> Tu nombre real y cédula son privados. En el ranking público solo aparece tu pseudónimo.
                </div>
                
                <div id="intentosMessage" style="display: none; color: #f59e0b; margin: 20px 0; font-weight: bold;"></div>
                
                <button class="btn" onclick="startGame()">COMENZAR AVENTURA</button>
            </div>
            
            <!-- Pantalla de juego -->
            <div id="gameScreen">
                <div class="game-header">
                    <div class="player-info">
                        <div>Jugador: <span id="displayName"></span></div>
                        <div>Pseudónimo: <span id="displayPseudonym"></span></div>
                        <div class="lives">
                            Vidas: 
                            <span class="heart" id="heart1">💙</span>
                            <span class="heart" id="heart2">💙</span>
                            <span class="heart" id="heart3">💙</span>
                        </div>
                    </div>
                    
                    <div class="game-stats">
                        <div>Nivel: <span id="currentLevelDisplay">1</span>/30</div>
                        <div>Puntaje: <span id="score">0</span></div>
                        <div class="timer-container">
                            <div class="timer" id="timer">30</div>
                        </div>
                    </div>
                    
                    <div class="comodines">
                        <button class="comodin" id="comodin5050" onclick="use5050()">🎯 50/50</button>
                        <button class="comodin" id="comodinChange" onclick="changeQuestion()">🔄 Cambiar</button>
                    </div>
                </div>
                
                <!-- Pantalla de nivel intermedia -->
                <div id="levelScreen">
                    <div class="level-title">NIVEL <span id="levelNumber"></span></div>
                    <div class="level-description" id="levelDescription"></div>
                    <button class="btn" onclick="startLevel()">COMENZAR NIVEL</button>
                </div>
                
                <div class="question-container" id="mainQuestionContainer" style="display: none;">
                    <div class="question" id="questionText"></div>
                    <div class="options" id="optionsContainer"></div>
                </div>
                
                <button class="btn" id="nextButton" style="display: none;" onclick="nextQuestion()">SIGUIENTE PREGUNTA</button>
            </div>
            
            <!-- Pantalla de resultados -->
            <div id="resultsScreen">
                <h1>¡Juego Terminado!</h1>
                <div class="final-score">Puntaje Final: <span id="finalScore">0</span></div>
                <div class="level-name" id="levelName"></div>
                <div>Nivel máximo alcanzado: <span id="maxLevel">1</span>/30</div>
                
                <!-- Descripción humorística del nivel -->
                <div class="horoscope-section">
                    <h3 class="horoscope-title">🔮 Tu Horóscopo Cardiológico</h3>
                    <div class="horoscope-text" id="levelHoroscope"></div>
                </div>
                
                <button class="btn" id="retryButton" onclick="retryGame()">🔄 REINTENTAR</button>
                <button class="btn" onclick="newGame()">👤 NUEVO JUGADOR</button>
                <button class="btn" onclick="showTab('dashboard')">📊 VER DASHBOARD</button>
            </div>
        </div>
    </div>
    
    <script>
        // Configuración Firebase - TUS CREDENCIALES REALES
        const firebaseConfig = {
            apiKey: "AIzaSyAF1UK57tg4jK856RSU7Qcr1MT8QEeY4-o",
            authDomain: "cardiologia-game-uy.firebaseapp.com",
            databaseURL: "https://cardiologia-game-uy-default-rtdb.firebaseio.com",
            projectId: "cardiologia-game-uy",
            storageBucket: "cardiologia-game-uy.firebasestorage.app",
            messagingSenderId: "950754238661",
            appId: "1:950754238661:web:3df1bc9c9089f3308410ac",
            measurementId: "G-R6SPME7MHK"
        };
        
        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // Variables globales
        let currentPlayer = { name: '', id: '', pseudonym: '' };
        let currentLevel = 1;
        let score = 0;
        let lives = 3;
        let maxLevelReached = 1;
        let currentQuestion = null;
        let answeredQuestions = new Set();
        let timeLeft = 30;
        let timerInterval = null;
        let comodines = { fifty: true, change: true };
        let shuffledOptions = [];
        let eliminated5050 = false;
        let playerAttempts = 0;
        let isAdminAuthenticated = false;
        const ADMIN_PASSWORD = "cardio2025admin";
        
        // Banco de preguntas clínicas avanzadas para cardiólogos (90 preguntas)
        const questionBank = [
            // Nivel 1-3: Diagnóstico y clasificación avanzada
            {"level": 1, "question": "Según las guías ESC 2021, ¿cuál es el punto de corte de NT-proBNP para descartar IC aguda en pacientes >75 años?", "options": [{"text": "< 450 pg/ml", "correct": false}, {"text": "< 900 pg/ml", "correct": true}, {"text": "< 1800 pg/ml", "correct": false}, {"text": "< 300 pg/ml", "correct": false}]},
            {"level": 1, "question": "¿Cuál es el criterio ecocardiográfico principal para definir ICFEp según las guías actuales?", "options": [{"text": "FEVI ≥50% + evidencia de disfunción diastólica", "correct": true}, {"text": "FEVI ≥45% + dilatación auricular", "correct": false}, {"text": "FEVI ≥40% + hipertrofia ventricular", "correct": false}, {"text": "FEVI ≥55% + insuficiencia mitral", "correct": false}]},
            {"level": 1, "question": "En la clasificación fenotípica actual de IC, ¿qué define a la ICFEli (ligeramente reducida)?", "options": [{"text": "FEVI 35-40%", "correct": false}, {"text": "FEVI 41-49%", "correct": true}, {"text": "FEVI 45-55%", "correct": false}, {"text": "FEVI 30-45%", "correct": false}]},

            {"level": 2, "question": "Según PARADIGM-HF, ¿cuál fue la reducción de mortalidad cardiovascular con sacubitrilo/valsartán vs enalapril?", "options": [{"text": "15%", "correct": false}, {"text": "20%", "correct": true}, {"text": "25%", "correct": false}, {"text": "30%", "correct": false}]},
            {"level": 2, "question": "¿Cuál es la dosis objetivo de carvedilol en IC según las guías ESC?", "options": [{"text": "25 mg c/12h", "correct": true}, {"text": "12.5 mg c/12h", "correct": false}, {"text": "50 mg c/12h", "correct": false}, {"text": "6.25 mg c/12h", "correct": false}]},
            {"level": 2, "question": "En el estudio EMPEROR-Reduced, ¿qué porcentaje de reducción del end-point primario mostró empagliflozina?", "options": [{"text": "20%", "correct": false}, {"text": "25%", "correct": true}, {"text": "30%", "correct": false}, {"text": "15%", "correct": false}]},

            {"level": 3, "question": "¿Cuál es el criterio de QRS para indicar TRC según las guías ESC 2021?", "options": [{"text": "QRS ≥120 ms", "correct": false}, {"text": "QRS ≥130 ms", "correct": false}, {"text": "QRS ≥150 ms con LBBB", "correct": true}, {"text": "QRS ≥140 ms", "correct": false}]},
            {"level": 3, "question": "En DAPA-HF, ¿cuál fue el NNT (number needed to treat) para prevenir un evento primario con dapagliflozina?", "options": [{"text": "15", "correct": false}, {"text": "21", "correct": true}, {"text": "28", "correct": false}, {"text": "35", "correct": false}]},
            {"level": 3, "question": "¿Cuál es la indicación principal para ivabradina en IC según las guías actuales?", "options": [{"text": "FC >70 lpm en ritmo sinusal, FEVI ≤35%, en terapia óptima con BB", "correct": true}, {"text": "Cualquier FC >80 lpm", "correct": false}, {"text": "Solo en intolerancia a betabloqueantes", "correct": false}, {"text": "FC >65 lpm con cualquier FEVI", "correct": false}]},

            // Nivel 4-6: Fisiopatología y mecanismos avanzados
            {"level": 4, "question": "¿Cuál es el mecanismo principal por el cual los iSGLT2 mejoran outcomes en IC?", "options": [{"text": "Reducción de precarga por diuresis osmótica", "correct": false}, {"text": "Mejora del metabolismo energético miocárdico", "correct": true}, {"text": "Vasodilatación coronaria directa", "correct": false}, {"text": "Reducción de la resistencia vascular sistémica", "correct": false}]},
            {"level": 4, "question": "En la IC, ¿qué valor de PCWP (presión capilar pulmonar) define congestión hemodinámica?", "options": [{"text": ">12 mmHg", "correct": false}, {"text": ">15 mmHg", "correct": false}, {"text": ">18 mmHg", "correct": true}, {"text": ">25 mmHg", "correct": false}]},
            {"level": 4, "question": "¿Cuál es el valor normal del índice cardíaco en reposo?", "options": [{"text": "1.8-2.2 L/min/m²", "correct": false}, {"text": "2.5-4.0 L/min/m²", "correct": true}, {"text": "4.0-5.5 L/min/m²", "correct": false}, {"text": "1.5-2.0 L/min/m²", "correct": false}]},

            {"level": 5, "question": "Según el perfil hemodinámico de Forrester, ¿qué caracteriza al perfil C (húmedo-frío)?", "options": [{"text": "PCWP >18 mmHg, IC <2.2 L/min/m²", "correct": true}, {"text": "PCWP <18 mmHg, IC >2.2 L/min/m²", "correct": false}, {"text": "PCWP >18 mmHg, IC >2.2 L/min/m²", "correct": false}, {"text": "PCWP <15 mmHg, IC <2.0 L/min/m²", "correct": false}]},
            {"level": 5, "question": "¿Cuál es el umbral de troponina para considerar daño miocárdico en IC aguda?", "options": [{"text": "Cualquier elevación sobre el percentil 99", "correct": true}, {"text": ">0.1 ng/ml", "correct": false}, {"text": ">1.0 ng/ml", "correct": false}, {"text": ">5.0 ng/ml", "correct": false}]},
            {"level": 5, "question": "En el cateterismo derecho, ¿qué define al 'square root sign'?", "options": [{"text": "Igualación de presiones diastólicas en pericarditis constrictiva", "correct": true}, {"text": "Onda V prominente en insuficiencia tricuspídea", "correct": false}, {"text": "Gradiente diastólico en estenosis mitral", "correct": false}, {"text": "Presión sistólica pulmonar >60 mmHg", "correct": false}]},

            // Nivel 6-10: Tratamiento avanzado y complicaciones
            {"level": 6, "question": "¿Cuál es la dosis de espironolactona que demostró beneficio en mortalidad en RALES?", "options": [{"text": "12.5-25 mg/día", "correct": false}, {"text": "25-50 mg/día", "correct": true}, {"text": "50-100 mg/día", "correct": false}, {"text": "100-200 mg/día", "correct": false}]},
            {"level": 6, "question": "En SHIFT, ¿cuál fue la reducción del endpoint primario con ivabradina?", "options": [{"text": "15%", "correct": false}, {"text": "18%", "correct": true}, {"text": "22%", "correct": false}, {"text": "25%", "correct": false}]},
            {"level": 6, "question": "¿Cuál es la contraindicación absoluta para TRC?", "options": [{"text": "QRS <120 ms", "correct": false}, {"text": "Expectativa de vida <1 año", "correct": true}, {"text": "FEVI >35%", "correct": false}, {"text": "Fibrilación auricular", "correct": false}]},

            {"level": 7, "question": "En IC aguda con EAP cardiogénico, ¿cuál es la PO2 objetivo inicial?", "options": [{"text": ">60 mmHg", "correct": false}, {"text": ">90 mmHg", "correct": true}, {"text": ">100 mmHg", "correct": false}, {"text": ">70 mmHg", "correct": false}]},
            {"level": 7, "question": "¿Cuál es el efecto principal de la levosimendan?", "options": [{"text": "Inhibición de fosfodiesterasa III", "correct": false}, {"text": "Sensibilización al calcio + apertura de canales KATP", "correct": true}, {"text": "Agonismo beta-1 selectivo", "correct": false}, {"text": "Inhibición de recaptación de noradrenalina", "correct": false}]},
            {"level": 7, "question": "En shock cardiogénico, ¿cuál es el valor de IABP más apropiado?", "options": [{"text": "1:1", "correct": true}, {"text": "1:2", "correct": false}, {"text": "1:3", "correct": false}, {"text": "2:1", "correct": false}]},

            {"level": 8, "question": "¿Cuál es el criterio para 'worsening renal function' en IC aguda?", "options": [{"text": "Aumento de creatinina >0.3 mg/dl", "correct": true}, {"text": "Reducción de FG >25%", "correct": false}, {"text": "Aumento de urea >20 mg/dl", "correct": false}, {"text": "Oliguria <0.5 ml/kg/h", "correct": false}]},
            {"level": 8, "question": "En el score MAGGIC, ¿cuáles son los predictores más potentes de mortalidad?", "options": [{"text": "Edad, creatinina, FEVI, clase NYHA", "correct": true}, {"text": "Solo FEVI y BNP", "correct": false}, {"text": "Presión sistólica y FC", "correct": false}, {"text": "Diabetes y enfermedad coronaria", "correct": false}]},
            {"level": 8, "question": "¿Cuál es la definición de IC refractaria según la ISHLT?", "options": [{"text": "NYHA IV persistente pese a terapia óptima", "correct": true}, {"text": "Hospitalizaciones recurrentes", "correct": false}, {"text": "FEVI <20%", "correct": false}, {"text": "Dependencia de inotrópicos", "correct": false}]},

            // Nivel 9-15: Casos complejos y scoring
            {"level": 9, "question": "En el score INTERMACS, ¿qué define el perfil 1?", "options": [{"text": "Shock cardiogénico crítico con hipoperfusión", "correct": true}, {"text": "IC sintomática en reposo", "correct": false}, {"text": "Limitación severa al ejercicio", "correct": false}, {"text": "IC avanzada ambulatoria", "correct": false}]},
            {"level": 9, "question": "¿Cuál es el Gold Standard para medir el consumo de oxígeno pico?", "options": [{"text": "Ergometría convencional", "correct": false}, {"text": "Test de 6 minutos", "correct": false}, {"text": "Ergoespirometría", "correct": true}, {"text": "Ecocardiograma de stress", "correct": false}]},
            {"level": 9, "question": "¿Qué valor de VO2 pico define IC severa en <50 años?", "options": [{"text": "<14 ml/kg/min", "correct": true}, {"text": "<18 ml/kg/min", "correct": false}, {"text": "<20 ml/kg/min", "correct": false}, {"text": "<12 ml/kg/min", "correct": false}]},

            {"level": 10, "question": "En la evaluación para trasplante cardíaco, ¿cuál es el VE/VCO2 slope de mal pronóstico?", "options": [{"text": ">35", "correct": true}, {"text": ">45", "correct": false}, {"text": ">25", "correct": false}, {"text": ">30", "correct": false}]},
            {"level": 10, "question": "¿Cuál es la contraindicación relativa para trasplante por resistencia vascular pulmonar?", "options": [{"text": "RVP >3 unidades Wood irreversible", "correct": true}, {"text": "RVP >2 unidades Wood", "correct": false}, {"text": "Gradiente transpulmonar >12 mmHg", "correct": false}, {"text": "Presión sistólica pulmonar >50 mmHg", "correct": false}]},
            {"level": 10, "question": "En IC con FA, ¿cuál es el score CHA2DS2-VASc para anticoagulación obligatoria?", "options": [{"text": "≥1 en hombres, ≥2 en mujeres", "correct": true}, {"text": "≥2 en todos", "correct": false}, {"text": "≥3 en todos", "correct": false}, {"text": "≥1 en todos", "correct": false}]},

            // Nivel 11-20: Procedimientos y técnicas avanzadas
            {"level": 11, "question": "En TAVI, ¿cuál es el gradiente medio aórtico considerado severo?", "options": [{"text": ">20 mmHg", "correct": false}, {"text": ">40 mmHg", "correct": true}, {"text": ">30 mmHg", "correct": false}, {"text": ">50 mmHg", "correct": false}]},
            {"level": 11, "question": "¿Cuál es la indicación clase I para MitraClip según ESC?", "options": [{"text": "IM severa primaria inoperable con síntomas", "correct": true}, {"text": "IM moderada sintomática", "correct": false}, {"text": "IM secundaria en cualquier grado", "correct": false}, {"text": "IM severa asintomática", "correct": false}]},
            {"level": 11, "question": "En el implante de DAV, ¿cuál es la complicación más frecuente?", "options": [{"text": "Sangrado", "correct": true}, {"text": "Infección", "correct": false}, {"text": "ACV", "correct": false}, {"text": "Falla del dispositivo", "correct": false}]},

            {"level": 12, "question": "¿Cuál es el tiempo óptimo de isquemia fría en trasplante cardíaco?", "options": [{"text": "<4 horas", "correct": true}, {"text": "<6 horas", "correct": false}, {"text": "<8 horas", "correct": false}, {"text": "<2 horas", "correct": false}]},
            {"level": 12, "question": "En rechazo agudo post-trasplante, ¿qué grado ISHLT requiere tratamiento inmediato?", "options": [{"text": "≥2R", "correct": true}, {"text": "≥1R", "correct": false}, {"text": "≥3R", "correct": false}, {"text": "Solo 3R", "correct": false}]},
            {"level": 12, "question": "¿Cuál es la dosis de mantenimiento típica de tacrolimus post-trasplante?", "options": [{"text": "Nivel 8-12 ng/ml", "correct": true}, {"text": "Nivel 15-20 ng/ml", "correct": false}, {"text": "Nivel 5-8 ng/ml", "correct": false}, {"text": "Nivel 20-25 ng/ml", "correct": false}]},

            // Nivel 13-25: Investigación y guías recientes
            {"level": 13, "question": "En VICTORIA, ¿cuál fue la reducción del endpoint primario con vericiguat?", "options": [{"text": "10%", "correct": true}, {"text": "15%", "correct": false}, {"text": "20%", "correct": false}, {"text": "5%", "correct": false}]},
            {"level": 13, "question": "¿Cuál es el mecanismo de acción del vericiguat?", "options": [{"text": "Estimulador de guanilato ciclasa soluble", "correct": true}, {"text": "Inhibidor de fosfodiesterasa V", "correct": false}, {"text": "Activador de NO sintasa", "correct": false}, {"text": "Bloqueador de endotelina", "correct": false}]},
            {"level": 13, "question": "En SOLOIST-WHF, ¿cuándo se inició sotagliflozina post-hospitalización?", "options": [{"text": "Antes del alta hospitalaria", "correct": true}, {"text": "A los 30 días", "correct": false}, {"text": "A los 7 días", "correct": false}, {"text": "A las 48 horas", "correct": false}]},

            {"level": 14, "question": "En GALACTIC-HF, ¿cuál fue el resultado del omecamtiv mecarbil?", "options": [{"text": "Reducción modest del endpoint primario", "correct": true}, {"text": "Sin beneficio significativo", "correct": false}, {"text": "Aumento de mortalidad", "correct": false}, {"text": "Beneficio solo en subgrupos", "correct": false}]},
            {"level": 14, "question": "¿Cuál es el mecanismo de omecamtiv mecarbil?", "options": [{"text": "Activador selectivo de miosina cardíaca", "correct": true}, {"text": "Inhibidor de troponina", "correct": false}, {"text": "Modulador de calcio", "correct": false}, {"text": "Estimulador de actina", "correct": false}]},
            {"level": 14, "question": "En STRONG-HF, ¿cuál fue la estrategia de up-titration?", "options": [{"text": "Intensificación rápida con seguimiento estrecho", "correct": true}, {"text": "Titulación estándar lenta", "correct": false}, {"text": "Solo ajuste de diuréticos", "correct": false}, {"text": "Titulación guiada por BNP", "correct": false}]},

            // Nivel 15-25: Casos extremos y subespecialidades
            {"level": 15, "question": "En IC con amiloidosis, ¿cuál es el signo patognomónico en ECG?", "options": [{"text": "Bajo voltaje con hipertrofia en eco", "correct": true}, {"text": "QRS fragmentado", "correct": false}, {"text": "Ondas Q septales", "correct": false}, {"text": "Prolongación QT", "correct": false}]},
            {"level": 15, "question": "¿Cuál es el tratamiento específico para amiloidosis TTR hereditaria?", "options": [{"text": "Tafamidis", "correct": true}, {"text": "Doxiciclina", "correct": false}, {"text": "Diflunisal", "correct": false}, {"text": "Patisiran", "correct": false}]},

            {"level": 16, "question": "En miocardiopatía hipertrófica obstructiva, ¿cuál es el gradiente para considerar intervención?", "options": [{"text": "≥50 mmHg en reposo o ≥30 mmHg provocado", "correct": true}, {"text": "≥30 mmHg en reposo", "correct": false}, {"text": "≥70 mmHg provocado", "correct": false}, {"text": "≥40 mmHg en cualquier condición", "correct": false}]},
            {"level": 16, "question": "En HCMP, ¿cuál es la indicación para mavacamten?", "options": [{"text": "NYHA II-III con obstrucción sintomática", "correct": true}, {"text": "Cualquier HCMP", "correct": false}, {"text": "Solo NYHA IV", "correct": false}, {"text": "HCMP asintomática", "correct": false}]},

            {"level": 17, "question": "En IC por quimioterapia, ¿cuál es el umbral de FEVI para suspender trastuzumab?", "options": [{"text": "Caída >10% y FEVI <53%", "correct": true}, {"text": "FEVI <50%", "correct": false}, {"text": "Caída >15%", "correct": false}, {"text": "FEVI <45%", "correct": false}]},
            {"level": 17, "question": "¿Cuál es el tratamiento preventivo más efectivo para cardiotoxicidad por antraciclinas?", "options": [{"text": "Dexrazoxano", "correct": true}, {"text": "IECA profilácticos", "correct": false}, {"text": "Betabloqueantes", "correct": false}, {"text": "Estatinas", "correct": false}]},

            {"level": 18, "question": "En IC pediátrica, ¿cuál es la causa más frecuente en lactantes?", "options": [{"text": "Malformaciones congénitas", "correct": true}, {"text": "Miocarditis", "correct": false}, {"text": "Miocardiopatía dilatada", "correct": false}, {"text": "Enfermedad de Kawasaki", "correct": false}]},

            {"level": 19, "question": "En IC y embarazo, ¿cuál es el fármaco de elección para hipertensión?", "options": [{"text": "Metildopa", "correct": true}, {"text": "IECA", "correct": false}, {"text": "Amlodipino", "correct": false}, {"text": "Hidroclorotiazida", "correct": false}]},

            {"level": 20, "question": "En miocardiopatía periparto, ¿cuál es el factor de riesgo más importante?", "options": [{"text": "Edad >35 años y multiparidad", "correct": true}, {"text": "Solo preeclampsia", "correct": false}, {"text": "Diabetes gestacional", "correct": false}, {"text": "Anemia", "correct": false}]},

            // Nivel 21-30: Fronteras del conocimiento
            {"level": 21, "question": "En el uso de células madre para IC, ¿cuál mostró mayor promesa en estudios?", "options": [{"text": "Células madre mesenquimales", "correct": true}, {"text": "Células madre embrionarias", "correct": false}, {"text": "Células iPS", "correct": false}, {"text": "Células satélite", "correct": false}]},

            {"level": 22, "question": "¿Cuál es el biomarcador emergente más prometedor para IC?", "options": [{"text": "Galectina-3", "correct": true}, {"text": "MicroRNA-21", "correct": false}, {"text": "Troponina ultrasensible", "correct": false}, {"text": "CRP ultrasensible", "correct": false}]},

            {"level": 23, "question": "En terapia génica para IC, ¿cuál es el target más estudiado?", "options": [{"text": "SERCA2a", "correct": true}, {"text": "Miosina", "correct": false}, {"text": "Troponina C", "correct": false}, {"text": "Fosfolamban", "correct": false}]},

            {"level": 24, "question": "¿Cuál es la técnica más promisoria para regeneración miocárdica?", "options": [{"text": "Cardiomiocitos derivados de iPS", "correct": true}, {"text": "Parches de colágeno", "correct": false}, {"text": "Factores de crecimiento", "correct": false}, {"text": "Nanomateriales", "correct": false}]},

            {"level": 25, "question": "En AI para IC, ¿cuál es la aplicación más desarrollada actualmente?", "options": [{"text": "Predicción de descompensación", "correct": true}, {"text": "Diagnóstico automático", "correct": false}, {"text": "Selección de fármacos", "correct": false}, {"text": "Análisis de imagen", "correct": false}]},

            {"level": 26, "question": "¿Cuál es el mecanismo propuesto para la terapia con ultrasonido en IC?", "options": [{"text": "Estimulación de angiogénesis", "correct": true}, {"text": "Destrucción de fibrosis", "correct": false}, {"text": "Activación neuronal", "correct": false}, {"text": "Modulación iónica", "correct": false}]},

            {"level": 27, "question": "En optogenética cardíaca, ¿cuál es el canal más estudiado?", "options": [{"text": "Channelrhodopsin-2", "correct": true}, {"text": "Halorhodopsin", "correct": false}, {"text": "Archaerhodopsin", "correct": false}, {"text": "OptoXR", "correct": false}]},

            {"level": 28, "question": "¿Cuál es la limitación principal de los corazones artificiales totales actuales?", "options": [{"text": "Tromboembolismo", "correct": true}, {"text": "Duración de batería", "correct": false}, {"text": "Tamaño del dispositivo", "correct": false}, {"text": "Rechazo inmune", "correct": false}]},

            {"level": 29, "question": "En xenotrasplante cardíaco, ¿cuál es la modificación genética más crítica en cerdos?", "options": [{"text": "Knockout de alfa-galactosil transferasa", "correct": true}, {"text": "Knockout de MHC", "correct": false}, {"text": "Overexpresión de CD55", "correct": false}, {"text": "Knockout de perforina", "correct": false}]},

            {"level": 30, "question": "¿Cuál representa el mayor desafío actual en medicina de precisión para IC?", "options": [{"text": "Integración de genómica, proteómica y fenómica clínica", "correct": true}, {"text": "Costos de secuenciación", "correct": false}, {"text": "Falta de biomarcadores", "correct": false}, {"text": "Resistencia de pacientes", "correct": false}]}
        ];
        
        // El banco de preguntas ya está completo con 90 preguntas reales
        
        // Títulos por nivel (30 niveles completos)
        const levelTitles = {
            1: "El que cura todo con agua con sal",
            2: "El que dice 'para el corazón lo mejor es el ajo'",
            3: "El botija que confunde un estetoscopio con un cargador",
            4: "El que cree que la presión se mide con el dedo en la muñeca",
            5: "El interno que ausculta la espalda buscando el ritmo sinusal",
            6: "El que receta ibuprofeno para el dolor precordial 'por las dudas'",
            7: "El que cree que el ecocardio se hace con gel y buena onda",
            8: "Aquel que convierte un dolor de pecho en un diagnóstico de 15 líneas",
            9: "El que interpreta la radiografía como si fuera una constelación",
            10: "El que escucha un soplo y pide en secreto que no le pregunten de qué es",
            11: "El que prescribe según lo que leyó en un grupo de WhatsApp",
            12: "El que dice 'probemos con carvedilol a ver qué pasa'",
            13: "El que escucha un R3 y lo anota aunque no esté seguro si no eran gases",
            14: "El que ya no dice 'tiene algo de falla' habla de IC con elementos congestivos",
            15: "El que pide BNP con cara seria aunque no sepa bien cómo interpretarlo",
            16: "El que empieza a citar artículos y ya no solo frases de la clínica médica",
            17: "El que entiende que no todo lo que se hincha es por 'retención'",
            18: "El que ya no ve todo como blanco y negro sino como 4 cuadrantes de Forrester",
            19: "El que sabe que los gliflozins no son una banda de rock noruega",
            20: "El que dejó de hablar de la FEVI, y mete strain y remodelado",
            21: "El que se emociona con un TAPSE >20 como si fuera una buena noticia familiar",
            22: "El que empieza a explicar la IC con analogías elegantes",
            23: "El que discute la clasificación universal de infarto como si hubiera estado en la mesa donde la armaron",
            24: "El que ajusta dosis de beta bloqueantes como quien afina una guitarra",
            25: "El que lee el ECG como si fuera partitura y encuentra la música oculta",
            26: "El que distingue entre empeoramiento clínico y progresión insidiosa",
            27: "El que recomienda rehabilitación cardiaca y se emociona al decir 'multidisciplinario'",
            28: "El que se indigna si no hay seguimiento post-alta",
            29: "El que guía al Heart Team con calma y convicción, como pastor clínico",
            30: "Oráculo cardiológico Manuel Quintela, de punta y al medio"
        };
        
        // Descripciones humorísticas (30 horóscopos únicos)
        const levelDescriptions = {
            1: "Felicitaciones, estás en el nivel básico de la medicina casera. Tu principal herramienta terapéutica es el agua con sal, que según vos cura desde un resfrío hasta una arritmia ventricular. En el fondo, tenés fe ciega en los remedios de la abuela.",
            2: "Has avanzado al nivel de curandero barrial. Tu arsenal se expandió: ajo para la presión, manzanilla para los nervios y cebolla para todo lo demás. Todavía creés que el limón puede destapar arterias.",
            3: "Sos ese interno tierno que todos quieren proteger. Confundís cables con instrumental médico y tenés esa inocencia que hace que los pacientes te sonrían con ternura. Al menos ya no intentás escuchar el corazón por la espalda.",
            4: "Nivel estudiante avanzado: ya sabés que el pulso no se toma con el dedo gordo, pero seguís buscando el punto exacto en la muñeca como si fuera un tesoro escondido. Los pacientes te tienen paciencia.",
            5: "Sos el que ausculta con cara seria pero en realidad está rezando para que no le pregunten qué escuchaste. Al menos ya diferenciás entre un pulmón y un corazón en la radiografía.",
            6: "Nivel 'médico precavido': para cualquier dolor en el pecho recetás ibuprofeno 'por las dudas' y mandás al paciente a caminar. Tu filosofía es 'si se mejora solo, mejor'.",
            7: "Ya entendiste que el ecocardiograma no es solo gel y buena onda, pero seguís viendo las imágenes como si fueran nubes en el cielo. Al menos preguntás cosas que suenan técnicas.",
            8: "Has desarrollado el talento especial de convertir un simple dolor de pecho en un diagnóstico diferencial de 15 patologías. Tu especialidad es encontrar zebras donde hay caballos.",
            9: "Interpretás las radiografías como constelaciones cósmicas. Ves patrones donde no los hay, pero al menos ya no confundís una costilla con el corazón. Progreso lento pero seguro.",
            10: "Escuchás soplos por todos lados, aunque no estés muy seguro de qué tipo son. Tu estrategia es anotar 'soplo sistólico grado II/VI' y que alguien más se haga cargo.",
            11: "Tu conocimiento médico proviene principalmente de grupos de WhatsApp de médicos. Citás papers que nunca leíste completos y usás términos en inglés para sonar más profesional.",
            12: "Entraste en la era del carvedilol experimental. Tu frase favorita es 'probemos con carvedilol a ver qué pasa'. Al menos ya sabés que es un betabloqueante.",
            13: "Desarrollaste el oído mágico para escuchar R3, aunque la mitad de las veces son gases intestinales. Pero lo anotás en la historia igual, por si acaso tenías razón.",
            14: "Evolucionaste del 'tiene algo de falla' al sofisticado 'IC con elementos congestivos'. Tu vocabulario se está volviendo más elegante, aunque seguís sin estar muy seguro.",
            15: "Pedís BNP con cara de experto, aunque después googleás discretamente cómo interpretarlo. Al menos ya sabés que tiene que ver con el corazón y no con el riñón.",
            16: "Comenzaste a citar estudios reales: 'según PARADIGM-HF...' aunque solo leíste el abstract. Pero sonás convincente y eso es lo que importa en esta etapa.",
            17: "Ya entendiste que no todo lo que se hincha es 'retención'. Empezaste a usar términos como 'sobrecarga de volumen' y 'redistribución'. Tu evolución semántica es notable.",
            18: "Descubriste los cuadrantes de Forrester y ahora clasificás todo en húmedo-seco, frío-caliente. Es como el juego de la batalla naval pero con hemodinamia.",
            19: "Aprendiste que los gliflozinas no son una banda noruega de metal, sino que son medicamentos revolucionarios. Empezaste a recetar con más fundamento científico.",
            20: "Dejaste de hablar solo de FEVI. Ahora metés strain, remodelado y función diastólica. Tu jerga cardiológica se está volviendo respetable y casi comprensible.",
            21: "Te emocionás genuinamente cuando ves un TAPSE mayor a 20 mm, como si fuera una buena noticia familiar. Ya entendés que el ventrículo derecho también existe e importa.",
            22: "Desarrollaste el arte de explicar la IC con analogías elegantes: comparás el corazón con una bomba de agua, los vasos con mangueras. Tus pacientes te entienden y agradecen.",
            23: "Discutís la clasificación universal de infarto como si hubieras estado en la mesa donde la escribieron. Citás a Thygesen con la familiaridad de quien lo conoce personalmente.",
            24: "Ajustás dosis de betabloqueantes como un músico que afina su guitarra: con precisión, paciencia y sabiendo que cada pequeño cambio puede hacer una gran diferencia.",
            25: "Leés el ECG como si fuera una partitura musical y encontrás la melodía oculta en cada complejo QRS. Los ritmos cardíacos tienen música para vos.",
            26: "Distinguís entre empeoramiento clínico franco y progresión insidiosa silenciosa. Tu ojo clínico se afinó y podés detectar matices sutiles que antes te pasaban inadvertidos.",
            27: "Recomendás rehabilitación cardíaca y te emocionás al pronunciar 'abordaje multidisciplinario'. Entendiste que curar no es solo recetar pastillas.",
            28: "Te indignás genuinamente cuando no hay seguimiento post-alta adecuado. Sabés que el alta hospitalaria es solo el comienzo del verdadero tratamiento.",
            29: "Guiás al Heart Team con la calma y convicción de un pastor experimentado. Tu juicio clínico se volvió una brújula confiable para decisiones complejas.",
            30: "Llegaste al olimpo cardiológico uruguayo. Sos el oráculo del Hospital de Clínicas, de punta y al medio. Los residentes te consultan, los adjuntos te respetan, y los pacientes te bendicen."
        };
        
        // Inicialización
        window.addEventListener('load', function() {
            loadDashboard();
            setupFirebaseListeners();
            updateLivesDisplay();
            handleMissingLogos();
            console.log('App inicializada con Firebase - Banco de preguntas:', questionBank.length);
        });
        
        // Manejar logos faltantes
        function handleMissingLogos() {
            const logos = ['logo-ccu', 'logo-uac'];
            logos.forEach(logoId => {
                const img = document.getElementById(logoId);
                img.onerror = function() {
                    this.style.display = 'none';
                    this.nextElementSibling.style.display = 'none';
                };
            });
        }
        
        // Funciones de navegación
        function showTab(tabName) {
            // Ocultar todos los tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Ocultar todos los nav-tabs activos
            document.querySelectorAll('.nav-tab').forEach(navTab => {
                navTab.classList.remove('active');
            });
            
            // Mostrar tab seleccionado
            document.getElementById(tabName).classList.add('active');
            
            // Activar nav-tab correspondiente
            event.target.classList.add('active');
            
            // Recargar dashboard si es necesario
            if (tabName === 'dashboard') {
                loadDashboard();
            }
        }
        
        // Funciones de administración
        function verifyAdmin() {
            const password = document.getElementById('adminPassword').value;
            if (password === ADMIN_PASSWORD) {
                isAdminAuthenticated = true;
                document.getElementById('adminData').style.display = 'block';
                loadAdminData();
            } else {
                alert('Contraseña incorrecta');
            }
        }
        
        async function loadAdminData() {
            try {
                const snapshot = await database.ref('resultados').once('value');
                const results = snapshot.val();
                
                if (results) {
                    const resultsArray = Object.values(results).sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
                    
                    let tableHTML = `
                        <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
                            <thead>
                                <tr style="background: rgba(59, 130, 246, 0.2);">
                                    <th style="padding: 12px; border: 1px solid rgba(59, 130, 246, 0.3);">Fecha/Hora</th>
                                    <th style="padding: 12px; border: 1px solid rgba(59, 130, 246, 0.3);">Nombre Completo</th>
                                    <th style="padding: 12px; border: 1px solid rgba(59, 130, 246, 0.3);">Cédula</th>
                                    <th style="padding: 12px; border: 1px solid rgba(59, 130, 246, 0.3);">Pseudónimo</th>
                                    <th style="padding: 12px; border: 1px solid rgba(59, 130, 246, 0.3);">Puntaje</th>
                                    <th style="padding: 12px; border: 1px solid rgba(59, 130, 246, 0.3);">Nivel</th>
                                    <th style="padding: 12px; border: 1px solid rgba(59, 130, 246, 0.3);">Intento</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    resultsArray.forEach(result => {
                        tableHTML += `
                            <tr>
                                <td style="padding: 8px; border: 1px solid rgba(59, 130, 246, 0.2);">${result.fecha}</td>
                                <td style="padding: 8px; border: 1px solid rgba(59, 130, 246, 0.2);">${result.nombre}</td>
                                <td style="padding: 8px; border: 1px solid rgba(59, 130, 246, 0.2);">${result.cedula}</td>
                                <td style="padding: 8px; border: 1px solid rgba(59, 130, 246, 0.2);">${result.pseudonimo}</td>
                                <td style="padding: 8px; border: 1px solid rgba(59, 130, 246, 0.2);">${result.puntaje}</td>
                                <td style="padding: 8px; border: 1px solid rgba(59, 130, 246, 0.2);">${result.nivel}</td>
                                <td style="padding: 8px; border: 1px solid rgba(59, 130, 246, 0.2);">${result.intento}</td>
                            </tr>
                        `;
                    });
                    
                    tableHTML += '</tbody></table>';
                    document.getElementById('adminTable').innerHTML = tableHTML;
                }
            } catch (error) {
                console.error('Error loading admin data:', error);
            }
        }
        
        function exportAdminData() {
            if (!isAdminAuthenticated) {
                alert('Acceso no autorizado');
                return;
            }
            
            database.ref('resultados').once('value').then(snapshot => {
                const results = snapshot.val();
                if (results) {
                    const resultsArray = Object.values(results);
                    
                    let csv = 'Fecha/Hora,Nombre Completo,Cédula,Pseudónimo,Puntaje,Nivel Máximo,Título,Intento\n';
                    
                    resultsArray.forEach(result => {
                        csv += `"${result.fecha}","${result.nombre}","${result.cedula}","${result.pseudonimo}",${result.puntaje},${result.nivel},"${result.titulo}",${result.intento}\n`;
                    });
                    
                    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = `registro_completo_cardiologia_${new Date().toISOString().split('T')[0]}.csv`;
                    link.click();
                }
            });
        }
        
        function clearAllData() {
            if (!isAdminAuthenticated) {
                alert('Acceso no autorizado');
                return;
            }
            
            if (confirm('¿Estás seguro de que quieres eliminar TODOS los datos? Esta acción no se puede deshacer.')) {
                database.ref('resultados').remove();
                database.ref('estadisticas').remove();
                alert('Todos los datos han sido eliminados');
                loadAdminData();
                loadDashboard();
            }
        }
        
        // Funciones Firebase
        function setupFirebaseListeners() {
            database.ref('resultados').on('value', (snapshot) => {
                updateDashboardStats();
                updateTopPlayers();
                updateLiveFeed();
            });
        }
        
        async function checkPlayerAttempts(cedula) {
            try {
                const snapshot = await database.ref('resultados').orderByChild('cedula').equalTo(cedula).once('value');
                const results = snapshot.val();
                return results ? Object.keys(results).length : 0;
            } catch (error) {
                console.error('Error checking attempts:', error);
                return 0;
            }
        }
        
        async function saveGameResult(result) {
            try {
                const resultId = database.ref('resultados').push().key;
                
                await database.ref('resultados/' + resultId).set({
                    ...result,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    id: resultId
                });
                
                updateGlobalStats();
                
                console.log('Resultado guardado en Firebase:', resultId);
                return resultId;
            } catch (error) {
                console.error('Error saving result:', error);
                throw error;
            }
        }
        
        async function updateGlobalStats() {
            try {
                const snapshot = await database.ref('resultados').once('value');
                const results = snapshot.val();
                
                if (results) {
                    const resultsArray = Object.values(results);
                    const totalPlayers = resultsArray.length;
                    const avgScore = resultsArray.reduce((sum, r) => sum + r.puntaje, 0) / totalPlayers;
                    const maxLevel = Math.max(...resultsArray.map(r => r.nivel));
                    
                    const today = new Date().toDateString();
                    const playersToday = resultsArray.filter(r => 
                        new Date(r.fecha).toDateString() === today
                    ).length;
                    
                    await database.ref('estadisticas').set({
                        totalJugadores: totalPlayers,
                        promedioScore: Math.round(avgScore * 10) / 10,
                        nivelMaximo: maxLevel,
                        jugadoresHoy: playersToday,
                        ultimaActualizacion: firebase.database.ServerValue.TIMESTAMP
                    });
                }
            } catch (error) {
                console.error('Error updating stats:', error);
            }
        }
        
        // Funciones Dashboard
        function loadDashboard() {
            updateDashboardStats();
            updateTopPlayers();
            updateLiveFeed();
        }
        
        async function updateDashboardStats() {
            try {
                const snapshot = await database.ref('estadisticas').once('value');
                const stats = snapshot.val();
                
                if (stats) {
                    document.getElementById('totalJugadores').textContent = stats.totalJugadores || 0;
                    document.getElementById('promedioScore').textContent = stats.promedioScore || 0;
                    document.getElementById('nivelMaximo').textContent = stats.nivelMaximo || 0;
                    document.getElementById('jugadoresHoy').textContent = stats.jugadoresHoy || 0;
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }
        
        async function updateTopPlayers() {
            try {
                const snapshot = await database.ref('resultados').orderByChild('puntaje').limitToLast(20).once('value');
                const results = snapshot.val();
                
                if (results) {
                    const resultsArray = Object.values(results).sort((a, b) => b.puntaje - a.puntaje);
                    
                    const uniqueResults = new Map();
                    resultsArray.forEach(result => {
                        const existing = uniqueResults.get(result.pseudonimo);
                        if (!existing || result.puntaje > existing.puntaje) {
                            uniqueResults.set(result.pseudonimo, result);
                        }
                    });
                    
                    const topResults = Array.from(uniqueResults.values())
                        .sort((a, b) => b.puntaje - a.puntaje)
                        .slice(0, 10);
                    
                    const container = document.getElementById('topPlayers');
                    container.innerHTML = '';
                    
                    topResults.forEach((result, index) => {
                        const playerRank = document.createElement('div');
                        playerRank.className = 'player-rank';
                        
                        if (index === 0) playerRank.classList.add('podium-1');
                        else if (index === 1) playerRank.classList.add('podium-2');
                        else if (index === 2) playerRank.classList.add('podium-3');
                        
                        playerRank.innerHTML = `
                            <div class="rank-number">${index + 1}</div>
                            <div>
                                <div class="rank-name">${result.pseudonimo}</div>
                                <div class="rank-title">${levelTitles[result.nivel] || 'El que cura todo con agua con sal'}</div>
                            </div>
                            <div class="rank-score">${result.puntaje} pts</div>
                            <div class="rank-level">Nv.${result.nivel}</div>
                        `;
                        
                        container.appendChild(playerRank);
                    });
                }
            } catch (error) {
                console.error('Error loading top players:', error);
            }
        }
        
        async function updateLiveFeed() {
            try {
                const snapshot = await database.ref('resultados').orderByChild('timestamp').limitToLast(10).once('value');
                const results = snapshot.val();
                
                if (results) {
                    const resultsArray = Object.values(results).sort((a, b) => b.timestamp - a.timestamp);
                    
                    const container = document.getElementById('liveFeed');
                    container.innerHTML = '';
                    
                    resultsArray.forEach(result => {
                        const feedItem = document.createElement('div');
                        feedItem.className = 'feed-item';
                        
                        const timeAgo = getTimeAgo(result.timestamp);
                        
                        feedItem.innerHTML = `
                            <div>
                                <div class="feed-player">${result.pseudonimo}</div>
                            </div>
                            <div class="feed-score">${result.puntaje} pts - Nv.${result.nivel}</div>
                            <div class="feed-time">${timeAgo}</div>
                        `;
                        
                        container.appendChild(feedItem);
                    });
                }
            } catch (error) {
                console.error('Error loading live feed:', error);
            }
        }
        
        function getTimeAgo(timestamp) {
            const now = Date.now();
            const diff = now - timestamp;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (days > 0) return `hace ${days}d`;
            if (hours > 0) return `hace ${hours}h`;
            if (minutes > 0) return `hace ${minutes}m`;
            return 'ahora';
        }
        
        // Funciones del juego
        async function startGame() {
            const name = document.getElementById('playerName').value.trim();
            const id = document.getElementById('playerId').value.trim();
            const pseudonym = document.getElementById('playerPseudonym').value.trim();
            
            if (!name || !id || !pseudonym) {
                alert('Por favor, completá todos los campos');
                return;
            }
            
            try {
                playerAttempts = await checkPlayerAttempts(id);
                
                if (playerAttempts >= 2) {
                    document.getElementById('intentosMessage').style.display = 'block';
                    document.getElementById('intentosMessage').textContent = 
                        '❌ Ya completaste tus 2 intentos permitidos. Solo podés ver el dashboard.';
                    return;
                }
                
                if (playerAttempts === 1) {
                    document.getElementById('intentosMessage').style.display = 'block';
                    document.getElementById('intentosMessage').textContent = 
                        '⚠️ Este es tu segundo y último intento.';
                }
            } catch (error) {
                console.error('Error checking attempts:', error);
                alert('Error conectando con la base de datos. Intenta de nuevo.');
                return;
            }
            
            currentPlayer = { name, id, pseudonym };
            document.getElementById('displayName').textContent = name;
            document.getElementById('displayPseudonym').textContent = pseudonym;
            
            // Resetear variables del juego
            currentLevel = 1;
            score = 0;
            lives = 3;
            maxLevelReached = 1;
            answeredQuestions.clear();
            comodines = { fifty: true, change: true };
            document.getElementById('comodin5050').disabled = false;
            document.getElementById('comodinChange').disabled = false;
            
            updateScore();
            updateLivesDisplay();
            updateCurrentLevel();
            
            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('gameScreen').style.display = 'block';
            
            showLevelScreen();
        }
        
        function showLevelScreen() {
            document.getElementById('levelScreen').style.display = 'block';
            document.getElementById('mainQuestionContainer').style.display = 'none';
            document.getElementById('nextButton').style.display = 'none';
            
            document.getElementById('levelNumber').textContent = currentLevel;
            document.getElementById('levelDescription').textContent = levelTitles[currentLevel] || "Nivel sin descripción";
        }
        
        function startLevel() {
            document.getElementById('levelScreen').style.display = 'none';
            document.getElementById('mainQuestionContainer').style.display = 'block';
            loadQuestion();
        }
        
        function loadQuestion() {
            eliminated5050 = false;
            
            // Filtrar preguntas disponibles del nivel actual
            const levelQuestions = questionBank.filter(q => q.level === currentLevel);
            const availableQuestions = levelQuestions.filter(q => !answeredQuestions.has(q.question));
            
            if (availableQuestions.length === 0) {
                // Si no hay preguntas disponibles, reiniciar el pool para este nivel
                answeredQuestions.forEach(q => {
                    const questionLevel = questionBank.find(qb => qb.question === q)?.level;
                    if (questionLevel === currentLevel) {
                        answeredQuestions.delete(q);
                    }
                });
                
                // Volver a filtrar
                const resetAvailable = levelQuestions.filter(q => !answeredQuestions.has(q.question));
                currentQuestion = resetAvailable.length > 0 ? 
                    resetAvailable[Math.floor(Math.random() * resetAvailable.length)] :
                    levelQuestions[Math.floor(Math.random() * levelQuestions.length)];
            } else {
                currentQuestion = availableQuestions[Math.floor(Math.random() * availableQuestions.length)];
            }
            
            answeredQuestions.add(currentQuestion.question);
            
            document.getElementById('questionText').textContent = currentQuestion.question;
            shuffledOptions = currentQuestion.options.slice().sort(() => Math.random() - 0.5);
            
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            
            shuffledOptions.forEach((option, index) => {
                const optionElement = document.createElement('div');
                optionElement.className = 'option';
                optionElement.textContent = option.text;
                optionElement.onclick = () => selectOption(option, optionElement);
                optionsContainer.appendChild(optionElement);
            });
            
            document.getElementById('nextButton').style.display = 'none';
            startTimer();
        }
        
        function startTimer() {
            timeLeft = 30;
            updateTimerDisplay();
            
            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();
                
                if (timeLeft <= 10) {
                    document.getElementById('timer').classList.add('warning');
                }
                
                if (timeLeft <= 0) {
                    timeOut();
                }
            }, 1000);
        }
        
        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            document.getElementById('timer').classList.remove('warning');
        }
        
        function updateTimerDisplay() {
            document.getElementById('timer').textContent = timeLeft;
        }
        
        function timeOut() {
            stopTimer();
            // Tiempo agotado = respuesta incorrecta = 0 puntos
            lives--;
            updateLivesDisplay();
            
            const allOptions = document.querySelectorAll('.option');
            allOptions.forEach((optElement, idx) => {
                optElement.classList.add('disabled');
                optElement.onclick = null;
                if (shuffledOptions[idx].correct) {
                    optElement.classList.add('correct');
                }
            });
            
            if (lives <= 0) {
                setTimeout(endGame, 2000);
            } else {
                setTimeout(() => {
                    document.getElementById('nextButton').style.display = 'inline-block';
                }, 1500);
            }
        }
        
        function selectOption(option, element) {
            stopTimer();
            
            if (element.classList.contains('eliminated')) {
                return;
            }
            
            const allOptions = document.querySelectorAll('.option');
            allOptions.forEach(opt => {
                opt.classList.add('disabled');
                opt.onclick = null;
            });
            
            // Sistema de puntuación simplificado
            if (option.correct) {
                element.classList.add('correct');
                score += 1; // Respuesta correcta = +1
            } else {
                element.classList.add('incorrect');
                // Respuesta incorrecta = 0 puntos, perder vida
                lives--;
                
                // Mostrar la opción correcta
                allOptions.forEach((optElement, idx) => {
                    if (shuffledOptions[idx].correct) {
                        optElement.classList.add('correct');
                    }
                });
            }
            
            updateScore();
            updateLivesDisplay();
            
            if (lives <= 0) {
                setTimeout(endGame, 2000);
                return;
            }
            
            setTimeout(() => {
                document.getElementById('nextButton').style.display = 'inline-block';
            }, 1500);
        }
        
        function nextQuestion() {
            currentLevel++;
            updateCurrentLevel();
            
            if (currentLevel > maxLevelReached) {
                maxLevelReached = currentLevel;
            }
            
            if (currentLevel > 30) {
                endGame();
                return;
            }
            
            showLevelScreen();
        }
        
        function use5050() {
            if (!comodines.fifty) return;
            
            comodines.fifty = false;
            document.getElementById('comodin5050').disabled = true;
            
            const incorrectIndices = [];
            shuffledOptions.forEach((option, index) => {
                if (!option.correct) {
                    incorrectIndices.push(index);
                }
            });
            
            const toEliminate = incorrectIndices.sort(() => Math.random() - 0.5).slice(0, 2);
            
            toEliminate.forEach(index => {
                const optionElement = document.querySelectorAll('.option')[index];
                optionElement.classList.add('eliminated');
                optionElement.onclick = null;
            });
        }
        
        function changeQuestion() {
            if (!comodines.change) return;
            
            comodines.change = false;
            document.getElementById('comodinChange').disabled = true;
            
            answeredQuestions.delete(currentQuestion.question);
            stopTimer();
            loadQuestion();
        }
        
        function updateScore() {
            document.getElementById('score').textContent = score;
        }
        
        function updateCurrentLevel() {
            document.getElementById('currentLevelDisplay').textContent = currentLevel;
        }
        
        function updateLivesDisplay() {
            const hearts = ['heart1', 'heart2', 'heart3'];
            hearts.forEach((heartId, index) => {
                const heart = document.getElementById(heartId);
                if (index < lives) {
                    heart.className = 'heart active';
                } else {
                    heart.className = 'heart lost';
                }
            });
        }
        
        function getLevelTitle(level) {
            return levelTitles[level] || "El que cura todo con agua con sal";
        }
        
        async function endGame() {
            stopTimer();
            
            const result = {
                nombre: currentPlayer.name,
                cedula: currentPlayer.id,
                pseudonimo: currentPlayer.pseudonym,
                puntaje: score,
                nivel: maxLevelReached,
                titulo: getLevelTitle(maxLevelReached),
                fecha: new Date().toLocaleString('es-UY'),
                intento: playerAttempts + 1
            };
            
            try {
                await saveGameResult(result);
                console.log('Juego guardado exitosamente');
            } catch (error) {
                console.error('Error guardando juego:', error);
                alert('Error guardando el resultado. Tu progreso puede no haberse guardado.');
            }
            
            document.getElementById('gameScreen').style.display = 'none';
            document.getElementById('resultsScreen').style.display = 'block';
            
            document.getElementById('finalScore').textContent = score;
            document.getElementById('maxLevel').textContent = maxLevelReached;
            document.getElementById('levelName').textContent = result.titulo;
            document.getElementById('levelHoroscope').textContent = 
                levelDescriptions[maxLevelReached] || levelDescriptions[1];
            
            document.getElementById('retryButton').style.display = 
                (playerAttempts + 1) < 2 ? 'inline-block' : 'none';
        }
        
        function retryGame() {
            lives = 3;
            currentLevel = 1;
            score = 0;
            maxLevelReached = 1;
            answeredQuestions.clear();
            comodines = { fifty: true, change: true };
            document.getElementById('comodin5050').disabled = false;
            document.getElementById('comodinChange').disabled = false;
            
            document.getElementById('resultsScreen').style.display = 'none';
            document.getElementById('gameScreen').style.display = 'block';
            
            updateScore();
            updateLivesDisplay();
            updateCurrentLevel();
            showLevelScreen();
        }
        
        function newGame() {
            document.getElementById('resultsScreen').style.display = 'none';
            document.getElementById('startScreen').style.display = 'block';
            document.getElementById('playerName').value = '';
            document.getElementById('playerId').value = '';
            document.getElementById('playerPseudonym').value = '';
            document.getElementById('intentosMessage').style.display = 'none';
        }
    </script>
</body>
</html>