<!DOCTYPE html>
<html lang="es-UY">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>¿Quién quiere ser cardiólogo? - Competencia por Equipos</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
            color: #e2e8f0;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow-x: hidden;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, transparent 20%, rgba(59, 130, 246, 0.15) 20%, rgba(59, 130, 246, 0.15) 21%, transparent 21%, transparent 30%, rgba(59, 130, 246, 0.1) 30%, rgba(59, 130, 246, 0.1) 31%, transparent 31%);
            background-size: 60px 60px;
            animation: rotate 180s linear infinite;
            opacity: 0.4;
            z-index: -1;
        }
        
        @keyframes rotate {
            to { transform: rotate(360deg); }
        }
        
        .container {
            width: 95%;
            max-width: 1200px;
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(20px);
            border: 2px solid rgba(59, 130, 246, 0.3);
            border-radius: 24px;
            padding: 24px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25), 0 0 0 1px rgba(59, 130, 246, 0.1);
            position: relative;
            z-index: 1;
            max-height: 95vh;
            overflow-y: auto;
        }
        
        /* Logos institucionales */
        .institutional-header {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 40px;
            margin-bottom: 20px;
            padding: 16px;
            background: rgba(30, 41, 59, 0.3);
            border-radius: 16px;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }
        
        .logo-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }
        
        .logo {
            height: 60px;
            width: auto;
            opacity: 0.9;
            transition: all 0.3s ease;
            filter: brightness(1.1);
        }
        
        .logo:hover {
            opacity: 1;
            transform: scale(1.05);
        }
        
        .logo-text {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            color: #94a3b8;
            text-align: center;
            font-weight: 500;
        }
        
        h1 {
            font-size: 2.75rem;
            font-weight: 700;
            text-align: center;
            background: linear-gradient(135deg, #60a5fa, #3b82f6, #2563eb);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 12px;
            letter-spacing: -0.025em;
        }
        
        h2 {
            font-size: 1.875rem;
            font-weight: 600;
            text-align: center;
            color: #60a5fa;
            margin-bottom: 24px;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .subtitle {
            font-family: 'JetBrains Mono', monospace;
            text-align: center;
            color: #94a3b8;
            font-size: 1.125rem;
            margin-bottom: 32px;
            letter-spacing: 0.05em;
            font-weight: 500;
        }
        
        .nav-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 32px;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .nav-tab {
            background: rgba(30, 58, 138, 0.2);
            color: #e2e8f0;
            border: 2px solid rgba(59, 130, 246, 0.3);
            padding: 12px 24px;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: 'JetBrains Mono', monospace;
            font-weight: 500;
            font-size: 0.875rem;
        }
        
        .nav-tab.active {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.3);
            transform: translateY(-2px);
        }
        
        .nav-tab:hover:not(.active) {
            background: rgba(59, 130, 246, 0.2);
            border-color: rgba(59, 130, 246, 0.5);
            transform: translateY(-1px);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Admin Panel */
        .admin-panel {
            background: rgba(220, 38, 38, 0.1);
            border: 2px solid rgba(220, 38, 38, 0.3);
            border-radius: 16px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }
        
        .admin-password {
            width: 300px;
            padding: 12px;
            margin: 12px;
            background: rgba(15, 23, 42, 0.8);
            border: 2px solid rgba(220, 38, 38, 0.3);
            border-radius: 8px;
            color: #e2e8f0;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .admin-data {
            background: rgba(15, 23, 42, 0.6);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            max-height: 500px;
            overflow-y: auto;
        }
        
        /* Pantalla de inicio */
        #startScreen {
            text-align: center;
        }
        
        .form-group {
            margin: 24px 0;
            text-align: left;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-size: 1.125rem;
            font-weight: 500;
            color: #60a5fa;
        }
        
        input, select {
            width: 100%;
            padding: 16px;
            font-size: 1rem;
            background: rgba(30, 41, 59, 0.8);
            border: 2px solid rgba(59, 130, 246, 0.3);
            border-radius: 12px;
            color: #e2e8f0;
            font-family: 'Inter', sans-serif;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #3b82f6;
            background: rgba(30, 41, 59, 0.95);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        select option {
            background: #1e293b;
            color: #e2e8f0;
        }
        
        .privacy-note {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 12px;
            padding: 16px;
            margin: 24px 0;
            font-size: 0.875rem;
            color: #94a3b8;
            line-height: 1.6;
        }
        
        .btn {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            border: none;
            padding: 14px 32px;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            margin: 8px;
            font-family: 'Inter', sans-serif;
            letter-spacing: 0.025em;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.3);
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
        }
        
        .btn-danger:hover {
            background: linear-gradient(135deg, #b91c1c, #991b1b);
        }
        
        /* Dashboard */
        .dashboard-section {
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 24px;
            margin: 24px 0;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin: 24px 0;
        }
        
        .stat-card {
            background: rgba(15, 23, 42, 0.6);
            border: 2px solid rgba(59, 130, 246, 0.2);
            border-radius: 16px;
            padding: 24px;
            text-align: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .stat-card:hover {
            border-color: rgba(59, 130, 246, 0.4);
            transform: translateY(-2px);
        }
        
        .stat-number {
            font-size: 2.5rem;
            color: #60a5fa;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .stat-label {
            color: #94a3b8;
            font-size: 1rem;
            font-weight: 500;
            margin-top: 8px;
        }
        
        /* Ranking por equipos */
        .team-rankings {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
            margin: 24px 0;
        }
        
        .team-section {
            background: rgba(15, 23, 42, 0.6);
            border-radius: 16px;
            padding: 20px;
            border: 2px solid rgba(59, 130, 246, 0.2);
            transition: all 0.3s ease;
        }
        
        .team-section:hover {
            border-color: rgba(59, 130, 246, 0.4);
            transform: translateY(-2px);
        }
        
        .team-section.team-a {
            border-color: rgba(34, 197, 94, 0.4);
        }
        
        .team-section.team-b {
            border-color: rgba(59, 130, 246, 0.4);
        }
        
        .team-section.team-c {
            border-color: rgba(251, 191, 36, 0.4);
        }
        
        .team-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding: 12px;
            border-radius: 8px;
        }
        
        .team-a .team-header {
            background: rgba(34, 197, 94, 0.1);
        }
        
        .team-b .team-header {
            background: rgba(59, 130, 246, 0.1);
        }
        
        .team-c .team-header {
            background: rgba(251, 191, 36, 0.1);
        }
        
        .team-name {
            font-size: 1.5rem;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .team-a .team-name {
            color: #22c55e;
        }
        
        .team-b .team-name {
            color: #3b82f6;
        }
        
        .team-c .team-name {
            color: #fbbf24;
        }
        
        .team-stats {
            display: flex;
            gap: 16px;
            font-size: 0.875rem;
            color: #94a3b8;
        }
        
        .team-player {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin: 4px 0;
            background: rgba(30, 41, 59, 0.4);
            border-radius: 8px;
            font-size: 0.875rem;
        }
        
        .live-feed {
            background: rgba(15, 23, 42, 0.4);
            border-radius: 12px;
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .feed-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid rgba(59, 130, 246, 0.2);
            animation: fadeIn 0.5s ease-out;
        }
        
        .feed-item:last-child {
            border-bottom: none;
        }
        
        .feed-player {
            font-weight: 600;
            color: #60a5fa;
        }
        
        .feed-team {
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: 500;
        }
        
        .feed-team.team-a {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }
        
        .feed-team.team-b {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
        }
        
        .feed-team.team-c {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }
        
        .feed-score {
            color: #3b82f6;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 500;
        }
        
        .feed-time {
            font-size: 0.75rem;
            color: #64748b;
        }
        
        /* Pantalla de juego */
        #gameScreen {
            display: none;
        }
        
        .game-header {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 24px;
            align-items: center;
            margin-bottom: 32px;
            padding: 24px;
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }
        
        .player-info, .game-stats, .comodines {
            font-family: 'JetBrains Mono', monospace;
            text-align: center;
        }
        
        .player-team {
            margin-top: 8px;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.875rem;
            font-weight: 600;
            display: inline-block;
        }
        
        .player-team.team-a {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }
        
        .player-team.team-b {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
        }
        
        .player-team.team-c {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }
        
        .lives {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 12px;
        }
        
        .heart {
            font-size: 1.5rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            filter: drop-shadow(0 0 8px rgba(59, 130, 246, 0.5));
        }
        
        .heart.active {
            color: #60a5fa;
            transform: scale(1);
        }
        
        .heart.lost {
            color: #334155;
            transform: scale(0.8);
            filter: none;
        }
        
        .comodines {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .comodin {
            background: linear-gradient(135deg, #60a5fa, #3b82f6);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.875rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .comodin:hover:not(:disabled) {
            transform: scale(1.05) translateY(-1px);
            box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.3);
        }
        
        .comodin:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Timer */
        .timer-container {
            text-align: center;
            margin: 20px 0;
        }
        
        .timer {
            font-size: 2rem;
            font-weight: 700;
            color: #60a5fa;
            background: rgba(30, 41, 59, 0.8);
            padding: 12px 24px;
            border-radius: 50%;
            display: inline-block;
            min-width: 80px;
            border: 3px solid rgba(59, 130, 246, 0.3);
            font-family: 'JetBrains Mono', monospace;
        }
        
        .timer.warning {
            color: #f59e0b;
            border-color: #f59e0b;
            animation: pulse 0.5s infinite;
        }
        
        /* Pregunta y opciones */
        .question-container {
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(59, 130, 246, 0.2);
            border-radius: 16px;
            padding: 32px;
            margin: 24px 0;
        }
        
        .question {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 32px;
            line-height: 1.6;
            color: #e2e8f0;
            text-align: center;
        }
        
        .options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }
        
        .option {
            background: rgba(15, 23, 42, 0.6);
            border: 2px solid rgba(59, 130, 246, 0.3);
            padding: 20px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 1rem;
            text-align: left;
            line-height: 1.5;
            font-weight: 500;
        }
        
        .option:hover:not(.disabled) {
            background: rgba(59, 130, 246, 0.1);
            border-color: #3b82f6;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px -8px rgba(59, 130, 246, 0.3);
        }
        
        .option.correct {
            background: linear-gradient(135deg, #059669, #047857);
            border-color: #10b981;
            color: white;
            animation: correctAnimation 0.6s ease-out;
        }
        
        .option.incorrect {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            border-color: #ef4444;
            color: white;
            animation: shake 0.6s ease-out;
        }
        
        .option.disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .option.eliminated {
            opacity: 0.3;
            background: rgba(51, 65, 85, 0.6);
            cursor: not-allowed;
            text-decoration: line-through;
        }
        
        @keyframes correctAnimation {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-4px); }
            20%, 40%, 60%, 80% { transform: translateX(4px); }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Pantalla de nivel */
        #levelScreen {
            display: none;
            text-align: center;
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(59, 130, 246, 0.2);
            border-radius: 16px;
            padding: 32px;
            margin: 24px 0;
        }
        
        .level-title {
            font-size: 2.25rem;
            font-weight: 700;
            color: #60a5fa;
            margin-bottom: 24px;
        }
        
        .level-description {
            font-size: 1.25rem;
            color: #94a3b8;
            margin-bottom: 32px;
            line-height: 1.6;
            font-style: italic;
        }
        
        /* Pantalla de resultados */
        #resultsScreen {
            display: none;
            text-align: center;
        }
        
        .final-score {
            font-size: 3rem;
            font-weight: 700;
            background: linear-gradient(135deg, #60a5fa, #3b82f6);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 24px 0;
        }
        
        .level-name {
            font-size: 1.5rem;
            color: #94a3b8;
            margin: 24px 0;
            font-family: 'JetBrains Mono', monospace;
        }
        
        /* Rankings */
        .ranking-section {
            margin: 32px 0;
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }
        
        .ranking-title {
            font-size: 1.75rem;
            color: #60a5fa;
            margin-bottom: 24px;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
        }
        
        .top-players {
            display: grid;
            gap: 12px;
            margin-bottom: 24px;
        }
        
        .player-rank {
            display: grid;
            grid-template-columns: 60px 2fr auto auto auto;
            gap: 16px;
            padding: 16px;
            background: rgba(15, 23, 42, 0.6);
            border-radius: 12px;
            align-items: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .player-rank:hover {
            transform: translateY(-1px);
        }
        
        .player-rank.podium-1 {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(245, 158, 11, 0.1));
            border: 2px solid #fbbf24;
        }
        
        .player-rank.podium-2 {
            background: linear-gradient(135deg, rgba(156, 163, 175, 0.2), rgba(107, 114, 128, 0.1));
            border: 2px solid #9ca3af;
        }
        
        .player-rank.podium-3 {
            background: linear-gradient(135deg, rgba(194, 120, 3, 0.2), rgba(146, 64, 14, 0.1));
            border: 2px solid #c2750b;
        }
        
        .rank-number {
            font-size: 1.5rem;
            font-weight: 700;
            color: #60a5fa;
            text-align: center;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .rank-name {
            font-weight: 600;
            color: #e2e8f0;
        }
        
        .rank-team {
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .rank-team.team-a {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }
        
        .rank-team.team-b {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
        }
        
        .rank-team.team-c {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }
        
        .rank-score {
            font-family: 'JetBrains Mono', monospace;
            color: #3b82f6;
            font-weight: 600;
        }
        
        .rank-title {
            color: #94a3b8;
            font-size: 0.75rem;
            font-style: italic;
            margin-top: 4px;
            line-height: 1.2;
        }
        
        .rank-level {
            font-family: 'JetBrains Mono', monospace;
            color: #60a5fa;
            font-size: 0.875rem;
        }
        
        .horoscope-section {
            background: rgba(59, 130, 246, 0.1);
            border: 2px solid rgba(59, 130, 246, 0.3);
            border-radius: 16px;
            padding: 24px;
            margin: 32px 0;
            text-align: left;
        }
        
        .horoscope-title {
            color: #60a5fa;
            text-align: center;
            margin-bottom: 16px;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
        }
        
        .horoscope-text {
            font-size: 1.125rem;
            line-height: 1.7;
            color: #e2e8f0;
            font-style: italic;
        }
        
        .loading {
            text-align: center;
            color: #94a3b8;
            font-style: italic;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            h1 {
                font-size: 2.25rem;
            }
            
            .container {
                padding: 16px;
            }
            
            .institutional-header {
                flex-direction: column;
                gap: 20px;
            }
            
            .logo {
                height: 50px;
            }
            
            .nav-tabs {
                justify-content: flex-start;
                overflow-x: auto;
                padding-bottom: 8px;
            }
            
            .game-header {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            .options {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .player-rank {
                grid-template-columns: 40px 2fr auto;
                gap: 12px;
            }
            
            .rank-level, .rank-team {
                display: none;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .team-rankings {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header institucional -->
        <div class="institutional-header">
            <div class="logo-container">
                <img src="logo-ccu.png" alt="Centro Cardiovascular Universitario" class="logo" id="logo-ccu">
                <div class="logo-text">Centro Cardiovascular<br>Universitario</div>
            </div>
            <div class="logo-container">
                <img src="logo-uac.png" alt="Unidad Académica de Cardiología" class="logo" id="logo-uac">
                <div class="logo-text">Unidad Académica<br>de Cardiología</div>
            </div>
        </div>
        
        <!-- Navegación -->
        <div class="nav-tabs">
            <div class="nav-tab active" onclick="showTab('dashboard')">📊 Dashboard</div>
            <div class="nav-tab" onclick="showTab('individual')">🏆 Individual</div>
            <div class="nav-tab" onclick="showTab('equipos')">👥 Equipos</div>
            <div class="nav-tab" onclick="showTab('game')">🎮 Jugar</div>
            <div class="nav-tab" onclick="showTab('admin')">🔐 Admin</div>
        </div>
        
        <!-- Dashboard General -->
        <div id="dashboard" class="tab-content active">
            <h1>🏥 Dashboard General</h1>
            <p class="subtitle">COMPETENCIA INDIVIDUAL Y POR EQUIPOS</p>
            
            <!-- Estadísticas Generales -->
            <div class="dashboard-section">
                <h2>📈 Estadísticas Generales</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalJugadores">-</div>
                        <div class="stat-label">Total Participantes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="promedioScore">-</div>
                        <div class="stat-label">Puntaje Promedio</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="nivelMaximo">-</div>
                        <div class="stat-label">Nivel Máximo Alcanzado</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="jugadoresHoy">-</div>
                        <div class="stat-label">Participantes Hoy</div>
                    </div>
                </div>
            </div>
            
            <!-- Ranking por Equipos -->
            <div class="dashboard-section">
                <h2>🥇 Ranking de Equipos</h2>
                <div class="team-rankings" id="teamRankings">
                    <div class="loading">Cargando estadísticas de equipos...</div>
                </div>
            </div>
            
            <!-- Feed en Vivo -->
            <div class="dashboard-section">
                <h2>🎮 Actividad Reciente</h2>
                <div class="live-feed" id="liveFeed">
                    <div class="loading">Cargando actividad reciente...</div>
                </div>
            </div>
        </div>
        
        <!-- Ranking Individual -->
        <div id="individual" class="tab-content">
            <h1>🏆 Ranking Individual</h1>
            <p class="subtitle">MEJORES PARTICIPANTES</p>
            
            <!-- Top 20 Individual -->
            <div class="ranking-section">
                <h2 class="ranking-title">🏅 Top 20 Individual</h2>
                <div class="top-players" id="topIndividual">
                    <div class="loading">Cargando ranking individual...</div>
                </div>
            </div>
        </div>
        
        <!-- Ranking por Equipos -->
        <div id="equipos" class="tab-content">
            <h1>👥 Competencia por Equipos</h1>
            <p class="subtitle">RANKING DETALLADO POR GRUPO</p>
            
            <!-- Estadísticas de Equipos -->
            <div class="dashboard-section">
                <h2>📊 Estadísticas por Equipo</h2>
                <div class="team-rankings" id="detailedTeamStats">
                    <div class="loading">Cargando estadísticas detalladas...</div>
                </div>
            </div>
        </div>
        
        <!-- Panel de Administración -->
        <div id="admin" class="tab-content">
            <h1>🔐 Panel de Administración</h1>
            <p class="subtitle">ACCESO RESTRINGIDO</p>
            
            <div class="admin-panel">
                <h2>🔒 Acceso Privado</h2>
                <p>Ingresa la contraseña para ver los datos de los participantes:</p>
                <input type="password" id="adminPassword" class="admin-password" placeholder="Contraseña de administrador">
                <br>
                <button class="btn" onclick="verifyAdmin()">Acceder</button>
                
                <div id="adminData" class="admin-data" style="display: none;">
                    <h3>📋 Registro Completo de Participantes</h3>
                    <button class="btn" onclick="exportAdminData()">📥 Descargar Excel</button>
                    <button class="btn btn-danger" onclick="clearAllData()">🗑️ Limpiar Datos</button>
                    
                    <div id="adminTable" style="margin-top: 20px;">
                        <!-- Tabla de admin se genera aquí -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Pantalla de Juego -->
        <div id="game" class="tab-content">
            <!-- Pantalla de inicio -->
            <div id="startScreen">
                <h1>¿Quién quiere ser cardiólogo?</h1>
                <p class="subtitle">COMPETENCIA INDIVIDUAL Y POR EQUIPOS</p>
                
                <div class="form-group">
                    <label for="playerName">Nombre y apellido:</label>
                    <input type="text" id="playerName" placeholder="Dr. Juan Pérez López" required>
                </div>
                
                <div class="form-group">
                    <label for="playerId">Cédula de identidad (sin dígito verificador):</label>
                    <input type="text" id="playerId" placeholder="1234567" required>
                </div>
                
                <div class="form-group">
                    <label for="playerTeam">Grupo del foro:</label>
                    <select id="playerTeam" required>
                        <option value="">Selecciona tu grupo</option>
                        <option value="A">Grupo A</option>
                        <option value="B">Grupo B</option>
                        <option value="C">Grupo C</option>
                    </select>
                </div>
                
                <div class="privacy-note">
                    🏆 <strong>Competencia:</strong> Participás tanto en el ranking individual como en el de tu equipo. Tus datos personales son privados, solo se muestra tu nombre en los rankings.
                </div>
                
                <div id="intentosMessage" style="display: none; color: #f59e0b; margin: 20px 0; font-weight: bold;"></div>
                
                <button class="btn" onclick="startGame()">COMENZAR COMPETENCIA</button>
            </div>
            
            <!-- Pantalla de juego -->
            <div id="gameScreen">
                <div class="game-header">
                    <div class="player-info">
                        <div>Participante: <span id="displayName"></span></div>
                        <div class="player-team" id="displayTeam"></div>
                        <div class="lives">
                            Vidas: 
                            <span class="heart" id="heart1">💙</span>
                            <span class="heart" id="heart2">💙</span>
                            <span class="heart" id="heart3">💙</span>
                        </div>
                    </div>
                    
                    <div class="game-stats">
                        <div>Nivel: <span id="currentLevelDisplay">1</span>/30</div>
                        <div>Puntaje: <span id="score">0</span></div>
                        <div class="timer-container">
                            <div class="timer" id="timer">30</div>
                        </div>
                    </div>
                    
                    <div class="comodines">
                        <button class="comodin" id="comodin5050" onclick="use5050()">🎯 50/50</button>
                        <button class="comodin" id="comodinChange" onclick="changeQuestion()">🔄 Cambiar</button>
                    </div>
                </div>
                
                <!-- Pantalla de nivel intermedia -->
                <div id="levelScreen">
                    <div class="level-title">NIVEL <span id="levelNumber"></span></div>
                    <div class="level-description" id="levelDescription"></div>
                    <button class="btn" onclick="startLevel()">COMENZAR NIVEL</button>
                </div>
                
                <div class="question-container" id="mainQuestionContainer" style="display: none;">
                    <div class="question" id="questionText"></div>
                    <div class="options" id="optionsContainer"></div>
                </div>
                
                <button class="btn" id="nextButton" style="display: none;" onclick="nextQuestion()">SIGUIENTE PREGUNTA</button>
            </div>
            
            <!-- Pantalla de resultados -->
            <div id="resultsScreen">
                <h1>¡Competencia Terminada!</h1>
                <div class="final-score">Puntaje Final: <span id="finalScore">0</span></div>
                <div class="level-name" id="levelName"></div>
                <div>Nivel máximo alcanzado: <span id="maxLevel">1</span>/30</div>
                
                <!-- Descripción humorística del nivel -->
                <div class="horoscope-section">
                    <h3 class="horoscope-title">🔍 Diagnóstico de nivel alcanzado</h3>
                    <div class="horoscope-text" id="levelHoroscope"></div>
                </div>
                
                <button class="btn" id="retryButton" onclick="retryGame()">🔄 REINTENTAR</button>
                <button class="btn" onclick="newGame()">👤 NUEVO PARTICIPANTE</button>
                <button class="btn" onclick="showTab('dashboard')">📊 VER DASHBOARD</button>
            </div>
        </div>
    </div>
    
    <script>
        // Configuración Firebase - TUS CREDENCIALES REALES
        const firebaseConfig = {
            apiKey: "AIzaSyAF1UK57tg4jK856RSU7Qcr1MT8QEeY4-o",
            authDomain: "cardiologia-game-uy.firebaseapp.com",
            databaseURL: "https://cardiologia-game-uy-default-rtdb.firebaseio.com",
            projectId: "cardiologia-game-uy",
            storageBucket: "cardiologia-game-uy.firebasestorage.app",
            messagingSenderId: "950754238661",
            appId: "1:950754238661:web:3df1bc9c9089f3308410ac",
            measurementId: "G-R6SPME7MHK"
        };
        
        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // Variables globales
        let currentPlayer = { name: '', id: '', team: '' };
        let currentLevel = 1;
        let score = 0;
        let lives = 3;
        let maxLevelReached = 1;
        let currentQuestion = null;
        let answeredQuestions = new Set();
        let timeLeft = 30;
        let timerInterval = null;
        let comodines = { fifty: true, change: true };
        let shuffledOptions = [];
        let eliminated5050 = false;
        let playerAttempts = 0;
        let isAdminAuthenticated = false;
        const ADMIN_PASSWORD = "cardio2025admin";
        
        // Banco de preguntas (mantenemos las 60 originales, después las reemplazarás con 120)
        const questionBank = [
            {"id": "ic_001", "level": 1, "question": "¿Cuál es el síntoma más específico de insuficiencia cardíaca?", "options": [{"text": "Disnea de esfuerzo", "correct": false}, {"text": "Ortopnea", "correct": true}, {"text": "Edemas en miembros inferiores", "correct": false}, {"text": "Fatiga", "correct": false}]},
            {"id": "ic_002", "level": 1, "question": "¿Qué fracción de eyección define la insuficiencia cardíaca con función reducida (ICFEr)?", "options": [{"text": "<50%", "correct": false}, {"text": "<40%", "correct": true}, {"text": "<35%", "correct": false}, {"text": "<30%", "correct": false}]},
            {"id": "ic_003", "level": 2, "question": "¿Qué biomarcador es más específico para diagnóstico de falla cardíaca aguda?", "options": [{"text": "Troponina", "correct": false}, {"text": "Péptido natriurético tipo B (BNP)", "correct": true}, {"text": "Creatinina", "correct": false}, {"text": "Procalcitonina", "correct": false}]},
            {"id": "ic_004", "level": 2, "question": "En pacientes con ICFEr, ¿qué clase de fármaco ha demostrado reducir mortalidad en todos los estudios?", "options": [{"text": "Diuréticos de asa", "correct": false}, {"text": "Betabloqueadores", "correct": true}, {"text": "Digoxina", "correct": false}, {"text": "Antagonistas del calcio", "correct": false}]},
            {"id": "ic_005", "level": 3, "question": "¿Qué parámetro ecocardiográfico es más útil para evaluar presión de llenado ventricular izquierdo?", "options": [{"text": "Fracción de eyección", "correct": false}, {"text": "Relación E/e'", "correct": true}, {"text": "Volumen auricular izquierdo", "correct": false}, {"text": "TAPSE", "correct": false}]},
            {"id": "ic_006", "level": 3, "question": "En insuficiencia cardíaca descompensada, ¿qué signo físico es predictor de mal pronóstico?", "options": [{"text": "Hipotensión ortostática", "correct": false}, {"text": "Tercer ruido cardíaco (S3)", "correct": true}, {"text": "Soplo sistólico", "correct": false}, {"text": "Pulso irregular", "correct": false}]},
            {"id": "ic_007", "level": 4, "question": "¿Qué mecanismo explica la mejoría con sacubitril/valsartán vs. enalapril en PARADIGM-HF?", "options": [{"text": "Bloqueo dual del SRA y neprilisina", "correct": true}, {"text": "Supresión de aldosterona", "correct": false}, {"text": "Vasodilatación coronaria", "correct": false}, {"text": "Reducción de poscarga", "correct": false}]},
            {"id": "ic_008", "level": 4, "question": "En pacientes con ICFEr y fibrilación auricular, ¿qué estrategia tiene mejor evidencia de reducir hospitalizaciones?", "options": [{"text": "Control estricto de frecuencia", "correct": false}, {"text": "Ablación de FA", "correct": true}, {"text": "Terapia antitrombótica", "correct": false}, {"text": "Cardioversión eléctrica", "correct": false}]},
            {"id": "ic_009", "level": 5, "question": "¿Qué parámetro hemodinámico invasivo define mejor la precarga ventricular izquierda?", "options": [{"text": "Presión arterial media", "correct": false}, {"text": "Presión capilar pulmonar", "correct": true}, {"text": "Gasto cardíaco", "correct": false}, {"text": "Resistencia vascular sistémica", "correct": false}]},
            {"id": "ic_010", "level": 5, "question": "En síndrome cardiorrenal tipo 1, ¿qué intervención es más efectiva para preservar función renal?", "options": [{"text": "Suspensión de diuréticos", "correct": false}, {"text": "Terapia de ultrafiltración", "correct": false}, {"text": "Optimización de volemia guiada por presión venosa", "correct": true}, {"text": "Aumento de dosis de IECA", "correct": false}]},
            {"id": "ic_011", "level": 6, "question": "¿Qué hallazgo en resonancia cardíaca es diagnóstico de amiloidosis cardíaca?", "options": [{"text": "Realce subendocárdico", "correct": false}, {"text": "Realce transmural", "correct": false}, {"text": "Realce global subepicárdico", "correct": true}, {"text": "Defecto de perfusión reversible", "correct": false}]},
            {"id": "ic_012", "level": 6, "question": "En pacientes con miocardiopatía hipertrófica e IC refractaria, ¿qué tratamiento tiene mejor evidencia?", "options": [{"text": "Alcohol septal", "correct": false}, {"text": "Micetomía quirúrgica", "correct": true}, {"text": "Terapia de resincronización", "correct": false}, {"text": "Bloqueadores de canales de calcio", "correct": false}]},
            {"id": "ic_013", "level": 7, "question": "¿Qué gen es más frecuentemente asociado a miocardiopatía dilatada familiar?", "options": [{"text": "MYH7", "correct": false}, {"text": "TTN", "correct": true}, {"text": "LMNA", "correct": false}, {"text": "PKP2", "correct": false}]},
            {"id": "ic_014", "level": 7, "question": "En IC con FEVI 30% y bloqueo de rama izquierda, ¿qué dispositivo reduce mortalidad súbita?", "options": [{"text": "DAI convencional", "correct": true}, {"text": "DAI subcutáneo", "correct": false}, {"text": "Marca pasos biventricular", "correct": false}, {"text": "Monitor implantable", "correct": false}]},
            {"id": "ic_015", "level": 8, "question": "¿Qué parámetro de strain longitudinal global tiene valor pronóstico independiente en IC?", "options": [{"text": "Strain longitudinal > -15%", "correct": false}, {"text": "Strain longitudinal < -12%", "correct": false}, {"text": "Strain longitudinal < -8%", "correct": true}, {"text": "Strain radial > 35%", "correct": false}]},
            {"id": "ic_016", "level": 8, "question": "En taquimiocardiopatía, ¿qué intervalo de recuperación de FEVI es característico?", "options": [{"text": "1-2 semanas", "correct": false}, {"text": "2-4 semanas", "correct": true}, {"text": "4-6 meses", "correct": false}, {"text": "Sin recuperación", "correct": false}]},
            {"id": "ic_017", "level": 9, "question": "¿Qué fármaco ha demostrado reducir eventos en IC con FE preservada?", "options": [{"text": "Espironolactona", "correct": false}, {"text": "Sacubitril/valsartán", "correct": false}, {"text": "Empagliflozina", "correct": true}, {"text": "Carvedilol", "correct": false}]},
            {"id": "ic_018", "level": 9, "question": "En shock cardiogénico refractario, ¿qué dispositivo de asistencia tiene menor riesgo de hemólisis?", "options": [{"text": "IABP", "correct": false}, {"text": "Impella CP", "correct": false}, {"text": "ECMO venoarterial", "correct": false}, {"text": "CentriMag", "correct": true}]},
            {"id": "ic_019", "level": 10, "question": "¿Qué patrón de realce en RMN es típico de sarcoidosis cardíaca?", "options": [{"text": "Realce epicárdico", "correct": false}, {"text": "Realce mesocárdico", "correct": false}, {"text": "Realce parcheado no isquémico", "correct": true}, {"text": "Realce transmural", "correct": false}]},
            {"id": "ic_020", "level": 10, "question": "En miocarditis fulminante, ¿qué hallazgo histológico predice recuperación?", "options": [{"text": "Infiltrado linfocitario", "correct": false}, {"text": "Necrosis miocítica focal", "correct": false}, {"text": "Edema intersticial", "correct": true}, {"text": "Fibrosis sustituyente", "correct": false}]},
            {"id": "ic_021", "level": 11, "question": "¿Qué terapia avanzada está indicada en IC con FEVI 15% y contraindicación absoluta para trasplante?", "options": [{"text": "Terapia de resincronización", "correct": false}, {"text": "Oxigenación hiperbárica", "correct": false}, {"text": "Asistencia ventricular izquierda", "correct": true}, {"text": "Denervación renal", "correct": false}]},
            {"id": "ic_022", "level": 11, "question": "En amiloidosis por transtiretina, ¿qué fármaco estabiliza el tetrámero proteico?", "options": [{"text": "Diflunisal", "correct": false}, {"text": "Tafamidis", "correct": true}, {"text": "Patisiran", "correct": false}, {"text": "Inotersen", "correct": false}]},
            {"id": "ic_023", "level": 12, "question": "¿Qué parámetro en cateterismo derecho define mejor la reserva contráctil?", "options": [{"text": "Presión auricular derecha", "correct": false}, {"text": "Relación dP/dt máxima", "correct": true}, {"text": "Resistencia pulmonar", "correct": false}, {"text": "Gasto cardíaco", "correct": false}]},
            {"id": "ic_024", "level": 12, "question": "En disfunción primaria de injerto postrasplante, ¿qué estrategia tiene mayor soporte?", "options": [{"text": "Ecmo venoarterial", "correct": true}, {"text": "Balón intraórtico", "correct": false}, {"text": "Inotrópicos en altas dosis", "correct": false}, {"text": "Oxigenación por membrana", "correct": false}]},
            {"id": "ic_025", "level": 13, "question": "¿Qué técnica de imagen cuantifica mejor fibrosis miocárdica difusa?", "options": [{"text": "Ecocardiografía con contraste", "correct": false}, {"text": "Tomografía por emisión de positrones", "correct": false}, {"text": "Resonancia magnética con T1 mapping", "correct": true}, {"text": "TC coronario", "correct": false}]},
            {"id": "ic_026", "level": 13, "question": "En pacientes con DAI e infección del dispositivo, ¿cuál es el manejo óptimo?", "options": [{"text": "Antibióticos prolongados", "correct": false}, {"text": "Extracción completa del sistema", "correct": true}, {"text": "Desbridamiento quirúrgico", "correct": false}, {"text": "Reemplazo parcial", "correct": false}]},
            {"id": "ic_027", "level": 14, "question": "¿Qué fenotipo de IC responde mejor a vericiguat según el estudio VICTORIA?", "options": [{"text": "IC con FEVI <25%", "correct": false}, {"text": "IC con NT-proBNP <8000", "correct": false}, {"text": "IC recientemente descompensada", "correct": true}, {"text": "IC con fibrilación auricular", "correct": false}]},
            {"id": "ic_028", "level": 14, "question": "En enfermedad de Chagas con IC, ¿qué arritmia es marcador de mal pronóstico?", "options": [{"text": "Taquicardia ventricular sostenida", "correct": true}, {"text": "Bloqueo AV de primer grado", "correct": false}, {"text": "Extrasístoles ventriculares", "correct": false}, {"text": "Fibrilación auricular", "correct": false}]},
            {"id": "ic_029", "level": 15, "question": "¿Qué patrón hemodinámico define la falla ventricular derecha aislada?", "options": [{"text": "PCP >15 mmHg con IC bajo", "correct": false}, {"text": "PAD >10 mmHg con IC normal", "correct": false}, {"text": "PAD >15 mmHg con PCP normal", "correct": true}, {"text": "RVP >3 UW", "correct": false}]},
            {"id": "ic_030", "level": 15, "question": "En miocardiopatía periparto, ¿qué factor predice recuperación completa?", "options": [{"text": "FEVI inicial >30%", "correct": false}, {"text": "Troponina elevada", "correct": false}, {"text": "FEVI >50% a los 6 meses", "correct": true}, {"text": "Edad materna <30 años", "correct": false}]},
            {"id": "ic_031", "level": 16, "question": "¿Qué técnica permite evaluación directa de presión intracardiaca sin cateterismo?", "options": [{"text": "Ecocardiografía 4D", "correct": false}, {"text": "Monitor CardioMEMS", "correct": true}, {"text": "Resonancia con contraste", "correct": false}, {"text": "SPECT de perfusión", "correct": false}]},
            {"id": "ic_032", "level": 16, "question": "En terapia con inhibidores de SGLT2, ¿qué efecto explica la reducción de descompensaciones?", "options": [{"text": "Reducción de glucosa", "correct": false}, {"text": "Disminución de volumen intravascular", "correct": true}, {"text": "Aumento de contractilidad", "correct": false}, {"text": "Bloqueo neurohormonal", "correct": false}]},
            {"id": "ic_033", "level": 17, "question": "¿Qué valor de strain auricular izquierdo predice FA en IC?", "options": [{"text": "<15%", "correct": false}, {"text": "<23%", "correct": true}, {"text": "<30%", "correct": false}, {"text": "<35%", "correct": false}]},
            {"id": "ic_034", "level": 17, "question": "En síndrome de takotsubo, ¿qué factor desencadenante es más frecuente?", "options": [{"text": "Ejercicio intenso", "correct": false}, {"text": "Estrés emocional agudo", "correct": true}, {"text": "Hipertensión severa", "correct": false}, {"text": "Anestesia general", "correct": false}]},
            {"id": "ic_035", "level": 18, "question": "¿Qué gen mutado requiere DAI primario en miocardiopatía dilatada?", "options": [{"text": "TTN truncante", "correct": false}, {"text": "LMNA", "correct": true}, {"text": "MYBPC3", "correct": false}, {"text": "DSP", "correct": false}]},
            {"id": "ic_036", "level": 18, "question": "En pacientes con DAI y tormenta eléctrica, ¿qué fármaco es primera línea?", "options": [{"text": "Amiodarona IV", "correct": true}, {"text": "Lidocaína", "correct": false}, {"text": "Propranolol", "correct": false}, {"text": "Verapamilo", "correct": false}]},
            {"id": "ic_037", "level": 19, "question": "¿Qué biomarcador predice respuesta a hierro IV en IC?", "options": [{"text": "Ferritina <100", "correct": true}, {"text": "Transferrina baja", "correct": false}, {"text": "Hematocrito <35%", "correct": false}, {"text": "Hepcidina elevada", "correct": false}]},
            {"id": "ic_038", "level": 19, "question": "En IC terminal, ¿qué escala valida mejor pronóstico a 6 meses?", "options": [{"text": "NYHA", "correct": false}, {"text": "MAGGIC", "correct": false}, {"text": "Seattle Heart Failure Model", "correct": false}, {"text": "Puntuación de riesgo PAL-HF", "correct": true}]},
            {"id": "ic_039", "level": 20, "question": "¿Qué característica define la miocardiopatía arritmogénica biventricular?", "options": [{"text": "Afectación predominante de VI", "correct": false}, {"text": "Sustitución fibroadiposa en ambos ventrículos", "correct": true}, {"text": "Dilatación aislada de VD", "correct": false}, {"text": "Asociación con mutación MYH7", "correct": false}]},
            {"id": "ic_040", "level": 20, "question": "En asistencia ventricular continua, ¿qué parámetro indica mal acoplamiento bomba-corazón?", "options": [{"text": "Flujo pulsátil <3 L/min", "correct": false}, {"text": "Apertura intermitente de válvula aórtica", "correct": true}, {"text": "PIA >15 mmHg", "correct": false}, {"text": "Diferencia de pulsos >20 mmHg", "correct": false}]},
            {"id": "ic_041", "level": 21, "question": "¿Qué técnica quirúrgica mejora geometría ventricular en cardiomiopatía isquémica?", "options": [{"text": "Bypass aorto-coronario", "correct": false}, {"text": "Anuloplastia mitral", "correct": false}, {"text": "Procedimiento de Dor", "correct": true}, {"text": "Ablación endocárdica", "correct": false}]},
            {"id": "ic_042", "level": 21, "question": "En enfermedad de Fabry, ¿qué hallazgo ecocardiográfico es patognomónico?", "options": [{"text": "Engrosamiento concéntrico", "correct": false}, {"text": "Banda ecogénica endocárdica", "correct": true}, {"text": "Aneurisma apical", "correct": false}, {"text": "Disfunción diastólica grado III", "correct": false}]},
            {"id": "ic_043", "level": 22, "question": "¿Qué parámetro en PET cardíaco diagnostica inflamación activa en sarcoidosis?", "options": [{"text": "Captación heterogénea de FDG", "correct": true}, {"text": "Defecto de perfusión reversible", "correct": false}, {"text": "Captación ósea asociada", "correct": false}, {"text": "SUV max >10", "correct": false}]},
            {"id": "ic_044", "level": 22, "question": "En hipertensión pulmonar postcapilar, ¿qué fármaco tiene indicación específica?", "options": [{"text": "Bosentán", "correct": false}, {"text": "Riociguat", "correct": false}, {"text": "Selexipag", "correct": false}, {"text": "Ninguno actualmente", "correct": true}]},
            {"id": "ic_045", "level": 23, "question": "¿Qué cambio genético requiere screening familiar en miocardiopatía no compactada?", "options": [{"text": "Mutación MYH7", "correct": false}, {"text": "Mutación TTN", "correct": false}, {"text": "Mutación LMNA", "correct": false}, {"text": "Mutación MYBPC3", "correct": true}]},
            {"id": "ic_046", "level": 23, "question": "En disfunción diastólica avanzada, ¿qué maniobra mejora llenado ventricular?", "options": [{"text": "Reducción de frecuencia cardíaca", "correct": true}, {"text": "Aumento de precarga", "correct": false}, {"text": "Vasodilatadores arteriales", "correct": false}, {"text": "Inotrópicos positivos", "correct": false}]},
            {"id": "ic_047", "level": 24, "question": "¿Qué patrón en cateterismo define perfusión coronaria no obstructiva?", "options": [{"text": "FFR >0.80", "correct": false}, {"text": "IMR >25", "correct": true}, {"text": "CFR <2.0", "correct": false}, {"text": "RVR >1.0", "correct": false}]},
            {"id": "ic_048", "level": 24, "question": "En trasplante cardíaco, ¿qué valor de donante/recipiente es crítico para sobrevida?", "options": [{"text": "Diferencia de peso >20%", "correct": false}, {"text": "Diferencia de talla >10 cm", "correct": false}, {"text": "Proporción de masa ventricular", "correct": true}, {"text": "Edad donante >45 años", "correct": false}]},
            {"id": "ic_049", "level": 25, "question": "¿Qué terapia génica ha mostrado resultados prometedores en IC con FE reducida?", "options": [{"text": "Terapia con SERCA2a", "correct": true}, {"text": "Suplencia de distrofina", "correct": false}, {"text": "Modulación de titina", "correct": false}, {"text": "Inhibición de fosfolamban", "correct": false}]},
            {"id": "ic_050", "level": 25, "question": "En shock cardiogénico por IAM, ¿qué estrategia reduce mortalidad a 30 días?", "options": [{"text": "Revascularización completa inmediata", "correct": true}, {"text": "Soporte inotrópico máximo", "correct": false}, {"text": "Contrapulsación intraórtica", "correct": false}, {"text": "ECMO precoz", "correct": false}]},
            {"id": "ic_051", "level": 26, "question": "¿Qué parámetro de resonancia cuantifica hierro miocárdico en hemocromatosis?", "options": [{"text": "T1 nativo", "correct": false}, {"text": "T2*", "correct": true}, {"text": "Realce tardío", "correct": false}, {"text": "T2 mapping", "correct": false}]},
            {"id": "ic_052", "level": 26, "question": "En miocardiopatía diabética, ¿qué mecanismo explica la disfunción diastólica precoz?", "options": [{"text": "Depósito de colágeno", "correct": false}, {"text": "Alteración metabolismo de calcio", "correct": false}, {"text": "Glicación avanzada de proteínas", "correct": true}, {"text": "Disfunción mitocondrial", "correct": false}]},
            {"id": "ic_053", "level": 27, "question": "¿Qué técnica permite biopsia miocárdica guiada por electroanatomía?", "options": [{"text": "Eco intracardíaco", "correct": false}, {"text": "Navegación electromagnética", "correct": true}, {"text": "Fluoroscopia 3D", "correct": false}, {"text": "PET/CT fusionado", "correct": false}]},
            {"id": "ic_054", "level": 27, "question": "En IC con bloqueo completo de rama izquierda, ¿qué parámetro ecográfico predice respuesta a TRC?", "options": [{"text": "Disfunción moderada de VD", "correct": false}, {"text": "Asincronía septal tardía", "correct": false}, {"text": "Retraso septal-lateral >65 ms", "correct": true}, {"text": "Strain radial <15%", "correct": false}]},
            {"id": "ic_055", "level": 28, "question": "¿Qué valor de presión de distensión arterial predice inestabilidad con vasodilatadores?", "options": [{"text": "PAD <65 mmHg", "correct": true}, {"text": "PAS <100 mmHg", "correct": false}, {"text": "PP <40 mmHg", "correct": false}, {"text": "PAM <70 mmHg", "correct": false}]},
            {"id": "ic_056", "level": 28, "question": "En recuperación de función ventricular, ¿qué fármaco debe continuarse indefinidamente?", "options": [{"text": "Betabloqueadores", "correct": true}, {"text": "IECA", "correct": false}, {"text": "Antagonistas de aldosterona", "correct": false}, {"text": "Diuréticos", "correct": false}]},
            {"id": "ic_057", "level": 29, "question": "¿Qué proteína plasmática es biomarcador de estrés de retículo endoplásmico en IC?", "options": [{"text": "Galectina-3", "correct": false}, {"text": "ST2 soluble", "correct": false}, {"text": "GDF-15", "correct": false}, {"text": "GRP78", "correct": true}]},
            {"id": "ic_058", "level": 29, "question": "En terapia celular para IC, ¿qué tipo celular tiene mayor potencial regenerativo?", "options": [{"text": "Células mononucleadas de médula ósea", "correct": false}, {"text": "Cardiomiocitos derivados de iPSC", "correct": true}, {"text": "Células mesenquimales", "correct": false}, {"text": "Células CD34+", "correct": false}]},
            {"id": "ic_059", "level": 30, "question": "¿Qué sistema de neuromodulación reduce actividad simpática renal en IC refractaria?", "options": [{"text": "Estimulación vagal", "correct": false}, {"text": "Barorreflex activation therapy", "correct": false}, {"text": "Ablación simpática renal", "correct": true}, {"text": "Modulación de médula espinal", "correct": false}]},
            {"id": "ic_060", "level": 30, "question": "En asistencia ventricular total artificial, ¿qué dispositivo tiene mayor durabilidad?", "options": [{"text": "HeartMate 3", "correct": true}, {"text": "Novacor", "correct": false}, {"text": "SynCardia", "correct": false}, {"text": "Jarvik 2000", "correct": false}]}
        ];
        
        // Títulos por nivel (30 niveles completos)
        const levelTitles = {
            1: "El que cura todo con agua con sal",
            2: "El que dice 'para el corazón lo mejor es el ajo'",
            3: "El botija que confunde un estetoscopio con un cargador",
            4: "El que cree que la presión se mide con el dedo en la muñeca",
            5: "El interno que ausculta la espalda buscando el ritmo sinusal",
            6: "El que receta ibuprofeno para el dolor precordial 'por las dudas'",
            7: "El que cree que el ecocardio se hace con gel y buena onda",
            8: "Aquel que convierte un dolor de pecho en un diagnóstico de 15 líneas",
            9: "El que interpreta la radiografía como si fuera una constelación",
            10: "El que escucha un soplo y pide en secreto que no le pregunten de qué es",
            11: "El que prescribe según lo que leyó en un grupo de WhatsApp",
            12: "El que dice 'probemos con carvedilol a ver qué pasa'",
            13: "El que escucha un R3 y lo anota aunque no esté seguro si no eran gases",
            14: "El que ya no dice 'tiene algo de falla' habla de IC con elementos congestivos",
            15: "El que pide BNP con cara seria aunque no sepa bien cómo interpretarlo",
            16: "El que empieza a citar artículos y ya no solo frases de la clínica médica",
            17: "El que entiende que no todo lo que se hincha es por 'retención'",
            18: "El que ya no ve todo como blanco y negro sino como 4 cuadrantes de Forrester",
            19: "El que sabe que los gliflozins no son una banda de rock noruega",
            20: "El que dejó de hablar de la FEVI, y mete strain y remodelado",
            21: "El que se emociona con un TAPSE >20 como si fuera una buena noticia familiar",
            22: "El que empieza a explicar la IC con analogías elegantes",
            23: "El que discute la clasificación universal de infarto como si hubiera estado en la mesa donde la armaron",
            24: "El que ajusta dosis de beta bloqueantes como quien afina una guitarra",
            25: "El que lee el ECG como si fuera partitura y encuentra la música oculta",
            26: "El que distingue entre empeoramiento clínico y progresión insidiosa",
            27: "El que recomienda rehabilitación cardiaca y se emociona al decir 'multidisciplinario'",
            28: "El que se indigna si no hay seguimiento post-alta",
            29: "El que guía al Heart Team con calma y convicción, como pastor clínico",
            30: "Oráculo cardiológico Manuel Quintela, de punta y al medio"
        };
        
        // Descripciones humorísticas (30 horóscopos únicos)
        const levelDescriptions = {
            1: "Felicitaciones, estás en el nivel básico de la medicina casera. Tu principal herramienta terapéutica es el agua con sal, que según vos cura desde un resfrío hasta una arritmia ventricular. En el fondo, tenés fe ciega en los remedios de la abuela.",
            2: "Has avanzado al nivel de curandero barrial. Tu arsenal se expandió: ajo para la presión, manzanilla para los nervios y cebolla para todo lo demás. Todavía creés que el limón puede destapar arterias.",
            3: "Sos ese interno tierno que todos quieren proteger. Confundís cables con instrumental médico y tenés esa inocencia que hace que los pacientes te sonrían con ternura. Al menos ya no intentás escuchar el corazón por la espalda.",
            4: "Nivel estudiante avanzado: ya sabés que el pulso no se toma con el dedo gordo, pero seguís buscando el punto exacto en la muñeca como si fuera un tesoro escondido. Los pacientes te tienen paciencia.",
            5: "Sos el que ausculta con cara seria pero en realidad está rezando para que no le pregunten qué escuchaste. Al menos ya diferenciás entre un pulmón y un corazón en la radiografía.",
            6: "Nivel 'médico precavido': para cualquier dolor en el pecho recetás ibuprofeno 'por las dudas' y mandás al paciente a caminar. Tu filosofía es 'si se mejora solo, mejor'.",
            7: "Ya entendiste que el ecocardiograma no es solo gel y buena onda, pero seguís viendo las imágenes como si fueran nubes en el cielo. Al menos preguntás cosas que suenan técnicas.",
            8: "Has desarrollado el talento especial de convertir un simple dolor de pecho en un diagnóstico diferencial de 15 patologías. Tu especialidad es encontrar zebras donde hay caballos.",
            9: "Interpretás las radiografías como constelaciones cósmicas. Ves patrones donde no los hay, pero al menos ya no confundís una costilla con el corazón. Progreso lento pero seguro.",
            10: "Escuchás soplos por todos lados, aunque no estés muy seguro de qué tipo son. Tu estrategia es anotar 'soplo sistólico grado II/VI' y que alguien más se haga cargo.",
            11: "Tu conocimiento médico proviene principalmente de grupos de WhatsApp de médicos. Citás papers que nunca leíste completos y usás términos en inglés para sonar más profesional.",
            12: "Entraste en la era del carvedilol experimental. Tu frase favorita es 'probemos con carvedilol a ver qué pasa'. Al menos ya sabés que es un betabloqueante.",
            13: "Desarrollaste el oído mágico para escuchar R3, aunque la mitad de las veces son gases intestinales. Pero lo anotás en la historia igual, por si acaso tenías razón.",
            14: "Evolucionaste del 'tiene algo de falla' al sofisticado 'IC con elementos congestivos'. Tu vocabulario se está volviendo más elegante, aunque seguís sin estar muy seguro.",
            15: "Pedís BNP con cara de experto, aunque después googleás discretamente cómo interpretarlo. Al menos ya sabés que tiene que ver con el corazón y no con el riñón.",
            16: "Comenzaste a citar estudios reales: 'según PARADIGM-HF...' aunque solo leíste el abstract. Pero sonás convincente y eso es lo que importa en esta etapa.",
            17: "Ya entendiste que no todo lo que se hincha es 'retención'. Empezaste a usar términos como 'sobrecarga de volumen' y 'redistribución'. Tu evolución semántica es notable.",
            18: "Descubriste los cuadrantes de Forrester y ahora clasificás todo en húmedo-seco, frío-caliente. Es como el juego de la batalla naval pero con hemodinamia.",
            19: "Aprendiste que los gliflozinas no son una banda noruega de metal, sino que son medicamentos revolucionarios. Empezaste a recetar con más fundamento científico.",
            20: "Dejaste de hablar solo de FEVI. Ahora metés strain, remodelado y función diastólica. Tu jerga cardiológica se está volviendo respetable y casi comprensible.",
            21: "Te emocionás genuinamente cuando ves un TAPSE mayor a 20 mm, como si fuera una buena noticia familiar. Ya entendés que el ventrículo derecho también existe e importa.",
            22: "Desarrollaste el arte de explicar la IC con analogías elegantes: comparás el corazón con una bomba de agua, los vasos con mangueras. Tus pacientes te entienden y agradecen.",
            23: "Discutís la clasificación universal de infarto como si hubieras estado en la mesa donde la escribieron. Citás a Thygesen con la familiaridad de quien lo conoce personalmente.",
            24: "Ajustás dosis de betabloqueantes como un músico que afina su guitarra: con precisión, paciencia y sabiendo que cada pequeño cambio puede hacer una gran diferencia.",
            25: "Leés el ECG como si fuera una partitura musical y encontrás la melodía oculta en cada complejo QRS. Los ritmos cardíacos tienen música para vos.",
            26: "Distinguís entre empeoramiento clínico franco y progresión insidiosa silenciosa. Tu ojo clínico se afinó y podés detectar matices sutiles que antes te pasaban inadvertidos.",
            27: "Recomendás rehabilitación cardíaca y te emocionás al pronunciar 'abordaje multidisciplinario'. Entendiste que curar no es solo recetar pastillas.",
            28: "Te indignás genuinamente cuando no hay seguimiento post-alta adecuado. Sabés que el alta hospitalaria es solo el comienzo del verdadero tratamiento.",
            29: "Guiás al Heart Team con la calma y convicción de un pastor experimentado. Tu juicio clínico se volvió una brújula confiable para decisiones complejas.",
            30: "Llegaste al olimpo cardiológico uruguayo. Sos el oráculo del Hospital de Clínicas, de punta y al medio. Los residentes te consultan, los adjuntos te respetan, y los pacientes te bendicen."
        };
        
        // Inicialización
        window.addEventListener('load', function() {
            loadDashboard();
            setupFirebaseListeners();
            updateLivesDisplay();
            handleMissingLogos();
            console.log('App inicializada con Firebase - Competencia por equipos');
        });
        
        // Manejar logos faltantes
        function handleMissingLogos() {
            const logos = ['logo-ccu', 'logo-uac'];
            logos.forEach(logoId => {
                const img = document.getElementById(logoId);
                img.onerror = function() {
                    this.style.display = 'none';
                    this.nextElementSibling.style.display = 'none';
                };
            });
        }
        
        // Funciones de navegación
        function showTab(tabName) {
            // Ocultar todos los tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Ocultar todos los nav-tabs activos
            document.querySelectorAll('.nav-tab').forEach(navTab => {
                navTab.classList.remove('active');
            });
            
            // Mostrar tab seleccionado
            document.getElementById(tabName).classList.add('active');
            
            // Activar nav-tab correspondiente
            event.target.classList.add('active');
            
            // Cargar datos específicos según el tab
            switch(tabName) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'individual':
                    loadIndividualRanking();
                    break;
                case 'equipos':
                    loadTeamRankings();
                    break;
            }
        }
        
        // Funciones de administración
        function verifyAdmin() {
            const password = document.getElementById('adminPassword').value;
            if (password === ADMIN_PASSWORD) {
                isAdminAuthenticated = true;
                document.getElementById('adminData').style.display = 'block';
                loadAdminData();
            } else {
                alert('Contraseña incorrecta');
            }
        }
        
        async function loadAdminData() {
            try {
                const snapshot = await database.ref('resultados').once('value');
                const results = snapshot.val();
                
                if (results) {
                    const resultsArray = Object.values(results).sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
                    
                    let tableHTML = `
                        <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
                            <thead>
                                <tr style="background: rgba(59, 130, 246, 0.2);">
                                    <th style="padding: 12px; border: 1px solid rgba(59, 130, 246, 0.3);">Fecha/Hora</th>
                                    <th style="padding: 12px; border: 1px solid rgba(59, 130, 246, 0.3);">Nombre Completo</th>
                                    <th style="padding: 12px; border: 1px solid rgba(59, 130, 246, 0.3);">Cédula</th>
                                    <th style="padding: 12px; border: 1px solid rgba(59, 130, 246, 0.3);">Grupo</th>
                                    <th style="padding: 12px; border: 1px solid rgba(59, 130, 246, 0.3);">Puntaje</th>
                                    <th style="padding: 12px; border: 1px solid rgba(59, 130, 246, 0.3);">Nivel</th>
                                    <th style="padding: 12px; border: 1px solid rgba(59, 130, 246, 0.3);">Intento</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    resultsArray.forEach(result => {
                        tableHTML += `
                            <tr>
                                <td style="padding: 8px; border: 1px solid rgba(59, 130, 246, 0.2);">${result.fecha}</td>
                                <td style="padding: 8px; border: 1px solid rgba(59, 130, 246, 0.2);">${result.nombre}</td>
                                <td style="padding: 8px; border: 1px solid rgba(59, 130, 246, 0.2);">${result.cedula}</td>
                                <td style="padding: 8px; border: 1px solid rgba(59, 130, 246, 0.2);">${result.grupo}</td>
                                <td style="padding: 8px; border: 1px solid rgba(59, 130, 246, 0.2);">${result.puntaje}</td>
                                <td style="padding: 8px; border: 1px solid rgba(59, 130, 246, 0.2);">${result.nivel}</td>
                                <td style="padding: 8px; border: 1px solid rgba(59, 130, 246, 0.2);">${result.intento}</td>
                            </tr>
                        `;
                    });
                    
                    tableHTML += '</tbody></table>';
                    document.getElementById('adminTable').innerHTML = tableHTML;
                }
            } catch (error) {
                console.error('Error loading admin data:', error);
            }
        }
        
        function exportAdminData() {
            if (!isAdminAuthenticated) {
                alert('Acceso no autorizado');
                return;
            }
            
            database.ref('resultados').once('value').then(snapshot => {
                const results = snapshot.val();
                if (results) {
                    const resultsArray = Object.values(results);
                    
                    let csv = 'Fecha/Hora,Nombre Completo,Cédula,Grupo,Puntaje,Nivel Máximo,Título,Intento\n';
                    
                    resultsArray.forEach(result => {
                        csv += `"${result.fecha}","${result.nombre}","${result.cedula}","${result.grupo}",${result.puntaje},${result.nivel},"${result.titulo}",${result.intento}\n`;
                    });
                    
                    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = `competencia_cardiologia_${new Date().toISOString().split('T')[0]}.csv`;
                    link.click();
                }
            });
        }
        
        function clearAllData() {
            if (!isAdminAuthenticated) {
                alert('Acceso no autorizado');
                return;
            }
            
            if (confirm('¿Estás seguro de que quieres eliminar TODOS los datos? Esta acción no se puede deshacer.')) {
                database.ref('resultados').remove();
                database.ref('estadisticas').remove();
                alert('Todos los datos han sido eliminados');
                loadAdminData();
                loadDashboard();
            }
        }
        
        // Funciones Firebase
        function setupFirebaseListeners() {
            database.ref('resultados').on('value', (snapshot) => {
                updateDashboardStats();
                updateTeamRankings();
                updateLiveFeed();
            });
        }
        
        async function checkPlayerAttempts(cedula) {
            try {
                const snapshot = await database.ref('resultados').orderByChild('cedula').equalTo(cedula).once('value');
                const results = snapshot.val();
                return results ? Object.keys(results).length : 0;
            } catch (error) {
                console.error('Error checking attempts:', error);
                return 0;
            }
        }
        
        async function saveGameResult(result) {
            try {
                const resultId = database.ref('resultados').push().key;
                
                await database.ref('resultados/' + resultId).set({
                    ...result,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    id: resultId
                });
                
                updateGlobalStats();
                
                console.log('Resultado guardado en Firebase:', resultId);
                return resultId;
            } catch (error) {
                console.error('Error saving result:', error);
                throw error;
            }
        }
        
        async function updateGlobalStats() {
            try {
                const snapshot = await database.ref('resultados').once('value');
                const results = snapshot.val();
                
                if (results) {
                    const resultsArray = Object.values(results);
                    const totalPlayers = resultsArray.length;
                    const avgScore = resultsArray.reduce((sum, r) => sum + r.puntaje, 0) / totalPlayers;
                    const maxLevel = Math.max(...resultsArray.map(r => r.nivel));
                    
                    // Contar jugadores de hoy
                    const today = new Date().toDateString();
                    const playersToday = resultsArray.filter(r => {
                        const resultDate = new Date(r.timestamp || 0).toDateString();
                        return resultDate === today;
                    }).length;
                    
                    // Estadísticas por equipo
                    const teamStats = {
                        A: { players: 0, totalScore: 0, avgScore: 0, maxLevel: 0 },
                        B: { players: 0, totalScore: 0, avgScore: 0, maxLevel: 0 },
                        C: { players: 0, totalScore: 0, avgScore: 0, maxLevel: 0 }
                    };
                    
                    resultsArray.forEach(result => {
                        const team = result.grupo;
                        if (teamStats[team]) {
                            teamStats[team].players++;
                            teamStats[team].totalScore += result.puntaje;
                            teamStats[team].maxLevel = Math.max(teamStats[team].maxLevel, result.nivel);
                        }
                    });
                    
                    // Calcular promedios por equipo
                    Object.keys(teamStats).forEach(team => {
                        if (teamStats[team].players > 0) {
                            teamStats[team].avgScore = Math.round((teamStats[team].totalScore / teamStats[team].players) * 10) / 10;
                        }
                    });
                    
                    await database.ref('estadisticas').set({
                        totalJugadores: totalPlayers,
                        promedioScore: Math.round(avgScore * 10) / 10,
                        nivelMaximo: maxLevel,
                        jugadoresHoy: playersToday,
                        equipos: teamStats,
                        ultimaActualizacion: firebase.database.ServerValue.TIMESTAMP
                    });
                }
            } catch (error) {
                console.error('Error updating stats:', error);
            }
        }
        
        // Funciones Dashboard
        function loadDashboard() {
            updateDashboardStats();
            updateTeamRankings();
            updateLiveFeed();
        }
        
        async function updateDashboardStats() {
            try {
                const snapshot = await database.ref('estadisticas').once('value');
                const stats = snapshot.val();
                
                if (stats) {
                    document.getElementById('totalJugadores').textContent = stats.totalJugadores || 0;
                    document.getElementById('promedioScore').textContent = stats.promedioScore || 0;
                    document.getElementById('nivelMaximo').textContent = stats.nivelMaximo || 0;
                    document.getElementById('jugadoresHoy').textContent = stats.jugadoresHoy || 0;
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }
        
        async function updateTeamRankings() {
            try {
                const snapshot = await database.ref('estadisticas/equipos').once('value');
                const teamStats = snapshot.val();
                
                if (teamStats) {
                    const container = document.getElementById('teamRankings');
                    container.innerHTML = '';
                    
                    // Ordenar equipos por promedio
                    const sortedTeams = Object.entries(teamStats)
                        .sort(([,a], [,b]) => b.avgScore - a.avgScore);
                    
                    sortedTeams.forEach(([teamName, stats]) => {
                        const teamSection = document.createElement('div');
                        teamSection.className = `team-section team-${teamName.toLowerCase()}`;
                        
                        teamSection.innerHTML = `
                            <div class="team-header">
                                <div class="team-name">GRUPO ${teamName}</div>
                                <div class="team-stats">
                                    <span>👥 ${stats.players}</span>
                                    <span>🏆 ${stats.avgScore} pts</span>
                                    <span>📈 Nv.${stats.maxLevel}</span>
                                </div>
                            </div>
                        `;
                        
                        container.appendChild(teamSection);
                    });
                }
            } catch (error) {
                console.error('Error loading team rankings:', error);
            }
        }
        
        async function loadIndividualRanking() {
            try {
                const snapshot = await database.ref('resultados').orderByChild('puntaje').limitToLast(20).once('value');
                const results = snapshot.val();
                
                if (results) {
                    const resultsArray = Object.values(results).sort((a, b) => b.puntaje - a.puntaje);
                    
                    // Obtener mejor resultado por jugador (por cédula)
                    const uniqueResults = new Map();
                    resultsArray.forEach(result => {
                        const existing = uniqueResults.get(result.cedula);
                        if (!existing || result.puntaje > existing.puntaje) {
                            uniqueResults.set(result.cedula, result);
                        }
                    });
                    
                    const topResults = Array.from(uniqueResults.values())
                        .sort((a, b) => b.puntaje - a.puntaje)
                        .slice(0, 20);
                    
                    const container = document.getElementById('topIndividual');
                    container.innerHTML = '';
                    
                    topResults.forEach((result, index) => {
                        const playerRank = document.createElement('div');
                        playerRank.className = 'player-rank';
                        
                        if (index === 0) playerRank.classList.add('podium-1');
                        else if (index === 1) playerRank.classList.add('podium-2');
                        else if (index === 2) playerRank.classList.add('podium-3');
                        
                        playerRank.innerHTML = `
                            <div class="rank-number">${index + 1}</div>
                            <div>
                                <div class="rank-name">${result.nombre}</div>
                                <div class="rank-title">${levelTitles[result.nivel] || 'El que cura todo con agua con sal'}</div>
                            </div>
                            <div class="rank-team team-${result.grupo?.toLowerCase() || 'a'}">Grupo ${result.grupo || 'A'}</div>
                            <div class="rank-score">${result.puntaje} pts</div>
                            <div class="rank-level">Nv.${result.nivel}</div>
                        `;
                        
                        container.appendChild(playerRank);
                    });
                }
            } catch (error) {
                console.error('Error loading individual ranking:', error);
            }
        }
        
        async function loadTeamRankings() {
            try {
                const snapshot = await database.ref('resultados').once('value');
                const results = snapshot.val();
                
                if (results) {
                    const resultsArray = Object.values(results);
                    
                    // Agrupar por equipo y obtener mejor resultado por jugador
                    const teamPlayers = {
                        A: new Map(),
                        B: new Map(),
                        C: new Map()
                    };
                    
                    resultsArray.forEach(result => {
                        const team = result.grupo;
                        if (teamPlayers[team]) {
                            const existing = teamPlayers[team].get(result.cedula);
                            if (!existing || result.puntaje > existing.puntaje) {
                                teamPlayers[team].set(result.cedula, result);
                            }
                        }
                    });
                    
                    const container = document.getElementById('detailedTeamStats');
                    container.innerHTML = '';
                    
                    // Crear sección para cada equipo
                    ['A', 'B', 'C'].forEach(teamName => {
                        const players = Array.from(teamPlayers[teamName].values())
                            .sort((a, b) => b.puntaje - a.puntaje);
                        
                        const avgScore = players.length > 0 ? 
                            Math.round((players.reduce((sum, p) => sum + p.puntaje, 0) / players.length) * 10) / 10 : 0;
                        const maxLevel = players.length > 0 ? 
                            Math.max(...players.map(p => p.nivel)) : 0;
                        
                        const teamSection = document.createElement('div');
                        teamSection.className = `team-section team-${teamName.toLowerCase()}`;
                        
                        let playersHTML = '';
                        players.slice(0, 10).forEach((player, index) => {
                            playersHTML += `
                                <div class="team-player">
                                    <span>${index + 1}. ${player.nombre}</span>
                                    <span>${player.puntaje} pts - Nv.${player.nivel}</span>
                                </div>
                            `;
                        });
                        
                        teamSection.innerHTML = `
                            <div class="team-header">
                                <div class="team-name">GRUPO ${teamName}</div>
                                <div class="team-stats">
                                    <span>👥 ${players.length}</span>
                                    <span>🏆 ${avgScore} pts</span>
                                    <span>📈 Nv.${maxLevel}</span>
                                </div>
                            </div>
                            <div style="margin-top: 16px;">
                                <h3 style="color: #94a3b8; margin-bottom: 12px; font-size: 1rem;">Top 10 del grupo:</h3>
                                ${playersHTML || '<div style="color: #64748b; font-style: italic;">No hay participantes aún</div>'}
                            </div>
                        `;
                        
                        container.appendChild(teamSection);
                    });
                }
            } catch (error) {
                console.error('Error loading team rankings:', error);
            }
        }
        
        async function updateLiveFeed() {
            try {
                const snapshot = await database.ref('resultados').orderByChild('timestamp').limitToLast(10).once('value');
                const results = snapshot.val();
                
                if (results) {
                    const resultsArray = Object.values(results).sort((a, b) => b.timestamp - a.timestamp);
                    
                    const container = document.getElementById('liveFeed');
                    container.innerHTML = '';
                    
                    resultsArray.forEach(result => {
                        const feedItem = document.createElement('div');
                        feedItem.className = 'feed-item';
                        
                        const timeAgo = getTimeAgo(result.timestamp);
                        
                        feedItem.innerHTML = `
                            <div>
                                <div class="feed-player">${result.nombre}</div>
                                <div class="feed-team team-${result.grupo?.toLowerCase() || 'a'}">Grupo ${result.grupo || 'A'}</div>
                            </div>
                            <div class="feed-score">${result.puntaje} pts - Nv.${result.nivel}</div>
                            <div class="feed-time">${timeAgo}</div>
                        `;
                        
                        container.appendChild(feedItem);
                    });
                }
            } catch (error) {
                console.error('Error loading live feed:', error);
            }
        }
        
        function getTimeAgo(timestamp) {
            const now = Date.now();
            const diff = now - timestamp;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (days > 0) return `hace ${days}d`;
            if (hours > 0) return `hace ${hours}h`;
            if (minutes > 0) return `hace ${minutes}m`;
            return 'ahora';
        }
        
        // Funciones del juego
        async function startGame() {
            const name = document.getElementById('playerName').value.trim();
            const id = document.getElementById('playerId').value.trim();
            const team = document.getElementById('playerTeam').value;
            
            if (!name || !id || !team) {
                alert('Por favor, completá todos los campos');
                return;
            }
            
            // Validar formato de cédula (solo números, sin dígito verificador)
            if (!/^\d{6,8}$/.test(id)) {
                alert('La cédula debe tener entre 6 y 8 dígitos, sin dígito verificador');
                return;
            }
            
            try {
                playerAttempts = await checkPlayerAttempts(id);
                
                if (playerAttempts >= 2) {
                    document.getElementById('intentosMessage').style.display = 'block';
                    document.getElementById('intentosMessage').textContent = 
                        '❌ Ya completaste tus 2 intentos permitidos. Solo podés ver el dashboard.';
                    return;
                }
                
                if (playerAttempts === 1) {
                    document.getElementById('intentosMessage').style.display = 'block';
                    document.getElementById('intentosMessage').textContent = 
                        '⚠️ Este es tu segundo y último intento.';
                }
            } catch (error) {
                console.error('Error checking attempts:', error);
                alert('Error conectando con la base de datos. Intenta de nuevo.');
                return;
            }
            
            currentPlayer = { name, id, team };
            document.getElementById('displayName').textContent = name;
            
            // Mostrar equipo con estilo
            const teamDisplay = document.getElementById('displayTeam');
            teamDisplay.textContent = `Grupo ${team}`;
            teamDisplay.className = `player-team team-${team.toLowerCase()}`;
            
            // Resetear variables del juego
            currentLevel = 1;
            score = 0;
            lives = 3;
            maxLevelReached = 1;
            answeredQuestions.clear();
            comodines = { fifty: true, change: true };
            document.getElementById('comodin5050').disabled = false;
            document.getElementById('comodinChange').disabled = false;
            
            updateScore();
            updateLivesDisplay();
            updateCurrentLevel();
            
            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('gameScreen').style.display = 'block';
            
            showLevelScreen();
        }
        
        function showLevelScreen() {
            document.getElementById('levelScreen').style.display = 'block';
            document.getElementById('mainQuestionContainer').style.display = 'none';
            document.getElementById('nextButton').style.display = 'none';
            
            document.getElementById('levelNumber').textContent = currentLevel;
            document.getElementById('levelDescription').textContent = levelTitles[currentLevel] || "Nivel sin descripción";
        }
        
        function startLevel() {
            document.getElementById('levelScreen').style.display = 'none';
            document.getElementById('mainQuestionContainer').style.display = 'block';
            loadQuestion();
        }
        
        function loadQuestion() {
            eliminated5050 = false;
            
            // Filtrar preguntas disponibles del nivel actual
            const levelQuestions = questionBank.filter(q => q.level === currentLevel);
            const availableQuestions = levelQuestions.filter(q => !answeredQuestions.has(q.question));
            
            if (availableQuestions.length === 0) {
                // Si no hay preguntas disponibles, reiniciar el pool para este nivel
                answeredQuestions.forEach(q => {
                    const questionLevel = questionBank.find(qb => qb.question === q)?.level;
                    if (questionLevel === currentLevel) {
                        answeredQuestions.delete(q);
                    }
                });
                
                // Volver a filtrar
                const resetAvailable = levelQuestions.filter(q => !answeredQuestions.has(q.question));
                currentQuestion = resetAvailable.length > 0 ? 
                    resetAvailable[Math.floor(Math.random() * resetAvailable.length)] :
                    levelQuestions[Math.floor(Math.random() * levelQuestions.length)];
            } else {
                currentQuestion = availableQuestions[Math.floor(Math.random() * availableQuestions.length)];
            }
            
            answeredQuestions.add(currentQuestion.question);
            
            document.getElementById('questionText').textContent = currentQuestion.question;
            shuffledOptions = currentQuestion.options.slice().sort(() => Math.random() - 0.5);
            
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            
            shuffledOptions.forEach((option, index) => {
                const optionElement = document.createElement('div');
                optionElement.className = 'option';
                optionElement.textContent = option.text;
                optionElement.onclick = () => selectOption(option, optionElement);
                optionsContainer.appendChild(optionElement);
            });
            
            document.getElementById('nextButton').style.display = 'none';
            startTimer();
        }
        
        function startTimer() {
            timeLeft = 30;
            updateTimerDisplay();
            
            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();
                
                if (timeLeft <= 10) {
                    document.getElementById('timer').classList.add('warning');
                }
                
                if (timeLeft <= 0) {
                    timeOut();
                }
            }, 1000);
        }
        
        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            document.getElementById('timer').classList.remove('warning');
        }
        
        function updateTimerDisplay() {
            document.getElementById('timer').textContent = timeLeft;
        }
        
        function timeOut() {
            stopTimer();
            // Tiempo agotado = respuesta incorrecta = 0 puntos
            lives--;
            updateLivesDisplay();
            
            const allOptions = document.querySelectorAll('.option');
            allOptions.forEach((optElement, idx) => {
                optElement.classList.add('disabled');
                optElement.onclick = null;
                if (shuffledOptions[idx].correct) {
                    optElement.classList.add('correct');
                }
            });
            
            if (lives <= 0) {
                setTimeout(endGame, 2000);
            } else {
                setTimeout(() => {
                    document.getElementById('nextButton').style.display = 'inline-block';
                }, 1500);
            }
        }
        
        function selectOption(option, element) {
            stopTimer();
            
            if (element.classList.contains('eliminated')) {
                return;
            }
            
            const allOptions = document.querySelectorAll('.option');
            allOptions.forEach(opt => {
                opt.classList.add('disabled');
                opt.onclick = null;
            });
            
            // Sistema de puntuación simplificado
            if (option.correct) {
                element.classList.add('correct');
                score += 1; // Respuesta correcta = +1
            } else {
                element.classList.add('incorrect');
                // Respuesta incorrecta = 0 puntos, perder vida
                lives--;
                
                // Mostrar la opción correcta
                allOptions.forEach((optElement, idx) => {
                    if (shuffledOptions[idx].correct) {
                        optElement.classList.add('correct');
                    }
                });
            }
            
            updateScore();
            updateLivesDisplay();
            
            if (lives <= 0) {
                setTimeout(endGame, 2000);
                return;
            }
            
            setTimeout(() => {
                document.getElementById('nextButton').style.display = 'inline-block';
            }, 1500);
        }
        
        function nextQuestion() {
            // Verificar ANTES de incrementar si ya completamos todos los niveles
            if (currentLevel >= 30) {
                endGame();
                return;
            }
            
            currentLevel++;
            updateCurrentLevel();
            
            if (currentLevel > maxLevelReached) {
                maxLevelReached = currentLevel;
            }
            
            showLevelScreen();
        }
        
        function use5050() {
            if (!comodines.fifty) return;
            
            comodines.fifty = false;
            document.getElementById('comodin5050').disabled = true;
            
            const incorrectIndices = [];
            shuffledOptions.forEach((option, index) => {
                if (!option.correct) {
                    incorrectIndices.push(index);
                }
            });
            
            const toEliminate = incorrectIndices.sort(() => Math.random() - 0.5).slice(0, 2);
            
            toEliminate.forEach(index => {
                const optionElement = document.querySelectorAll('.option')[index];
                optionElement.classList.add('eliminated');
                optionElement.onclick = null;
            });
        }
        
        function changeQuestion() {
            if (!comodines.change) return;
            
            comodines.change = false;
            document.getElementById('comodinChange').disabled = true;
            
            // Guardar la pregunta actual para no repetirla
            const currentQuestionText = currentQuestion.question;
            
            // Filtrar preguntas disponibles del nivel actual (excluyendo la actual)
            const levelQuestions = questionBank.filter(q => q.level === currentLevel && q.question !== currentQuestionText);
            const availableQuestions = levelQuestions.filter(q => !answeredQuestions.has(q.question));
            
            if (availableQuestions.length > 0) {
                // Hay preguntas disponibles diferentes
                currentQuestion = availableQuestions[Math.floor(Math.random() * availableQuestions.length)];
            } else {
                // No hay más preguntas, usar cualquiera diferente a la actual
                const differentQuestions = levelQuestions.length > 0 ? levelQuestions : 
                    questionBank.filter(q => q.level === currentLevel && q.question !== currentQuestionText);
                if (differentQuestions.length > 0) {
                    currentQuestion = differentQuestions[Math.floor(Math.random() * differentQuestions.length)];
                } else {
                    // Último recurso: mantener la pregunta actual
                    alert('No hay más preguntas disponibles para este nivel');
                    comodines.change = true;
                    document.getElementById('comodinChange').disabled = false;
                    return;
                }
            }
            
            answeredQuestions.add(currentQuestion.question);
            
            // Recargar la interfaz
            document.getElementById('questionText').textContent = currentQuestion.question;
            shuffledOptions = currentQuestion.options.slice().sort(() => Math.random() - 0.5);
            
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            
            shuffledOptions.forEach((option, index) => {
                const optionElement = document.createElement('div');
                optionElement.className = 'option';
                optionElement.textContent = option.text;
                optionElement.onclick = () => selectOption(option, optionElement);
                optionsContainer.appendChild(optionElement);
            });
            
            // Reiniciar timer
            stopTimer();
            startTimer();
        }
        
        function updateScore() {
            document.getElementById('score').textContent = score;
        }
        
        function updateCurrentLevel() {
            document.getElementById('currentLevelDisplay').textContent = currentLevel;
        }
        
        function updateLivesDisplay() {
            const hearts = ['heart1', 'heart2', 'heart3'];
            hearts.forEach((heartId, index) => {
                const heart = document.getElementById(heartId);
                if (index < lives) {
                    heart.className = 'heart active';
                } else {
                    heart.className = 'heart lost';
                }
            });
        }
        
        function getLevelTitle(level) {
            return levelTitles[level] || "El que cura todo con agua con sal";
        }
        
        async function endGame() {
            stopTimer();
            
            // Asegurar que el nivel máximo nunca exceda 30
            if (maxLevelReached > 30) {
                maxLevelReached = 30;
            }
            
            const result = {
                nombre: currentPlayer.name,
                cedula: currentPlayer.id,
                grupo: currentPlayer.team,
                puntaje: score,
                nivel: maxLevelReached,
                titulo: getLevelTitle(maxLevelReached),
                fecha: new Date().toLocaleString('es-UY'),
                intento: playerAttempts + 1
            };
            
            try {
                await saveGameResult(result);
                console.log('Resultado guardado exitosamente');
            } catch (error) {
                console.error('Error guardando resultado:', error);
                alert('Error guardando el resultado. Tu progreso puede no haberse guardado.');
            }
            
            document.getElementById('gameScreen').style.display = 'none';
            document.getElementById('resultsScreen').style.display = 'block';
            
            document.getElementById('finalScore').textContent = score;
            document.getElementById('maxLevel').textContent = maxLevelReached;
            document.getElementById('levelName').textContent = result.titulo;
            document.getElementById('levelHoroscope').textContent = 
                levelDescriptions[maxLevelReached] || levelDescriptions[1];
            
            document.getElementById('retryButton').style.display = 
                (playerAttempts + 1) < 2 ? 'inline-block' : 'none';
        }
        
        function retryGame() {
            lives = 3;
            currentLevel = 1;
            score = 0;
            maxLevelReached = 1;
            answeredQuestions.clear();
            comodines = { fifty: true, change: true };
            document.getElementById('comodin5050').disabled = false;
            document.getElementById('comodinChange').disabled = false;
            
            document.getElementById('resultsScreen').style.display = 'none';
            document.getElementById('gameScreen').style.display = 'block';
            
            updateScore();
            updateLivesDisplay();
            updateCurrentLevel();
            showLevelScreen();
        }
        
        function newGame() {
            document.getElementById('resultsScreen').style.display = 'none';
            document.getElementById('startScreen').style.display = 'block';
            document.getElementById('playerName').value = '';
            document.getElementById('playerId').value = '';
            document.getElementById('playerTeam').value = '';
            document.getElementById('intentosMessage').style.display = 'none';
        }
    </script>
</body>
</html>