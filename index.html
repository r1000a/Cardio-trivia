<!DOCTYPE html>
<html lang="es-UY">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>¬øQui√©n quiere ser cardi√≥logo? - Competencia por Equipos</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
            color: #e2e8f0;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow-x: hidden;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, transparent 20%, rgba(59, 130, 246, 0.15) 20%, rgba(59, 130, 246, 0.15) 21%, transparent 21%, transparent 30%, rgba(59, 130, 246, 0.1) 30%, rgba(59, 130, 246, 0.1) 31%, transparent 31%);
            background-size: 60px 60px;
            animation: rotate 180s linear infinite;
            opacity: 0.4;
            z-index: -1;
        }
        
        @keyframes rotate {
            to { transform: rotate(360deg); }
        }
        
        .container {
            width: 95%;
            max-width: 1200px;
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(20px);
            border: 2px solid rgba(59, 130, 246, 0.3);
            border-radius: 24px;
            padding: 24px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25), 0 0 0 1px rgba(59, 130, 246, 0.1);
            position: relative;
            z-index: 1;
            max-height: 95vh;
            overflow-y: auto;
        }
        
        /* Logos institucionales */
        .institutional-header {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 40px;
            margin-bottom: 20px;
            padding: 16px;
            background: rgba(30, 41, 59, 0.3);
            border-radius: 16px;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }
        
        .logo-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }
        
        .logo {
            height: 60px;
            width: auto;
            opacity: 0.9;
            transition: all 0.3s ease;
            filter: brightness(1.1);
        }
        
        .logo:hover {
            opacity: 1;
            transform: scale(1.05);
        }
        
        .logo-text {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            color: #94a3b8;
            text-align: center;
            font-weight: 500;
        }
        
        /* Contador de visitas */
        .stats-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 12px;
            padding: 12px 16px;
            margin-bottom: 20px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875rem;
        }
        
        .visit-counter {
            color: #60a5fa;
        }
        
        .online-players {
            color: #22c55e;
        }
        
        .last-update {
            color: #94a3b8;
        }
        
        h1 {
            font-size: 2.75rem;
            font-weight: 700;
            text-align: center;
            background: linear-gradient(135deg, #60a5fa, #3b82f6, #2563eb);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 12px;
            letter-spacing: -0.025em;
        }
        
        h2 {
            font-size: 1.875rem;
            font-weight: 600;
            text-align: center;
            color: #60a5fa;
            margin-bottom: 24px;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .subtitle {
            font-family: 'JetBrains Mono', monospace;
            text-align: center;
            color: #94a3b8;
            font-size: 1.125rem;
            margin-bottom: 32px;
            letter-spacing: 0.05em;
            font-weight: 500;
        }
        
        .nav-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 32px;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .nav-tab {
            background: rgba(30, 58, 138, 0.2);
            color: #e2e8f0;
            border: 2px solid rgba(59, 130, 246, 0.3);
            padding: 12px 24px;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: 'JetBrains Mono', monospace;
            font-weight: 500;
            font-size: 0.875rem;
        }
        
        .nav-tab.active {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.3);
            transform: translateY(-2px);
        }
        
        .nav-tab:hover:not(.active) {
            background: rgba(59, 130, 246, 0.2);
            border-color: rgba(59, 130, 246, 0.5);
            transform: translateY(-1px);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Admin Panel */
        .admin-panel {
            background: rgba(220, 38, 38, 0.1);
            border: 2px solid rgba(220, 38, 38, 0.3);
            border-radius: 16px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }
        
        .admin-password {
            width: 300px;
            padding: 12px;
            margin: 12px;
            background: rgba(15, 23, 42, 0.8);
            border: 2px solid rgba(220, 38, 38, 0.3);
            border-radius: 8px;
            color: #e2e8f0;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .admin-data {
            background: rgba(15, 23, 42, 0.6);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            max-height: 500px;
            overflow-y: auto;
        }
        
        /* Pantalla de inicio */
        #startScreen {
            text-align: center;
        }
        
        .form-group {
            margin: 24px 0;
            text-align: left;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-size: 1.125rem;
            font-weight: 500;
            color: #60a5fa;
        }
        
        input, select {
            width: 100%;
            padding: 16px;
            font-size: 1rem;
            background: rgba(30, 41, 59, 0.8);
            border: 2px solid rgba(59, 130, 246, 0.3);
            border-radius: 12px;
            color: #e2e8f0;
            font-family: 'Inter', sans-serif;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #3b82f6;
            background: rgba(30, 41, 59, 0.95);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        select option {
            background: #1e293b;
            color: #e2e8f0;
        }
        
        .privacy-note {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 12px;
            padding: 16px;
            margin: 24px 0;
            font-size: 0.875rem;
            color: #94a3b8;
            line-height: 1.6;
        }
        
        .btn {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            border: none;
            padding: 14px 32px;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            margin: 8px;
            font-family: 'Inter', sans-serif;
            letter-spacing: 0.025em;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.3);
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
        }
        
        .btn-danger:hover {
            background: linear-gradient(135deg, #b91c1c, #991b1b);
        }
        
        /* Dashboard */
        .dashboard-section {
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 24px;
            margin: 24px 0;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin: 24px 0;
        }
        
        .stat-card {
            background: rgba(15, 23, 42, 0.6);
            border: 2px solid rgba(59, 130, 246, 0.2);
            border-radius: 16px;
            padding: 24px;
            text-align: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .stat-card:hover {
            border-color: rgba(59, 130, 246, 0.4);
            transform: translateY(-2px);
        }
        
        .stat-number {
            font-size: 2.5rem;
            color: #60a5fa;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .stat-label {
            color: #94a3b8;
            font-size: 1rem;
            font-weight: 500;
            margin-top: 8px;
        }
        
        /* Ranking por equipos */
        .team-rankings {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
            margin: 24px 0;
        }
        
        .team-section {
            background: rgba(15, 23, 42, 0.6);
            border-radius: 16px;
            padding: 20px;
            border: 2px solid rgba(59, 130, 246, 0.2);
            transition: all 0.3s ease;
        }
        
        .team-section:hover {
            border-color: rgba(59, 130, 246, 0.4);
            transform: translateY(-2px);
        }
        
        .team-section.team-a {
            border-color: rgba(34, 197, 94, 0.4);
        }
        
        .team-section.team-b {
            border-color: rgba(59, 130, 246, 0.4);
        }
        
        .team-section.team-c {
            border-color: rgba(251, 191, 36, 0.4);
        }
        
        .team-section.team-individual {
            border-color: rgba(139, 92, 246, 0.4);
        }
        
        .team-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding: 12px;
            border-radius: 8px;
        }
        
        .team-a .team-header {
            background: rgba(34, 197, 94, 0.1);
        }
        
        .team-b .team-header {
            background: rgba(59, 130, 246, 0.1);
        }
        
        .team-c .team-header {
            background: rgba(251, 191, 36, 0.1);
        }
        
        .team-individual .team-header {
            background: rgba(139, 92, 246, 0.1);
        }
        
        .team-name {
            font-size: 1.5rem;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .team-a .team-name {
            color: #22c55e;
        }
        
        .team-b .team-name {
            color: #3b82f6;
        }
        
        .team-c .team-name {
            color: #fbbf24;
        }
        
        .team-individual .team-name {
            color: #8b5cf6;
        }
        
        .team-stats {
            display: flex;
            gap: 16px;
            font-size: 0.875rem;
            color: #94a3b8;
        }
        
        /* Game Screen Styles */
        .game-interface {
            display: none;
            text-align: center;
        }
        
        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(30, 41, 59, 0.4);
            border-radius: 16px;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }
        
        .game-info {
            display: flex;
            gap: 30px;
            align-items: center;
        }
        
        .info-item {
            text-align: center;
        }
        
        .info-label {
            font-size: 0.875rem;
            color: #94a3b8;
            margin-bottom: 4px;
        }
        
        .info-value {
            font-size: 1.5rem;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .level-value {
            color: #60a5fa;
        }
        
        .score-value {
            color: #22c55e;
        }
        
        .lives-value {
            color: #f59e0b;
        }
        
        .timer {
            font-size: 3rem;
            font-weight: 700;
            color: #ef4444;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .timer.warning {
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .question-container {
            background: rgba(15, 23, 42, 0.6);
            border-radius: 16px;
            padding: 30px;
            margin: 30px 0;
            border: 2px solid rgba(59, 130, 246, 0.2);
        }
        
        .level-indicator {
            font-size: 1.125rem;
            color: #94a3b8;
            margin-bottom: 20px;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .question-text {
            font-size: 1.375rem;
            font-weight: 600;
            color: #e2e8f0;
            margin-bottom: 30px;
            line-height: 1.6;
        }
        
        .options-container {
            display: grid;
            gap: 16px;
            margin: 30px 0;
        }
        
        .option {
            background: rgba(30, 41, 59, 0.6);
            border: 2px solid rgba(59, 130, 246, 0.3);
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-align: left;
            font-size: 1.125rem;
            color: #e2e8f0;
        }
        
        .option:hover {
            background: rgba(59, 130, 246, 0.1);
            border-color: rgba(59, 130, 246, 0.5);
            transform: translateY(-2px);
        }
        
        .option.selected {
            background: rgba(59, 130, 246, 0.2);
            border-color: #3b82f6;
        }
        
        .option.correct {
            background: rgba(34, 197, 94, 0.2);
            border-color: #22c55e;
        }
        
        .option.incorrect {
            background: rgba(239, 68, 68, 0.2);
            border-color: #ef4444;
        }
        
        .option.eliminated {
            opacity: 0.3;
            cursor: not-allowed;
            background: rgba(100, 116, 139, 0.2);
            border-color: #64748b;
        }
        
        .comodines {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 30px 0;
        }
        
        .comodin {
            background: rgba(251, 191, 36, 0.2);
            border: 2px solid rgba(251, 191, 36, 0.4);
            border-radius: 12px;
            padding: 12px 24px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            color: #fbbf24;
        }
        
        .comodin:hover:not(.used) {
            background: rgba(251, 191, 36, 0.3);
            transform: translateY(-2px);
        }
        
        .comodin.used {
            opacity: 0.3;
            cursor: not-allowed;
            background: rgba(100, 116, 139, 0.2);
            border-color: #64748b;
            color: #64748b;
        }
        
        .game-actions {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 30px 0;
        }
        
        .result-screen {
            display: none;
            text-align: center;
            padding: 40px;
        }
        
        .result-title {
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 20px;
        }
        
        .result-title.success {
            color: #22c55e;
        }
        
        .result-title.failure {
            color: #ef4444;
        }
        
        .final-stats {
            background: rgba(15, 23, 42, 0.6);
            border-radius: 16px;
            padding: 30px;
            margin: 30px 0;
            border: 2px solid rgba(59, 130, 246, 0.2);
        }
        
        .stats-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(59, 130, 246, 0.1);
        }
        
        .stats-row:last-child {
            border-bottom: none;
        }
        
        .stats-label {
            font-size: 1.125rem;
            color: #94a3b8;
        }
        
        .stats-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: #60a5fa;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .loading {
            text-align: center;
            color: #94a3b8;
            font-style: italic;
        }
        
        .error-message {
            background: rgba(220, 38, 38, 0.1);
            border: 2px solid rgba(220, 38, 38, 0.3);
            border-radius: 12px;
            padding: 16px;
            margin: 16px 0;
            color: #f87171;
            text-align: center;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(15, 23, 42, 0.95);
            border: 2px solid rgba(59, 130, 246, 0.4);
            border-radius: 12px;
            padding: 16px 20px;
            color: #e2e8f0;
            font-weight: 500;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            max-width: 350px;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(30, 41, 59, 0.6);
            border-radius: 4px;
            overflow: hidden;
            margin: 20px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #60a5fa);
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            body {
                align-items: flex-start;
                padding: 10px;
            }
            
            .container {
                width: 100%;
                margin: 0;
                border-radius: 16px;
                padding: 16px;
                max-height: none;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .institutional-header {
                flex-direction: column;
                gap: 20px;
            }
            
            .logo {
                height: 50px;
            }
            
            .nav-tabs {
                justify-content: flex-start;
                overflow-x: auto;
                padding-bottom: 8px;
            }
            
            .stats-bar {
                flex-direction: column;
                gap: 8px;
                text-align: center;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .team-rankings {
                grid-template-columns: 1fr;
            }
            
            .admin-password {
                width: 90%;
                max-width: 300px;
            }
            
            .game-header {
                flex-direction: column;
                gap: 20px;
            }
            
            .game-info {
                justify-content: space-around;
                width: 100%;
            }
            
            .timer {
                font-size: 2rem;
            }
            
            .question-text {
                font-size: 1.125rem;
            }
            
            .option {
                font-size: 1rem;
                padding: 16px;
            }
            
            .comodines {
                flex-direction: column;
                align-items: center;
            }
            
            .game-actions {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Barra de estad√≠sticas en tiempo real -->
        <div class="stats-bar">
            <div class="visit-counter">
                üåê Visitas: <span id="visitCount">-</span>
            </div>
            <div class="online-players">
                üë§ Jugando ahora: <span id="onlinePlayers">-</span>
            </div>
            <div class="last-update">
                üîÑ √öltima actualizaci√≥n: <span id="lastUpdate">-</span>
            </div>
        </div>
        
        <!-- Header institucional -->
        <div class="institutional-header">
            <div class="logo-container">
                <img src="logo-ccu.png" alt="Centro Cardiovascular Universitario" class="logo" id="logo-ccu">
                <div class="logo-text">Centro Cardiovascular<br>Universitario</div>
            </div>
            <div class="logo-container">
                <img src="logo-uac.png" alt="Unidad Acad√©mica de Cardiolog√≠a" class="logo" id="logo-uac">
                <div class="logo-text">Unidad Acad√©mica<br>de Cardiolog√≠a</div>
            </div>
        </div>
        
        <!-- Navegaci√≥n -->
        <div class="nav-tabs">
            <div class="nav-tab active" onclick="showTab('dashboard')">üìä Dashboard</div>
            <div class="nav-tab" onclick="showTab('individual')">üèÜ Individual</div>
            <div class="nav-tab" onclick="showTab('equipos')">üë• Equipos</div>
            <div class="nav-tab" onclick="showTab('game')">üéÆ Jugar</div>
            <div class="nav-tab" onclick="showTab('admin')">üîê Admin</div>
        </div>
        
        <!-- Dashboard General -->
        <div id="dashboard" class="tab-content active">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <div>
                    <h1>üè• Dashboard General</h1>
                    <p class="subtitle">COMPETENCIA INDIVIDUAL Y POR EQUIPOS</p>
                </div>
                <button class="btn" onclick="refreshDashboard()" style="margin: 0;">üîÑ Actualizar</button>
            </div>
            
            <!-- Estad√≠sticas Generales -->
            <div class="dashboard-section">
                <h2>üìà Estad√≠sticas Generales</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalJugadores">-</div>
                        <div class="stat-label">Total Participantes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalPartidas">-</div>
                        <div class="stat-label">Partidas Iniciadas</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="promedioScore">-</div>
                        <div class="stat-label">Puntaje Promedio</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="nivelMaximo">-</div>
                        <div class="stat-label">Nivel M√°ximo Alcanzado</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="jugadoresHoy">-</div>
                        <div class="stat-label">Participantes Hoy</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="visitasHoy">-</div>
                        <div class="stat-label">Visitas de Hoy</div>
                    </div>
                </div>
            </div>
            
            <!-- Ranking por Equipos -->
            <div class="dashboard-section">
                <h2>ü•á Ranking de Equipos</h2>
                <div class="team-rankings" id="teamRankings">
                    <div class="loading">Cargando estad√≠sticas de equipos...</div>
                </div>
            </div>
        </div>
        
        <!-- Ranking Individual -->
        <div id="individual" class="tab-content">
            <h1>üèÜ Ranking Individual</h1>
            <p class="subtitle">MEJORES PARTICIPANTES</p>
            <div class="loading">Cargando ranking individual...</div>
        </div>
        
        <!-- Ranking por Equipos -->
        <div id="equipos" class="tab-content">
            <h1>üë• Competencia por Equipos</h1>
            <p class="subtitle">RANKING DETALLADO POR GRUPO</p>
            <div class="loading">Cargando estad√≠sticas detalladas...</div>
        </div>
        
        <!-- Panel de Administraci√≥n -->
        <div id="admin" class="tab-content">
            <h1>üîê Panel de Administraci√≥n</h1>
            <p class="subtitle">ACCESO RESTRINGIDO</p>
            
            <div class="admin-panel">
                <h2>üîí Acceso Privado</h2>
                <p>Ingresa la contrase√±a para ver los datos de los participantes:</p>
                <input type="password" id="adminPassword" class="admin-password" placeholder="Contrase√±a de administrador">
                <br>
                <button class="btn" onclick="verifyAdmin()">Acceder</button>
                
                <div id="adminData" class="admin-data" style="display: none;">
                    <h3>üìã Registro Completo de Participantes</h3>
                    
                    <div style="margin-bottom: 20px;">
                        <button class="btn" onclick="exportAdminData()">üì• Descargar CSV</button>
                        <button class="btn btn-danger" onclick="clearAllDataSafe()">üóëÔ∏è Limpiar Datos</button>
                        <button class="btn" onclick="resetAllAttempts()" style="background: linear-gradient(135deg, #f59e0b, #d97706);">üîÑ Reset Intentos</button>
                    </div>
                    
                    <div style="margin-bottom: 20px; padding: 16px; background: rgba(59, 130, 246, 0.1); border-radius: 8px;">
                        <h4 style="color: #3b82f6; margin-bottom: 12px;">üîß Herramientas de Diagn√≥stico</h4>
                        <button class="btn" onclick="diagnoseFirebase()" style="background: linear-gradient(135deg, #059669, #047857); margin: 4px;">üîç Diagn√≥stico Completo</button>
                        <button class="btn" onclick="testFirebaseConnection()" style="background: linear-gradient(135deg, #0ea5e9, #0284c7); margin: 4px;">‚ö° Test R√°pido</button>
                        <button class="btn" onclick="refreshDashboard()" style="background: linear-gradient(135deg, #7c3aed, #6d28d9); margin: 4px;">üîÑ Refrescar Dashboard</button>
                    </div>
                    
                    <div style="margin-bottom: 20px; padding: 16px; background: rgba(245, 158, 11, 0.1); border-radius: 8px;">
                        <h4 style="color: #f59e0b; margin-bottom: 8px;">‚ÑπÔ∏è Informaci√≥n del Sistema</h4>
                        <p style="margin: 4px 0; font-size: 0.875rem; color: #94a3b8;">
                            <strong>üîÑ Reset Intentos:</strong> Permite que todos los jugadores vuelvan a participar sin eliminar puntajes hist√≥ricos.
                        </p>
                        <p style="margin: 4px 0; font-size: 0.875rem; color: #94a3b8;">
                            <strong>üë• Puntaje por Equipos:</strong> Suma algebraica del mejor intento de cada participante del grupo.
                        </p>
                        <p style="margin: 4px 0; font-size: 0.875rem; color: #94a3b8;">
                            <strong>üéÆ L√≠mite de Intentos:</strong> 2 intentos por persona (se resetea con el bot√≥n correspondiente).
                        </p>
                    </div>
                    
                    <div id="adminTable" style="margin-top: 20px;">
                        <!-- Tabla de admin se genera aqu√≠ -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Pantalla de Juego -->
        <div id="game" class="tab-content">
            <!-- Pantalla de inicio -->
            <div id="startScreen">
                <h1>¬øQui√©n quiere ser cardi√≥logo?</h1>
                <p class="subtitle">COMPETENCIA INDIVIDUAL Y POR EQUIPOS</p>
                
                <form onsubmit="event.preventDefault(); startGame();">
                    <div class="form-group">
                        <label for="playerName">üìù Nombre y apellido:</label>
                        <input type="text" id="playerName" placeholder="Dr. Juan P√©rez L√≥pez" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="playerNickname">üé≠ Pseud√≥nimo (aparecer√° en los rankings):</label>
                        <input type="text" id="playerNickname" placeholder="CardioMaster2025" required maxlength="20" 
                               style="background-color: rgba(59, 130, 246, 0.1); border-color: #3b82f6;">
                        <small style="color: #94a3b8; font-size: 0.8rem;">Solo letras, n√∫meros y gui√≥n bajo. Entre 3-20 caracteres.</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="playerId">üÜî C√©dula de identidad (sin d√≠gito verificador):</label>
                        <input type="text" id="playerId" placeholder="1234567" required onblur="checkParticipantInfo()">
                    </div>
                    
                    <div id="participantInfo" style="display: none; margin: 20px 0; padding: 16px; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 12px;">
                        <!-- Informaci√≥n del participante se muestra aqu√≠ -->
                    </div>
                </form>
                
                <div class="privacy-note">
                    üèÜ <strong>Competencia:</strong> Tu grupo se asigna autom√°ticamente seg√∫n el registro del foro. Si no est√°s registrado, particip√°s individualmente.
                    <br>üîí <strong>Privacidad:</strong> Tu nombre real es privado (solo lo ve el administrador), en los rankings p√∫blicos aparece tu pseud√≥nimo. 
                    <br>üìã <strong>Validaci√≥n:</strong> Tu c√©dula es solo para validar participaci√≥n y evitar m√∫ltiples intentos.
                    <br>üéÆ <strong>L√≠mites:</strong> M√°ximo 2 intentos por persona.
                    <br>üìö <strong>Categor√≠as:</strong> Progres√° desde "Vendedor de Globos" hasta "Maestro del Universo Card√≠aco" en 30 niveles √∫nicos.
                </div>
                
                <div id="intentosMessage" style="display: none; color: #f59e0b; margin: 20px 0; font-weight: bold;"></div>
                
                <button class="btn" id="startGameBtn" onclick="startGame()">üöÄ COMENZAR COMPETENCIA</button>
                
                <div id="questionsStatus" style="margin-top: 20px; padding: 12px; border-radius: 8px; text-align: center; font-size: 0.875rem;">
                    <div id="questionsLoading" style="color: #f59e0b;">üìö Cargando banco de preguntas...</div>
                    <div id="questionsError" style="display: none; color: #ef4444;">‚ùå Error cargando preguntas. Verifica questions_bank.json</div>
                    <div id="questionsSuccess" style="display: none; color: #22c55e;">‚úÖ Banco de preguntas cargado correctamente</div>
                </div>
            </div>
            
            <!-- Interfaz del juego -->
            <div id="gameInterface" class="game-interface">
                <div class="game-header">
                    <div class="game-info">
                        <div class="info-item">
                            <div class="info-label">Nivel</div>
                            <div class="info-value level-value" id="gameLevel">1</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Puntaje</div>
                            <div class="info-value score-value" id="gameScore">0</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Vidas</div>
                            <div class="info-value lives-value" id="gameLives">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
                        </div>
                    </div>
                    <div class="timer" id="gameTimer">30</div>
                </div>
                
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 3.33%;"></div>
                </div>
                
                <div class="question-container">
                    <div class="level-indicator" id="levelIndicator">Nivel 1 - Estudiante</div>
                    <div class="question-text" id="questionText">Cargando pregunta...</div>
                    
                    <div class="options-container" id="optionsContainer">
                        <!-- Las opciones se generan din√°micamente -->
                    </div>
                </div>
                
                <div class="comodines">
                    <div class="comodin" id="comodin5050" onclick="use5050()">
                        üéØ 50/50
                    </div>
                    <div class="comodin" id="comodinChange" onclick="changeQuestion()">
                        üîÑ Cambiar Pregunta
                    </div>
                </div>
                
                <div class="game-actions">
                    <button class="btn" id="confirmAnswer" onclick="confirmAnswer()" disabled>Confirmar Respuesta</button>
                    <button class="btn btn-danger" onclick="quitGame()">Abandonar Juego</button>
                </div>
            </div>
            
            <!-- Pantalla de resultados -->
            <div id="resultScreen" class="result-screen">
                <div class="result-title" id="resultTitle">¬°Felicitaciones!</div>
                <div class="final-stats" id="finalStats">
                    <!-- Estad√≠sticas finales se generan aqu√≠ -->
                </div>
                <div style="margin-top: 30px;">
                    <button class="btn" onclick="restartGame()">üîÑ Jugar Otra Vez</button>
                    <button class="btn" onclick="goToDashboard()">üìä Ver Dashboard</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Notificaciones -->
    <div id="notification" class="notification"></div>
    
    <script>
        // Configuraci√≥n Firebase - TUS CREDENCIALES REALES
        const firebaseConfig = {
            apiKey: "AIzaSyAF1UK57tg4jK856RSU7Qcr1MT8QEeY4-o",
            authDomain: "cardiologia-game-uy.firebaseapp.com",
            databaseURL: "https://cardiologia-game-uy-default-rtdb.firebaseio.com",
            projectId: "cardiologia-game-uy",
            storageBucket: "cardiologia-game-uy.firebasestorage.app",
            messagingSenderId: "950754238661",
            appId: "1:950754238661:web:3df1bc9c9089f3308410ac",
            measurementId: "G-R6SPME7MHK"
        };
        
        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // Variables globales mejoradas para evitar duplicados
        let currentPlayer = { name: '', nickname: '', id: '', team: '' };
        let currentLevel = 1;
        let score = 0;
        let lives = 3;
        let maxLevelReached = 1;
        let currentQuestion = null;
        let answeredQuestions = new Set();
        let timeLeft = 30;
        let timerInterval = null;
        let comodines = { fifty: true, change: true };
        let shuffledOptions = [];
        let eliminated5050 = false;
        let playerAttempts = 0;
        let isAdminAuthenticated = false;
        let questionBank = [];
        let correctStreak = 0;
        let currentSessionId = null;
        let gameStartId = null;
        let selectedOption = null;
        let gameInProgress = false; // Nueva variable para evitar m√∫ltiples inicios
        let resultAlreadySaved = false; // Nueva variable para evitar guardado duplicado
        
        // Configuraci√≥n del juego
        const ADMIN_PASSWORD = "cardio2025admin";
        const MAX_ATTEMPTS = 2;
        const TIMER_SECONDS = 30;
        const TOTAL_LEVELS = 30;
        
        // Sistema de puntaje avanzado
        const SCORING_SYSTEM = {
            BASE_POINTS: 1,
            TIME_BONUS_THRESHOLD: 20,
            TIME_BONUS_POINTS: 1,
            HARD_LEVEL_THRESHOLD: 20,
            HARD_LEVEL_BONUS: 1,
            STREAK_BONUS_5: 3,
            STREAK_BONUS_10: 5,
            PERFECT_GAME_BONUS: 10
        };
        
        // Mapeo de participantes del foro (desde Excel)
        const FORO_PARTICIPANTS = {
            "15545334": {"nombre": "PEDRO TRUJILLO LEZAMA", "grupo": "INDIVIDUAL", "email": "petruji67@gmail.com"},
            "17905069": {"nombre": "ALEJANDRO NICOLAS CUESTA HOLGADO", "grupo": "INDIVIDUAL", "email": "arritmia@yahoo.com"},
            "18253148": {"nombre": "ALVARO NIGGEMEYER VENDITTO", "grupo": "INDIVIDUAL", "email": "alnigge@adinet.com.uy"},
            "26625094": {"nombre": "FEDERICO FERRANDO CASTAGNETTO", "grupo": "INDIVIDUAL", "email": "federico.ferrando@gmail.com"},
            "27517612": {"nombre": "SERGIO GABRIEL BRUZZONI DOMINGUEZ", "grupo": "B", "email": "sergio.b.d@hotmail.com"},
            "27529453": {"nombre": "EDUARDO RAFAEL MILA GARCIA", "grupo": "INDIVIDUAL", "email": "r1000a@gmail.com"},
            "28013366": {"nombre": "LUCIA FLORIO LEGNANI", "grupo": "INDIVIDUAL", "email": "lu.floriol@gmail.com"},
            "30512522": {"nombre": "VIRGINIA SANDRA ESTRAGO MEROLA", "grupo": "INDIVIDUAL", "email": "vikyestrago@gmail.com"},
            "30995275": {"nombre": "NELSON MARIO JES√öS VEGLIA VIAMONTE", "grupo": "A", "email": "nelsonveglia@hotmail.com"},
            "31138428": {"nombre": "NELSON MIGUEL CARABELLI FERREIRA", "grupo": "C", "email": "nelcar@vera.com.uy"},
            "31756199": {"nombre": "HUGO MARTIN ARRESTIA GALLUZZO", "grupo": "C", "email": "marrestia@gmail.com"},
            "35015820": {"nombre": "DAVID ISRAEL DE SOSA TECCO", "grupo": "B", "email": "daviddesosa@gmail.com"},
            "35754076": {"nombre": "DARIO CABEZA LANDO", "grupo": "B", "email": "dariocla@gmail.com"},
            "36479033": {"nombre": "JUAN SEBASTIAN ALBISTUR REYES", "grupo": "INDIVIDUAL", "email": "elseba26@gmail.com"},
            "36975247": {"nombre": "ALEJANDRO DANIEL MORENO ROMERO", "grupo": "B", "email": "alemor40113@gmail.com"},
            "37302146": {"nombre": "CAMILA RAMOS MALCUORI", "grupo": "INDIVIDUAL", "email": "camiramos@gmail.com"},
            "38978912": {"nombre": "MARIA EUGENIA GONZALEZ NU√ëEZ", "grupo": "B", "email": "ma.eugenia.gonzalez@hotmail.com"},
            "39875680": {"nombre": "LEANDRO AGUSTIN SALAZAR DE MELO", "grupo": "B", "email": "leandrosalazar87@gmail.com"},
            "40452069": {"nombre": "JIMENA L√ìPEZ MIQUEIRO", "grupo": "C", "email": "jiji39505@hotmail.com"},
            "42123189": {"nombre": "MARIA BERENISE ORONOZ RECAYTE", "grupo": "C", "email": "berenoz@hotmail.com"},
            "42455659": {"nombre": "SOLEDAD MURGUIA SALGADO", "grupo": "INDIVIDUAL", "email": "solmurguia@gmail.com"},
            "42554607": {"nombre": "MARCIO AGUSTIN BAPTISTA VARIETTI", "grupo": "B", "email": "marciobv89@gmail.com"},
            "43874826": {"nombre": "LEONARDO CURBELO RIVERO", "grupo": "A", "email": "leocuriver@gmail.com"},
            "44468377": {"nombre": "DIEGO AGUSTO SICA SCAPUSIO", "grupo": "A", "email": "dsica90@gmail.com"},
            "44795132": {"nombre": "STEFANI JUDITH FEIRER MACHADO", "grupo": "C", "email": "stefyfeirer@gmail.com"},
            "44809456": {"nombre": "NATALIA DANIELA NOBILE GONZ√ÅLEZ", "grupo": "INDIVIDUAL", "email": "natinobile07@gmail.com"},
            "44912475": {"nombre": "MARIA EUGENIA PELUFFO PORTEIRO", "grupo": "A", "email": "mariaeugeniaprluggo@outloock.es"},
            "44925000": {"nombre": "MELISA TEIXEIRA RODRIGUEZ", "grupo": "B", "email": "melisa.teixeirar@gmail.com"},
            "45225596": {"nombre": "GRACIELA MACHADO NACIMENTO", "grupo": "A", "email": "gmn_uy25@hotmail.com"},
            "45341485": {"nombre": "CAMILA NADIA BOZZOLASCO CONTI", "grupo": "A", "email": "cbozzolasco@gmail.com"},
            "45701936": {"nombre": "INES MABEL GONZALEZ GARCIA", "grupo": "A", "email": "inemabe@hotmail.com"},
            "45707689": {"nombre": "ESTEFANIA DE LA FUENTE CHIARA", "grupo": "A", "email": "delafuentest@gmail.com"},
            "45942845": {"nombre": "GIMENA PLACIDA BENITEZ FERREIRA", "grupo": "B", "email": "gimenabenitez01@gmail.com"},
            "45945007": {"nombre": "CAMILA GURASCIER RAMOS", "grupo": "INDIVIDUAL", "email": "gurascier.camila@gmail.com"},
            "45985281": {"nombre": "NAHIARA LEQUINI PECHI", "grupo": "INDIVIDUAL", "email": "n.lequinipechi@gmail.com"},
            "46013746": {"nombre": "DAHIANA RAPETTI MOREIRA", "grupo": "C", "email": "dahianarapetti@hotmail.com"},
            "46040107": {"nombre": "VICTORIA FRAGA RUSCH", "grupo": "B", "email": "vicky.fraga10@hotmail.com"},
            "46138788": {"nombre": "FEDERICO ANDRES ACQUISTAPACE PERONI", "grupo": "INDIVIDUAL", "email": "feacquista@gmail.com"},
            "46200739": {"nombre": "FACUNDO CAMPOS PREGLIASCO", "grupo": "A", "email": "facundocampos24@gmail.com"},
            "46245684": {"nombre": "EMILIANO BRAND√ìN GARCIA", "grupo": "B", "email": "emilianobrandon@gmail.com"},
            "46273936": {"nombre": "FELIPE MIGUEL FRACHIA CHABCHUL", "grupo": "A", "email": "frachiaf@gmail.com"},
            "46493077": {"nombre": "PABLO OMAR MONTIEL MOREIRA", "grupo": "A", "email": "pablomon949@gmail.com"},
            "46553845": {"nombre": "SOF√çA ISABEL RODR√çGUEZ LESA", "grupo": "C", "email": "sofiarodriguezlesa@hotmail.com"},
            "46688012": {"nombre": "GONZALO PELUSO RODRIGUEZ", "grupo": "INDIVIDUAL", "email": "gonzalopeluso3@gmail.com"},
            "46810728": {"nombre": "JOAQUIN VAZQUEZ GONZALEZ", "grupo": "INDIVIDUAL", "email": "joaquin.vazquez.gonzalez@gmail.com"},
            "46814003": {"nombre": "MARIANA OLIVET CIMINO", "grupo": "INDIVIDUAL", "email": "marianaolivet@gmail.com"},
            "46896083": {"nombre": "CAROLINA FUENTES SALAVERRIA", "grupo": "C", "email": "carolinafs_94@hotmail.com"},
            "46992302": {"nombre": "LEANDRO MARTIN GASTEL√ö DUARTE", "grupo": "C", "email": "gastelu90@gmail.com"},
            "47131189": {"nombre": "MARTIN HORACIO RODRIGUEZ SOSA", "grupo": "C", "email": "martin.rodriguezsosa2302@gmail.com"},
            "47235660": {"nombre": "MARIA EUGENIA CASTRO SILVA", "grupo": "B", "email": "mariaeugeniacastro7@gmail.com"},
            "47251717": {"nombre": "IV√ÅN MOREL BENDERSKY", "grupo": "A", "email": "ivan.morelb@gmail.com"},
            "47307451": {"nombre": "AGUSTINA PEREZ SUAREZ", "grupo": "C", "email": "agustinaps21@hotmail.com"},
            "47338896": {"nombre": "FRANCISCO ESTEBAN SOUTO OLAZABAL", "grupo": "C", "email": "frsouto6@gmail.com"},
            "47373713": {"nombre": "NICOLAS MARCELO CORBO MOLINA", "grupo": "C", "email": "nicolascorbo23@gmail.com"},
            "47462611": {"nombre": "JULI√ÅN PRANDI REYES", "grupo": "B", "email": "julianprandi96@gmail.com"},
            "47483166": {"nombre": "SEBASTIAN EDUARDO BARTO QUINTANA", "grupo": "A", "email": "sebastian-barto@hotmail.com"},
            "47492187": {"nombre": "FEDERICO SANTIAGO MASTROBERTI MARTIGNANO", "grupo": "C", "email": "fedemas25@gmail.com"},
            "47507819": {"nombre": "MATIAS GABRIEL MARQUEZ PEREIRA", "grupo": "B", "email": "mmatias.fmed@gmail.com"},
            "47564508": {"nombre": "MARIA VICTORIA BRIANO OXLEY", "grupo": "INDIVIDUAL", "email": "victoria.brox02@gmail.com"},
            "47792666": {"nombre": "LUC√çA MAR√çA RAMPA SPINELLI", "grupo": "A", "email": "luciarampa.s@gmail.com"},
            "47864275": {"nombre": "MARTINA IN√âS MORANDI MUTARELLI", "grupo": "A", "email": "martinamorandi12@gmail.com"},
            "47871555": {"nombre": "AGUST√çN FUMEAUX CASELLI", "grupo": "C", "email": "agufumo@hotmail.com"},
            "47995361": {"nombre": "BRUNO TOMAS LENZI RODRIGUEZ", "grupo": "A", "email": "brunol22222@gmail.com"},
            "48036978": {"nombre": "MAR√çA ALEJANDRA PRESNO SANDAR", "grupo": "C", "email": "ale.presno@hotmail.com"},
            "48082977": {"nombre": "GIMENA DENISSE LOZA ROSSI", "grupo": "INDIVIDUAL", "email": "gime.loza@gmail.com"},
            "48090483": {"nombre": "JOAQUIN GONZALEZ MOURELLE", "grupo": "C", "email": "joacogm15@gmail.com"},
            "48094655": {"nombre": "SOF√çA GUTIERREZ PASEYRO", "grupo": "A", "email": "sgutierrezp19@gmail.com"},
            "48170081": {"nombre": "JIMENA CABRERA TRAVERS", "grupo": "A", "email": "jimena.jct@hotmail.com"},
            "48178118": {"nombre": "FLORENCIA MAFFIOLI GUTIERREZ", "grupo": "A", "email": "florenciamaffioli@gmail.com"},
            "48244814": {"nombre": "RODRIGO URBAN VALENTINI", "grupo": "A", "email": "rodrigoonedrive@gmail.com"},
            "48344327": {"nombre": "GABRIEL EUGENIO ROCHA RICHART", "grupo": "A", "email": "grocharichart25@gmail.com"},
            "48361575": {"nombre": "AGUSTINA FERNANDA OGAZ IRIGOYEN", "grupo": "C", "email": "agustinaogaz@gmail.com"},
            "48369624": {"nombre": "YAMILA REBOLLO VAQUERO", "grupo": "B", "email": "yamilarebollo@gmail.com"},
            "48480444": {"nombre": "PATRICIA BELEN GARABEDIAN MARTINEZ", "grupo": "A", "email": "patogarabedian18@gmail.com"},
            "48550550": {"nombre": "CLAUDIA INES CES MARQUEZ", "grupo": "B", "email": "claudiacesmarquez@gmail.com"},
            "48581462": {"nombre": "LUCAS BENTANCOR CRISTINO", "grupo": "B", "email": "lubencri@gmail.com"},
            "48594633": {"nombre": "GABRIEL MART√çNEZ SALVADOR", "grupo": "B", "email": "gabosalvador1@gmail.com"},
            "48598526": {"nombre": "RAMIRO JULIAN NIN ALBONICO", "grupo": "B", "email": "ninramiro@gmail.com"},
            "48662644": {"nombre": "NICOLAS ANDRES CONSOLANDICH ROBALLO", "grupo": "C", "email": "nconsolandich@gmail.com"},
            "48691304": {"nombre": "DANIELA CASELLA N√ö√ëEZ", "grupo": "C", "email": "dani_casella@hotmail.com"},
            "48727581": {"nombre": "NICOLAS PEREIRA RODRIGUEZ", "grupo": "A", "email": "nico18094@gmail.com"},
            "48745131": {"nombre": "SABRINA PEREIRA RODRIGUEZ", "grupo": "B", "email": "pereirarodrisabri@gmail.com"},
            "48766749": {"nombre": "LEONARDO LA PAZ FIGUEREDO", "grupo": "B", "email": "leo-lapaz@hotmail.com"},
            "48802725": {"nombre": "DOMINIQUE GILARD BRUNO", "grupo": "C", "email": "dominique.gilard@gmail.com"},
            "48824848": {"nombre": "RODRIGO ANDRES VIOTTI ALAYON", "grupo": "C", "email": "rodrigo.viotti@hotmail.com"},
            "48832837": {"nombre": "GABRIELA MARISOL TALM√ìN TRAVERS", "grupo": "A", "email": "talmongabriela@gmail.com"},
            "48997285": {"nombre": "FLORENCIA VER√ìNICA REBOLIZ CARDOZO", "grupo": "A", "email": "flora1906@hotmail.com"},
            "49005631": {"nombre": "BRUNO NICOLAS DORNEL SOSA", "grupo": "A", "email": "brunodornel@hotmail.com"},
            "49013288": {"nombre": "LUCIA FERNANDEZ BERAMENDI", "grupo": "B", "email": "luciafber@gmail.com"},
            "49045081": {"nombre": "MIGUEL MATEO SANCHEZ SANCHIS", "grupo": "A", "email": "mmateo.sanchez97@gmail.com"},
            "49060764": {"nombre": "LUC√çA PEREIRA SEMPERENA", "grupo": "A", "email": "luciapeereira06@gmail.com"},
            "49149136": {"nombre": "MICHELLE MARROIG SANTOS", "grupo": "C", "email": "michellemarroig5699@gmail.com"},
            "49216789": {"nombre": "JOAQUIN RODRIGUEZ PIANA", "grupo": "A", "email": "joaquinrodriguezpiana@gmail.com"},
            "49238476": {"nombre": "LUCIA LESCOUMES ALVES", "grupo": "C", "email": "lucialescoumes@gmail.com"},
            "49246528": {"nombre": "IGNACIO SI√âCOLA TECHEIRA", "grupo": "B", "email": "n-ac-ho28@hotmail.com"},
            "49266267": {"nombre": "DANIELA TRINDADE DE LOS SANTOS", "grupo": "C", "email": "danielatrindadedelossantos@gmail.com"},
            "49273848": {"nombre": "PAULA AGUSTINA ALAMON FRANCHI", "grupo": "C", "email": "paula.alamon@gmail.com"},
            "49281768": {"nombre": "SOF√çA PLACERES ITURRIA", "grupo": "C", "email": "sofiplaceres@hotmail.com"},
            "49289801": {"nombre": "JOS√â OCTAVIO SALAZAR VAZ", "grupo": "A", "email": "osalazar1995@gmail.com"},
            "49300251": {"nombre": "LETICIA VICTORIA RODRIGUEZ FALERO", "grupo": "A", "email": "leticiarfalero@gmail.com"},
            "49445136": {"nombre": "FEDERICO JAVIER BARBIERI ACEVEDO", "grupo": "A", "email": "fedebarbieri641@gmail.com"},
            "49480984": {"nombre": "CAMILA DENISS SASTRE MENESES", "grupo": "C", "email": "camilasastre2019@gmail.com"},
            "49557311": {"nombre": "MAITE AGUIRRE MU√ëOZ", "grupo": "A", "email": "maiteagui@gmail.com"},
            "49730258": {"nombre": "MAYRA TALIA LIBAN√âS MART√çNEZ", "grupo": "B", "email": "mayratlibanesm9915@gmail.com"},
            "49761819": {"nombre": "JULIA TABO GONZALEZ", "grupo": "C", "email": "juliatabogonzalez@gmail.com"},
            "50048214": {"nombre": "FLAVIA MARIANA HERN√ÅNDEZ RODRIGUEZ", "grupo": "B", "email": "flahernandez12@gmail.com"},
            "50133780": {"nombre": "MAR√çA AGUSTINA CAMPA√ëA GARC√çA", "grupo": "A", "email": "agustinacamp1897@hotmail.com"},
            "50499192": {"nombre": "VALENTINA PALERMO VIOLA", "grupo": "A", "email": "vale20794@gmail.com"},
            "50688666": {"nombre": "ANGELA ESTEVES GINI", "grupo": "B", "email": "estevesangela@outlook.com"},
            "50771623": {"nombre": "HUGO PABLO NOCEDO PAZ", "grupo": "C", "email": "hugonocedopaz@gmail.com"},
            "50788135": {"nombre": "CRISTIAN ANDRES ROJAS RIPPA", "grupo": "A", "email": "cristian_rojas_16@hotmail.com"},
            "50823866": {"nombre": "ELOISA ARIAS PANDOLFO", "grupo": "A", "email": "eloisaariaspandolfo@gmail.com"},
            "50932851": {"nombre": "MARCOS BELOQUI SU√ÅREZ", "grupo": "C", "email": "marcosbeloqui1@gmail.com"},
            "51008116": {"nombre": "LARISSA SCHEFFEL PEREIRA", "grupo": "A", "email": "lisa.schep@hotmail.com"},
            "51229643": {"nombre": "AGUSTINA MU√ëOZ LINCK", "grupo": "C", "email": "agustinamunoz8299@gmail.com"},
            "51351012": {"nombre": "SOF√çA DRAPER RIVAS", "grupo": "B", "email": "sofidraper@gmail.com"},
            "51441641": {"nombre": "SOF√çA LASSERRE BLANCO", "grupo": "A", "email": "sofialasserre@hotmail.com"},
            "51505891": {"nombre": "DANIEL RU√çZ NU√ëEZ", "grupo": "C", "email": "dani2516ru@gmail.com"},
            "51641714": {"nombre": "RODRIGO FACUNDO GIANOLI OLIVERA", "grupo": "B", "email": "facugianoli@gmail.com"},
            "52070019": {"nombre": "MAITE BARITUSSIO BACCHETTA", "grupo": "C", "email": "maitebaritussiob@gmail.com"},
            "52180967": {"nombre": "CATALINA KAVEDJIAN KADAHDJIAN", "grupo": "C", "email": "ckavedjian@gmail.com"},
            "52877994": {"nombre": "BERNARDO CORIA GUTIERREZ", "grupo": "C", "email": "ber.coria@hotmail.com"},
            "52886573": {"nombre": "RODRIGO ARANCO ERSERGUER", "grupo": "B", "email": "ro.31616@gmail.com"},
            "52967614": {"nombre": "MARIA BELEN CAMPOS REGUEIRA", "grupo": "B", "email": "mbcregueira@gmail.com"},
            "53004996": {"nombre": "PAOLA GIMENA ESTEVES BENITEZ", "grupo": "C", "email": "paola.esteves2@gmail.com"},
            "53121384": {"nombre": "DIEGO PEREYRA SANSBERRO", "grupo": "C", "email": "diego.zelide@gmail.com"},
            "53711612": {"nombre": "JOAQUIN BARRIOS FRUMENTO", "grupo": "B", "email": "joaquinbfm@hotmail.com"},
            "53821203": {"nombre": "KEVIN MICHEL FERNANDEZ HERNANDEZ", "grupo": "B", "email": "kevinferher98@gmail.com"},
            "53869354": {"nombre": "PAULA CASTELLANOS CUADRADO", "grupo": "B", "email": "paulacastellanos123@gmail.com"},
            "54889135": {"nombre": "VICTORIA BEL√âN GREEN LIMA", "grupo": "C", "email": "belen-green96@hotmail.com"},
            "58934697": {"nombre": "ROBERTO ALEJANDRO FAROLINI SEPULVEDA", "grupo": "B", "email": "roafarolini@gmail.com"},
            "59564332": {"nombre": "JOANA STENS RAMOS DE LOS REYES", "grupo": "B", "email": "joanastensr@gmail.com"},
            "61693599": {"nombre": "JULIO ALBERTO ALVARENGA MEL√âNDEZ", "grupo": "A", "email": "julioalvareng@gmail.com"},
            "61815268": {"nombre": "RUBI DEL ROCIO RODRIGUEZ AYALA", "grupo": "C", "email": "rubsrodz@outlook.es"},
            "63176779": {"nombre": "LUIS EMIRO BUENO PRATO", "grupo": "C", "email": "lubukaga@gmail.com"},
            "64138340": {"nombre": "ROBERTO CARLOS GUTIERREZ VERDECIA", "grupo": "B", "email": "betogtz.1993@gmail.com"},
            "64251061": {"nombre": "MARIO JOSE CRIOLLO GUILLEN", "grupo": "A", "email": "mjcg1990@hotmail.com"},
            "65064201": {"nombre": "LUIS MANUEL RODRIGUEZ OYUELA", "grupo": "B", "email": "luismrod10@gmail.com"},
            "65162506": {"nombre": "GUILLERMO ANDR√âS ORTEGA NARV√ÅEZ", "grupo": "B", "email": "sirandresxy28@gmail.com"},
            "65354721": {"nombre": "CARLOS MANUEL ALONSO ARANGO", "grupo": "A", "email": "carlosmanuelalonso95@gmail.com"},
            "65608596": {"nombre": "ENCIS CRISTIAN CISNEROS REA", "grupo": "B", "email": "quique_cdo94@hotmail.com"}
        };
        
        // Categor√≠as graciosas por nivel (30 niveles √∫nicos)
        const LEVEL_CATEGORIES = {
            1: { name: "üõí Vendedor de Globos", concept: "Identific√°s un coraz√≥n en el diagrama, pero pens√°s que es decorativo" },
            2: { name: "üçï Repartidor de Pizza", concept: "Conoc√©s las arterias... porque las recorr√©s en bicicleta por la ciudad" },
            3: { name: "üöó Conductor de Uber", concept: "Sab√©s de circulaci√≥n, pero te refer√≠s al tr√°fico vehicular" },
            4: { name: "üé≠ Actor de Telenovelas", concept: "Pod√©s fingir un infarto convincentemente en pantalla" },
            5: { name: "üîß Plomero Card√≠aco", concept: "Entend√©s que hay tuber√≠as y bombas, pero no est√°s seguro para qu√© sirven" },
            6: { name: "üìö Estudiante Perdido", concept: "Abriste un libro de medicina y no te desmayaste. ¬°Progreso!" },
            7: { name: "üîç Detective de Google", concept: "Pod√©s diagnosticar cualquier s√≠ntoma... seg√∫n el primer resultado de b√∫squeda" },
            8: { name: "üíä Farmac√©utico Novato", concept: "Sab√©s que el coraz√≥n bombea algo, pero no est√°s seguro si es sangre o esperanza" },
            9: { name: "üè• Visitante de Hospital", concept: "Conoc√©s el hospital por dentro porque te perd√©s cada vez que ven√≠s" },
            10: { name: "ü©∫ Interno Somnoliento", concept: "Pod√©s identificar un estetoscopio, aunque lo us√©s al rev√©s" },
            11: { name: "üìñ Estudiante de Medicina", concept: "Memorizaste los nombres de las c√°maras card√≠acas (con algunos errores menores)" },
            12: { name: "üíâ Enfermero Principiante", concept: "Distingu√≠s entre taquicardia y bradicardia, pero a√∫n confund√≠s cu√°l es cu√°l" },
            13: { name: "üî¨ Laboratorista Curioso", concept: "Sab√©s que los an√°lisis dicen algo importante, pero preguntas qu√© significan" },
            14: { name: "üìä T√©cnico en ECG", concept: "Pod√©s poner electrodos sin electrocutar al paciente (la mayor√≠a de las veces)" },
            15: { name: "üè• Residente Junior", concept: "Empez√°s a entender que 'miocardiopat√≠a' no es una fobia al trabajo" },
            16: { name: "ü©∫ M√©dico General", concept: "Sab√©s cu√°ndo derivar al cardi√≥logo... despu√©s de intentar todo lo dem√°s" },
            17: { name: "‚ù§Ô∏è Aspirante a Cardi√≥logo", concept: "Las miocardiopat√≠as infiltrativas ya no te suenan a ciencia ficci√≥n" },
            18: { name: "üî¨ Fellow Entusiasta", concept: "Pod√©s pronunciar 'amiloidosis' sin trabarte (casi siempre)" },
            19: { name: "üìö Especialista en Formaci√≥n", concept: "Distingu√≠s entre amiloidosis y hemocromatosis sin consultar Google" },
            20: { name: "üéØ Cardi√≥logo Competente", concept: "Tus diagn√≥sticos ya no dependen exclusivamente de la suerte" },
            21: { name: "üèÜ Especialista Reconocido", concept: "Los pacientes te buscan espec√≠ficamente para miocardiopat√≠as infiltrativas" },
            22: { name: "üìñ Profesor de Cardiolog√≠a", concept: "Pod√©s explicar la fisiopatolog√≠a sin que se duerman tus estudiantes" },
            23: { name: "üî¨ Investigador Cl√≠nico", concept: "Tus papers sobre infiltrativas son citados por otros (¬°m√°s de 3 veces!)" },
            24: { name: "üåü Referente Nacional", concept: "Te consultan desde otros pa√≠ses sobre casos complejos" },
            25: { name: "üéñÔ∏è Maestro Internacional", concept: "Desarrollaste tu propia clasificaci√≥n de miocardiopat√≠as infiltrativas" },
            26: { name: "üëë Leyenda Viviente", concept: "Los fellows hacen peregrinaci√≥n para aprender de tu sabidur√≠a" },
            27: { name: "üßô‚Äç‚ôÇÔ∏è Gur√∫ de las Infiltrativas", concept: "Predec√≠s infiltraciones card√≠acas con solo mirar al paciente" },
            28: { name: "‚ö° Or√°culo Cardiol√≥gico", concept: "Tu conocimiento trasciende lo humano. Los protocolos se escriben basados en tus visiones" },
            29: { name: "üåå Deidad de la Cardiolog√≠a", concept: "Has alcanzado la iluminaci√≥n. Las miocardiopat√≠as se infiltran ante tu presencia" },
            30: { name: "‚ôæÔ∏è Maestro del Universo Card√≠aco", concept: "Sos uno con el cosmos cardiol√≥gico. Las infiltrativas son tu lenguaje nativo" }
        };
        
        // Cargar banco de preguntas
        async function loadQuestionBank() {
            const loadingDiv = document.getElementById('questionsLoading');
            const errorDiv = document.getElementById('questionsError');
            const successDiv = document.getElementById('questionsSuccess');
            const startBtn = document.getElementById('startGameBtn');
            
            try {
                // Mostrar estado de carga
                if (loadingDiv) loadingDiv.style.display = 'block';
                if (errorDiv) errorDiv.style.display = 'none';
                if (successDiv) successDiv.style.display = 'none';
                if (startBtn) startBtn.disabled = true;
                
                const response = await fetch('questions_bank.json');
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status} - No se pudo cargar questions_bank.json`);
                }
                
                const data = await response.json();
                
                if (!Array.isArray(data) || data.length === 0) {
                    throw new Error('El archivo questions_bank.json est√° vac√≠o o no es un array v√°lido');
                }
                
                questionBank = data;
                console.log(`‚úÖ Banco de preguntas cargado: ${questionBank.length} preguntas`);
                
                // Validar estructura de preguntas
                const invalidQuestions = questionBank.filter(q => 
                    !q.id || !q.level || !q.question || !q.options || 
                    !Array.isArray(q.options) || q.options.length !== 4 ||
                    !q.options.some(opt => opt.correct === true)
                );
                
                if (invalidQuestions.length > 0) {
                    console.warn(`‚ö†Ô∏è ${invalidQuestions.length} preguntas con formato inv√°lido encontradas`);
                }
                
                // Mostrar √©xito
                if (loadingDiv) loadingDiv.style.display = 'none';
                if (successDiv) {
                    successDiv.style.display = 'block';
                    successDiv.textContent = `‚úÖ ${questionBank.length} preguntas cargadas correctamente`;
                }
                if (startBtn) startBtn.disabled = false;
                
            } catch (error) {
                console.error('‚ùå Error cargando banco de preguntas:', error);
                
                // Mostrar error
                if (loadingDiv) loadingDiv.style.display = 'none';
                if (errorDiv) {
                    errorDiv.style.display = 'block';
                    errorDiv.textContent = `‚ùå ${error.message}`;
                }
                if (startBtn) {
                    startBtn.disabled = true;
                    startBtn.textContent = '‚ùå No se pueden cargar preguntas';
                }
                
                questionBank = [];
                throw error;
            }
        }
        
        // Funciones de navegaci√≥n
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.nav-tab').forEach(navTab => {
                navTab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            switch(tabName) {
                case 'dashboard':
                    console.log('üìä Cargando dashboard...');
                    loadDashboard();
                    break;
                case 'individual':
                    loadIndividualRanking();
                    break;
                case 'equipos':
                    loadDetailedTeamRankings();
                    break;
                case 'game':
                    resetGameInterface();
                    break;
            }
        }
        
        // Funciones del juego principal
        function checkParticipantInfo() {
            const cedula = document.getElementById('playerId').value.trim();
            const infoDiv = document.getElementById('participantInfo');
            
            if (!/^\d{6,8}$/.test(cedula)) {
                infoDiv.style.display = 'none';
                return;
            }
            
            const participantInfo = getParticipantInfo(cedula);
            const assignedGroup = getAutoAssignedGroup(cedula);
            
            if (participantInfo) {
                // Participante registrado en el foro
                infoDiv.innerHTML = `
                    <h3 style="color: #22c55e; margin-bottom: 8px;">‚úÖ Participante Registrado</h3>
                    <p><strong>Nombre en foro:</strong> ${participantInfo.nombre}</p>
                    <p><strong>Modalidad asignada:</strong> ${assignedGroup === 'INDIVIDUAL' ? 'üèÜ Individual' : 'üë• Grupo ' + assignedGroup}</p>
                    <p style="color: #94a3b8; font-size: 0.875rem; margin-top: 8px;">
                        Tu grupo ha sido asignado autom√°ticamente seg√∫n el registro del foro.
                    </p>
                `;
                infoDiv.style.display = 'block';
                infoDiv.style.borderColor = 'rgba(34, 197, 94, 0.3)';
                infoDiv.style.backgroundColor = 'rgba(34, 197, 94, 0.1)';
            } else {
                // No registrado en el foro
                infoDiv.innerHTML = `
                    <h3 style="color: #f59e0b; margin-bottom: 8px;">‚ÑπÔ∏è Participante No Registrado</h3>
                    <p><strong>Modalidad asignada:</strong> üèÜ Individual</p>
                    <p style="color: #94a3b8; font-size: 0.875rem; margin-top: 8px;">
                        No est√°s registrado en los grupos del foro, participar√°s de forma individual.
                    </p>
                `;
                infoDiv.style.display = 'block';
                infoDiv.style.borderColor = 'rgba(245, 158, 11, 0.3)';
                infoDiv.style.backgroundColor = 'rgba(245, 158, 11, 0.1)';
            }
        }
        
        async function startGame() {
            // Prevenir m√∫ltiples inicios simult√°neos
            if (gameInProgress) {
                console.log('‚ö†Ô∏è Juego ya en progreso, ignorando intento de inicio');
                return;
            }

            const name = document.getElementById('playerName').value.trim();
            const nickname = document.getElementById('playerNickname').value.trim();
            const id = document.getElementById('playerId').value.trim();
            
            if (!name || !nickname || !id) {
                alert('Por favor, complet√° todos los campos');
                return;
            }
            
            // Validar formato de c√©dula
            if (!/^\d{6,8}$/.test(id)) {
                alert('La c√©dula debe tener entre 6 y 8 d√≠gitos, sin d√≠gito verificador');
                return;
            }
            
            // Validar pseud√≥nimo
            if (!/^[a-zA-Z0-9_√°√©√≠√≥√∫√º√±√Å√â√ç√ì√ö√ú√ë]{3,20}$/.test(nickname)) {
                alert('El pseud√≥nimo debe tener entre 3 y 20 caracteres (letras, n√∫meros y _ solamente)');
                return;
            }
            
            // Asignar grupo autom√°ticamente
            const team = getAutoAssignedGroup(id);
            const participantInfo = getParticipantInfo(id);
            
            // Marcar juego en progreso
            gameInProgress = true;
            resultAlreadySaved = false;
            
            try {
                // Verificar intentos previos usando la nueva funci√≥n que considera resets
                console.log(`üîç Verificando intentos para c√©dula: ${id}`);
                playerAttempts = await checkAttemptsWithReset(id);
                
                console.log(`üìä Intentos actuales: ${playerAttempts} de ${MAX_ATTEMPTS} permitidos`);
                
                if (playerAttempts >= MAX_ATTEMPTS) {
                    gameInProgress = false;
                    alert(`Ya has usado tus ${MAX_ATTEMPTS} intentos permitidos.\n\nSi crees que esto es un error, contacta al administrador.\n\nNota: Los intentos se resetean peri√≥dicamente.`);
                    return;
                }
                
                if (playerAttempts > 0) {
                    document.getElementById('intentosMessage').style.display = 'block';
                    document.getElementById('intentosMessage').textContent = 
                        `‚ö†Ô∏è Este es tu intento ${playerAttempts + 1} de ${MAX_ATTEMPTS}`;
                }
                
            } catch (error) {
                console.error('Error verificando intentos:', error);
                gameInProgress = false;
                alert('Error al verificar intentos previos. Intenta nuevamente.');
                return;
            }
            
            // Configurar jugador
            currentPlayer = { 
                name, 
                nickname, 
                id, 
                team,
                foroName: participantInfo ? participantInfo.nombre : null
            };
            
            // Verificar que las preguntas est√©n cargadas antes de iniciar
            if (questionBank.length === 0) {
                gameInProgress = false;
                alert('‚ùå Error: No se pueden cargar las preguntas. Verifica que el archivo questions_bank.json existe y es v√°lido.');
                return;
            }
            
            // Mostrar mensaje de confirmaci√≥n
            const teamDisplay = team === 'INDIVIDUAL' ? 'Individual' : `Grupo ${team}`;
            const confirmMessage = participantInfo 
                ? `¬°Bienvenido ${nickname}!\n\nRegistrado como: ${participantInfo.nombre}\nModalidad: ${teamDisplay}\n\nIntento ${playerAttempts + 1} de ${MAX_ATTEMPTS}\n\n¬°Comencemos la competencia!`
                : `¬°Bienvenido ${nickname}!\n\nModalidad: ${teamDisplay}\n\nIntento ${playerAttempts + 1} de ${MAX_ATTEMPTS}\n\n¬°Comencemos la competencia!`;
            
            if (!confirm(confirmMessage)) {
                gameInProgress = false;
                return;
            }
            
            try {
                // Registrar inicio de partida con ID √∫nico
                gameStartId = database.ref('gameStarts').push().key;
                await database.ref(`gameStarts/${gameStartId}`).set({
                    cedula: id,
                    pseudonimo: nickname,
                    grupo: team,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    completed: false,
                    currentLevel: 1,
                    currentScore: 0,
                    sessionId: currentSessionId
                });
                
                console.log(`‚úÖ Partida registrada con ID: ${gameStartId}`);
                
            } catch (error) {
                console.error('Error registrando inicio:', error);
                gameInProgress = false;
                alert('Error al iniciar la partida. Intenta nuevamente.');
                return;
            }
            
            // Inicializar juego
            resetGameState();
            showGameInterface();
            loadNextQuestion();
            
            showNotification(`üéÆ ¬°${nickname} ha comenzado la competencia en ${teamDisplay}!`);
        }
        
        function resetGameState() {
            currentLevel = 1;
            score = 0;
            lives = 3;
            maxLevelReached = 1;
            answeredQuestions = new Set();
            comodines = { fifty: true, change: true };
            correctStreak = 0;
            selectedOption = null;
            eliminated5050 = false;
        }
        
        function showGameInterface() {
            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('gameInterface').style.display = 'block';
            document.getElementById('resultScreen').style.display = 'none';
            
            updateGameDisplay();
        }
        
        function updateGameDisplay() {
            document.getElementById('gameLevel').textContent = currentLevel;
            document.getElementById('gameScore').textContent = score;
            
            // Actualizar vidas
            const heartsArray = Array(3).fill('üñ§');
            for (let i = 0; i < lives; i++) {
                heartsArray[i] = '‚ù§Ô∏è';
            }
            document.getElementById('gameLives').textContent = heartsArray.join('');
            
            // Actualizar indicador de nivel
            const levelName = getLevelName(currentLevel);
            document.getElementById('levelIndicator').textContent = `Nivel ${currentLevel} - ${levelName}`;
            
            // Actualizar barra de progreso
            const progress = (currentLevel / TOTAL_LEVELS) * 100;
            document.getElementById('progressFill').style.width = `${progress}%`;
            
            // Actualizar comodines
            document.getElementById('comodin5050').className = comodines.fifty ? 'comodin' : 'comodin used';
            document.getElementById('comodinChange').className = comodines.change ? 'comodin' : 'comodin used';
        }
        
        function getLevelName(level) {
            return LEVEL_CATEGORIES[level] ? LEVEL_CATEGORIES[level].name : "üõí Vendedor de Globos";
        }
        
        function getLevelConcept(level) {
            return LEVEL_CATEGORIES[level] ? LEVEL_CATEGORIES[level].concept : "Algo sali√≥ mal en el universo cardiol√≥gico...";
        }
        
        function getAutoAssignedGroup(cedula) {
            if (FORO_PARTICIPANTS[cedula]) {
                return FORO_PARTICIPANTS[cedula].grupo;
            }
            return 'INDIVIDUAL'; // Si no est√° en el foro, va como individual
        }
        
        function getParticipantInfo(cedula) {
            return FORO_PARTICIPANTS[cedula] || null;
        }
        
        async function loadNextQuestion() {
            // Verificar que el banco de preguntas est√© cargado
            if (questionBank.length === 0) {
                showNotification('‚ùå Error: No hay preguntas disponibles. Verifica questions_bank.json', 5000);
                gameOver();
                return;
            }
            
            // Filtrar preguntas del nivel actual que no han sido respondidas
            const levelQuestions = questionBank.filter(q => 
                q.level === currentLevel && !answeredQuestions.has(q.id)
            );
            
            if (levelQuestions.length === 0) {
                // Si no hay m√°s preguntas de este nivel, buscar en niveles cercanos
                const nearbyLevels = [currentLevel - 1, currentLevel + 1, currentLevel - 2, currentLevel + 2]
                    .filter(level => level >= 1 && level <= TOTAL_LEVELS);
                
                let foundQuestion = null;
                for (const level of nearbyLevels) {
                    const availableQuestions = questionBank.filter(q => 
                        q.level === level && !answeredQuestions.has(q.id)
                    );
                    if (availableQuestions.length > 0) {
                        foundQuestion = availableQuestions[Math.floor(Math.random() * availableQuestions.length)];
                        break;
                    }
                }
                
                if (!foundQuestion) {
                    // Si no hay m√°s preguntas disponibles en absoluto
                    showNotification('üéâ ¬°Has agotado todas las preguntas disponibles!', 3000);
                    completeGame();
                    return;
                }
                
                currentQuestion = foundQuestion;
            } else {
                currentQuestion = levelQuestions[Math.floor(Math.random() * levelQuestions.length)];
            }
            
            // Marcar pregunta como respondida
            answeredQuestions.add(currentQuestion.id);
            
            // Mostrar pregunta
            displayQuestion();
            startTimer();
        }
        
        function displayQuestion() {
            document.getElementById('questionText').textContent = currentQuestion.question;
            
            // Mezclar opciones
            shuffledOptions = [...currentQuestion.options].sort(() => Math.random() - 0.5);
            eliminated5050 = false;
            selectedOption = null;
            
            const container = document.getElementById('optionsContainer');
            container.innerHTML = '';
            
            shuffledOptions.forEach((option, index) => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'option';
                optionDiv.textContent = `${String.fromCharCode(65 + index)}. ${option.text}`;
                optionDiv.onclick = () => selectOption(index, optionDiv);
                container.appendChild(optionDiv);
            });
            
            document.getElementById('confirmAnswer').disabled = true;
        }
        
        function selectOption(index, element) {
            // Limpiar selecci√≥n anterior
            document.querySelectorAll('.option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            // Seleccionar nueva opci√≥n
            element.classList.add('selected');
            selectedOption = index;
            document.getElementById('confirmAnswer').disabled = false;
        }
        
        function startTimer() {
            timeLeft = TIMER_SECONDS;
            updateTimer();
            
            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimer();
                
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    timeUp();
                }
            }, 1000);
        }
        
        function updateTimer() {
            const timerElement = document.getElementById('gameTimer');
            timerElement.textContent = timeLeft;
            
            if (timeLeft <= 5) {
                timerElement.classList.add('warning');
            } else {
                timerElement.classList.remove('warning');
            }
        }
        
        function timeUp() {
            showNotification('‚è∞ ¬°Tiempo agotado!');
            wrongAnswer();
        }
        
        function confirmAnswer() {
            if (selectedOption === null) return;
            
            clearInterval(timerInterval);
            
            const selected = shuffledOptions[selectedOption];
            const options = document.querySelectorAll('.option');
            
            if (selected.correct) {
                // Respuesta correcta
                options[selectedOption].classList.add('correct');
                correctAnswer();
            } else {
                // Respuesta incorrecta
                options[selectedOption].classList.add('incorrect');
                
                // Mostrar respuesta correcta
                shuffledOptions.forEach((option, index) => {
                    if (option.correct) {
                        options[index].classList.add('correct');
                    }
                });
                
                wrongAnswer();
            }
            
            // Deshabilitar todas las opciones
            options.forEach(opt => {
                opt.onclick = null;
                opt.style.cursor = 'default';
            });
            
            document.getElementById('confirmAnswer').disabled = true;
        }
        
        function correctAnswer() {
            correctStreak++;
            
            // Sistema de puntaje seg√∫n README de Rafael Mila
            let points = SCORING_SYSTEM.BASE_POINTS; // +1 punto base
            let bonusMessages = [];
            
            // +1 punto bonus por respuesta r√°pida (‚â•20 segundos restantes)
            if (timeLeft >= SCORING_SYSTEM.TIME_BONUS_THRESHOLD) {
                points += SCORING_SYSTEM.TIME_BONUS_POINTS;
                bonusMessages.push('‚ö° +1 Bonus por velocidad!');
            }
            
            // +1 punto bonus por niveles dif√≠ciles (20-30)
            if (currentLevel >= SCORING_SYSTEM.HARD_LEVEL_THRESHOLD) {
                points += SCORING_SYSTEM.HARD_LEVEL_BONUS;
                bonusMessages.push('üî• +1 Bonus por nivel dif√≠cil!');
            }
            
            // Bonus por rachas
            if (correctStreak === 5) {
                points += SCORING_SYSTEM.STREAK_BONUS_5;
                bonusMessages.push('üéØ +3 Bonus por 5 seguidas!');
            } else if (correctStreak === 10) {
                points += SCORING_SYSTEM.STREAK_BONUS_10;
                bonusMessages.push('üî• +5 Bonus por 10 seguidas!');
            }
            
            // Aplicar puntaje
            score += points;
            currentLevel++;
            maxLevelReached = Math.max(maxLevelReached, currentLevel);
            
            // Mostrar mensajes de bonus
            if (bonusMessages.length > 0) {
                bonusMessages.forEach((message, index) => {
                    setTimeout(() => showNotification(message), index * 800);
                });
            }
            
            updateGameDisplay();
            
            setTimeout(() => {
                if (currentLevel > TOTAL_LEVELS) {
                    // +10 puntos bonus por completar los 30 niveles
                    score += SCORING_SYSTEM.PERFECT_GAME_BONUS;
                    showNotification('üëë +10 Bonus por completar todos los niveles!');
                    setTimeout(() => completeGame(), 1500);
                } else {
                    loadNextQuestion();
                }
            }, 2000);
        }
        
        function wrongAnswer() {
            correctStreak = 0;
            lives--;
            updateGameDisplay();
            
            if (lives <= 0) {
                gameOver();
            } else {
                setTimeout(() => {
                    loadNextQuestion();
                }, 2000);
            }
        }
        
        function use5050() {
            if (!comodines.fifty || eliminated5050) return;
            
            comodines.fifty = false;
            eliminated5050 = true;
            updateGameDisplay();
            
            const options = document.querySelectorAll('.option');
            const incorrectOptions = [];
            
            shuffledOptions.forEach((option, index) => {
                if (!option.correct) {
                    incorrectOptions.push(index);
                }
            });
            
            // Eliminar 2 opciones incorrectas aleatoriamente
            const toEliminate = incorrectOptions.sort(() => Math.random() - 0.5).slice(0, 2);
            
            toEliminate.forEach(index => {
                options[index].classList.add('eliminated');
                options[index].onclick = null;
            });
            
            showNotification('üéØ 50/50 usado - 2 opciones eliminadas');
        }
        
        function changeQuestion() {
            if (!comodines.change) return;
            
            comodines.change = false;
            updateGameDisplay();
            
            clearInterval(timerInterval);
            
            // Quitar la pregunta actual de las respondidas para poder obtener otra
            answeredQuestions.delete(currentQuestion.id);
            
            loadNextQuestion();
            showNotification('üîÑ Pregunta cambiada');
        }
        
        async function completeGame() {
            clearInterval(timerInterval);
            
            // Actualizar estado de partida
            if (gameStartId) {
                try {
                    await database.ref(`gameStarts/${gameStartId}`).update({
                        completed: true,
                        finalLevel: currentLevel,
                        finalScore: score
                    });
                } catch (error) {
                    console.error('Error actualizando estado:', error);
                }
            }
            
            // Guardar resultado
            await saveGameResult();
            
            // Mostrar pantalla de resultados
            showResultScreen();
            
            // Forzar actualizaci√≥n del dashboard despu√©s de un momento
            setTimeout(() => {
                console.log('üîÑ Actualizando dashboard despu√©s de completar juego...');
                loadDashboard();
            }, 2000);
        }
        
        function gameOver() {
            completeGame();
        }
        
        // Funci√≥n para resetear todos los intentos y permitir que todos jueguen de nuevo
        async function resetAllAttempts() {
            if (!confirm('¬øRESETEAR TODOS LOS INTENTOS?\n\nEsto permitir√° que TODOS los jugadores vuelvan a jugar desde cero.\n\n‚ö†Ô∏è NO elimina los puntajes actuales, solo resetea el contador de intentos.\n\n¬øContinuar?')) {
                return;
            }
            
            if (!confirm('CONFIRMACI√ìN FINAL:\n\n¬øResetear el sistema de intentos para TODOS los participantes?\n\nTodos podr√°n volver a jugar 2 intentos m√°s.')) {
                return;
            }
            
            const confirmation = prompt('Escribe "RESET" para confirmar:');
            if (confirmation !== 'RESET') {
                alert('Reset cancelado.');
                return;
            }
            
            try {
                console.log('üîÑ Iniciando reset de intentos...');
                showNotification('üîÑ Reseteando sistema de intentos...', 3000);
                
                // Obtener todos los resultados actuales
                const snapshot = await database.ref('resultados').once('value');
                const results = snapshot.val();
                
                if (results) {
                    const resultsArray = Object.values(results);
                    const uniquePlayers = new Set();
                    
                    // Marcar todos los resultados existentes como "hist√≥ricos"
                    const updates = {};
                    Object.keys(results).forEach(key => {
                        updates[`resultados/${key}/esHistorico`] = true;
                        updates[`resultados/${key}/resetDate`] = new Date().toISOString();
                        uniquePlayers.add(results[key].cedula);
                    });
                    
                    await database.ref().update(updates);
                    
                    console.log(`‚úÖ Marcados ${Object.keys(updates).length/2} resultados como hist√≥ricos`);
                    console.log(`‚úÖ ${uniquePlayers.size} jugadores pueden volver a participar`);
                    
                    // Crear entrada en el log de resets
                    await database.ref('admin/resets').push({
                        timestamp: firebase.database.ServerValue.TIMESTAMP,
                        date: new Date().toLocaleDateString('es-UY'),
                        playersAffected: uniquePlayers.size,
                        resultsMarked: Object.keys(updates).length/2,
                        type: 'attempt_reset'
                    });
                    
                    alert(`‚úÖ RESET COMPLETADO\n\n${uniquePlayers.size} jugadores pueden volver a participar.\n\nLos puntajes anteriores se mantienen como hist√≥ricos.`);
                    
                } else {
                    alert('No hay datos para resetear.');
                }
                
                // Actualizar dashboard
                setTimeout(() => {
                    loadDashboard();
                }, 1000);
                
            } catch (error) {
                console.error('‚ùå Error en reset:', error);
                alert(`‚ùå Error en reset: ${error.message}`);
            }
        }
        
        // Funci√≥n para verificar intentos considerando resets
        async function checkAttemptsWithReset(cedula) {
            try {
                const snapshot = await database.ref('resultados')
                    .orderByChild('cedula')
                    .equalTo(cedula)
                    .once('value');
                
                const results = snapshot.val();
                if (!results) return 0;
                
                // Contar solo resultados que NO son hist√≥ricos
                const currentAttempts = Object.values(results)
                    .filter(result => !result.esHistorico)
                    .length;
                
                return currentAttempts;
                
            } catch (error) {
                console.error('Error verificando intentos:', error);
                return 0;
            }
        }
        
        async function saveGameResult() {
            // Prevenir guardado duplicado
            if (resultAlreadySaved) {
                console.log('‚ö†Ô∏è Resultado ya guardado, evitando duplicado');
                return;
            }
            
            resultAlreadySaved = true;
            
            try {
                const resultData = {
                    nombre: currentPlayer.name,
                    pseudonimo: currentPlayer.nickname,
                    cedula: currentPlayer.id,
                    grupo: currentPlayer.team,
                    puntaje: score,
                    nivel: maxLevelReached,
                    fecha: new Date().toLocaleDateString('es-UY'),
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    intentoNumero: playerAttempts + 1,
                    foroName: currentPlayer.foroName || null,
                    gameStartId: gameStartId, // Vincular con el inicio de partida
                    sessionId: currentSessionId
                };
                
                console.log('üíæ Guardando resultado:', resultData);
                
                const resultRef = await database.ref('resultados').push(resultData);
                console.log('‚úÖ Resultado guardado con ID:', resultRef.key);
                
                showNotification(`üéâ Resultado guardado: ${currentPlayer.nickname} - ${score} puntos`);
                
                // Forzar actualizaci√≥n del dashboard
                setTimeout(() => {
                    updateDashboardStats();
                    updateTeamRankings();
                }, 1000);
                
            } catch (error) {
                console.error('‚ùå Error guardando resultado:', error);
                resultAlreadySaved = false; // Permitir reintento
                showNotification('‚ùå Error guardando resultado. Verifica la conexi√≥n.', 3000);
            }
        }
        
        function showResultScreen() {
            document.getElementById('gameInterface').style.display = 'none';
            document.getElementById('resultScreen').style.display = 'block';
            
            const resultTitle = document.getElementById('resultTitle');
            const finalStats = document.getElementById('finalStats');
            
            // Obtener categor√≠a y concepto del nivel alcanzado
            const levelCategory = getLevelName(maxLevelReached);
            const levelConcept = getLevelConcept(maxLevelReached);
            
            if (currentLevel > TOTAL_LEVELS) {
                resultTitle.textContent = 'üëë ¬°PERFECTO!';
                resultTitle.className = 'result-title success';
            } else if (maxLevelReached >= 25) {
                resultTitle.textContent = 'üåü ¬°EXCEPCIONAL!';
                resultTitle.className = 'result-title success';
            } else if (maxLevelReached >= 20) {
                resultTitle.textContent = 'ü•á ¬°EXCELENTE!';
                resultTitle.className = 'result-title success';
            } else if (maxLevelReached >= 15) {
                resultTitle.textContent = 'ü•à ¬°MUY BIEN!';
                resultTitle.className = 'result-title success';
            } else if (maxLevelReached >= 10) {
                resultTitle.textContent = 'ü•â ¬°BIEN!';
                resultTitle.className = 'result-title success';
            } else {
                resultTitle.textContent = 'üìö ¬°A SEGUIR ESTUDIANDO!';
                resultTitle.className = 'result-title failure';
            }
            
            finalStats.innerHTML = `
                <div class="stats-row">
                    <span class="stats-label">Pseud√≥nimo:</span>
                    <span class="stats-value">${currentPlayer.nickname}</span>
                </div>
                <div class="stats-row">
                    <span class="stats-label">Modalidad:</span>
                    <span class="stats-value">${currentPlayer.team === 'INDIVIDUAL' ? 'Individual' : 'Grupo ' + currentPlayer.team}</span>
                </div>
                <div class="stats-row">
                    <span class="stats-label">Puntaje Final:</span>
                    <span class="stats-value">${score} puntos</span>
                </div>
                <div class="stats-row">
                    <span class="stats-label">Nivel Alcanzado:</span>
                    <span class="stats-value">${maxLevelReached} / ${TOTAL_LEVELS}</span>
                </div>
                <div class="stats-row">
                    <span class="stats-label">Categor√≠a:</span>
                    <span class="stats-value" style="font-size: 1rem;">${levelCategory}</span>
                </div>
                <div style="background: rgba(30, 41, 59, 0.4); border-radius: 8px; padding: 16px; margin: 16px 0; border: 1px solid rgba(59, 130, 246, 0.2);">
                    <div style="color: #94a3b8; font-size: 0.875rem; margin-bottom: 8px; font-weight: 600;">üí≠ Concepto de tu nivel:</div>
                    <div style="color: #e2e8f0; font-style: italic; line-height: 1.4;">"${levelConcept}"</div>
                </div>
                <div class="stats-row">
                    <span class="stats-label">Intento:</span>
                    <span class="stats-value">${playerAttempts + 1} / ${MAX_ATTEMPTS}</span>
                </div>
                ${currentPlayer.foroName ? `
                <div class="stats-row">
                    <span class="stats-label">Registrado como:</span>
                    <span class="stats-value" style="font-size: 0.875rem;">${currentPlayer.foroName}</span>
                </div>
                ` : ''}
            `;
        }
        
        function restartGame() {
            if (playerAttempts + 1 >= MAX_ATTEMPTS) {
                alert(`Has usado todos tus ${MAX_ATTEMPTS} intentos permitidos.\n\nSi necesitas m√°s intentos, contacta al administrador.`);
                goToDashboard();
                return;
            }
            
            // Resetear estado de progreso
            gameInProgress = false;
            resultAlreadySaved = false;
            
            resetGameInterface();
        }
        
        function resetGameInterface() {
            document.getElementById('startScreen').style.display = 'block';
            document.getElementById('gameInterface').style.display = 'none';
            document.getElementById('resultScreen').style.display = 'none';
            
            // Limpiar informaci√≥n del participante
            document.getElementById('participantInfo').style.display = 'none';
            document.getElementById('intentosMessage').style.display = 'none';
            
            // Resetear estado del juego
            gameInProgress = false;
            resultAlreadySaved = false;
            
            // Limpiar formulario solo si ya no puede jugar m√°s
            if (playerAttempts + 1 >= MAX_ATTEMPTS) {
                document.getElementById('playerName').value = '';
                document.getElementById('playerNickname').value = '';
                document.getElementById('playerId').value = '';
                document.getElementById('participantInfo').style.display = 'none';
            }
        }
        
        function quitGame() {
            if (confirm('¬øEst√°s seguro de que quer√©s abandonar el juego?')) {
                clearInterval(timerInterval);
                saveGameResult();
                goToDashboard();
            }
        }
        
        function goToDashboard() {
            console.log('üìä Navegando al dashboard...');
            showTab('dashboard');
            // Asegurarse de que el dashboard est√© actualizado
            setTimeout(() => loadDashboard(), 500);
        }
        
        // Funciones del dashboard (mantener las existentes)
        async         function loadDashboard() {
            console.log('üè† Cargando dashboard...');
            updateDashboardStats();
            updateTeamRankings();
            updateVisitCounters();
            updateOnlineCount();
            updateLastUpdate();
        }
        
        // Funci√≥n para refrescar manualmente el dashboard
        function refreshDashboard() {
            console.log('üîÑ Refrescando dashboard manualmente...');
            showNotification('üîÑ Actualizando dashboard...', 1500);
            loadDashboard();
        }
        
        async function loadIndividualRanking() {
            try {
                const snapshot = await database.ref('resultados').once('value');
                const results = snapshot.val();
                
                const container = document.getElementById('individual');
                
                if (!results) {
                    container.innerHTML = `
                        <h1>üèÜ Ranking Individual</h1>
                        <p class="subtitle">MEJORES PARTICIPANTES</p>
                        <div class="loading">No hay datos a√∫n. ¬°S√© el primero en jugar!</div>
                    `;
                    return;
                }
                
                const resultsArray = Object.values(results);
                
                // Obtener mejor resultado por jugador (por c√©dula)
                const uniqueResults = new Map();
                resultsArray.forEach(result => {
                    const existing = uniqueResults.get(result.cedula);
                    if (!existing || result.puntaje > existing.puntaje) {
                        uniqueResults.set(result.cedula, result);
                    }
                });
                
                const topResults = Array.from(uniqueResults.values())
                    .sort((a, b) => b.puntaje - a.puntaje)
                    .slice(0, 20);
                
                let html = `
                    <h1>üèÜ Ranking Individual</h1>
                    <p class="subtitle">MEJORES PARTICIPANTES</p>
                    <div class="dashboard-section">
                        <h2>üèÖ Top 20 Individual</h2>
                `;
                
                if (topResults.length > 0) {
                    html += '<div style="display: grid; gap: 12px;">';
                    
                    topResults.forEach((result, index) => {
                        const displayName = result.pseudonimo || result.nombre;
                        const teamDisplay = result.grupo === 'INDIVIDUAL' ? 'Individual' : `Grupo ${result.grupo}`;
                        
                        html += `
                            <div style="display: grid; grid-template-columns: 50px 2fr auto auto auto; gap: 16px; padding: 16px; background: rgba(15, 23, 42, 0.6); border-radius: 12px; align-items: center;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: #60a5fa; text-align: center; font-family: 'JetBrains Mono', monospace;">${index + 1}</div>
                                <div>
                                    <div style="font-weight: 600; color: #e2e8f0;">${displayName}</div>
                                </div>
                                <div style="padding: 4px 8px; border-radius: 8px; font-size: 0.75rem; font-weight: 600; ${result.grupo === 'INDIVIDUAL' ? 'background: rgba(139, 92, 246, 0.2); color: #8b5cf6;' : 'background: rgba(59, 130, 246, 0.2); color: #3b82f6;'}">${teamDisplay}</div>
                                <div style="font-family: 'JetBrains Mono', monospace; color: #3b82f6; font-weight: 600;">${result.puntaje} pts</div>
                                <div style="font-family: 'JetBrains Mono', monospace; color: #60a5fa; font-size: 0.875rem;">Nv.${result.nivel}</div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                } else {
                    html += '<div class="loading">No hay resultados para mostrar</div>';
                }
                
                html += '</div>';
                container.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading individual ranking:', error);
                document.getElementById('individual').innerHTML = `
                    <h1>üèÜ Ranking Individual</h1>
                    <p class="subtitle">MEJORES PARTICIPANTES</p>
                    <div class="loading">Error cargando datos</div>
                `;
            }
        }
        
        async function loadDetailedTeamRankings() {
            try {
                const snapshot = await database.ref('resultados').once('value');
                const results = snapshot.val();
                
                const container = document.getElementById('equipos');
                
                if (!results) {
                    container.innerHTML = `
                        <h1>üë• Competencia por Equipos</h1>
                        <p class="subtitle">RANKING DETALLADO POR GRUPO</p>
                        <div class="loading">No hay datos a√∫n. ¬°S√© el primero en jugar!</div>
                    `;
                    return;
                }
                
                const resultsArray = Object.values(results);
                
                // Agrupar por equipo y obtener mejor resultado por jugador
                const teamPlayers = {
                    A: new Map(),
                    B: new Map(),
                    C: new Map(),
                    INDIVIDUAL: new Map()
                };
                
                resultsArray.forEach(result => {
                    const team = result.grupo;
                    if (teamPlayers[team]) {
                        const existing = teamPlayers[team].get(result.cedula);
                        if (!existing || result.puntaje > existing.puntaje) {
                            teamPlayers[team].set(result.cedula, result);
                        }
                    }
                });
                
                let html = `
                    <h1>üë• Competencia por Equipos</h1>
                    <p class="subtitle">RANKING DETALLADO POR GRUPO</p>
                    <div class="dashboard-section">
                        <h2>üìä Estad√≠sticas por Equipo</h2>
                        <div class="team-rankings">
                `;
                
                ['A', 'B', 'C', 'INDIVIDUAL'].forEach(teamName => {
                    const players = Array.from(teamPlayers[teamName].values())
                        .sort((a, b) => b.puntaje - a.puntaje);
                    
                    const avgScore = players.length > 0 ? 
                        Math.round((players.reduce((sum, p) => sum + p.puntaje, 0) / players.length) * 10) / 10 : 0;
                    const maxLevel = players.length > 0 ? 
                        Math.max(...players.map(p => p.nivel)) : 0;
                    
                    const teamDisplayName = teamName === 'INDIVIDUAL' ? 'INDIVIDUAL' : `GRUPO ${teamName}`;
                    
                    let playersHTML = '';
                    players.slice(0, 10).forEach((player, index) => {
                        const displayName = player.pseudonimo || player.nombre;
                        playersHTML += `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; margin: 4px 0; background: rgba(30, 41, 59, 0.4); border-radius: 8px; font-size: 0.875rem;">
                                <span>${index + 1}. ${displayName}</span>
                                <span>${player.puntaje} pts - Nv.${player.nivel}</span>
                            </div>
                        `;
                    });
                    
                    html += `
                        <div class="team-section team-${teamName.toLowerCase()}">
                            <div class="team-header">
                                <div class="team-name">${teamDisplayName}</div>
                                <div class="team-stats">
                                    <span>üë• ${players.length}</span>
                                    <span>üèÜ ${avgScore} pts</span>
                                    <span>üìà Nv.${maxLevel}</span>
                                </div>
                            </div>
                            <div style="margin-top: 16px;">
                                <h3 style="color: #94a3b8; margin-bottom: 12px; font-size: 1rem;">Top 10 ${teamName === 'INDIVIDUAL' ? 'individual' : 'del grupo'}:</h3>
                                ${playersHTML || '<div style="color: #64748b; font-style: italic;">No hay participantes a√∫n</div>'}
                            </div>
                        </div>
                    `;
                });
                
                html += '</div></div>';
                container.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading detailed team rankings:', error);
                document.getElementById('equipos').innerHTML = `
                    <h1>üë• Competencia por Equipos</h1>
                    <p class="subtitle">RANKING DETALLADO POR GRUPO</p>
                    <div class="loading">Error cargando datos</div>
                `;
            }
        }
        
        // Funciones Firebase reales
        async function recordVisit() {
            try {
                const today = new Date().toDateString();
                const timestamp = Date.now();
                
                await database.ref('analytics/totalVisits').transaction((current) => (current || 0) + 1);
                await database.ref(`analytics/dailyVisits/${today}`).transaction((current) => (current || 0) + 1);
                
                const visitId = database.ref('analytics/visits').push().key;
                await database.ref(`analytics/visits/${visitId}`).set({
                    timestamp: timestamp,
                    date: today,
                    userAgent: navigator.userAgent,
                    ip: 'hidden'
                });
            } catch (error) {
                console.error('Error registrando visita:', error);
            }
        }
        
        async function trackOnlinePlayer() {
            try {
                const sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                currentSessionId = sessionId;
                
                const playerRef = database.ref(`analytics/onlinePlayers/${sessionId}`);
                await playerRef.set({
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    status: 'browsing'
                });
                
                playerRef.onDisconnect().remove();
            } catch (error) {
                console.error('Error tracking online player:', error);
            }
        }
        
        function setupFirebaseListeners() {
            // Listener para resultados - actualizar dashboard cuando cambien
            database.ref('resultados').on('value', (snapshot) => {
                console.log('üîÑ Datos de resultados actualizados');
                setTimeout(() => {
                    updateDashboardStats();
                    updateTeamRankings();
                }, 500);
            });
            
            // Listener para jugadores online
            database.ref('analytics/onlinePlayers').on('value', (snapshot) => {
                updateOnlineCount();
            });
            
            // Listener para visitas totales
            database.ref('analytics/totalVisits').on('value', (snapshot) => {
                updateVisitCounters();
            });
        }
        
        async function updateDashboardStats() {
            try {
                console.log('üìä Actualizando estad√≠sticas del dashboard...');
                
                const resultsSnapshot = await database.ref('resultados').once('value');
                const results = resultsSnapshot.val();
                
                const gameStartsSnapshot = await database.ref('gameStarts').once('value');
                const gameStarts = gameStartsSnapshot.val();
                
                if (results) {
                    const resultsArray = Object.values(results);
                    console.log(`üìà Procesando ${resultsArray.length} resultados`);
                    
                    const totalPlayers = resultsArray.length;
                    const totalGames = gameStarts ? Object.keys(gameStarts).length : 0;
                    const avgScore = totalPlayers > 0 ? resultsArray.reduce((sum, r) => sum + r.puntaje, 0) / totalPlayers : 0;
                    const maxLevel = totalPlayers > 0 ? Math.max(...resultsArray.map(r => r.nivel)) : 0;
                    
                    const today = new Date().toDateString();
                    const playersToday = resultsArray.filter(r => {
                        const resultDate = new Date(r.timestamp || 0).toDateString();
                        return resultDate === today;
                    }).length;
                    
                    // Actualizar elementos del DOM
                    const elements = {
                        totalJugadores: totalPlayers,
                        totalPartidas: totalGames,
                        promedioScore: Math.round(avgScore * 10) / 10,
                        nivelMaximo: maxLevel,
                        jugadoresHoy: playersToday
                    };
                    
                    Object.entries(elements).forEach(([id, value]) => {
                        const element = document.getElementById(id);
                        if (element) {
                            element.textContent = value;
                            console.log(`‚úÖ ${id}: ${value}`);
                        }
                    });
                    
                } else {
                    console.log('üìä No hay resultados a√∫n');
                    // Establecer valores en 0 si no hay datos
                    ['totalJugadores', 'totalPartidas', 'promedioScore', 'nivelMaximo', 'jugadoresHoy'].forEach(id => {
                        const element = document.getElementById(id);
                        if (element) element.textContent = '0';
                    });
                }
                
                console.log('‚úÖ Estad√≠sticas del dashboard actualizadas');
                
            } catch (error) {
                console.error('‚ùå Error actualizando estad√≠sticas:', error);
                // Mostrar error en los elementos
                ['totalJugadores', 'totalPartidas', 'promedioScore', 'nivelMaximo', 'jugadoresHoy'].forEach(id => {
                    const element = document.getElementById(id);
                    if (element) element.textContent = '-';
                });
            }
        }
        
        async function updateTeamRankings() {
            try {
                console.log('üë• Actualizando rankings de equipos (suma algebraica simplificada)...');
                
                const snapshot = await database.ref('resultados').once('value');
                const results = snapshot.val();
                
                const container = document.getElementById('teamRankings');
                
                if (!results) {
                    console.log('üë• No hay datos de equipos a√∫n');
                    container.innerHTML = '<div class="loading">No hay datos a√∫n. ¬°S√© el primero en jugar!</div>';
                    return;
                }
                
                const resultsArray = Object.values(results);
                console.log(`üë• Procesando ${resultsArray.length} resultados para equipos`);
                
                // Obtener MEJOR resultado por jugador (por c√©dula)
                const bestResultsByPlayer = new Map();
                resultsArray.forEach(result => {
                    const cedula = result.cedula;
                    const existing = bestResultsByPlayer.get(cedula);
                    if (!existing || result.puntaje > existing.puntaje) {
                        bestResultsByPlayer.set(cedula, result);
                    }
                });
                
                // Agrupar por equipo los MEJORES resultados
                const teamPlayers = {
                    A: [],
                    B: [],
                    C: [],
                    INDIVIDUAL: []
                };
                
                bestResultsByPlayer.forEach(result => {
                    const team = result.grupo;
                    if (teamPlayers[team]) {
                        teamPlayers[team].push(result);
                    } else {
                        console.warn(`‚ö†Ô∏è Grupo desconocido encontrado: ${team}`);
                    }
                });
                
                // Calcular estad√≠sticas SIMPLIFICADAS por equipo
                const teamStats = {};
                Object.keys(teamPlayers).forEach(team => {
                    const players = teamPlayers[team];
                    
                    // SUMA ALGEBRAICA SIMPLE del mejor intento de cada participante
                    const totalScore = players.reduce((sum, player) => sum + player.puntaje, 0);
                    
                    teamStats[team] = {
                        players: players.length,
                        totalScore: totalScore, // Suma total de puntos del equipo
                        avgScore: players.length > 0 ? 
                            Math.round((totalScore / players.length) * 10) / 10 : 0,
                        maxLevel: players.length > 0 ? 
                            Math.max(...players.map(p => p.nivel)) : 0
                    };
                    
                    console.log(`üìä Equipo ${team}: ${teamStats[team].players} jugadores, total ${teamStats[team].totalScore} pts, promedio ${teamStats[team].avgScore}`);
                });
                
                // Ordenar equipos por puntaje total (suma algebraica)
                const teamRanking = Object.entries(teamStats)
                    .filter(([team, stats]) => team !== 'INDIVIDUAL') // Separar individual
                    .sort(([,a], [,b]) => b.totalScore - a.totalScore);
                
                // Generar HTML
                container.innerHTML = '';
                
                // Mostrar ranking de equipos primero
                teamRanking.forEach(([teamName, stats], index) => {
                    const teamSection = document.createElement('div');
                    teamSection.className = `team-section team-${teamName.toLowerCase()}`;
                    
                    const position = index + 1;
                    const medal = position === 1 ? 'ü•á' : position === 2 ? 'ü•à' : position === 3 ? 'ü•â' : `${position}¬∞`;
                    
                    teamSection.innerHTML = `
                        <div class="team-header">
                            <div class="team-name">${medal} GRUPO ${teamName}</div>
                            <div class="team-stats">
                                <span>üë• ${stats.players}</span>
                                <span>üèÜ ${stats.totalScore} pts total</span>
                                <span>üìä ${stats.avgScore} promedio</span>
                                <span>üìà Nv.${stats.maxLevel} m√°ximo</span>
                            </div>
                        </div>
                    `;
                    
                    container.appendChild(teamSection);
                });
                
                // Mostrar individual al final
                const individualStats = teamStats['INDIVIDUAL'];
                if (individualStats && individualStats.players > 0) {
                    const teamSection = document.createElement('div');
                    teamSection.className = 'team-section team-individual';
                    
                    teamSection.innerHTML = `
                        <div class="team-header">
                            <div class="team-name">INDIVIDUAL</div>
                            <div class="team-stats">
                                <span>üë• ${individualStats.players}</span>
                                <span>üèÜ ${individualStats.totalScore} pts total</span>
                                <span>üìä ${individualStats.avgScore} promedio</span>
                                <span>üìà Nv.${individualStats.maxLevel} m√°ximo</span>
                            </div>
                        </div>
                    `;
                    
                    container.appendChild(teamSection);
                }
                
                console.log('‚úÖ Rankings de equipos actualizados con suma algebraica');
                
            } catch (error) {
                console.error('‚ùå Error actualizando rankings de equipos:', error);
                document.getElementById('teamRankings').innerHTML = '<div class="loading">Error cargando datos</div>';
            }
        }
        
        async function updateVisitCounters() {
            try {
                const totalSnapshot = await database.ref('analytics/totalVisits').once('value');
                const totalVisits = totalSnapshot.val() || 0;
                
                const today = new Date().toDateString();
                const todaySnapshot = await database.ref(`analytics/dailyVisits/${today}`).once('value');
                const visitsToday = todaySnapshot.val() || 0;
                
                const visitCountElement = document.getElementById('visitCount');
                const visitsTodayElement = document.getElementById('visitasHoy');
                
                if (visitCountElement) visitCountElement.textContent = totalVisits.toLocaleString();
                if (visitsTodayElement) visitsTodayElement.textContent = visitsToday;
                
            } catch (error) {
                console.error('Error updating visit counters:', error);
                const visitCountElement = document.getElementById('visitCount');
                const visitsTodayElement = document.getElementById('visitasHoy');
                
                if (visitCountElement) visitCountElement.textContent = '-';
                if (visitsTodayElement) visitsTodayElement.textContent = '-';
            }
        }
        
        async function updateOnlineCount() {
            try {
                const snapshot = await database.ref('analytics/onlinePlayers').once('value');
                const onlinePlayers = snapshot.val();
                
                const count = onlinePlayers ? Object.keys(onlinePlayers).length : 0;
                const onlineElement = document.getElementById('onlinePlayers');
                if (onlineElement) onlineElement.textContent = count;
                
            } catch (error) {
                console.error('Error updating online count:', error);
                const onlineElement = document.getElementById('onlinePlayers');
                if (onlineElement) onlineElement.textContent = '-';
            }
        }
        
        function updateLastUpdate() {
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('es-UY');
        }
        
        // Admin functions
        function verifyAdmin() {
            const password = document.getElementById('adminPassword').value;
            if (password === ADMIN_PASSWORD) {
                isAdminAuthenticated = true;
                document.getElementById('adminData').style.display = 'block';
                loadAdminData();
            } else {
                alert('Contrase√±a incorrecta');
            }
        }
        
        async function loadAdminData() {
            try {
                const snapshot = await database.ref('resultados').once('value');
                const results = snapshot.val();
                
                if (!results) {
                    document.getElementById('adminTable').innerHTML = '<p>No hay datos de participantes</p>';
                    return;
                }
                
                const resultsArray = Object.values(results);
                
                let html = `
                    <h4>üìä Resumen de Actividad</h4>
                    <p>Total de partidas completadas: ${resultsArray.length}</p>
                    <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
                        <thead>
                            <tr style="background: rgba(59, 130, 246, 0.2);">
                                <th style="padding: 8px; border: 1px solid #3b82f6;">Fecha</th>
                                <th style="padding: 8px; border: 1px solid #3b82f6;">Nombre Real</th>
                                <th style="padding: 8px; border: 1px solid #3b82f6;">Pseud√≥nimo</th>
                                <th style="padding: 8px; border: 1px solid #3b82f6;">C√©dula</th>
                                <th style="padding: 8px; border: 1px solid #3b82f6;">Modalidad</th>
                                <th style="padding: 8px; border: 1px solid #3b82f6;">Puntaje</th>
                                <th style="padding: 8px; border: 1px solid #3b82f6;">Nivel</th>
                                <th style="padding: 8px; border: 1px solid #3b82f6;">Intento</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                resultsArray
                    .sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0))
                    .forEach(result => {
                        html += `
                            <tr>
                                <td style="padding: 6px; border: 1px solid #64748b; font-size: 0.875rem;">${result.fecha || 'N/A'}</td>
                                <td style="padding: 6px; border: 1px solid #64748b;">${result.nombre}</td>
                                <td style="padding: 6px; border: 1px solid #64748b;">${result.pseudonimo}</td>
                                <td style="padding: 6px; border: 1px solid #64748b; font-family: monospace;">${result.cedula}</td>
                                <td style="padding: 6px; border: 1px solid #64748b;">${result.grupo === 'INDIVIDUAL' ? 'Individual' : 'Grupo ' + result.grupo}</td>
                                <td style="padding: 6px; border: 1px solid #64748b; font-weight: bold; color: #3b82f6;">${result.puntaje}</td>
                                <td style="padding: 6px; border: 1px solid #64748b;">${result.nivel}</td>
                                <td style="padding: 6px; border: 1px solid #64748b;">${result.intentoNumero || 1}</td>
                            </tr>
                        `;
                    });
                
                html += '</tbody></table>';
                
                document.getElementById('adminTable').innerHTML = html;
                
            } catch (error) {
                console.error('Error loading admin data:', error);
                document.getElementById('adminTable').innerHTML = '<p>Error cargando datos</p>';
            }
        }
        
        async function exportAdminData() {
            try {
                const snapshot = await database.ref('resultados').once('value');
                const results = snapshot.val();
                
                if (!results) {
                    alert('No hay datos para exportar');
                    return;
                }
                
                const resultsArray = Object.values(results);
                
                // Crear CSV
                let csv = 'Fecha,Nombre Real,Pseud√≥nimo,C√©dula,Modalidad,Puntaje,Nivel,Intento\n';
                
                resultsArray.forEach(result => {
                    csv += `"${result.fecha || 'N/A'}","${result.nombre}","${result.pseudonimo}","${result.cedula}","${result.grupo === 'INDIVIDUAL' ? 'Individual' : 'Grupo ' + result.grupo}","${result.puntaje}","${result.nivel}","${result.intentoNumero || 1}"\n`;
                });
                
                // Descargar archivo
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `cardiologia_resultados_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
            } catch (error) {
                console.error('Error exporting data:', error);
                alert('Error al exportar datos');
            }
        }
        
        async function clearAllData() {
            // Redirigir a la funci√≥n m√°s segura
            return await clearAllDataSafe();
        }
        
        // Sistema de notificaciones
        function showNotification(message, duration = 3000) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, duration);
        }
        
        function handleMissingLogos() {
            const logos = ['logo-ccu', 'logo-uac'];
            logos.forEach(logoId => {
                const img = document.getElementById(logoId);
                img.onerror = function() {
                    this.style.display = 'none';
                    this.nextElementSibling.style.display = 'none';
                };
            });
        }
        
        // Inicializaci√≥n
        window.addEventListener('load', async function() {
            try {
                console.log('üè• Iniciando ¬øQui√©n quiere ser cardi√≥logo? v2.0.0');
                
                // Cargar banco de preguntas PRIMERO
                await loadQuestionBank();
                
                // Registrar visita
                await recordVisit();
                
                // Tracking de jugador online
                await trackOnlinePlayer();
                
                // Configurar listeners de Firebase
                setupFirebaseListeners();
                
                // Cargar dashboard inicial
                loadDashboard();
                
                // Manejar logos faltantes
                handleMissingLogos();
                
                // Actualizar contadores peri√≥dicamente
                setInterval(() => {
                    updateLastUpdate();
                }, 60000); // Cada minuto
                
                console.log('‚úÖ Sistema completo iniciado correctamente');
                
            } catch (error) {
                console.error('‚ùå Error cr√≠tico en inicializaci√≥n:', error);
                
                // Si falla la carga de preguntas, mostrar error espec√≠fico
                if (error.message.includes('questions_bank.json')) {
                    console.log('üìù Para crear questions_bank.json, usa este formato:');
                    console.log(`[
  {
    "id": "infiltrativas_001",
    "level": 1,
    "question": "¬øCu√°l es la principal caracter√≠stica de las miocardiopat√≠as infiltrativas?",
    "options": [
      {"text": "Deposici√≥n de sustancias anormales en el miocardio", "correct": true},
      {"text": "Dilataci√≥n ventricular exclusiva", "correct": false},
      {"text": "Hipertrofia conc√©ntrica solamente", "correct": false},
      {"text": "Arritmias ventriculares aisladas", "correct": false}
    ]
  }
]`);
                }
                
                // Continuar con Firebase aunque fallen las preguntas
                try {
                    await recordVisit();
                    await trackOnlinePlayer();
                    setupFirebaseListeners();
                    loadDashboard();
                    handleMissingLogos();
                    
                    setInterval(() => {
                        updateLastUpdate();
                    }, 60000);
                    
                } catch (firebaseError) {
                    console.error('‚ùå Error adicional con Firebase:', firebaseError);
                    
                    // Mostrar datos por defecto si todo falla
                    document.getElementById('totalJugadores').textContent = '0';
                    document.getElementById('totalPartidas').textContent = '0';
                    document.getElementById('promedioScore').textContent = '0';
                    document.getElementById('nivelMaximo').textContent = '0';
                    document.getElementById('jugadoresHoy').textContent = '0';
                    document.getElementById('visitasHoy').textContent = '0';
                    document.getElementById('visitCount').textContent = '-';
                    document.getElementById('onlinePlayers').textContent = '-';
                    
                    document.getElementById('teamRankings').innerHTML = '<div class="loading">Error de conexi√≥n. Verifica tu internet.</div>';
                }
                
                showNotification('‚ö†Ô∏è Error de inicializaci√≥n. Algunas funciones pueden no estar disponibles.', 8000);
            }
        });
        
        // Detectar cuando el usuario sale de la p√°gina
        window.addEventListener('beforeunload', function() {
            if (currentSessionId) {
                // Marcar sesi√≥n como finalizada
                database.ref(`analytics/onlinePlayers/${currentSessionId}`).remove();
            }
        });
        
        // Manejo de errores globales
        window.addEventListener('error', function(e) {
            console.error('Error global:', e.error);
            showNotification('‚ùå Error inesperado. Recarga la p√°gina si persiste.', 3000);
        });
        
        // Funciones de utilidad adicionales
        function formatDate(timestamp) {
            if (!timestamp) return 'N/A';
            return new Date(timestamp).toLocaleDateString('es-UY', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        function sanitizeInput(input) {
            return input.trim().replace(/[<>\"'&]/g, '');
        }
        
        function generateSessionId() {
            return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }
        
        // Funci√≥n de debug para verificar Firebase
        async function testFirebaseConnection() {
            console.log('üîç === PRUEBA DE CONEXI√ìN FIREBASE ===');
            
            try {
                // Prueba 1: Leer datos existentes
                console.log('üìñ Prueba 1: Leyendo resultados...');
                const readSnapshot = await database.ref('resultados').once('value');
                const existingData = readSnapshot.val();
                console.log('‚úÖ Lectura exitosa:', existingData ? Object.keys(existingData).length + ' resultados' : 'Sin datos');
                
                // Prueba 2: Escribir datos de prueba
                console.log('‚úèÔ∏è Prueba 2: Escribiendo datos de prueba...');
                const testData = {
                    nombre: 'Usuario de Prueba',
                    pseudonimo: 'TestUser',
                    cedula: '9999999',
                    grupo: 'INDIVIDUAL',
                    puntaje: 42,
                    nivel: 10,
                    fecha: new Date().toLocaleDateString('es-UY'),
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    intentoNumero: 1,
                    esTest: true
                };
                
                const testRef = await database.ref('resultados').push(testData);
                console.log('‚úÖ Escritura exitosa:', testRef.key);
                
                // Prueba 3: Eliminar datos de prueba (NUEVO TEST)
                console.log('üóëÔ∏è Prueba 3: Probando eliminaci√≥n...');
                await testRef.remove();
                console.log('‚úÖ Eliminaci√≥n exitosa');
                
                // Prueba 4: Verificar analytics
                console.log('üìä Prueba 4: Probando analytics...');
                const analyticsTestRef = await database.ref('analytics/testConnection').set({
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    test: true
                });
                console.log('‚úÖ Analytics escritura OK');
                
                // Prueba 5: Eliminar analytics de prueba
                console.log('üóëÔ∏è Prueba 5: Eliminando analytics de prueba...');
                await database.ref('analytics/testConnection').remove();
                console.log('‚úÖ Analytics eliminaci√≥n OK');
                
                console.log('üéâ === TODAS LAS PRUEBAS EXITOSAS ===');
                showNotification('‚úÖ Firebase funcionando correctamente (incluye eliminaci√≥n)', 3000);
                return true;
                
            } catch (error) {
                console.error('‚ùå Error en prueba de Firebase:', error);
                console.error('üîß Posibles soluciones:');
                
                if (error.message.includes('Permission denied')) {
                    console.error('1. ‚ùå PROBLEMA DE PERMISOS: Las reglas de Firebase no permiten la operaci√≥n');
                    console.error('2. üîß SOLUCI√ìN: Aplicar las reglas con .delete: true');
                    console.error('3. üìã REGLAS NECESARIAS: Las rutas principales deben tener ".delete": true');
                } else {
                    console.error('2. Verificar credenciales de Firebase en firebaseConfig');
                    console.error('3. Verificar conexi√≥n a internet');
                    console.error('4. Verificar que la base de datos est√© activa en Firebase Console');
                }
                
                showNotification('‚ùå Error de Firebase: ' + error.message, 5000);
                return false;
            }
        }
        
        // Funci√≥n de diagn√≥stico completo de Firebase
        async function diagnoseFirebase() {
            console.log('üîç === DIAGN√ìSTICO COMPLETO DE FIREBASE ===');
            
            try {
                // 1. Verificar configuraci√≥n
                console.log('1Ô∏è‚É£ Verificando configuraci√≥n...');
                console.log('üìã Database URL:', firebaseConfig.databaseURL);
                console.log('üìã Project ID:', firebaseConfig.projectId);
                
                // 2. Verificar conexi√≥n b√°sica
                console.log('2Ô∏è‚É£ Probando conexi√≥n b√°sica...');
                const connectionTest = await database.ref('.info/connected').once('value');
                const isConnected = connectionTest.val();
                console.log('üîó Conectado a Firebase:', isConnected ? '‚úÖ S√ç' : '‚ùå NO');
                
                if (!isConnected) {
                    throw new Error('No hay conexi√≥n a Firebase');
                }
                
                // 3. Probar lectura
                console.log('3Ô∏è‚É£ Probando lectura...');
                const readTest = await database.ref('test').once('value');
                console.log('üìñ Lectura:', '‚úÖ OK');
                
                // 4. Probar escritura
                console.log('4Ô∏è‚É£ Probando escritura...');
                await database.ref('test/write').set({ timestamp: Date.now() });
                console.log('‚úèÔ∏è Escritura:', '‚úÖ OK');
                
                // 5. Probar eliminaci√≥n
                console.log('5Ô∏è‚É£ Probando eliminaci√≥n...');
                await database.ref('test/write').remove();
                console.log('üóëÔ∏è Eliminaci√≥n:', '‚úÖ OK');
                
                // 6. Probar operaciones masivas
                console.log('6Ô∏è‚É£ Probando eliminaci√≥n masiva...');
                await database.ref('test').set({
                    item1: { test: true },
                    item2: { test: true },
                    item3: { test: true }
                });
                await database.ref('test').remove();
                console.log('üóëÔ∏è Eliminaci√≥n masiva:', '‚úÖ OK');
                
                console.log('üéâ === DIAGN√ìSTICO EXITOSO - FIREBASE FUNCIONA CORRECTAMENTE ===');
                showNotification('‚úÖ Firebase funciona perfectamente', 3000);
                return true;
                
            } catch (error) {
                console.error('‚ùå === ERROR EN DIAGN√ìSTICO ===');
                console.error('üö® Error:', error.message);
                console.error('üö® C√≥digo:', error.code);
                console.error('üö® Detalles:', error);
                
                // Diagn√≥stico espec√≠fico del error
                if (error.message.includes('Permission denied')) {
                    console.error('üîß PROBLEMA: Reglas de Firebase muy restrictivas');
                    console.error('üîß SOLUCI√ìN: Usar reglas permisivas temporalmente');
                    console.error('üîß REGLAS RECOMENDADAS:');
                    console.error(`{
  "rules": {
    ".read": true,
    ".write": true
  }
}`);
                } else if (error.message.includes('Network')) {
                    console.error('üîß PROBLEMA: Error de conexi√≥n');
                    console.error('üîß SOLUCI√ìN: Verificar internet y estado de Firebase');
                } else if (error.message.includes('not found')) {
                    console.error('üîß PROBLEMA: Base de datos no encontrada');
                    console.error('üîß SOLUCI√ìN: Verificar URL de database en firebaseConfig');
                } else {
                    console.error('üîß PROBLEMA: Error desconocido');
                    console.error('üîß SOLUCI√ìN: Verificar credenciales completas');
                }
                
                showNotification('‚ùå Error Firebase: ' + error.message, 5000);
                return false;
            }
        }
        
        // Funci√≥n simplificada para limpiar datos con mejor debugging
        async function clearAllDataSafe() {
            console.log('üóëÔ∏è === ELIMINACI√ìN SEGURA DE DATOS ===');
            
            // Confirmaciones m√∫ltiples
            if (!confirm('¬øEliminar TODOS los datos?\n\n‚ö†Ô∏è ESTA ACCI√ìN NO SE PUEDE DESHACER')) {
                console.log('‚ùå Eliminaci√≥n cancelada por el usuario');
                return;
            }
            
            const confirmation = prompt('Escribe "ELIMINAR" para confirmar:');
            if (confirmation !== 'ELIMINAR') {
                console.log('‚ùå Eliminaci√≥n cancelada: confirmaci√≥n incorrecta');
                return;
            }
            
            try {
                showNotification('üóëÔ∏è Eliminando datos...', 2000);
                
                // M√©todo 1: Intentar eliminaci√≥n directa
                console.log('üóëÔ∏è M√©todo 1: Eliminaci√≥n directa...');
                await database.ref('resultados').remove();
                console.log('‚úÖ Resultados eliminados');
                
                await database.ref('gameStarts').remove();
                console.log('‚úÖ Game starts eliminados');
                
                await database.ref('analytics').remove();
                console.log('‚úÖ Analytics eliminados');
                
                console.log('üéâ === ELIMINACI√ìN EXITOSA ===');
                alert('‚úÖ Todos los datos eliminados correctamente');
                
                // Recargar interfaz
                loadAdminData();
                setTimeout(() => loadDashboard(), 1000);
                
            } catch (error) {
                console.error('‚ùå Error en eliminaci√≥n:', error);
                
                if (error.message.includes('Permission denied')) {
                    alert(`‚ùå ERROR DE PERMISOS

Firebase no permite eliminar datos.

SOLUCI√ìN INMEDIATA:
1. Ve a Firebase Console
2. Database > Rules  
3. Reemplaza con:
{
  "rules": {
    ".read": true,
    ".write": true
  }
}
4. Click "Publish"
5. Intenta de nuevo`);
                } else {
                    alert(`‚ùå Error: ${error.message}

Revisa la consola para m√°s detalles.`);
                }
            }
        }
        
        // Debug: Funci√≥n para desarrolladores
        function debugGameState() {
            console.log('=== ESTADO DEL JUEGO ===');
            console.log('Jugador actual:', currentPlayer);
            console.log('Nivel:', currentLevel);
            console.log('Puntaje:', score);
            console.log('Vidas:', lives);
            console.log('Pregunta actual:', currentQuestion?.id);
            console.log('Preguntas respondidas:', answeredQuestions.size);
            console.log('Comodines:', comodines);
            console.log('Banco de preguntas:', questionBank.length);
            console.log('========================');
        }
        
        // Hacer disponible para debugging
        window.debugGameState = debugGameState;
        window.testFirebaseConnection = testFirebaseConnection;
        window.diagnoseFirebase = diagnoseFirebase;
        window.clearAllDataSafe = clearAllDataSafe;
        window.resetAllAttempts = resetAllAttempts;
        window.checkAttemptsWithReset = checkAttemptsWithReset;
        window.refreshDashboard = refreshDashboard;
        
        // Mensaje de cr√©ditos en consola
        console.log(`
    üè• ¬øQUI√âN QUIERE SER CARDI√ìLOGO?
    ================================
    
    üì± CREADO Y PRODUCIDO POR: RAFAEL MILA
    üìß Email: r1000a@gmail.com
    
    üè• Desarrollado para:
    - Centro Cardiovascular Universitario  
    - Unidad Acad√©mica de Cardiolog√≠a
    
    üìã Especialidad: Miocardiopat√≠as Infiltrativas
    üî¢ Versi√≥n: 2.0.1 - BUGS CORREGIDOS
    üìÖ A√±o: 2025
    
    üêõ PROBLEMAS SOLUCIONADOS:
    ‚úÖ Corregido bug de m√∫ltiples intentos (reporte de Federico)
    ‚úÖ Sistema de puntaje por equipos simplificado (suma algebraica)
    ‚úÖ Prevenci√≥n de guardado duplicado de resultados
    ‚úÖ Funci√≥n de reset de intentos para todos los jugadores
    ‚úÖ Mejor manejo de estado del juego
    ‚úÖ Validaciones robustas contra errores de concurrencia
    
    üèÜ CARACTER√çSTICAS ACTUALES:
    ‚úÖ 30 categor√≠as graciosas (Vendedor de Globos ‚Üí Maestro del Universo)
    ‚úÖ Conceptos personalizados por nivel alcanzado
    ‚úÖ Asignaci√≥n autom√°tica de grupos del foro (${Object.keys(FORO_PARTICIPANTS).length} participantes registrados)
    ‚úÖ Sistema de puntaje seg√∫n README original
    ‚úÖ Comodines funcionales (50/50 y Cambiar Pregunta)
    ‚úÖ Rankings en tiempo real con suma algebraica por equipos
    ‚úÖ Panel de administraci√≥n con herramientas de diagn√≥stico
    ‚úÖ Sistema de reset de intentos
    
    üë• Distribuci√≥n del foro:
    - Grupo A: 42 participantes registrados
    - Grupo B: 39 participantes registrados
    - Grupo C: 41 participantes registrados
    - Individual: 19 registrados + no registrados
    
    üîß HERRAMIENTAS ADMIN:
    - Reset de intentos sin eliminar puntajes hist√≥ricos
    - Diagn√≥stico completo de Firebase
    - C√°lculo simplificado de puntajes por equipos
    
    üõ†Ô∏è Para soporte t√©cnico: r1000a@gmail.com
    üéì ¬°Competencia cardiol√≥gica lista y estable!
        `);
    </script>
</body>
</html>