<!DOCTYPE html>
<html lang="es-UY">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>¿Quién quiere ser cardiólogo? - Competencia por Equipos</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
            color: #e2e8f0;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow-x: hidden;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, transparent 20%, rgba(59, 130, 246, 0.15) 20%, rgba(59, 130, 246, 0.15) 21%, transparent 21%, transparent 30%, rgba(59, 130, 246, 0.1) 30%, rgba(59, 130, 246, 0.1) 31%, transparent 31%);
            background-size: 60px 60px;
            animation: rotate 180s linear infinite;
            opacity: 0.4;
            z-index: -1;
        }
        
        @keyframes rotate {
            to { transform: rotate(360deg); }
        }
        
        .container {
            width: 95%;
            max-width: 1200px;
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(20px);
            border: 2px solid rgba(59, 130, 246, 0.3);
            border-radius: 24px;
            padding: 24px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25), 0 0 0 1px rgba(59, 130, 246, 0.1);
            position: relative;
            z-index: 1;
            max-height: 95vh;
            overflow-y: auto;
        }
        
        /* Logos institucionales */
        .institutional-header {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 40px;
            margin-bottom: 20px;
            padding: 16px;
            background: rgba(30, 41, 59, 0.3);
            border-radius: 16px;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }
        
        .logo-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }
        
        .logo {
            height: 60px;
            width: auto;
            opacity: 0.9;
            transition: all 0.3s ease;
            filter: brightness(1.1);
        }
        
        .logo:hover {
            opacity: 1;
            transform: scale(1.05);
        }
        
        .logo-text {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            color: #94a3b8;
            text-align: center;
            font-weight: 500;
        }
        
        h1 {
            font-size: 2.75rem;
            font-weight: 700;
            text-align: center;
            background: linear-gradient(135deg, #60a5fa, #3b82f6, #2563eb);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 12px;
            letter-spacing: -0.025em;
        }
        
        h2 {
            font-size: 1.875rem;
            font-weight: 600;
            text-align: center;
            color: #60a5fa;
            margin-bottom: 24px;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .subtitle {
            font-family: 'JetBrains Mono', monospace;
            text-align: center;
            color: #94a3b8;
            font-size: 1.125rem;
            margin-bottom: 32px;
            letter-spacing: 0.05em;
            font-weight: 500;
        }
        
        .nav-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 32px;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .nav-tab {
            background: rgba(30, 58, 138, 0.2);
            color: #e2e8f0;
            border: 2px solid rgba(59, 130, 246, 0.3);
            padding: 12px 24px;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: 'JetBrains Mono', monospace;
            font-weight: 500;
            font-size: 0.875rem;
        }
        
        .nav-tab.active {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.3);
            transform: translateY(-2px);
        }
        
        .nav-tab:hover:not(.active) {
            background: rgba(59, 130, 246, 0.2);
            border-color: rgba(59, 130, 246, 0.5);
            transform: translateY(-1px);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Admin Panel */
        .admin-panel {
            background: rgba(220, 38, 38, 0.1);
            border: 2px solid rgba(220, 38, 38, 0.3);
            border-radius: 16px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }
        
        .admin-password {
            width: 300px;
            padding: 12px;
            margin: 12px;
            background: rgba(15, 23, 42, 0.8);
            border: 2px solid rgba(220, 38, 38, 0.3);
            border-radius: 8px;
            color: #e2e8f0;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .admin-data {
            background: rgba(15, 23, 42, 0.6);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            max-height: 500px;
            overflow-y: auto;
        }
        
        /* Pantalla de inicio */
        #startScreen {
            text-align: center;
        }
        
        .form-group {
            margin: 24px 0;
            text-align: left;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-size: 1.125rem;
            font-weight: 500;
            color: #60a5fa;
        }
        
        input, select {
            width: 100%;
            padding: 16px;
            font-size: 1rem;
            background: rgba(30, 41, 59, 0.8);
            border: 2px solid rgba(59, 130, 246, 0.3);
            border-radius: 12px;
            color: #e2e8f0;
            font-family: 'Inter', sans-serif;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #3b82f6;
            background: rgba(30, 41, 59, 0.95);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        select option {
            background: #1e293b;
            color: #e2e8f0;
        }
        
        .privacy-note {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 12px;
            padding: 16px;
            margin: 24px 0;
            font-size: 0.875rem;
            color: #94a3b8;
            line-height: 1.6;
        }
        
        .btn {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            border: none;
            padding: 14px 32px;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            margin: 8px;
            font-family: 'Inter', sans-serif;
            letter-spacing: 0.025em;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.3);
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
        }
        
        .btn-danger:hover {
            background: linear-gradient(135deg, #b91c1c, #991b1b);
        }
        
        /* Dashboard */
        .dashboard-section {
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 24px;
            margin: 24px 0;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin: 24px 0;
        }
        
        .stat-card {
            background: rgba(15, 23, 42, 0.6);
            border: 2px solid rgba(59, 130, 246, 0.2);
            border-radius: 16px;
            padding: 24px;
            text-align: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .stat-card:hover {
            border-color: rgba(59, 130, 246, 0.4);
            transform: translateY(-2px);
        }
        
        .stat-number {
            font-size: 2.5rem;
            color: #60a5fa;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .stat-label {
            color: #94a3b8;
            font-size: 1rem;
            font-weight: 500;
            margin-top: 8px;
        }
        
        /* Ranking por equipos */
        .team-rankings {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
            margin: 24px 0;
        }
        
        .team-section {
            background: rgba(15, 23, 42, 0.6);
            border-radius: 16px;
            padding: 20px;
            border: 2px solid rgba(59, 130, 246, 0.2);
            transition: all 0.3s ease;
        }
        
        .team-section:hover {
            border-color: rgba(59, 130, 246, 0.4);
            transform: translateY(-2px);
        }
        
        .team-section.team-a {
            border-color: rgba(34, 197, 94, 0.4);
        }
        
        .team-section.team-b {
            border-color: rgba(59, 130, 246, 0.4);
        }
        
        .team-section.team-c {
            border-color: rgba(251, 191, 36, 0.4);
        }
        
        .team-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding: 12px;
            border-radius: 8px;
        }
        
        .team-a .team-header {
            background: rgba(34, 197, 94, 0.1);
        }
        
        .team-b .team-header {
            background: rgba(59, 130, 246, 0.1);
        }
        
        .team-c .team-header {
            background: rgba(251, 191, 36, 0.1);
        }
        
        .team-name {
            font-size: 1.5rem;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .team-a .team-name {
            color: #22c55e;
        }
        
        .team-b .team-name {
            color: #3b82f6;
        }
        
        .team-c .team-name {
            color: #fbbf24;
        }
        
        .team-stats {
            display: flex;
            gap: 16px;
            font-size: 0.875rem;
            color: #94a3b8;
        }
        
        .team-player {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin: 4px 0;
            background: rgba(30, 41, 59, 0.4);
            border-radius: 8px;
            font-size: 0.875rem;
        }
        
        .live-feed {
            background: rgba(15, 23, 42, 0.4);
            border-radius: 12px;
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .feed-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid rgba(59, 130, 246, 0.2);
            animation: fadeIn 0.5s ease-out;
        }
        
        .feed-item:last-child {
            border-bottom: none;
        }
        
        .feed-player {
            font-weight: 600;
            color: #60a5fa;
        }
        
        .feed-team {
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: 500;
        }
        
        .feed-team.team-a {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }
        
        .feed-team.team-b {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
        }
        
        .feed-team.team-c {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }
        
        .feed-score {
            color: #3b82f6;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 500;
        }
        
        .feed-time {
            font-size: 0.75rem;
            color: #64748b;
        }
        
        /* Pantalla de juego */
        #gameScreen {
            display: none;
        }
        
        .game-header {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 24px;
            align-items: center;
            margin-bottom: 32px;
            padding: 24px;
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }
        
        .player-info, .game-stats, .comodines {
            font-family: 'JetBrains Mono', monospace;
            text-align: center;
        }
        
        .player-team {
            margin-top: 8px;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.875rem;
            font-weight: 600;
            display: inline-block;
        }
        
        .player-team.team-a {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }
        
        .player-team.team-b {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
        }
        
        .player-team.team-c {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }
        
        .lives {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 12px;
        }
        
        .heart {
            font-size: 1.5rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            filter: drop-shadow(0 0 8px rgba(59, 130, 246, 0.5));
        }
        
        .heart.active {
            color: #60a5fa;
            transform: scale(1);
        }
        
        .heart.lost {
            color: #334155;
            transform: scale(0.8);
            filter: none;
        }
        
        .comodines {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .comodin {
            background: linear-gradient(135deg, #60a5fa, #3b82f6);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.875rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .comodin:hover:not(:disabled) {
            transform: scale(1.05) translateY(-1px);
            box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.3);
        }
        
        .comodin:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Timer */
        .timer-container {
            text-align: center;
            margin: 20px 0;
        }
        
        .timer {
            font-size: 2rem;
            font-weight: 700;
            color: #60a5fa;
            background: rgba(30, 41, 59, 0.8);
            padding: 12px 24px;
            border-radius: 50%;
            display: inline-block;
            min-width: 80px;
            border: 3px solid rgba(59, 130, 246, 0.3);
            font-family: 'JetBrains Mono', monospace;
        }
        
        .timer.warning {
            color: #f59e0b;
            border-color: #f59e0b;
            animation: pulse 0.5s infinite;
        }
        
        /* Pregunta y opciones */
        .question-container {
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(59, 130, 246, 0.2);
            border-radius: 16px;
            padding: 32px;
            margin: 24px 0;
        }
        
        .question {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 32px;
            line-height: 1.6;
            color: #e2e8f0;
            text-align: center;
        }
        
        .options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }
        
        .option {
            background: rgba(15, 23, 42, 0.6);
            border: 2px solid rgba(59, 130, 246, 0.3);
            padding: 20px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 1rem;
            text-align: left;
            line-height: 1.5;
            font-weight: 500;
        }
        
        .option:hover:not(.disabled) {
            background: rgba(59, 130, 246, 0.1);
            border-color: #3b82f6;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px -8px rgba(59, 130, 246, 0.3);
        }
        
        .option.correct {
            background: linear-gradient(135deg, #059669, #047857);
            border-color: #10b981;
            color: white;
            animation: correctAnimation 0.6s ease-out;
        }
        
        .option.incorrect {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            border-color: #ef4444;
            color: white;
            animation: shake 0.6s ease-out;
        }
        
        .option.disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .option.eliminated {
            opacity: 0.3;
            background: rgba(51, 65, 85, 0.6);
            cursor: not-allowed;
            text-decoration: line-through;
        }
        
        @keyframes correctAnimation {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-4px); }
            20%, 40%, 60%, 80% { transform: translateX(4px); }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Pantalla de nivel */
        #levelScreen {
            display: none;
            text-align: center;
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(59, 130, 246, 0.2);
            border-radius: 16px;
            padding: 32px;
            margin: 24px 0;
        }
        
        .level-title {
            font-size: 2.25rem;
            font-weight: 700;
            color: #60a5fa;
            margin-bottom: 24px;
        }
        
        .level-description {
            font-size: 1.25rem;
            color: #94a3b8;
            margin-bottom: 32px;
            line-height: 1.6;
            font-style: italic;
        }
        
        /* Pantalla de resultados */
        #resultsScreen {
            display: none;
            text-align: center;
        }
        
        .final-score {
            font-size: 3rem;
            font-weight: 700;
            background: linear-gradient(135deg, #60a5fa, #3b82f6);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 24px 0;
        }
        
        .level-name {
            font-size: 1.5rem;
            color: #94a3b8;
            margin: 24px 0;
            font-family: 'JetBrains Mono', monospace;
        }
        
        /* Rankings */
        .ranking-section {
            margin: 32px 0;
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }
        
        .ranking-title {
            font-size: 1.75rem;
            color: #60a5fa;
            margin-bottom: 24px;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
        }
        
        .top-players {
            display: grid;
            gap: 12px;
            margin-bottom: 24px;
        }
        
        .player-rank {
            display: grid;
            grid-template-columns: 60px 2fr auto auto auto;
            gap: 16px;
            padding: 16px;
            background: rgba(15, 23, 42, 0.6);
            border-radius: 12px;
            align-items: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .player-rank:hover {
            transform: translateY(-1px);
        }
        
        .player-rank.podium-1 {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(245, 158, 11, 0.1));
            border: 2px solid #fbbf24;
        }
        
        .player-rank.podium-2 {
            background: linear-gradient(135deg, rgba(156, 163, 175, 0.2), rgba(107, 114, 128, 0.1));
            border: 2px solid #9ca3af;
        }
        
        .player-rank.podium-3 {
            background: linear-gradient(135deg, rgba(194, 120, 3, 0.2), rgba(146, 64, 14, 0.1));
            border: 2px solid #c2750b;
        }
        
        .rank-number {
            font-size: 1.5rem;
            font-weight: 700;
            color: #60a5fa;
            text-align: center;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .rank-name {
            font-weight: 600;
            color: #e2e8f0;
        }
        
        .rank-team {
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .rank-team.team-a {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }
        
        .rank-team.team-b {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
        }
        
        .rank-team.team-c {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }
        
        .rank-score {
            font-family: 'JetBrains Mono', monospace;
            color: #3b82f6;
            font-weight: 600;
        }
        
        .rank-title {
            color: #94a3b8;
            font-size: 0.75rem;
            font-style: italic;
            margin-top: 4px;
            line-height: 1.2;
        }
        
        .rank-level {
            font-family: 'JetBrains Mono', monospace;
            color: #60a5fa;
            font-size: 0.875rem;
        }
        
        .horoscope-section {
            background: rgba(59, 130, 246, 0.1);
            border: 2px solid rgba(59, 130, 246, 0.3);
            border-radius: 16px;
            padding: 24px;
            margin: 32px 0;
            text-align: left;
        }
        
        .horoscope-title {
            color: #60a5fa;
            text-align: center;
            margin-bottom: 16px;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
        }
        
        .horoscope-text {
            font-size: 1.125rem;
            line-height: 1.7;
            color: #e2e8f0;
            font-style: italic;
        }
        
        .loading {
            text-align: center;
            color: #94a3b8;
            font-style: italic;
        }
        
        .error-message {
            background: rgba(220, 38, 38, 0.1);
            border: 2px solid rgba(220, 38, 38, 0.3);
            border-radius: 12px;
            padding: 16px;
            margin: 16px 0;
            color: #f87171;
            text-align: center;
        }

        /* Mejoras de jugabilidad */
        .combo-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(34, 197, 94, 0.9);
            color: white;
            padding: 12px 24px;
            border-radius: 20px;
            font-weight: 600;
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s ease;
            z-index: 100;
        }

        .combo-indicator.show {
            opacity: 1;
            transform: translateY(0);
        }

        .achievement-popup {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: white;
            padding: 16px 24px;
            border-radius: 16px;
            box-shadow: 0 10px 25px -5px rgba(251, 191, 36, 0.5);
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.5s ease;
            z-index: 100;
            max-width: 300px;
        }

        .achievement-popup.show {
            opacity: 1;
            transform: translateX(0);
        }

        .achievement-title {
            font-weight: 700;
            margin-bottom: 4px;
        }

        .achievement-desc {
            font-size: 0.875rem;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            h1 {
                font-size: 2.25rem;
            }
            
            .container {
                padding: 16px;
            }
            
            .institutional-header {
                flex-direction: column;
                gap: 20px;
            }
            
            .logo {
                height: 50px;
            }
            
            .nav-tabs {
                justify-content: flex-start;
                overflow-x: auto;
                padding-bottom: 8px;
            }
            
            .game-header {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            .options {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .player-rank {
                grid-template-columns: 40px 2fr auto;
                gap: 12px;
            }
            
            .rank-level, .rank-team {
                display: none;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .team-rankings {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header institucional -->
        <div class="institutional-header">
            <div class="logo-container">
                <img src="logo-ccu.png" alt="Centro Cardiovascular Universitario" class="logo" id="logo-ccu">
                <div class="logo-text">Centro Cardiovascular<br>Universitario</div>
            </div>
            <div class="logo-container">
                <img src="logo-uac.png" alt="Unidad Académica de Cardiología" class="logo" id="logo-uac">
                <div class="logo-text">Unidad Académica<br>de Cardiología</div>
            </div>
        </div>
        
        <!-- Navegación -->
        <div class="nav-tabs">
            <div class="nav-tab active" onclick="showTab('dashboard')">📊 Dashboard</div>
            <div class="nav-tab" onclick="showTab('individual')">🏆 Individual</div>
            <div class="nav-tab" onclick="showTab('equipos')">👥 Equipos</div>
            <div class="nav-tab" onclick="showTab('game')">🎮 Jugar</div>
            <div class="nav-tab" onclick="showTab('admin')">🔐 Admin</div>
        </div>
        
        <!-- Dashboard General -->
        <div id="dashboard" class="tab-content active">
            <h1>🏥 Dashboard General</h1>
            <p class="subtitle">COMPETENCIA INDIVIDUAL Y POR EQUIPOS</p>
            
            <!-- Estadísticas Generales -->
            <div class="dashboard-section">
                <h2>📈 Estadísticas Generales</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalJugadores">-</div>
                        <div class="stat-label">Total Participantes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="promedioScore">-</div>
                        <div class="stat-label">Puntaje Promedio</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="nivelMaximo">-</div>
                        <div class="stat-label">Nivel Máximo Alcanzado</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="jugadoresHoy">-</div>
                        <div class="stat-label">Participantes Hoy</div>
                    </div>
                </div>
            </div>
            
            <!-- Ranking por Equipos -->
            <div class="dashboard-section">
                <h2>🥇 Ranking de Equipos</h2>
                <div class="team-rankings" id="teamRankings">
                    <div class="loading">Cargando estadísticas de equipos...</div>
                </div>
            </div>
            
            <!-- Feed en Vivo -->
            <div class="dashboard-section">
                <h2>🎮 Actividad Reciente</h2>
                <div class="live-feed" id="liveFeed">
                    <div class="loading">Cargando actividad reciente...</div>
                </div>
            </div>
        </div>
        
        <!-- Ranking Individual -->
        <div id="individual" class="tab-content">
            <h1>🏆 Ranking Individual</h1>
            <p class="subtitle">MEJORES PARTICIPANTES</p>
            
            <!-- Top 20 Individual -->
            <div class="ranking-section">
                <h2 class="ranking-title">🏅 Top 20 Individual</h2>
                <div class="top-players" id="topIndividual">
                    <div class="loading">Cargando ranking individual...</div>
                </div>
            </div>
        </div>
        
        <!-- Ranking por Equipos -->
        <div id="equipos" class="tab-content">
            <h1>👥 Competencia por Equipos</h1>
            <p class="subtitle">RANKING DETALLADO POR GRUPO</p>
            
            <!-- Estadísticas de Equipos -->
            <div class="dashboard-section">
                <h2>📊 Estadísticas por Equipo</h2>
                <div class="team-rankings" id="detailedTeamStats">
                    <div class="loading">Cargando estadísticas detalladas...</div>
                </div>
            </div>
        </div>
        
        <!-- Panel de Administración -->
        <div id="admin" class="tab-content">
            <h1>🔐 Panel de Administración</h1>
            <p class="subtitle">ACCESO RESTRINGIDO</p>
            
            <div class="admin-panel">
                <h2>🔒 Acceso Privado</h2>
                <p>Ingresa la contraseña para ver los datos de los participantes:</p>
                <input type="password" id="adminPassword" class="admin-password" placeholder="Contraseña de administrador">
                <br>
                <button class="btn" onclick="verifyAdmin()">Acceder</button>
                
                <div id="adminData" class="admin-data" style="display: none;">
                    <h3>📋 Registro Completo de Participantes</h3>
                    <button class="btn" onclick="exportAdminData()">📥 Descargar Excel</button>
                    <button class="btn btn-danger" onclick="clearAllData()">🗑️ Limpiar Datos</button>
                    
                    <div id="adminTable" style="margin-top: 20px;">
                        <!-- Tabla de admin se genera aquí -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Pantalla de Juego -->
        <div id="game" class="tab-content">
            <!-- Pantalla de inicio -->
            <div id="startScreen">
                <h1>¿Quién quiere ser cardiólogo?</h1>
                <p class="subtitle">COMPETENCIA INDIVIDUAL Y POR EQUIPOS</p>
                
                <div class="form-group">
                    <label for="playerName">Nombre y apellido:</label>
                    <input type="text" id="playerName" placeholder="Dr. Juan Pérez López" required>
                </div>
                
                <div class="form-group">
                    <label for="playerId">Cédula de identidad (sin dígito verificador):</label>
                    <input type="text" id="playerId" placeholder="1234567" required>
                </div>
                
                <div class="form-group">
                    <label for="playerTeam">Grupo del foro:</label>
                    <select id="playerTeam" required>
                        <option value="">Selecciona tu grupo</option>
                        <option value="A">Grupo A</option>
                        <option value="B">Grupo B</option>
                        <option value="C">Grupo C</option>
                    </select>
                </div>
                
                <div class="privacy-note">
                    🏆 <strong>Competencia:</strong> Participás tanto en el ranking individual como en el de tu equipo. Tus datos personales son privados, solo se muestra tu nombre en los rankings.
                </div>
                
                <div id="intentosMessage" style="display: none; color: #f59e0b; margin: 20px 0; font-weight: bold;"></div>
                
                <button class="btn" onclick="startGame()">COMENZAR COMPETENCIA</button>
            </div>
            
            <!-- Pantalla de juego -->
            <div id="gameScreen">
                <div class="game-header">
                    <div class="player-info">
                        <div>Participante: <span id="displayName"></span></div>
                        <div class="player-team" id="displayTeam"></div>
                        <div class="lives">
                            Vidas: 
                            <span class="heart" id="heart1">💙</span>
                            <span class="heart" id="heart2">💙</span>
                            <span class="heart" id="heart3">💙</span>
                        </div>
                    </div>
                    
                    <div class="game-stats">
                        <div>Nivel: <span id="currentLevelDisplay">1</span>/30</div>
                        <div>Puntaje: <span id="score">0</span></div>
                        <div class="timer-container">
                            <div class="timer" id="timer">30</div>
                        </div>
                    </div>
                    
                    <div class="comodines">
                        <button class="comodin" id="comodin5050" onclick="use5050()">🎯 50/50</button>
                        <button class="comodin" id="comodinChange" onclick="changeQuestion()">🔄 Cambiar</button>
                    </div>
                </div>
                
                <!-- Pantalla de nivel intermedia -->
                <div id="levelScreen">
                    <div class="level-title">NIVEL <span id="levelNumber"></span></div>
                    <div class="level-description" id="levelDescription"></div>
                    <button class="btn" onclick="startLevel()">COMENZAR NIVEL</button>
                </div>
                
                <div class="question-container" id="mainQuestionContainer" style="display: none;">
                    <div class="question" id="questionText"></div>
                    <div class="options" id="optionsContainer"></div>
                </div>
                
                <button class="btn" id="nextButton" style="display: none;" onclick="nextQuestion()">SIGUIENTE PREGUNTA</button>
            </div>
            
            <!-- Pantalla de resultados -->
            <div id="resultsScreen">
                <h1>¡Competencia Terminada!</h1>
                <div class="final-score">Puntaje Final: <span id="finalScore">0</span></div>
                <div class="level-name" id="levelName"></div>
                <div>Nivel máximo alcanzado: <span id="maxLevel">1</span>/30</div>
                
                <!-- Descripción humorística del nivel -->
                <div class="horoscope-section">
                    <h3 class="horoscope-title">🔍 Diagnóstico de nivel alcanzado</h3>
                    <div class="horoscope-text" id="levelHoroscope"></div>
                </div>
                
                <button class="btn" id="retryButton" onclick="retryGame()">🔄 REINTENTAR</button>
                <button class="btn" onclick="newGame()">👤 NUEVO PARTICIPANTE</button>
                <button class="btn" onclick="showTab('dashboard')">📊 VER DASHBOARD</button>
            </div>
        </div>

        <!-- Error message container -->
        <div id="errorMessage" class="error-message" style="display: none;"></div>
    </div>

    <!-- Indicadores de combo y logros -->
    <div class="combo-indicator" id="comboIndicator">
        <span id="comboText">¡Racha de 3!</span>
    </div>

    <div class="achievement-popup" id="achievementPopup">
        <div class="achievement-title" id="achievementTitle">¡Logro desbloqueado!</div>
        <div class="achievement-desc" id="achievementDesc">Descripción del logro</div>
    </div>
    
    <script>
        // Configuración Firebase - TUS CREDENCIALES REALES
        const firebaseConfig = {
            apiKey: "AIzaSyAF1UK57tg4jK856RSU7Qcr1MT8QEeY4-o",
            authDomain: "cardiologia-game-uy.firebaseapp.com",
            databaseURL: "https://cardiologia-game-uy-default-rtdb.firebaseio.com",
            projectId: "cardiologia-game-uy",
            storageBucket: "cardiologia-game-uy.firebasestorage.app",
            messagingSenderId: "950754238661",
            appId: "1:950754238661:web:3df1bc9c9089f3308410ac",
            measurementId: "G-R6SPME7MHK"
        };
        
        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // Variables globales
        let currentPlayer = { name: '', id: '', team: '' };
        let currentLevel = 1;
        let score = 0;
        let lives = 3;
        let maxLevelReached = 1;
        let currentQuestion = null;
        let answeredQuestions = new Set();
        let timeLeft = 30;
        let timerInterval = null;
        let comodines = { fifty: true, change: true };
        let shuffledOptions = [];
        let eliminated5050 = false;
        let playerAttempts = 0;
        let isAdminAuthenticated = false;
        const ADMIN_PASSWORD = "cardio2025admin";
        let questionBank = []; // IMPORTANTE: Este array se llenará SOLO desde el archivo JSON
        let correctStreak = 0;
        
        // Títulos mejorados por nivel (30 niveles progresivos y graciosos)
        const levelTitles = {
            1: "Estudiante de primer año con estetoscopio al revés",
            2: "Interno que confunde el ECG con un sismógrafo",
            3: "R1 que ausculta con esperanza pero sin certeza", 
            4: "R2 que ya distingue un soplo de los ruidos intestinales",
            5: "R3 que dice 'suena raro' con aire profesional",
            6: "Fellow novato que googlea bajo la mesa",
            7: "Cardiólogo junior que todavía suda con las arritmias",
            8: "El que ya no confunde la aorta con la vena cava",
            9: "Especialista que empieza a entender el Forrester",
            10: "El que explica la IC sin usar las manos",
            11: "Experto en FEVI que habla de strain para impresionar",
            12: "El que dice 'claramente es una miocardiopatía' (aunque dude)",
            13: "Maestro del cateterismo que nunca admite que se perdió",
            14: "El que lee los estudios pero solo el abstract",
            15: "Gurú del ecocardio que ve cosas que otros no ven",
            16: "El que cita las guías ESC de memoria (las partes fáciles)",
            17: "Referente que tiene una anécdota para cada caso",
            18: "El que ya no teme a las taquicardias ventriculares",
            19: "Sabio que distingue ATTR de AL con solo mirar al paciente",
            20: "El que hace diagnósticos mientras toma el café",
            21: "Maestro Jedi del ventrículo derecho",
            22: "El que ve patrones donde otros ven caos",
            23: "Oráculo de las miocardiopatías infiltrativas",
            24: "El que susurra a los marcapasos",
            25: "Leyenda viviente del servicio de cardiología",
            26: "El que tiene nombre propio en las guías clínicas",
            27: "Semidiós de la hemodinamia",
            28: "El que hace ablaciones con los ojos cerrados",
            29: "Casi omnisciente cardiovascular",
            30: "Deidad cardiológica del Olimpo uruguayo"
        };
        
        // Descripciones humorísticas mejoradas
        const levelDescriptions = {
            1: "Recién empezás tu viaje cardiológico. Todavía creés que el corazón es solo una bomba y que los betabloqueantes son vitaminas potentes. Tu estetoscopio está más de adorno que de instrumento, pero hey, todos empezamos así.",
            2: "Ya sabés que el ECG no mide terremotos, aunque a veces parezca. Identificás las ondas P, QRS y T, pero cuando aparece un bloqueo de rama te mareás un poco. Progreso es progreso.",
            3: "Empezás a auscultar con cierta confianza, aunque secretamente rezás para no encontrar nada raro. Los soplos te suenan todos iguales, pero al menos ya no confundís el primero con el segundo ruido.",
            4: "¡Felicitaciones! Ya distinguís entre ruidos cardíacos y borborigmos. Todavía sudás cuando te preguntan sobre el ciclo cardíaco, pero al menos ya no decís que la diástole es cuando el corazón descansa.",
            5: "Tu vocabulario médico se expande: ya decís 'hallazgos sugestivos' y 'correlación clínica' con soltura. Cuando algo suena raro, lo anotás con cara seria aunque no sepas exactamente qué es.",
            6: "Nivel Fellow novato: tu teléfono tiene más apps médicas que redes sociales. Consultás UpToDate discretamente y ya empezás a entender por qué la cardiología es tan compleja.",
            7: "Las arritmias ya no te dan pánico, solo una sudoración moderada. Empezás a ver patrones en el caos del ECG y ocasionalmente acertás el diagnóstico sin ayuda.",
            8: "Gran logro: ya no confundís estructuras anatómicas básicas. La diferencia entre arterias y venas es clara, y hasta te animás a explicar la circulación pulmonar sin trabarte.",
            9: "Descubriste a Forrester y su clasificación. Ahora ves el mundo en cuadrantes: húmedo-seco, frío-caliente. Tu comprensión hemodinámica empieza a tener sentido.",
            10: "Podés explicar la insuficiencia cardíaca sin gesticular desesperadamente. Usás términos como 'remodelado ventricular' y 'activación neurohormonal' con naturalidad.",
            11: "Te uniste al club del strain. Hablar de FEVI es muy 2020, ahora impresionás con deformación miocárdica y mecánica ventricular. Los residentes te miran con respeto.",
            12: "Tu confianza crece: diagnosticás miocardiopatías con relativa certeza. Aunque por dentro dudés, tu cara poker es impecable cuando dices 'claramente es restrictiva'.",
            13: "Maestro del cateterismo: navegás las coronarias como GPS humano. Solo te perdiste una vez en la circunfleja, pero nadie tiene que saberlo.",
            14: "Lees estudios científicos... bueno, los abstracts y las conclusiones. Citás el PARADIGM-HF en conversaciones casuales y todos piensan que leíste el paper completo.",
            15: "Gurú ecocardiográfico: ves disfunciones diastólicas donde otros ven manchas grises. Tu ojo entrenado detecta alteraciones sutiles que escapan a los mortales.",
            16: "Las guías ESC son tu lectura ligera. Recitás las recomendaciones clase I con facilidad, aunque las IIb todavía te confunden un poco.",
            17: "Cada paciente te recuerda a otro caso. Tu repertorio de anécdotas médicas es extenso y ligeramente exagerado, pero siempre educativo.",
            18: "Las taquicardias ventriculares son tu pan de cada día. Ya no corres a buscar ayuda, calmadamente administras amiodarona mientras explicás la fisiopatología.",
            19: "Diagnosticás amiloidosis con una mirada. Distinguís ATTR de AL por el patrón de sudoración del paciente (o eso creés). Tu intuición clínica es envidiable.",
            20: "Hacés diagnósticos entre sorbo y sorbo de café. Tu cerebro procesa información cardiológica en piloto automático. Los residentes piensan que tenés superpoderes.",
            21: "El ventrículo derecho no tiene secretos para vos. TAPSE, función longitudinal, acoplamiento VD-AP... hablás su idioma fluentemente.",
            22: "Ves patrones donde otros ven electrocardiogramas normales. Tu capacidad para detectar sutilezas es legendaria. Matrix cardiológico.",
            23: "Las miocardiopatías infiltrativas son tu especialidad. Hemocromatosis, sarcoidosis, amiloidosis... las detectás como Pokemon raros.",
            24: "Los marcapasos te obedecen. Programás resincronizadores con la misma facilidad con que otros configuran el despertador.",
            25: "Leyenda viviente: los fellows cuentan historias sobre tus diagnósticos imposibles. Tu nombre es sinónimo de excelencia cardiológica.",
            26: "Tu apellido aparece en las guías clínicas. Has contribuido tanto al campo que los nuevos fellows estudian tus casos.",
            27: "Semidiós hemodinámico: calculás resistencias vasculares mentalmente. Las curvas de presión-volumen son tu arte abstracto favorito.",
            28: "Hacés ablaciones a ciegas y nunca fallás. Tu mano es más precisa que el sistema de navegación 3D. Chuck Norris de la electrofisiología.",
            29: "Casi omnisciente: predecís eventos cardiovasculares con precisión inquietante. Los pacientes piensan que lees mentes, los colegas saben que es experiencia pura.",
            30: "Alcanzaste la deidad cardiológica uruguaya. Tu conocimiento trasciende los libros. Sos el oráculo al que todos consultan, el maestro de maestros. En el Olimpo del Hospital de Clínicas, tu trono está asegurado."
        };
        
        // IMPORTANTE: No más preguntas hardcodeadas. Solo se cargan desde el archivo JSON
        
        // Cargar preguntas desde archivo JSON
        async function loadQuestions() {
            try {
                console.log('Iniciando carga de preguntas...');
                
                // Intentar cargar desde múltiples rutas posibles
                const possiblePaths = [
                    'questions_bank.json',
                    'questions-bank.json', 
                    'questionsBank.json',
                    './questions_bank.json',
                    '/questions_bank.json',
                    'assets/questions_bank.json',
                    'data/questions_bank.json'
                ];
                
                let loaded = false;
                let lastError = null;
                
                for (const path of possiblePaths) {
                    try {
                        console.log(`Intentando cargar desde: ${path}`);
                        const response = await fetch(path);
                        if (response.ok) {
                            const data = await response.json();
                            if (Array.isArray(data) && data.length > 0) {
                                questionBank = data;
                                console.log(`✅ Preguntas cargadas exitosamente desde ${path}: ${questionBank.length} preguntas`);
                                showSuccess(`Preguntas cargadas correctamente: ${questionBank.length} preguntas sobre cardiomiopatías infiltrativas`);
                                loaded = true;
                                break;
                            }
                        }
                    } catch (e) {
                        lastError = e;
                        console.log(`❌ No se pudo cargar desde ${path}:`, e.message);
                    }
                }
                
                // Si no se cargó desde archivo y existe window.fs (en el entorno de Claude)
                if (!loaded && window.fs && window.fs.readFile) {
                    try {
                        console.log('Intentando cargar desde window.fs...');
                        const fileContent = await window.fs.readFile('questions_bank.json', { encoding: 'utf8' });
                        const data = JSON.parse(fileContent);
                        if (Array.isArray(data) && data.length > 0) {
                            questionBank = data;
                            console.log('✅ Preguntas cargadas desde window.fs:', questionBank.length);
                            showSuccess(`Preguntas cargadas: ${questionBank.length} preguntas sobre cardiomiopatías infiltrativas`);
                            loaded = true;
                        }
                    } catch (e) {
                        console.log('❌ No se pudo cargar desde window.fs:', e.message);
                    }
                }
                
                // Si aún no se cargó, mostrar error detallado
                if (!loaded || questionBank.length === 0) {
                    console.error('❌ ERROR: No se pudieron cargar las preguntas');
                    showError(`
                        Error: No se pudo cargar el archivo de preguntas.
                        Por favor, verifica que el archivo "questions_bank.json" esté en el servidor.
                        Se buscó en: ${possiblePaths.join(', ')}
                    `);
                    
                    // Usar preguntas de emergencia mínimas
                    questionBank = [
                        {
                            "id": "emergency_001", 
                            "level": 1, 
                            "question": "Error: No se cargaron las preguntas. Esta es una pregunta de emergencia. ¿Cuál es el mecanismo fisiopatológico primario en las miocardiopatías infiltrativas?", 
                            "options": [
                                {"text": "Depósito de sustancias anormales en el intersticio miocárdico", "correct": true}, 
                                {"text": "Daño isquémico recurrente", "correct": false}, 
                                {"text": "Mutaciones en proteínas sarcoméricas", "correct": false}, 
                                {"text": "Desregulación autonómica", "correct": false}
                            ]
                        }
                    ];
                    
                    // Duplicar la pregunta de emergencia para todos los niveles
                    for (let i = 2; i <= 30; i++) {
                        questionBank.push({...questionBank[0], id: `emergency_${i.toString().padStart(3, '0')}`, level: i});
                    }
                }
                
            } catch (error) {
                console.error('❌ Error general cargando preguntas:', error);
                showError('Error crítico cargando las preguntas: ' + error.message);
            }
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            if (errorDiv) {
                errorDiv.innerHTML = message.replace(/\n/g, '<br>');
                errorDiv.style.display = 'block';
                setTimeout(() => {
                    errorDiv.style.display = 'none';
                }, 10000); // Mostrar por 10 segundos
            }
            console.error(message);
        }
        
        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'achievement-popup show';
            successDiv.style.background = 'linear-gradient(135deg, #22c55e, #16a34a)';
            successDiv.innerHTML = `
                <div class="achievement-title">✅ Éxito</div>
                <div class="achievement-desc">${message}</div>
            `;
            document.body.appendChild(successDiv);
            
            setTimeout(() => {
                successDiv.classList.remove('show');
                setTimeout(() => successDiv.remove(), 500);
            }, 3000);
        }
        
        // Mejoras de jugabilidad
        function showCombo(streak) {
            const indicator = document.getElementById('comboIndicator');
            const comboText = document.getElementById('comboText');
            
            if (streak >= 3) {
                comboText.textContent = `¡Racha de ${streak}!`;
                indicator.classList.add('show');
                
                // Bonus de puntos por racha
                if (streak === 5) {
                    score += 2;
                    showAchievement("¡Racha de 5!", "Bonus: +2 puntos");
                } else if (streak === 10) {
                    score += 5;
                    showAchievement("¡Racha perfecta!", "Bonus: +5 puntos");
                }
                
                setTimeout(() => {
                    indicator.classList.remove('show');
                }, 2000);
            }
        }
        
        function showAchievement(title, description) {
            const popup = document.getElementById('achievementPopup');
            document.getElementById('achievementTitle').textContent = title;
            document.getElementById('achievementDesc').textContent = description;
            
            popup.classList.add('show');
            setTimeout(() => {
                popup.classList.remove('show');
            }, 3000);
        }
        
        // Inicialización
        window.addEventListener('load', async function() {
            await loadQuestions();
            loadDashboard();
            setupFirebaseListeners();
            updateLivesDisplay();
            handleMissingLogos();
            console.log('App inicializada con Firebase - Competencia por equipos');
        });
        
        // Manejar logos faltantes
        function handleMissingLogos() {
            const logos = ['logo-ccu', 'logo-uac'];
            logos.forEach(logoId => {
                const img = document.getElementById(logoId);
                img.onerror = function() {
                    this.style.display = 'none';
                    this.nextElementSibling.style.display = 'none';
                };
            });
        }
        
        // Funciones de navegación
        function showTab(tabName) {
            // Ocultar todos los tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Ocultar todos los nav-tabs activos
            document.querySelectorAll('.nav-tab').forEach(navTab => {
                navTab.classList.remove('active');
            });
            
            // Mostrar tab seleccionado
            document.getElementById(tabName).classList.add('active');
            
            // Activar nav-tab correspondiente
            event.target.classList.add('active');
            
            // Cargar datos específicos según el tab
            switch(tabName) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'individual':
                    loadIndividualRanking();
                    break;
                case 'equipos':
                    loadTeamRankings();
                    break;
            }
        }
        
        // Funciones de administración
        function verifyAdmin() {
            const password = document.getElementById('adminPassword').value;
            if (password === ADMIN_PASSWORD) {
                isAdminAuthenticated = true;
                document.getElementById('adminData').style.display = 'block';
                loadAdminData();
            } else {
                alert('Contraseña incorrecta');
            }
        }
        
        async function loadAdminData() {
            try {
                const snapshot = await database.ref('resultados').once('value');
                const results = snapshot.val();
                
                if (results) {
                    const resultsArray = Object.values(results).sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
                    
                    let tableHTML = `
                        <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
                            <thead>
                                <tr style="background: rgba(59, 130, 246, 0.2);">
                                    <th style="padding: 12px; border: 1px solid rgba(59, 130, 246, 0.3);">Fecha/Hora</th>
                                    <th style="padding: 12px; border: 1px solid rgba(59, 130, 246, 0.3);">Nombre Completo</th>
                                    <th style="padding: 12px; border: 1px solid rgba(59, 130, 246, 0.3);">Cédula</th>
                                    <th style="padding: 12px; border: 1px solid rgba(59, 130, 246, 0.3);">Grupo</th>
                                    <th style="padding: 12px; border: 1px solid rgba(59, 130, 246, 0.3);">Puntaje</th>
                                    <th style="padding: 12px; border: 1px solid rgba(59, 130, 246, 0.3);">Nivel</th>
                                    <th style="padding: 12px; border: 1px solid rgba(59, 130, 246, 0.3);">Intento</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    resultsArray.forEach(result => {
                        tableHTML += `
                            <tr>
                                <td style="padding: 8px; border: 1px solid rgba(59, 130, 246, 0.2);">${result.fecha}</td>
                                <td style="padding: 8px; border: 1px solid rgba(59, 130, 246, 0.2);">${result.nombre}</td>
                                <td style="padding: 8px; border: 1px solid rgba(59, 130, 246, 0.2);">${result.cedula}</td>
                                <td style="padding: 8px; border: 1px solid rgba(59, 130, 246, 0.2);">${result.grupo}</td>
                                <td style="padding: 8px; border: 1px solid rgba(59, 130, 246, 0.2);">${result.puntaje}</td>
                                <td style="padding: 8px; border: 1px solid rgba(59, 130, 246, 0.2);">${result.nivel}</td>
                                <td style="padding: 8px; border: 1px solid rgba(59, 130, 246, 0.2);">${result.intento}</td>
                            </tr>
                        `;
                    });
                    
                    tableHTML += '</tbody></table>';
                    document.getElementById('adminTable').innerHTML = tableHTML;
                }
            } catch (error) {
                console.error('Error loading admin data:', error);
            }
        }
        
        function exportAdminData() {
            if (!isAdminAuthenticated) {
                alert('Acceso no autorizado');
                return;
            }
            
            database.ref('resultados').once('value').then(snapshot => {
                const results = snapshot.val();
                if (results) {
                    const resultsArray = Object.values(results);
                    
                    let csv = 'Fecha/Hora,Nombre Completo,Cédula,Grupo,Puntaje,Nivel Máximo,Título,Intento\n';
                    
                    resultsArray.forEach(result => {
                        csv += `"${result.fecha}","${result.nombre}","${result.cedula}","${result.grupo}",${result.puntaje},${result.nivel},"${result.titulo}",${result.intento}\n`;
                    });
                    
                    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = `competencia_cardiologia_${new Date().toISOString().split('T')[0]}.csv`;
                    link.click();
                }
            });
        }
        
        function clearAllData() {
            if (!isAdminAuthenticated) {
                alert('Acceso no autorizado');
                return;
            }
            
            if (confirm('¿Estás seguro de que quieres eliminar TODOS los datos? Esta acción no se puede deshacer.')) {
                database.ref('resultados').remove();
                database.ref('estadisticas').remove();
                alert('Todos los datos han sido eliminados');
                loadAdminData();
                loadDashboard();
            }
        }
        
        // Funciones Firebase
        function setupFirebaseListeners() {
            database.ref('resultados').on('value', (snapshot) => {
                updateDashboardStats();
                updateTeamRankings();
                updateLiveFeed();
            });
        }
        
        async function checkPlayerAttempts(cedula) {
            try {
                const snapshot = await database.ref('resultados').orderByChild('cedula').equalTo(cedula).once('value');
                const results = snapshot.val();
                return results ? Object.keys(results).length : 0;
            } catch (error) {
                console.error('Error checking attempts:', error);
                return 0;
            }
        }
        
        async function saveGameResult(result) {
            try {
                const resultId = database.ref('resultados').push().key;
                
                await database.ref('resultados/' + resultId).set({
                    ...result,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    id: resultId
                });
                
                updateGlobalStats();
                
                console.log('Resultado guardado en Firebase:', resultId);
                return resultId;
            } catch (error) {
                console.error('Error saving result:', error);
                throw error;
            }
        }
        
        async function updateGlobalStats() {
            try {
                const snapshot = await database.ref('resultados').once('value');
                const results = snapshot.val();
                
                if (results) {
                    const resultsArray = Object.values(results);
                    const totalPlayers = resultsArray.length;
                    const avgScore = resultsArray.reduce((sum, r) => sum + r.puntaje, 0) / totalPlayers;
                    const maxLevel = Math.max(...resultsArray.map(r => r.nivel));
                    
                    // Contar jugadores de hoy
                    const today = new Date().toDateString();
                    const playersToday = resultsArray.filter(r => {
                        const resultDate = new Date(r.timestamp || 0).toDateString();
                        return resultDate === today;
                    }).length;
                    
                    // Estadísticas por equipo
                    const teamStats = {
                        A: { players: 0, totalScore: 0, avgScore: 0, maxLevel: 0 },
                        B: { players: 0, totalScore: 0, avgScore: 0, maxLevel: 0 },
                        C: { players: 0, totalScore: 0, avgScore: 0, maxLevel: 0 }
                    };
                    
                    resultsArray.forEach(result => {
                        const team = result.grupo;
                        if (teamStats[team]) {
                            teamStats[team].players++;
                            teamStats[team].totalScore += result.puntaje;
                            teamStats[team].maxLevel = Math.max(teamStats[team].maxLevel, result.nivel);
                        }
                    });
                    
                    // Calcular promedios por equipo
                    Object.keys(teamStats).forEach(team => {
                        if (teamStats[team].players > 0) {
                            teamStats[team].avgScore = Math.round((teamStats[team].totalScore / teamStats[team].players) * 10) / 10;
                        }
                    });
                    
                    await database.ref('estadisticas').set({
                        totalJugadores: totalPlayers,
                        promedioScore: Math.round(avgScore * 10) / 10,
                        nivelMaximo: maxLevel,
                        jugadoresHoy: playersToday,
                        equipos: teamStats,
                        ultimaActualizacion: firebase.database.ServerValue.TIMESTAMP
                    });
                }
            } catch (error) {
                console.error('Error updating stats:', error);
            }
        }
        
        // Funciones Dashboard
        function loadDashboard() {
            updateDashboardStats();
            updateTeamRankings();
            updateLiveFeed();
        }
        
        async function updateDashboardStats() {
            try {
                const snapshot = await database.ref('estadisticas').once('value');
                const stats = snapshot.val();
                
                if (stats) {
                    document.getElementById('totalJugadores').textContent = stats.totalJugadores || 0;
                    document.getElementById('promedioScore').textContent = stats.promedioScore || 0;
                    document.getElementById('nivelMaximo').textContent = stats.nivelMaximo || 0;
                    document.getElementById('jugadoresHoy').textContent = stats.jugadoresHoy || 0;
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }
        
        async function updateTeamRankings() {
            try {
                const snapshot = await database.ref('estadisticas/equipos').once('value');
                const teamStats = snapshot.val();
                
                if (teamStats) {
                    const container = document.getElementById('teamRankings');
                    container.innerHTML = '';
                    
                    // Ordenar equipos por promedio
                    const sortedTeams = Object.entries(teamStats)
                        .sort(([,a], [,b]) => b.avgScore - a.avgScore);
                    
                    sortedTeams.forEach(([teamName, stats]) => {
                        const teamSection = document.createElement('div');
                        teamSection.className = `team-section team-${teamName.toLowerCase()}`;
                        
                        teamSection.innerHTML = `
                            <div class="team-header">
                                <div class="team-name">GRUPO ${teamName}</div>
                                <div class="team-stats">
                                    <span>👥 ${stats.players}</span>
                                    <span>🏆 ${stats.avgScore} pts</span>
                                    <span>📈 Nv.${stats.maxLevel}</span>
                                </div>
                            </div>
                        `;
                        
                        container.appendChild(teamSection);
                    });
                }
            } catch (error) {
                console.error('Error loading team rankings:', error);
            }
        }
        
        async function loadIndividualRanking() {
            try {
                const snapshot = await database.ref('resultados').orderByChild('puntaje').limitToLast(20).once('value');
                const results = snapshot.val();
                
                if (results) {
                    const resultsArray = Object.values(results).sort((a, b) => b.puntaje - a.puntaje);
                    
                    // Obtener mejor resultado por jugador (por cédula)
                    const uniqueResults = new Map();
                    resultsArray.forEach(result => {
                        const existing = uniqueResults.get(result.cedula);
                        if (!existing || result.puntaje > existing.puntaje) {
                            uniqueResults.set(result.cedula, result);
                        }
                    });
                    
                    const topResults = Array.from(uniqueResults.values())
                        .sort((a, b) => b.puntaje - a.puntaje)
                        .slice(0, 20);
                    
                    const container = document.getElementById('topIndividual');
                    container.innerHTML = '';
                    
                    topResults.forEach((result, index) => {
                        const playerRank = document.createElement('div');
                        playerRank.className = 'player-rank';
                        
                        if (index === 0) playerRank.classList.add('podium-1');
                        else if (index === 1) playerRank.classList.add('podium-2');
                        else if (index === 2) playerRank.classList.add('podium-3');
                        
                        playerRank.innerHTML = `
                            <div class="rank-number">${index + 1}</div>
                            <div>
                                <div class="rank-name">${result.nombre}</div>
                                <div class="rank-title">${levelTitles[result.nivel] || 'Estudiante de primer año con estetoscopio al revés'}</div>
                            </div>
                            <div class="rank-team team-${result.grupo?.toLowerCase() || 'a'}">Grupo ${result.grupo || 'A'}</div>
                            <div class="rank-score">${result.puntaje} pts</div>
                            <div class="rank-level">Nv.${result.nivel}</div>
                        `;
                        
                        container.appendChild(playerRank);
                    });
                }
            } catch (error) {
                console.error('Error loading individual ranking:', error);
            }
        }
        
        async function loadTeamRankings() {
            try {
                const snapshot = await database.ref('resultados').once('value');
                const results = snapshot.val();
                
                if (results) {
                    const resultsArray = Object.values(results);
                    
                    // Agrupar por equipo y obtener mejor resultado por jugador
                    const teamPlayers = {
                        A: new Map(),
                        B: new Map(),
                        C: new Map()
                    };
                    
                    resultsArray.forEach(result => {
                        const team = result.grupo;
                        if (teamPlayers[team]) {
                            const existing = teamPlayers[team].get(result.cedula);
                            if (!existing || result.puntaje > existing.puntaje) {
                                teamPlayers[team].set(result.cedula, result);
                            }
                        }
                    });
                    
                    const container = document.getElementById('detailedTeamStats');
                    container.innerHTML = '';
                    
                    // Crear sección para cada equipo
                    ['A', 'B', 'C'].forEach(teamName => {
                        const players = Array.from(teamPlayers[teamName].values())
                            .sort((a, b) => b.puntaje - a.puntaje);
                        
                        const avgScore = players.length > 0 ? 
                            Math.round((players.reduce((sum, p) => sum + p.puntaje, 0) / players.length) * 10) / 10 : 0;
                        const maxLevel = players.length > 0 ? 
                            Math.max(...players.map(p => p.nivel)) : 0;
                        
                        const teamSection = document.createElement('div');
                        teamSection.className = `team-section team-${teamName.toLowerCase()}`;
                        
                        let playersHTML = '';
                        players.slice(0, 10).forEach((player, index) => {
                            playersHTML += `
                                <div class="team-player">
                                    <span>${index + 1}. ${player.nombre}</span>
                                    <span>${player.puntaje} pts - Nv.${player.nivel}</span>
                                </div>
                            `;
                        });
                        
                        teamSection.innerHTML = `
                            <div class="team-header">
                                <div class="team-name">GRUPO ${teamName}</div>
                                <div class="team-stats">
                                    <span>👥 ${players.length}</span>
                                    <span>🏆 ${avgScore} pts</span>
                                    <span>📈 Nv.${maxLevel}</span>
                                </div>
                            </div>
                            <div style="margin-top: 16px;">
                                <h3 style="color: #94a3b8; margin-bottom: 12px; font-size: 1rem;">Top 10 del grupo:</h3>
                                ${playersHTML || '<div style="color: #64748b; font-style: italic;">No hay participantes aún</div>'}
                            </div>
                        `;
                        
                        container.appendChild(teamSection);
                    });
                }
            } catch (error) {
                console.error('Error loading team rankings:', error);
            }
        }
        
        async function updateLiveFeed() {
            try {
                const snapshot = await database.ref('resultados').orderByChild('timestamp').limitToLast(10).once('value');
                const results = snapshot.val();
                
                if (results) {
                    const resultsArray = Object.values(results).sort((a, b) => b.timestamp - a.timestamp);
                    
                    const container = document.getElementById('liveFeed');
                    container.innerHTML = '';
                    
                    resultsArray.forEach(result => {
                        const feedItem = document.createElement('div');
                        feedItem.className = 'feed-item';
                        
                        const timeAgo = getTimeAgo(result.timestamp);
                        
                        feedItem.innerHTML = `
                            <div>
                                <div class="feed-player">${result.nombre}</div>
                                <div class="feed-team team-${result.grupo?.toLowerCase() || 'a'}">Grupo ${result.grupo || 'A'}</div>
                            </div>
                            <div class="feed-score">${result.puntaje} pts - Nv.${result.nivel}</div>
                            <div class="feed-time">${timeAgo}</div>
                        `;
                        
                        container.appendChild(feedItem);
                    });
                }
            } catch (error) {
                console.error('Error loading live feed:', error);
            }
        }
        
        function getTimeAgo(timestamp) {
            const now = Date.now();
            const diff = now - timestamp;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (days > 0) return `hace ${days}d`;
            if (hours > 0) return `hace ${hours}h`;
            if (minutes > 0) return `hace ${minutes}m`;
            return 'ahora';
        }
        
        // Funciones del juego
        async function startGame() {
            const name = document.getElementById('playerName').value.trim();
            const id = document.getElementById('playerId').value.trim();
            const team = document.getElementById('playerTeam').value;
            
            if (!name || !id || !team) {
                alert('Por favor, completá todos los campos');
                return;
            }
            
            // Validar formato de cédula (solo números, sin dígito verificador)
            if (!/^\d{6,8}$/.test(id)) {
                alert('La cédula debe tener entre 6 y 8 dígitos, sin dígito verificador');
                return;
            }
            
            // Verificar que las preguntas estén cargadas
            if (questionBank.length === 0) {
                await loadQuestions();
                if (questionBank.length === 0) {
                    alert('Error: No se pudieron cargar las preguntas. Por favor, recarga la página.');
                    return;
                }
            }
            
            try {
                playerAttempts = await checkPlayerAttempts(id);
                
                if (playerAttempts >= 2) {
                    document.getElementById('intentosMessage').style.display = 'block';
                    document.getElementById('intentosMessage').textContent = 
                        '❌ Ya completaste tus 2 intentos permitidos. Solo podés ver el dashboard.';
                    return;
                }
                
                if (playerAttempts === 1) {
                    document.getElementById('intentosMessage').style.display = 'block';
                    document.getElementById('intentosMessage').textContent = 
                        '⚠️ Este es tu segundo y último intento.';
                }
            } catch (error) {
                console.error('Error checking attempts:', error);
                alert('Error conectando con la base de datos. Intenta de nuevo.');
                return;
            }
            
            currentPlayer = { name, id, team };
            document.getElementById('displayName').textContent = name;
            
            // Mostrar equipo con estilo
            const teamDisplay = document.getElementById('displayTeam');
            teamDisplay.textContent = `Grupo ${team}`;
            teamDisplay.className = `player-team team-${team.toLowerCase()}`;
            
            // Resetear variables del juego
            currentLevel = 1;
            score = 0;
            lives = 3;
            maxLevelReached = 1;
            answeredQuestions.clear();
            comodines = { fifty: true, change: true };
            correctStreak = 0;
            document.getElementById('comodin5050').disabled = false;
            document.getElementById('comodinChange').disabled = false;
            
            updateScore();
            updateLivesDisplay();
            updateCurrentLevel();
            
            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('gameScreen').style.display = 'block';
            
            showLevelScreen();
        }
        
        function showLevelScreen() {
            document.getElementById('levelScreen').style.display = 'block';
            document.getElementById('mainQuestionContainer').style.display = 'none';
            document.getElementById('nextButton').style.display = 'none';
            
            document.getElementById('levelNumber').textContent = currentLevel;
            document.getElementById('levelDescription').textContent = levelTitles[currentLevel] || "Nivel sin descripción";
        }
        
        function startLevel() {
            document.getElementById('levelScreen').style.display = 'none';
            document.getElementById('mainQuestionContainer').style.display = 'block';
            loadQuestion();
        }
        
        function loadQuestion() {
            eliminated5050 = false;
            
            // Filtrar preguntas disponibles del nivel actual
            const levelQuestions = questionBank.filter(q => q.level === currentLevel);
            const availableQuestions = levelQuestions.filter(q => !answeredQuestions.has(q.question));
            
            if (availableQuestions.length === 0) {
                // Si no hay preguntas disponibles, reiniciar el pool para este nivel
                answeredQuestions.forEach(q => {
                    const questionLevel = questionBank.find(qb => qb.question === q)?.level;
                    if (questionLevel === currentLevel) {
                        answeredQuestions.delete(q);
                    }
                });
                
                // Volver a filtrar
                const resetAvailable = levelQuestions.filter(q => !answeredQuestions.has(q.question));
                currentQuestion = resetAvailable.length > 0 ? 
                    resetAvailable[Math.floor(Math.random() * resetAvailable.length)] :
                    levelQuestions[Math.floor(Math.random() * levelQuestions.length)];
            } else {
                currentQuestion = availableQuestions[Math.floor(Math.random() * availableQuestions.length)];
            }
            
            answeredQuestions.add(currentQuestion.question);
            
            document.getElementById('questionText').textContent = currentQuestion.question;
            shuffledOptions = currentQuestion.options.slice().sort(() => Math.random() - 0.5);
            
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            
            shuffledOptions.forEach((option, index) => {
                const optionElement = document.createElement('div');
                optionElement.className = 'option';
                optionElement.textContent = option.text;
                optionElement.onclick = () => selectOption(option, optionElement);
                optionsContainer.appendChild(optionElement);
            });
            
            document.getElementById('nextButton').style.display = 'none';
            startTimer();
        }
        
        function startTimer() {
            timeLeft = 30;
            updateTimerDisplay();
            
            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();
                
                if (timeLeft <= 10) {
                    document.getElementById('timer').classList.add('warning');
                }
                
                if (timeLeft <= 0) {
                    timeOut();
                }
            }, 1000);
        }
        
        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            document.getElementById('timer').classList.remove('warning');
        }
        
        function updateTimerDisplay() {
            document.getElementById('timer').textContent = timeLeft;
        }
        
        function timeOut() {
            stopTimer();
            // Tiempo agotado = respuesta incorrecta = 0 puntos
            lives--;
            correctStreak = 0;
            updateLivesDisplay();
            
            const allOptions = document.querySelectorAll('.option');
            allOptions.forEach((optElement, idx) => {
                optElement.classList.add('disabled');
                optElement.onclick = null;
                if (shuffledOptions[idx].correct) {
                    optElement.classList.add('correct');
                }
            });
            
            if (lives <= 0) {
                setTimeout(endGame, 2000);
            } else {
                setTimeout(() => {
                    document.getElementById('nextButton').style.display = 'inline-block';
                }, 1500);
            }
        }
        
        function selectOption(option, element) {
            stopTimer();
            
            if (element.classList.contains('eliminated')) {
                return;
            }
            
            const allOptions = document.querySelectorAll('.option');
            allOptions.forEach(opt => {
                opt.classList.add('disabled');
                opt.onclick = null;
            });
            
            // Sistema de puntuación con bonus por tiempo
            if (option.correct) {
                element.classList.add('correct');
                correctStreak++;
                
                // Puntos base + bonus por tiempo
                let points = 1;
                if (timeLeft >= 20) points += 1; // Respuesta rápida
                if (currentLevel >= 20) points += 1; // Niveles difíciles
                
                score += points;
                showCombo(correctStreak);
                
                // Logros especiales
                if (correctStreak === 3) {
                    showAchievement("¡En racha!", "3 respuestas correctas seguidas");
                }
            } else {
                element.classList.add('incorrect');
                correctStreak = 0;
                lives--;
                
                // Mostrar la opción correcta
                allOptions.forEach((optElement, idx) => {
                    if (shuffledOptions[idx].correct) {
                        optElement.classList.add('correct');
                    }
                });
            }
            
            updateScore();
            updateLivesDisplay();
            
            if (lives <= 0) {
                setTimeout(endGame, 2000);
                return;
            }
            
            setTimeout(() => {
                document.getElementById('nextButton').style.display = 'inline-block';
            }, 1500);
        }
        
        function nextQuestion() {
            // Verificar ANTES de incrementar si ya completamos todos los niveles
            if (currentLevel >= 30) {
                endGame();
                return;
            }
            
            currentLevel++;
            updateCurrentLevel();
            
            if (currentLevel > maxLevelReached) {
                maxLevelReached = currentLevel;
            }
            
            showLevelScreen();
        }
        
        function use5050() {
            if (!comodines.fifty) return;
            
            comodines.fifty = false;
            document.getElementById('comodin5050').disabled = true;
            
            const incorrectIndices = [];
            shuffledOptions.forEach((option, index) => {
                if (!option.correct) {
                    incorrectIndices.push(index);
                }
            });
            
            const toEliminate = incorrectIndices.sort(() => Math.random() - 0.5).slice(0, 2);
            
            toEliminate.forEach(index => {
                const optionElement = document.querySelectorAll('.option')[index];
                optionElement.classList.add('eliminated');
                optionElement.onclick = null;
            });
        }
        
        function changeQuestion() {
            if (!comodines.change) return;
            
            comodines.change = false;
            document.getElementById('comodinChange').disabled = true;
            
            // Guardar la pregunta actual para no repetirla
            const currentQuestionText = currentQuestion.question;
            
            // Filtrar preguntas disponibles del nivel actual (excluyendo la actual)
            const levelQuestions = questionBank.filter(q => q.level === currentLevel && q.question !== currentQuestionText);
            const availableQuestions = levelQuestions.filter(q => !answeredQuestions.has(q.question));
            
            if (availableQuestions.length > 0) {
                // Hay preguntas disponibles diferentes
                currentQuestion = availableQuestions[Math.floor(Math.random() * availableQuestions.length)];
            } else {
                // No hay más preguntas, usar cualquiera diferente a la actual
                const differentQuestions = levelQuestions.length > 0 ? levelQuestions : 
                    questionBank.filter(q => q.level === currentLevel && q.question !== currentQuestionText);
                if (differentQuestions.length > 0) {
                    currentQuestion = differentQuestions[Math.floor(Math.random() * differentQuestions.length)];
                } else {
                    // Último recurso: mantener la pregunta actual
                    alert('No hay más preguntas disponibles para este nivel');
                    comodines.change = true;
                    document.getElementById('comodinChange').disabled = false;
                    return;
                }
            }
            
            answeredQuestions.add(currentQuestion.question);
            
            // Recargar la interfaz
            document.getElementById('questionText').textContent = currentQuestion.question;
            shuffledOptions = currentQuestion.options.slice().sort(() => Math.random() - 0.5);
            
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            
            shuffledOptions.forEach((option, index) => {
                const optionElement = document.createElement('div');
                optionElement.className = 'option';
                optionElement.textContent = option.text;
                optionElement.onclick = () => selectOption(option, optionElement);
                optionsContainer.appendChild(optionElement);
            });
            
            // Reiniciar timer
            stopTimer();
            startTimer();
        }
        
        function updateScore() {
            document.getElementById('score').textContent = score;
        }
        
        function updateCurrentLevel() {
            document.getElementById('currentLevelDisplay').textContent = currentLevel;
        }
        
        function updateLivesDisplay() {
            const hearts = ['heart1', 'heart2', 'heart3'];
            hearts.forEach((heartId, index) => {
                const heart = document.getElementById(heartId);
                if (index < lives) {
                    heart.className = 'heart active';
                } else {
                    heart.className = 'heart lost';
                }
            });
        }
        
        function getLevelTitle(level) {
            return levelTitles[level] || "Estudiante de primer año con estetoscopio al revés";
        }
        
        async function endGame() {
            stopTimer();
            
            // Asegurar que el nivel máximo nunca exceda 30
            if (maxLevelReached > 30) {
                maxLevelReached = 30;
            }
            
            // Logros finales
            if (maxLevelReached >= 25) {
                showAchievement("¡Maestro cardiólogo!", "Alcanzaste un nivel élite");
            } else if (maxLevelReached >= 20) {
                showAchievement("¡Experto reconocido!", "Nivel avanzado alcanzado");
            } else if (maxLevelReached >= 15) {
                showAchievement("¡En camino a la excelencia!", "Buen desempeño");
            }
            
            const result = {
                nombre: currentPlayer.name,
                cedula: currentPlayer.id,
                grupo: currentPlayer.team,
                puntaje: score,
                nivel: maxLevelReached,
                titulo: getLevelTitle(maxLevelReached),
                fecha: new Date().toLocaleString('es-UY'),
                intento: playerAttempts + 1
            };
            
            try {
                await saveGameResult(result);
                console.log('Resultado guardado exitosamente');
            } catch (error) {
                console.error('Error guardando resultado:', error);
                alert('Error guardando el resultado. Tu progreso puede no haberse guardado.');
            }
            
            document.getElementById('gameScreen').style.display = 'none';
            document.getElementById('resultsScreen').style.display = 'block';
            
            document.getElementById('finalScore').textContent = score;
            document.getElementById('maxLevel').textContent = maxLevelReached;
            document.getElementById('levelName').textContent = result.titulo;
            document.getElementById('levelHoroscope').textContent = 
                levelDescriptions[maxLevelReached] || levelDescriptions[1];
            
            document.getElementById('retryButton').style.display = 
                (playerAttempts + 1) < 2 ? 'inline-block' : 'none';
        }
        
        function retryGame() {
            lives = 3;
            currentLevel = 1;
            score = 0;
            maxLevelReached = 1;
            answeredQuestions.clear();
            comodines = { fifty: true, change: true };
            correctStreak = 0;
            document.getElementById('comodin5050').disabled = false;
            document.getElementById('comodinChange').disabled = false;
            
            document.getElementById('resultsScreen').style.display = 'none';
            document.getElementById('gameScreen').style.display = 'block';
            
            updateScore();
            updateLivesDisplay();
            updateCurrentLevel();
            showLevelScreen();
        }
        
        function newGame() {
            document.getElementById('resultsScreen').style.display = 'none';
            document.getElementById('startScreen').style.display = 'block';
            document.getElementById('playerName').value = '';
            document.getElementById('playerId').value = '';
            document.getElementById('playerTeam').value = '';
            document.getElementById('intentosMessage').style.display = 'none';
        }
    </script>
</body>
</html>