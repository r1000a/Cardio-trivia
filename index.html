<!DOCTYPE html>
<html lang="es-UY">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>¬øQui√©n quiere ser cardi√≥logo? - Competencia por Equipos</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
            color: #e2e8f0;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow-x: hidden;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, transparent 20%, rgba(59, 130, 246, 0.15) 20%, rgba(59, 130, 246, 0.15) 21%, transparent 21%, transparent 30%, rgba(59, 130, 246, 0.1) 30%, rgba(59, 130, 246, 0.1) 31%, transparent 31%);
            background-size: 60px 60px;
            animation: rotate 180s linear infinite;
            opacity: 0.4;
            z-index: -1;
        }
        
        @keyframes rotate {
            to { transform: rotate(360deg); }
        }
        
        .container {
            width: 95%;
            max-width: 1200px;
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(20px);
            border: 2px solid rgba(59, 130, 246, 0.3);
            border-radius: 24px;
            padding: 24px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25), 0 0 0 1px rgba(59, 130, 246, 0.1);
            position: relative;
            z-index: 1;
            max-height: 95vh;
            overflow-y: auto;
        }
        
        /* Logos institucionales */
        .institutional-header {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 40px;
            margin-bottom: 20px;
            padding: 16px;
            background: rgba(30, 41, 59, 0.3);
            border-radius: 16px;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }
        
        .logo-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }
        
        .logo {
            height: 60px;
            width: auto;
            opacity: 0.9;
            transition: all 0.3s ease;
            filter: brightness(1.1);
        }
        
        .logo:hover {
            opacity: 1;
            transform: scale(1.05);
        }
        
        .logo-text {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            color: #94a3b8;
            text-align: center;
            font-weight: 500;
        }
        
        /* Contador de visitas */
        .stats-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 12px;
            padding: 12px 16px;
            margin-bottom: 20px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875rem;
        }
        
        .visit-counter {
            color: #60a5fa;
        }
        
        .online-players {
            color: #22c55e;
        }
        
        .last-update {
            color: #94a3b8;
        }
        
        h1 {
            font-size: 2.75rem;
            font-weight: 700;
            text-align: center;
            background: linear-gradient(135deg, #60a5fa, #3b82f6, #2563eb);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 12px;
            letter-spacing: -0.025em;
        }
        
        h2 {
            font-size: 1.875rem;
            font-weight: 600;
            text-align: center;
            color: #60a5fa;
            margin-bottom: 24px;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .subtitle {
            font-family: 'JetBrains Mono', monospace;
            text-align: center;
            color: #94a3b8;
            font-size: 1.125rem;
            margin-bottom: 32px;
            letter-spacing: 0.05em;
            font-weight: 500;
        }
        
        .nav-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 32px;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .nav-tab {
            background: rgba(30, 58, 138, 0.2);
            color: #e2e8f0;
            border: 2px solid rgba(59, 130, 246, 0.3);
            padding: 12px 24px;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: 'JetBrains Mono', monospace;
            font-weight: 500;
            font-size: 0.875rem;
        }
        
        .nav-tab.active {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.3);
            transform: translateY(-2px);
        }
        
        .nav-tab:hover:not(.active) {
            background: rgba(59, 130, 246, 0.2);
            border-color: rgba(59, 130, 246, 0.5);
            transform: translateY(-1px);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Admin Panel */
        .admin-panel {
            background: rgba(220, 38, 38, 0.1);
            border: 2px solid rgba(220, 38, 38, 0.3);
            border-radius: 16px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }
        
        .admin-password {
            width: 300px;
            padding: 12px;
            margin: 12px;
            background: rgba(15, 23, 42, 0.8);
            border: 2px solid rgba(220, 38, 38, 0.3);
            border-radius: 8px;
            color: #e2e8f0;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .admin-data {
            background: rgba(15, 23, 42, 0.6);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            max-height: 500px;
            overflow-y: auto;
        }
        
        /* Pantalla de inicio */
        #startScreen {
            text-align: center;
        }
        
        .form-group {
            margin: 24px 0;
            text-align: left;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-size: 1.125rem;
            font-weight: 500;
            color: #60a5fa;
        }
        
        input, select {
            width: 100%;
            padding: 16px;
            font-size: 1rem;
            background: rgba(30, 41, 59, 0.8);
            border: 2px solid rgba(59, 130, 246, 0.3);
            border-radius: 12px;
            color: #e2e8f0;
            font-family: 'Inter', sans-serif;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #3b82f6;
            background: rgba(30, 41, 59, 0.95);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        select option {
            background: #1e293b;
            color: #e2e8f0;
        }
        
        .privacy-note {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 12px;
            padding: 16px;
            margin: 24px 0;
            font-size: 0.875rem;
            color: #94a3b8;
            line-height: 1.6;
        }
        
        .btn {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            border: none;
            padding: 14px 32px;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            margin: 8px;
            font-family: 'Inter', sans-serif;
            letter-spacing: 0.025em;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.3);
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
        }
        
        .btn-danger:hover {
            background: linear-gradient(135deg, #b91c1c, #991b1b);
        }
        
        /* Dashboard */
        .dashboard-section {
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 24px;
            margin: 24px 0;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin: 24px 0;
        }
        
        .stat-card {
            background: rgba(15, 23, 42, 0.6);
            border: 2px solid rgba(59, 130, 246, 0.2);
            border-radius: 16px;
            padding: 24px;
            text-align: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .stat-card:hover {
            border-color: rgba(59, 130, 246, 0.4);
            transform: translateY(-2px);
        }
        
        .stat-number {
            font-size: 2.5rem;
            color: #60a5fa;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .stat-label {
            color: #94a3b8;
            font-size: 1rem;
            font-weight: 500;
            margin-top: 8px;
        }
        
        /* Team rankings styles */
        .team-rankings {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
            margin: 24px 0;
        }
        
        .team-section {
            background: rgba(15, 23, 42, 0.6);
            border-radius: 16px;
            padding: 20px;
            border: 2px solid rgba(59, 130, 246, 0.2);
            transition: all 0.3s ease;
        }
        
        .team-section:hover {
            border-color: rgba(59, 130, 246, 0.4);
            transform: translateY(-2px);
        }
        
        .team-section.team-a {
            border-color: rgba(34, 197, 94, 0.4);
        }
        
        .team-section.team-b {
            border-color: rgba(59, 130, 246, 0.4);
        }
        
        .team-section.team-c {
            border-color: rgba(251, 191, 36, 0.4);
        }
        
        .team-section.team-individual {
            border-color: rgba(139, 92, 246, 0.4);
        }
        
        .team-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding: 12px;
            border-radius: 8px;
        }
        
        .team-a .team-header {
            background: rgba(34, 197, 94, 0.1);
        }
        
        .team-b .team-header {
            background: rgba(59, 130, 246, 0.1);
        }
        
        .team-c .team-header {
            background: rgba(251, 191, 36, 0.1);
        }
        
        .team-individual .team-header {
            background: rgba(139, 92, 246, 0.1);
        }
        
        .team-name {
            font-size: 1.5rem;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .team-a .team-name {
            color: #22c55e;
        }
        
        .team-b .team-name {
            color: #3b82f6;
        }
        
        .team-c .team-name {
            color: #fbbf24;
        }
        
        .team-individual .team-name {
            color: #8b5cf6;
        }
        
        .team-stats {
            display: flex;
            gap: 16px;
            font-size: 0.875rem;
            color: #94a3b8;
        }
        
        /* Game screen styles */
        #gameScreen {
            display: none;
            text-align: center;
        }
        
        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding: 16px;
            background: rgba(30, 41, 59, 0.6);
            border-radius: 12px;
        }
        
        .game-info {
            display: flex;
            gap: 24px;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .lives {
            color: #ef4444;
            font-weight: 600;
        }
        
        .timer {
            color: #60a5fa;
            font-weight: 600;
            font-size: 1.25rem;
        }
        
        .question-container {
            background: rgba(30, 41, 59, 0.4);
            border: 2px solid rgba(59, 130, 246, 0.3);
            border-radius: 16px;
            padding: 32px;
            margin-bottom: 24px;
        }
        
        .question {
            font-size: 1.5rem;
            font-weight: 600;
            color: #e2e8f0;
            margin-bottom: 32px;
            line-height: 1.5;
        }
        
        .options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .option {
            padding: 20px;
            background: rgba(15, 23, 42, 0.8);
            border: 2px solid rgba(59, 130, 246, 0.3);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1.125rem;
            text-align: left;
        }
        
        .option:hover:not(.eliminated):not(.correct):not(.incorrect) {
            background: rgba(59, 130, 246, 0.2);
            border-color: rgba(59, 130, 246, 0.5);
            transform: translateY(-2px);
        }
        
        .option.correct {
            background: rgba(34, 197, 94, 0.3);
            border-color: #22c55e;
        }
        
        .option.incorrect {
            background: rgba(220, 38, 38, 0.3);
            border-color: #dc2626;
        }
        
        .option.eliminated {
            opacity: 0.5;
            cursor: not-allowed;
            text-decoration: line-through;
        }
        
        .lifelines {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .lifeline {
            padding: 12px 24px;
            background: rgba(139, 92, 246, 0.2);
            border: 2px solid rgba(139, 92, 246, 0.3);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .lifeline:hover:not(.used) {
            background: rgba(139, 92, 246, 0.3);
            border-color: rgba(139, 92, 246, 0.5);
            transform: translateY(-2px);
        }
        
        .lifeline.used {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Result screen */
        #resultScreen {
            display: none;
            text-align: center;
        }
        
        .result-card {
            background: rgba(30, 41, 59, 0.6);
            border: 2px solid rgba(59, 130, 246, 0.3);
            border-radius: 16px;
            padding: 48px;
            margin: 32px auto;
            max-width: 600px;
        }
        
        .result-score {
            font-size: 4rem;
            font-weight: 700;
            color: #60a5fa;
            margin-bottom: 16px;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .result-level {
            font-size: 1.5rem;
            color: #94a3b8;
            margin-bottom: 32px;
        }
        
        /* Forum member badge */
        .forum-badge {
            display: inline-block;
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            padding: 4px 12px;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 600;
            margin-left: 8px;
        }
        
        .auto-assigned-message {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
            border-radius: 12px;
            padding: 16px;
            margin: 16px 0;
            color: #22c55e;
            font-weight: 500;
        }
        
        .loading {
            text-align: center;
            color: #94a3b8;
            font-style: italic;
        }
        
        .error-message {
            background: rgba(220, 38, 38, 0.1);
            border: 2px solid rgba(220, 38, 38, 0.3);
            border-radius: 12px;
            padding: 16px;
            margin: 16px 0;
            color: #f87171;
            text-align: center;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            body {
                align-items: flex-start;
                padding: 10px;
            }
            
            .container {
                width: 100%;
                margin: 0;
                border-radius: 16px;
                padding: 16px;
                max-height: none;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .institutional-header {
                flex-direction: column;
                gap: 20px;
            }
            
            .logo {
                height: 50px;
            }
            
            .nav-tabs {
                justify-content: flex-start;
                overflow-x: auto;
                padding-bottom: 8px;
            }
            
            .stats-bar {
                flex-direction: column;
                gap: 8px;
                text-align: center;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .team-rankings {
                grid-template-columns: 1fr;
            }
            
            .options {
                grid-template-columns: 1fr;
            }
            
            .admin-password {
                width: 90%;
                max-width: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Barra de estad√≠sticas en tiempo real -->
        <div class="stats-bar">
            <div class="visit-counter">
                üåê Visitas: <span id="visitCount">-</span>
            </div>
            <div class="online-players">
                üë§ Jugando ahora: <span id="onlinePlayers">-</span>
            </div>
            <div class="last-update">
                üîÑ √öltima actualizaci√≥n: <span id="lastUpdate">-</span>
            </div>
        </div>
        
        <!-- Header institucional -->
        <div class="institutional-header">
            <div class="logo-container">
                <img src="logo-ccu.png" alt="Centro Cardiovascular Universitario" class="logo" id="logo-ccu">
                <div class="logo-text">Centro Cardiovascular<br>Universitario</div>
            </div>
            <div class="logo-container">
                <img src="logo-uac.png" alt="Unidad Acad√©mica de Cardiolog√≠a" class="logo" id="logo-uac">
                <div class="logo-text">Unidad Acad√©mica<br>de Cardiolog√≠a</div>
            </div>
        </div>
        
        <!-- Navegaci√≥n -->
        <div class="nav-tabs">
            <div class="nav-tab active" onclick="showTab('dashboard')">üìä Dashboard</div>
            <div class="nav-tab" onclick="showTab('individual')">üèÜ Individual</div>
            <div class="nav-tab" onclick="showTab('equipos')">üë• Equipos</div>
            <div class="nav-tab" onclick="showTab('game')">üéÆ Jugar</div>
            <div class="nav-tab" onclick="showTab('admin')">üîê Admin</div>
        </div>
        
        <!-- Dashboard General -->
        <div id="dashboard" class="tab-content active">
            <h1>üè• Dashboard General</h1>
            <p class="subtitle">COMPETENCIA INDIVIDUAL Y POR EQUIPOS</p>
            
            <!-- Estad√≠sticas Generales -->
            <div class="dashboard-section">
                <h2>üìà Estad√≠sticas Generales</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalJugadores">-</div>
                        <div class="stat-label">Total Participantes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalPartidas">-</div>
                        <div class="stat-label">Partidas Iniciadas</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="promedioScore">-</div>
                        <div class="stat-label">Puntaje Promedio</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="nivelMaximo">-</div>
                        <div class="stat-label">Nivel M√°ximo Alcanzado</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="jugadoresHoy">-</div>
                        <div class="stat-label">Participantes Hoy</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="visitasHoy">-</div>
                        <div class="stat-label">Visitas de Hoy</div>
                    </div>
                </div>
            </div>
            
            <!-- Ranking por Equipos -->
            <div class="dashboard-section">
                <h2>ü•á Ranking de Equipos</h2>
                <div class="team-rankings" id="teamRankings">
                    <div class="loading">Cargando estad√≠sticas de equipos...</div>
                </div>
            </div>
        </div>
        
        <!-- Ranking Individual -->
        <div id="individual" class="tab-content">
            <h1>üèÜ Ranking Individual</h1>
            <p class="subtitle">MEJORES PARTICIPANTES</p>
            <div class="loading">Cargando ranking individual...</div>
        </div>
        
        <!-- Ranking por Equipos -->
        <div id="equipos" class="tab-content">
            <h1>üë• Competencia por Equipos</h1>
            <p class="subtitle">RANKING DETALLADO POR GRUPO</p>
            <div class="loading">Cargando estad√≠sticas detalladas...</div>
        </div>
        
        <!-- Panel de Administraci√≥n -->
        <div id="admin" class="tab-content">
            <h1>üîê Panel de Administraci√≥n</h1>
            <p class="subtitle">ACCESO RESTRINGIDO</p>
            
            <div class="admin-panel">
                <h2>üîí Acceso Privado</h2>
                <p>Ingresa la contrase√±a para ver los datos de los participantes:</p>
                <input type="password" id="adminPassword" class="admin-password" placeholder="Contrase√±a de administrador">
                <br>
                <button class="btn" onclick="verifyAdmin()">Acceder</button>
                
                <div id="adminData" class="admin-data" style="display: none;">
                    <h3>üìã Registro Completo de Participantes</h3>
                    <button class="btn" onclick="exportAdminData()">üì• Descargar Excel</button>
                    <button class="btn btn-danger" onclick="clearAllData()">üóëÔ∏è Limpiar Datos</button>
                    
                    <div id="adminTable" style="margin-top: 20px;">
                        <!-- Tabla de admin se genera aqu√≠ -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Pantalla de Juego -->
        <div id="game" class="tab-content">
            <!-- Pantalla de inicio -->
            <div id="startScreen">
                <h1>¬øQui√©n quiere ser cardi√≥logo?</h1>
                <p class="subtitle">COMPETENCIA INDIVIDUAL Y POR EQUIPOS</p>
                
                <form onsubmit="event.preventDefault(); startGame();">
                    <div class="form-group">
                        <label for="playerName">üìù Nombre y apellido:</label>
                        <input type="text" id="playerName" placeholder="Dr. Juan P√©rez L√≥pez" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="playerNickname">üé≠ Pseud√≥nimo (aparecer√° en los rankings):</label>
                        <input type="text" id="playerNickname" placeholder="CardioMaster2025" required maxlength="20" 
                               style="background-color: rgba(59, 130, 246, 0.1); border-color: #3b82f6;">
                        <small style="color: #94a3b8; font-size: 0.8rem;">Solo letras, n√∫meros y gui√≥n bajo. Entre 3-20 caracteres.</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="playerId">üÜî C√©dula de identidad (sin d√≠gito verificador):</label>
                        <input type="text" id="playerId" placeholder="1234567" required>
                    </div>
                    
                    <div id="autoAssignedGroup" class="auto-assigned-message" style="display: none;">
                        ‚úÖ ¬°C√©dula validada! Has sido asignado autom√°ticamente al <strong id="assignedGroupName"></strong>
                    </div>
                    
                    <div class="form-group" id="teamSelectGroup">
                        <label for="playerTeam">üéØ Modalidad de juego:</label>
                        <select id="playerTeam" required>
                            <option value="">Selecciona tu modalidad</option>
                            <option value="A">üë• Grupo A (competencia por equipos)</option>
                            <option value="B">üë• Grupo B (competencia por equipos)</option>
                            <option value="C">üë• Grupo C (competencia por equipos)</option>
                            <option value="INDIVIDUAL">üèÜ Individual (solo tu puntaje)</option>
                        </select>
                    </div>
                </form>
                
                <div class="privacy-note">
                    üèÜ <strong>Competencia:</strong> Si eres miembro del foro, ser√°s asignado autom√°ticamente a tu grupo. Si no, puedes elegir jugar individualmente.
                    <br>üîí <strong>Privacidad:</strong> Tu nombre real es privado (solo lo ve el administrador), en los rankings p√∫blicos aparece tu pseud√≥nimo. 
                    <br>üìã <strong>Validaci√≥n:</strong> Tu c√©dula valida tu participaci√≥n y pertenencia al foro.
                    <br>üéÆ <strong>L√≠mites:</strong> M√°ximo 2 intentos por persona.
                </div>
                
                <div id="intentosMessage" style="display: none; color: #f59e0b; margin: 20px 0; font-weight: bold;"></div>
                
                <button class="btn" onclick="startGame()">üöÄ COMENZAR COMPETENCIA</button>
            </div>
            
            <!-- Pantalla de juego -->
            <div id="gameScreen">
                <div class="game-header">
                    <div class="game-info">
                        <div>Nivel: <span id="currentLevel">1</span>/15</div>
                        <div>Puntaje: <span id="currentScore">0</span></div>
                        <div class="lives">‚ù§Ô∏è <span id="livesCount">3</span></div>
                    </div>
                    <div class="timer">‚è±Ô∏è <span id="timeLeft">30</span>s</div>
                </div>
                
                <div class="question-container">
                    <div class="question" id="questionText"></div>
                    <div class="options" id="optionsContainer"></div>
                    <div class="lifelines">
                        <button class="lifeline" id="fifty" onclick="useFiftyFifty()">
                            50:50
                        </button>
                        <button class="lifeline" id="change" onclick="changeQuestion()">
                            üîÑ Cambiar
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Pantalla de resultados -->
            <div id="resultScreen">
                <h1>üéâ ¬°Juego Completado!</h1>
                <div class="result-card">
                    <div class="result-score" id="finalScore">0</div>
                    <div class="result-level">Nivel alcanzado: <span id="finalLevel">1</span>/15</div>
                    <div id="teamResult" style="margin: 20px 0; font-size: 1.25rem;"></div>
                    <button class="btn" onclick="location.reload()">üîÑ Volver al inicio</button>
                </div>
            </div>
        </div>

        <!-- Error message container -->
        <div id="errorMessage" class="error-message" style="display: none;"></div>
    </div>
    
    <script>
        // Configuraci√≥n Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAF1UK57tg4jK856RSU7Qcr1MT8QEeY4-o",
            authDomain: "cardiologia-game-uy.firebaseapp.com",
            databaseURL: "https://cardiologia-game-uy-default-rtdb.firebaseio.com",
            projectId: "cardiologia-game-uy",
            storageBucket: "cardiologia-game-uy.firebasestorage.app",
            messagingSenderId: "950754238661",
            appId: "1:950754238661:web:3df1bc9c9089f3308410ac",
            measurementId: "G-R6SPME7MHK"
        };
        
        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // Base de datos de miembros del foro (c√©dulas extra√≠das del Excel)
        const validForumMembers = {
            "27517612": "B", "30995275": "A", "31138428": "C", "31756199": "C", "35015820": "B",
            "35754076": "B", "36975247": "B", "38978912": "B", "39875680": "B", "40452069": "C",
            "40688920": "B", "41078609": "C", "41211117": "B", "41232290": "A", "41295530": "A",
            "41439671": "C", "41440180": "A", "41605018": "C", "41795596": "A", "41866668": "C",
            "41889993": "C", "41896580": "A", "41943091": "A", "41995033": "C", "42001180": "A",
            "42059940": "A", "42088810": "C", "42103230": "A", "42159613": "A", "42232511": "C",
            "42409810": "B", "42487125": "B", "42595420": "A", "42690517": "B", "42712120": "C",
            "42747430": "A", "42756312": "C", "42802641": "C", "42959903": "B", "43002210": "A",
            "43198240": "C", "43274741": "C", "43345260": "B", "43431922": "B", "43558613": "C",
            "43574790": "B", "43596650": "C", "43770710": "B", "43791012": "B", "43803923": "A",
            "43850011": "A", "43853018": "C", "43944515": "A", "44010510": "A", "44045918": "C",
            "44166328": "B", "44235311": "A", "44343113": "C", "44357312": "B", "44381010": "C",
            "44390916": "C", "44401626": "C", "44449725": "A", "44457319": "B", "44544822": "C",
            "44613040": "C", "44662415": "B", "44684316": "B", "44708510": "A", "44869140": "A",
            "44940318": "B", "44941416": "A", "45031015": "C", "45068422": "B", "45142211": "B",
            "45182220": "B", "45212010": "C", "45283613": "B", "45448628": "A", "45537325": "C",
            "45692614": "A", "45774816": "B", "45908810": "C", "45966318": "A", "46100113": "C",
            "46138788": "A", "46211619": "A", "46452827": "C", "46539922": "C", "46639618": "A",
            "46896620": "C", "47085610": "A", "47136619": "A", "47188923": "B", "47240111": "B",
            "47355012": "B", "49273848": "C", "49490115": "C", "49557311": "A", "50301612": "C",
            "65354721": "A"
        };
        
        // Variables globales
        let currentPlayer = { name: '', nickname: '', id: '', team: '' };
        let currentLevel = 1;
        let score = 0;
        let lives = 3;
        let maxLevelReached = 1;
        let currentQuestion = null;
        let answeredQuestions = new Set();
        let timeLeft = 30;
        let timerInterval = null;
        let comodines = { fifty: true, change: true };
        let shuffledOptions = [];
        let eliminated5050 = false;
        let playerAttempts = 0;
        let isAdminAuthenticated = false;
        const ADMIN_PASSWORD = "cardio2025admin";
        let correctStreak = 0;
        let currentSessionId = null;
        let gameStartId = null;
        
        // Banco de preguntas de cardiolog√≠a
        const questionBank = [
            // Nivel 1-3 (F√°cil)
            {
                question: "¬øCu√°l es la frecuencia card√≠aca normal en reposo de un adulto?",
                options: ["60-100 lpm", "40-60 lpm", "100-120 lpm", "120-140 lpm"],
                correct: 0,
                level: 1
            },
            {
                question: "¬øCu√°l es la presi√≥n arterial normal en un adulto?",
                options: ["<120/80 mmHg", "<140/90 mmHg", "<160/100 mmHg", "<100/60 mmHg"],
                correct: 0,
                level: 1
            },
            {
                question: "¬øCu√°l es el marcapasos natural del coraz√≥n?",
                options: ["Nodo sinusal", "Nodo AV", "Haz de His", "Fibras de Purkinje"],
                correct: 0,
                level: 1
            },
            {
                question: "¬øCu√°ntas v√°lvulas tiene el coraz√≥n?",
                options: ["4", "2", "3", "5"],
                correct: 0,
                level: 1
            },
            {
                question: "¬øQu√© arteria irriga principalmente el ventr√≠culo izquierdo?",
                options: ["Descendente anterior", "Circunfleja", "Coronaria derecha", "Marginal"],
                correct: 0,
                level: 2
            },
            {
                question: "¬øCu√°l es el primer ruido card√≠aco (S1)?",
                options: ["Cierre de v√°lvulas AV", "Cierre de v√°lvulas semilunares", "Llenado ventricular", "Contracci√≥n auricular"],
                correct: 0,
                level: 2
            },
            {
                question: "¬øQu√© representa la onda P en el ECG?",
                options: ["Despolarizaci√≥n auricular", "Despolarizaci√≥n ventricular", "Repolarizaci√≥n ventricular", "Repolarizaci√≥n auricular"],
                correct: 0,
                level: 2
            },
            {
                question: "¬øCu√°l es la enzima card√≠aca m√°s espec√≠fica para infarto?",
                options: ["Troponina", "CPK", "LDH", "GOT"],
                correct: 0,
                level: 3
            },
            {
                question: "¬øQu√© f√°rmaco est√° contraindicado en el bloqueo AV completo?",
                options: ["Betabloqueantes", "IECA", "Estatinas", "Aspirina"],
                correct: 0,
                level: 3
            },
            {
                question: "¬øCu√°l es el tratamiento de primera l√≠nea para la fibrilaci√≥n auricular?",
                options: ["Control de frecuencia + anticoagulaci√≥n", "Cardioversi√≥n inmediata", "Ablaci√≥n", "Marcapasos"],
                correct: 0,
                level: 3
            },
            
            // Nivel 4-6 (Intermedio)
            {
                question: "¬øCu√°l es el mecanismo del edema en la insuficiencia card√≠aca?",
                options: ["Aumento de presi√≥n hidrost√°tica", "Disminuci√≥n de presi√≥n onc√≥tica", "Aumento de permeabilidad", "Obstrucci√≥n linf√°tica"],
                correct: 0,
                level: 4
            },
            {
                question: "¬øQu√© hallazgo ECG es t√≠pico del infarto inferior?",
                options: ["Elevaci√≥n ST en II, III, aVF", "Elevaci√≥n ST en V1-V4", "Depresi√≥n ST difusa", "Ondas Q en I, aVL"],
                correct: 0,
                level: 4
            },
            {
                question: "¬øCu√°l es la causa m√°s frecuente de muerte s√∫bita en atletas j√≥venes?",
                options: ["Miocardiopat√≠a hipertr√≥fica", "Infarto agudo", "TEP", "Ruptura a√≥rtica"],
                correct: 0,
                level: 4
            },
            {
                question: "¬øQu√© define el s√≠ndrome de Brugada tipo 1?",
                options: ["Elevaci√≥n ST ‚â•2mm en V1-V3 con morfolog√≠a coved", "PR corto + onda delta", "QT largo >460ms", "Alternancia el√©ctrica"],
                correct: 0,
                level: 5
            },
            {
                question: "¬øCu√°l es el score m√°s usado para estratificar riesgo en SCA?",
                options: ["GRACE", "CHADS2", "Wells", "TIMI"],
                correct: 0,
                level: 5
            },
            {
                question: "¬øQu√© par√°metro ecocardiogr√°fico define disfunci√≥n sist√≥lica severa?",
                options: ["FEVI <35%", "FEVI <45%", "FEVI <55%", "FEVI <65%"],
                correct: 0,
                level: 5
            },
            {
                question: "¬øCu√°l es el tratamiento de elecci√≥n para WPW sintom√°tico?",
                options: ["Ablaci√≥n por radiofrecuencia", "Betabloqueantes", "Amiodarona", "Verapamilo"],
                correct: 0,
                level: 6
            },
            {
                question: "¬øQu√© hallazgo define la estenosis a√≥rtica severa?",
                options: ["√Årea valvular <1 cm¬≤", "√Årea valvular <1.5 cm¬≤", "Gradiente medio >20 mmHg", "Velocidad m√°xima >3 m/s"],
                correct: 0,
                level: 6
            },
            {
                question: "¬øCu√°l es la indicaci√≥n clase I para CDI en prevenci√≥n primaria?",
                options: ["FEVI ‚â§35% + NYHA II-III", "FEVI ‚â§45% + NYHA I", "TV no sostenida", "S√≠ncope de origen desconocido"],
                correct: 0,
                level: 6
            },
            
            // Nivel 7-9 (Dif√≠cil)
            {
                question: "¬øQu√© mutaci√≥n gen√©tica es m√°s frecuente en la miocardiopat√≠a hipertr√≥fica?",
                options: ["MYH7", "MYBPC3", "TNNT2", "TPM1"],
                correct: 0,
                level: 7
            },
            {
                question: "¬øCu√°l es el mecanismo del fen√≥meno de Wenckebach?",
                options: ["Prolongaci√≥n progresiva del PR hasta bloqueo", "Bloqueo 2:1 fijo", "Disociaci√≥n AV completa", "PR corto con onda delta"],
                correct: 0,
                level: 7
            },
            {
                question: "¬øQu√© define el MINOCA?",
                options: ["IAM con coronarias normales", "Angina microvascular", "Espasmo coronario", "Disecci√≥n coronaria"],
                correct: 0,
                level: 7
            },
            {
                question: "¬øCu√°l es el punto de corte de BNP para descartar IC aguda?",
                options: ["<100 pg/mL", "<300 pg/mL", "<500 pg/mL", "<1000 pg/mL"],
                correct: 0,
                level: 8
            },
            {
                question: "¬øQu√© patr√≥n ECG sugiere hiperpotasemia severa?",
                options: ["Ondas T picudas + QRS ancho", "QT largo + torsade", "Elevaci√≥n ST difusa", "Depresi√≥n ST + T invertida"],
                correct: 0,
                level: 8
            },
            {
                question: "¬øCu√°l es la indicaci√≥n de denervaci√≥n renal en HTA?",
                options: ["HTA resistente con PA ‚â•160/100 pese a 3 f√°rmacos", "HTA grado 1", "HTA secundaria", "HTA de bata blanca"],
                correct: 0,
                level: 8
            },
            {
                question: "¬øQu√© hallazgo hemodin√°mico define el shock cardiog√©nico?",
                options: ["IC <2.2 L/min/m¬≤ + PCP >18 mmHg", "PAM <65 mmHg", "Lactato >2 mmol/L", "SvO2 <65%"],
                correct: 0,
                level: 9
            },
            {
                question: "¬øCu√°l es el mecanismo del signo de Kussmaul?",
                options: ["Aumento de PVC con inspiraci√≥n", "Disminuci√≥n de PVC con inspiraci√≥n", "Pulso parad√≥jico", "Alternancia el√©ctrica"],
                correct: 0,
                level: 9
            },
            {
                question: "¬øQu√© define la miocardiopat√≠a de takotsubo?",
                options: ["Discinesia apical + coronarias normales", "Hipocinesia global + coronarias normales", "Acinesia septal + LAD ocluida", "Discinesia basal + espasmo"],
                correct: 0,
                level: 9
            },
            
            // Nivel 10-12 (Muy dif√≠cil)
            {
                question: "¬øCu√°l es el punto de corte de FFR para indicar revascularizaci√≥n?",
                options: ["‚â§0.80", "‚â§0.75", "‚â§0.85", "‚â§0.90"],
                correct: 0,
                level: 10
            },
            {
                question: "¬øQu√© par√°metro define mejor la severidad de la insuficiencia mitral?",
                options: ["EROA ‚â•40 mm¬≤", "Vena contracta >7 mm", "Volumen regurgitante >30 mL", "Jet >40% AI"],
                correct: 0,
                level: 10
            },
            {
                question: "¬øCu√°l es la dosis de carga de prasugrel en SCACEST?",
                options: ["60 mg", "180 mg", "300 mg", "600 mg"],
                correct: 0,
                level: 10
            },
            {
                question: "¬øQu√© hallazgo ECG es patognom√≥nico de pericarditis?",
                options: ["Elevaci√≥n ST c√≥ncava difusa + depresi√≥n PR", "Elevaci√≥n ST convexa en V1-V4", "Alternancia el√©ctrica", "Bajo voltaje difuso"],
                correct: 0,
                level: 11
            },
            {
                question: "¬øCu√°l es el mecanismo del fen√≥meno de no-reflow post-ICP?",
                options: ["Obstrucci√≥n microvascular + espasmo + edema", "Reestenosis aguda", "Trombosis del stent", "Disecci√≥n coronaria"],
                correct: 0,
                level: 11
            },
            {
                question: "¬øQu√© define la respuesta hemodin√°mica anormal al ejercicio?",
                options: ["Ca√≠da de PA >10 mmHg o no aumento", "PA sist√≥lica >220 mmHg", "FC <85% te√≥rica", "Doble producto <20000"],
                correct: 0,
                level: 11
            },
            {
                question: "¬øCu√°l es el mecanismo del signo de Frank en IAM?",
                options: ["Pliegue diagonal del l√≥bulo auricular", "Xantelasmas", "Arco corneal", "N√≥dulos de Osler"],
                correct: 0,
                level: 12
            },
            {
                question: "¬øQu√© par√°metro strain define disfunci√≥n subcl√≠nica del VI?",
                options: ["GLS >-18%", "GLS >-20%", "GLS <-22%", "GLS <-16%"],
                correct: 0,
                level: 12
            },
            {
                question: "¬øCu√°l es la indicaci√≥n de ECMO-VA en shock cardiog√©nico?",
                options: ["Shock refractario + edad <75 + potencial recuperaci√≥n", "Cualquier shock cardiog√©nico", "Solo post-cardiotom√≠a", "Solo miocarditis fulminante"],
                correct: 0,
                level: 12
            },
            
            // Nivel 13-15 (Extremo)
            {
                question: "¬øQu√© mutaci√≥n define el s√≠ndrome de QT largo tipo 3?",
                options: ["SCN5A", "KCNQ1", "KCNH2", "KCNE1"],
                correct: 0,
                level: 13
            },
            {
                question: "¬øCu√°l es el punto de corte de iFR para indicar revascularizaci√≥n?",
                options: ["‚â§0.89", "‚â§0.80", "‚â§0.85", "‚â§0.92"],
                correct: 0,
                level: 13
            },
            {
                question: "¬øQu√© par√°metro hemodin√°mico diferencia la pericarditis constrictiva de la miocardiopat√≠a restrictiva?",
                options: ["Igualaci√≥n de presiones diast√≥licas + interdependencia ventricular", "PCP > PAD", "PAP >50 mmHg", "Gradiente transpulmonar >12"],
                correct: 0,
                level: 13
            },
            {
                question: "¬øCu√°l es el mecanismo del patr√≥n de repolarizaci√≥n precoz maligno?",
                options: ["Elevaci√≥n punto J ‚â•2mm inferior/lateral + onda J", "Elevaci√≥n ST <1mm V1-V3", "Onda T bif√°sica V2-V3", "QT largo + alternancia T"],
                correct: 0,
                level: 14
            },
            {
                question: "¬øQu√© define el fen√≥meno de stunning mioc√°rdico post-revascularizaci√≥n?",
                options: ["Disfunci√≥n reversible pese a flujo restaurado", "Necrosis irreversible", "Hibernaci√≥n cr√≥nica", "Remodelado adverso"],
                correct: 0,
                level: 14
            },
            {
                question: "¬øCu√°l es la ecuaci√≥n m√°s precisa para estimar √°rea valvular a√≥rtica por continuidad?",
                options: ["AVA = (TSVI √ó œÄr¬≤) / VTI Ao", "AVA = 220 / Tmedio", "AVA = CO / (gradiente √ó 44.3)", "AVA = Vmax √ó 0.25"],
                correct: 0,
                level: 14
            },
            {
                question: "¬øQu√© hallazgo molecular define la amiloidosis card√≠aca por transtiretina?",
                options: ["Dep√≥sito de TTR mal plegada", "Cadenas ligeras lambda", "Prote√≠na SAA", "Beta-2 microglobulina"],
                correct: 0,
                level: 15
            },
            {
                question: "¬øCu√°l es el mecanismo del patr√≥n en 'root sign' en la disecci√≥n a√≥rtica?",
                options: ["Dilataci√≥n de ra√≠z con regurgitaci√≥n central", "Prolapso comisural", "Restricci√≥n valvar", "Perforaci√≥n de velo"],
                correct: 0,
                level: 15
            },
            {
                question: "¬øQu√© par√°metro de mec√°nica auricular predice FA de novo post-ablaci√≥n?",
                options: ["Strain reservoir AI <23%", "Volumen AI >34 mL/m¬≤", "Velocidad A <50 cm/s", "TDI a' <8 cm/s"],
                correct: 0,
                level: 15
            }
        ];
        
        // Funciones b√°sicas
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.nav-tab').forEach(navTab => {
                navTab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            switch(tabName) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'individual':
                    loadIndividualRanking();
                    break;
                case 'equipos':
                    loadDetailedTeamRankings();
                    break;
            }
        }
        
        // Validaci√≥n de c√©dula al escribir
        document.getElementById('playerId').addEventListener('input', function() {
            const cedula = this.value.trim();
            
            // Solo validar si tiene entre 6 y 8 d√≠gitos
            if (/^\d{6,8}$/.test(cedula)) {
                if (validForumMembers[cedula]) {
                    const assignedGroup = validForumMembers[cedula];
                    
                    // Mostrar mensaje de asignaci√≥n autom√°tica
                    document.getElementById('autoAssignedGroup').style.display = 'block';
                    document.getElementById('assignedGroupName').textContent = `Grupo ${assignedGroup}`;
                    
                    // Seleccionar autom√°ticamente el grupo y deshabilitar el selector
                    document.getElementById('playerTeam').value = assignedGroup;
                    document.getElementById('playerTeam').disabled = true;
                    document.getElementById('teamSelectGroup').style.opacity = '0.6';
                } else {
                    // No es miembro del foro, puede elegir solo INDIVIDUAL
                    document.getElementById('autoAssignedGroup').style.display = 'none';
                    document.getElementById('playerTeam').disabled = false;
                    document.getElementById('teamSelectGroup').style.opacity = '1';
                    
                    // Actualizar las opciones disponibles
                    const teamSelect = document.getElementById('playerTeam');
                    teamSelect.innerHTML = `
                        <option value="">Selecciona tu modalidad</option>
                        <option value="INDIVIDUAL">üèÜ Individual (solo tu puntaje)</option>
                    `;
                    
                    // Agregar nota de que solo puede jugar individual
                    if (!document.getElementById('nonForumNote')) {
                        const note = document.createElement('div');
                        note.id = 'nonForumNote';
                        note.style.cssText = 'color: #f59e0b; font-size: 0.875rem; margin-top: 8px;';
                        note.textContent = '‚ö†Ô∏è No eres miembro del foro. Solo puedes participar en modalidad individual.';
                        document.getElementById('teamSelectGroup').appendChild(note);
                    }
                }
            } else {
                // Resetear si la c√©dula no es v√°lida
                document.getElementById('autoAssignedGroup').style.display = 'none';
                document.getElementById('playerTeam').disabled = false;
                document.getElementById('teamSelectGroup').style.opacity = '1';
                
                const nonForumNote = document.getElementById('nonForumNote');
                if (nonForumNote) nonForumNote.remove();
            }
        });
        
        async function startGame() {
            const name = document.getElementById('playerName').value.trim();
            const nickname = document.getElementById('playerNickname').value.trim();
            const id = document.getElementById('playerId').value.trim();
            const team = document.getElementById('playerTeam').value;
            
            if (!name || !nickname || !id || !team) {
                alert('Por favor, complet√° todos los campos');
                return;
            }
            
            // Validar formato de c√©dula
            if (!/^\d{6,8}$/.test(id)) {
                alert('La c√©dula debe tener entre 6 y 8 d√≠gitos, sin d√≠gito verificador');
                return;
            }
            
            // Validar pseud√≥nimo
            if (!/^[a-zA-Z0-9_√°√©√≠√≥√∫√º√±√Å√â√ç√ì√ö√ú√ë]{3,20}$/.test(nickname)) {
                alert('El pseud√≥nimo debe tener entre 3 y 20 caracteres (letras, n√∫meros y _ solamente)');
                return;
            }
            
            // Validar pertenencia al grupo si no es INDIVIDUAL
            if (team !== 'INDIVIDUAL') {
                if (!validForumMembers[id] || validForumMembers[id] !== team) {
                    alert('No est√°s autorizado para jugar en este grupo. Solo los miembros del foro pueden participar en la competencia por equipos.');
                    return;
                }
            }
            
            try {
                // Verificar intentos previos
                const attemptsSnapshot = await database.ref(`jugadores/${id}/intentos`).once('value');
                const attempts = attemptsSnapshot.val() || 0;
                
                if (attempts >= 2) {
                    document.getElementById('intentosMessage').style.display = 'block';
                    document.getElementById('intentosMessage').textContent = '‚ö†Ô∏è Ya has alcanzado el l√≠mite de 2 intentos.';
                    return;
                }
                
                // Guardar datos del jugador
                currentPlayer = { name, nickname, id, team };
                playerAttempts = attempts;
                
                // Registrar inicio de juego
                gameStartId = database.ref('gameStarts').push().key;
                await database.ref(`gameStarts/${gameStartId}`).set({
                    jugador: name,
                    cedula: id,
                    grupo: team,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    intento: attempts + 1
                });
                
                // Actualizar jugador online
                if (currentSessionId) {
                    await database.ref(`analytics/onlinePlayers/${currentSessionId}`).update({
                        status: 'playing',
                        cedula: id,
                        grupo: team
                    });
                }
                
                // Mostrar mensaje de intentos restantes
                if (attempts === 1) {
                    alert('¬°Este es tu √∫ltimo intento! Dale con todo üí™');
                }
                
                // Iniciar juego
                initGame();
                
            } catch (error) {
                console.error('Error starting game:', error);
                alert('Error al iniciar el juego. Por favor, intent√° nuevamente.');
            }
        }
        
        function initGame() {
            // Ocultar pantalla de inicio, mostrar juego
            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('gameScreen').style.display = 'block';
            
            // Resetear variables
            currentLevel = 1;
            score = 0;
            lives = 3;
            maxLevelReached = 1;
            answeredQuestions.clear();
            comodines = { fifty: true, change: true };
            correctStreak = 0;
            
            // Actualizar UI
            updateGameUI();
            
            // Cargar primera pregunta
            loadQuestion();
        }
        
        function updateGameUI() {
            document.getElementById('currentLevel').textContent = currentLevel;
            document.getElementById('currentScore').textContent = score;
            document.getElementById('livesCount').textContent = lives;
            
            // Actualizar estado de comodines
            document.getElementById('fifty').classList.toggle('used', !comodines.fifty);
            document.getElementById('change').classList.toggle('used', !comodines.change);
        }
        
        function loadQuestion() {
            // Filtrar preguntas por nivel y no respondidas
            const availableQuestions = questionBank.filter(q => 
                q.level === currentLevel && !answeredQuestions.has(questionBank.indexOf(q))
            );
            
            if (availableQuestions.length === 0) {
                // Si no hay m√°s preguntas del nivel, buscar del nivel anterior o siguiente
                const alternativeQuestions = questionBank.filter(q => 
                    Math.abs(q.level - currentLevel) <= 1 && !answeredQuestions.has(questionBank.indexOf(q))
                );
                
                if (alternativeQuestions.length > 0) {
                    currentQuestion = alternativeQuestions[Math.floor(Math.random() * alternativeQuestions.length)];
                } else {
                    // No hay m√°s preguntas disponibles
                    endGame();
                    return;
                }
            } else {
                currentQuestion = availableQuestions[Math.floor(Math.random() * availableQuestions.length)];
            }
            
            // Marcar pregunta como respondida
            answeredQuestions.add(questionBank.indexOf(currentQuestion));
            
            // Mostrar pregunta
            document.getElementById('questionText').textContent = currentQuestion.question;
            
            // Mezclar opciones
            const options = [...currentQuestion.options];
            const correctAnswer = options[currentQuestion.correct];
            shuffledOptions = options.sort(() => Math.random() - 0.5);
            const correctIndex = shuffledOptions.indexOf(correctAnswer);
            currentQuestion.shuffledCorrect = correctIndex;
            
            // Mostrar opciones
            const container = document.getElementById('optionsContainer');
            container.innerHTML = '';
            
            shuffledOptions.forEach((option, index) => {
                const button = document.createElement('button');
                button.className = 'option';
                button.textContent = option;
                button.onclick = () => selectAnswer(index);
                container.appendChild(button);
            });
            
            // Resetear estado 50:50
            eliminated5050 = false;
            
            // Iniciar timer
            startTimer();
        }
        
        function startTimer() {
            timeLeft = 30;
            updateTimerDisplay();
            
            if (timerInterval) clearInterval(timerInterval);
            
            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();
                
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    handleTimeout();
                }
            }, 1000);
        }
        
        function updateTimerDisplay() {
            document.getElementById('timeLeft').textContent = timeLeft;
            
            // Cambiar color seg√∫n tiempo restante
            const timerElement = document.querySelector('.timer');
            if (timeLeft <= 10) {
                timerElement.style.color = '#ef4444';
            } else if (timeLeft <= 20) {
                timerElement.style.color = '#f59e0b';
            } else {
                timerElement.style.color = '#60a5fa';
            }
        }
        
        function handleTimeout() {
            // Marcar como incorrecta
            const options = document.querySelectorAll('.option');
            options[currentQuestion.shuffledCorrect].classList.add('correct');
            
            // Reducir vidas
            lives--;
            updateGameUI();
            
            // Mostrar mensaje
            setTimeout(() => {
                if (lives > 0) {
                    alert(`‚è±Ô∏è ¬°Se acab√≥ el tiempo! Te quedan ${lives} vidas.`);
                    loadQuestion();
                } else {
                    endGame();
                }
            }, 1500);
        }
        
        function selectAnswer(index) {
            if (timerInterval) clearInterval(timerInterval);
            
            const options = document.querySelectorAll('.option');
            const selectedOption = options[index];
            
            // Deshabilitar todas las opciones
            options.forEach(opt => opt.style.pointerEvents = 'none');
            
            if (index === currentQuestion.shuffledCorrect) {
                // Respuesta correcta
                selectedOption.classList.add('correct');
                correctStreak++;
                
                // Calcular puntaje con bonus por racha
                const baseScore = currentLevel * 100;
                const timeBonus = Math.floor((timeLeft / 30) * 50);
                const streakBonus = correctStreak > 2 ? (correctStreak - 2) * 50 : 0;
                const levelScore = baseScore + timeBonus + streakBonus;
                
                score += levelScore;
                updateGameUI();
                
                setTimeout(() => {
                    if (currentLevel < 15) {
                        currentLevel++;
                        maxLevelReached = Math.max(maxLevelReached, currentLevel);
                        loadQuestion();
                    } else {
                        // Complet√≥ todos los niveles
                        alert('üéâ ¬°INCRE√çBLE! ¬°Has completado todos los niveles!');
                        endGame();
                    }
                }, 1500);
            } else {
                // Respuesta incorrecta
                selectedOption.classList.add('incorrect');
                options[currentQuestion.shuffledCorrect].classList.add('correct');
                correctStreak = 0;
                
                lives--;
                updateGameUI();
                
                setTimeout(() => {
                    if (lives > 0) {
                        alert(`‚ùå Respuesta incorrecta. Te quedan ${lives} vidas.`);
                        loadQuestion();
                    } else {
                        endGame();
                    }
                }, 1500);
            }
        }
        
        function useFiftyFifty() {
            if (!comodines.fifty || eliminated5050) return;
            
            comodines.fifty = false;
            eliminated5050 = true;
            updateGameUI();
            
            const options = document.querySelectorAll('.option');
            const correctIndex = currentQuestion.shuffledCorrect;
            
            // Seleccionar 2 opciones incorrectas para eliminar
            const incorrectIndices = [];
            for (let i = 0; i < options.length; i++) {
                if (i !== correctIndex) {
                    incorrectIndices.push(i);
                }
            }
            
            // Mezclar y tomar 2
            incorrectIndices.sort(() => Math.random() - 0.5);
            const toEliminate = incorrectIndices.slice(0, 2);
            
            // Eliminar opciones
            toEliminate.forEach(index => {
                options[index].classList.add('eliminated');
                options[index].onclick = null;
            });
        }
        
        function changeQuestion() {
            if (!comodines.change) return;
            
            comodines.change = false;
            updateGameUI();
            
            if (timerInterval) clearInterval(timerInterval);
            
            // Cargar nueva pregunta del mismo nivel
            loadQuestion();
        }
        
        async function endGame() {
            if (timerInterval) clearInterval(timerInterval);
            
            // Ocultar juego, mostrar resultados
            document.getElementById('gameScreen').style.display = 'none';
            document.getElementById('resultScreen').style.display = 'block';
            
            // Mostrar puntaje final
            document.getElementById('finalScore').textContent = score;
            document.getElementById('finalLevel').textContent = maxLevelReached;
            
            // Mensaje seg√∫n el equipo
            const teamResult = document.getElementById('teamResult');
            if (currentPlayer.team === 'INDIVIDUAL') {
                teamResult.innerHTML = 'üèÜ Has participado en modalidad individual';
            } else {
                teamResult.innerHTML = `üë• Tu puntaje contribuye al <strong>Grupo ${currentPlayer.team}</strong>`;
            }
            
            try {
                // Guardar resultado
                const resultId = database.ref('resultados').push().key;
                await database.ref(`resultados/${resultId}`).set({
                    nombre: currentPlayer.name,
                    pseudonimo: currentPlayer.nickname,
                    cedula: currentPlayer.id,
                    grupo: currentPlayer.team,
                    puntaje: score,
                    nivel: maxLevelReached,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    intento: playerAttempts + 1,
                    esForoMiembro: validForumMembers[currentPlayer.id] ? true : false
                });
                
                // Actualizar intentos del jugador
                await database.ref(`jugadores/${currentPlayer.id}`).update({
                    nombre: currentPlayer.name,
                    pseudonimo: currentPlayer.nickname,
                    intentos: playerAttempts + 1,
                    mejorPuntaje: score,
                    mejorNivel: maxLevelReached,
                    ultimoIntento: firebase.database.ServerValue.TIMESTAMP
                });
                
                // Actualizar estad√≠sticas del equipo si no es individual
                if (currentPlayer.team !== 'INDIVIDUAL') {
                    await database.ref(`equipos/${currentPlayer.team}/participantes/${currentPlayer.id}`).set({
                        nombre: currentPlayer.nickname,
                        puntaje: score,
                        nivel: maxLevelReached
                    });
                }
                
                // Marcar juego como completado
                if (gameStartId) {
                    await database.ref(`gameStarts/${gameStartId}`).update({
                        completado: true,
                        puntajeFinal: score,
                        nivelFinal: maxLevelReached,
                        timestampFin: firebase.database.ServerValue.TIMESTAMP
                    });
                }
                
                // Actualizar estado online
                if (currentSessionId) {
                    await database.ref(`analytics/onlinePlayers/${currentSessionId}`).update({
                        status: 'finished',
                        score: score
                    });
                }
                
            } catch (error) {
                console.error('Error saving results:', error);
                alert('Error al guardar los resultados. Tu puntaje es: ' + score);
            }
        }
        
        // Funciones de rankings y dashboard
        async function loadIndividualRanking() {
            try {
                const snapshot = await database.ref('resultados').once('value');
                const results = snapshot.val();
                
                const container = document.getElementById('individual');
                
                if (!results) {
                    container.innerHTML = `
                        <h1>üèÜ Ranking Individual</h1>
                        <p class="subtitle">MEJORES PARTICIPANTES</p>
                        <div class="loading">No hay datos a√∫n. ¬°S√© el primero en jugar!</div>
                    `;
                    return;
                }
                
                const resultsArray = Object.values(results);
                
                // Obtener mejor resultado por jugador
                const uniqueResults = new Map();
                resultsArray.forEach(result => {
                    const existing = uniqueResults.get(result.cedula);
                    if (!existing || result.puntaje > existing.puntaje) {
                        uniqueResults.set(result.cedula, result);
                    }
                });
                
                const topResults = Array.from(uniqueResults.values())
                    .sort((a, b) => b.puntaje - a.puntaje)
                    .slice(0, 20);
                
                let html = `
                    <h1>üèÜ Ranking Individual</h1>
                    <p class="subtitle">MEJORES PARTICIPANTES</p>
                    <div class="dashboard-section">
                        <h2>üèÖ Top 20 Individual</h2>
                `;
                
                if (topResults.length > 0) {
                    html += '<div style="display: grid; gap: 12px;">';
                    
                    topResults.forEach((result, index) => {
                        const displayName = result.pseudonimo || result.nombre;
                        const teamDisplay = result.grupo === 'INDIVIDUAL' ? 'Individual' : `Grupo ${result.grupo}`;
                        const isForumMember = result.esForoMiembro ? '<span class="forum-badge">Miembro Foro</span>' : '';
                        
                        html += `
                            <div style="display: grid; grid-template-columns: 50px 2fr auto auto auto; gap: 16px; padding: 16px; background: rgba(15, 23, 42, 0.6); border-radius: 12px; align-items: center;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: #60a5fa; text-align: center; font-family: 'JetBrains Mono', monospace;">${index + 1}</div>
                                <div>
                                    <div style="font-weight: 600; color: #e2e8f0;">${displayName}${isForumMember}</div>
                                </div>
                                <div style="padding: 4px 8px; border-radius: 8px; font-size: 0.75rem; font-weight: 600; ${result.grupo === 'INDIVIDUAL' ? 'background: rgba(139, 92, 246, 0.2); color: #8b5cf6;' : 'background: rgba(59, 130, 246, 0.2); color: #3b82f6;'}">${teamDisplay}</div>
                                <div style="font-family: 'JetBrains Mono', monospace; color: #3b82f6; font-weight: 600;">${result.puntaje} pts</div>
                                <div style="font-family: 'JetBrains Mono', monospace; color: #60a5fa; font-size: 0.875rem;">Nv.${result.nivel}</div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                } else {
                    html += '<div class="loading">No hay resultados para mostrar</div>';
                }
                
                html += '</div>';
                container.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading individual ranking:', error);
                document.getElementById('individual').innerHTML = `
                    <h1>üèÜ Ranking Individual</h1>
                    <p class="subtitle">MEJORES PARTICIPANTES</p>
                    <div class="loading">Error cargando datos</div>
                `;
            }
        }
        
        async function loadDetailedTeamRankings() {
            try {
                const snapshot = await database.ref('resultados').once('value');
                const results = snapshot.val();
                
                const container = document.getElementById('equipos');
                
                if (!results) {
                    container.innerHTML = `
                        <h1>üë• Competencia por Equipos</h1>
                        <p class="subtitle">RANKING DETALLADO POR GRUPO</p>
                        <div class="loading">No hay datos a√∫n. ¬°S√© el primero en jugar!</div>
                    `;
                    return;
                }
                
                const resultsArray = Object.values(results);
                
                // Agrupar por equipo y obtener mejor resultado por jugador
                const teamPlayers = {
                    A: new Map(),
                    B: new Map(),
                    C: new Map(),
                    INDIVIDUAL: new Map()
                };
                
                resultsArray.forEach(result => {
                    const team = result.grupo;
                    if (teamPlayers[team]) {
                        const existing = teamPlayers[team].get(result.cedula);
                        if (!existing || result.puntaje > existing.puntaje) {
                            teamPlayers[team].set(result.cedula, result);
                        }
                    }
                });
                
                let html = `
                    <h1>üë• Competencia por Equipos</h1>
                    <p class="subtitle">RANKING DETALLADO POR GRUPO</p>
                    <div class="dashboard-section">
                        <h2>üìä Estad√≠sticas por Equipo</h2>
                        <div class="team-rankings">
                `;
                
                ['A', 'B', 'C', 'INDIVIDUAL'].forEach(teamName => {
                    const players = Array.from(teamPlayers[teamName].values())
                        .sort((a, b) => b.puntaje - a.puntaje);
                    
                    const avgScore = players.length > 0 ? 
                        Math.round((players.reduce((sum, p) => sum + p.puntaje, 0) / players.length) * 10) / 10 : 0;
                    const maxLevel = players.length > 0 ? 
                        Math.max(...players.map(p => p.nivel)) : 0;
                    
                    const teamDisplayName = teamName === 'INDIVIDUAL' ? 'INDIVIDUAL' : `GRUPO ${teamName}`;
                    
                    let playersHTML = '';
                    players.slice(0, 10).forEach((player, index) => {
                        const displayName = player.pseudonimo || player.nombre;
                        const isForumMember = player.esForoMiembro ? ' üèõÔ∏è' : '';
                        playersHTML += `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; margin: 4px 0; background: rgba(30, 41, 59, 0.4); border-radius: 8px; font-size: 0.875rem;">
                                <span>${index + 1}. ${displayName}${isForumMember}</span>
                                <span>${player.puntaje} pts - Nv.${player.nivel}</span>
                            </div>
                        `;
                    });
                    
                    html += `
                        <div class="team-section team-${teamName.toLowerCase()}">
                            <div class="team-header">
                                <div class="team-name">${teamDisplayName}</div>
                                <div class="team-stats">
                                    <span>üë• ${players.length}</span>
                                    <span>üèÜ ${avgScore} pts</span>
                                    <span>üìà Nv.${maxLevel}</span>
                                </div>
                            </div>
                            <div style="margin-top: 16px;">
                                <h3 style="color: #94a3b8; margin-bottom: 12px; font-size: 1rem;">Top 10 ${teamName === 'INDIVIDUAL' ? 'individual' : 'del grupo'}:</h3>
                                ${playersHTML || '<div style="color: #64748b; font-style: italic;">No hay participantes a√∫n</div>'}
                            </div>
                        </div>
                    `;
                });
                
                html += '</div></div>';
                container.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading detailed team rankings:', error);
                document.getElementById('equipos').innerHTML = `
                    <h1>üë• Competencia por Equipos</h1>
                    <p class="subtitle">RANKING DETALLADO POR GRUPO</p>
                    <div class="loading">Error cargando datos</div>
                `;
            }
        }
        
        function loadDashboard() {
            updateDashboardStats();
            updateTeamRankings();
            updateVisitCounters();
            updateOnlineCount();
            updateLastUpdate();
        }
        
        // Funciones Firebase
        async function recordVisit() {
            try {
                const today = new Date().toDateString();
                const timestamp = Date.now();
                
                await database.ref('analytics/totalVisits').transaction((current) => (current || 0) + 1);
                await database.ref(`analytics/dailyVisits/${today}`).transaction((current) => (current || 0) + 1);
                
                const visitId = database.ref('analytics/visits').push().key;
                await database.ref(`analytics/visits/${visitId}`).set({
                    timestamp: timestamp,
                    date: today,
                    userAgent: navigator.userAgent,
                    ip: 'hidden'
                });
            } catch (error) {
                console.error('Error registrando visita:', error);
            }
        }
        
        async function trackOnlinePlayer() {
            try {
                const sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                currentSessionId = sessionId;
                
                const playerRef = database.ref(`analytics/onlinePlayers/${sessionId}`);
                await playerRef.set({
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    status: 'browsing'
                });
                
                playerRef.onDisconnect().remove();
            } catch (error) {
                console.error('Error tracking online player:', error);
            }
        }
        
        function setupFirebaseListeners() {
            database.ref('resultados').on('value', (snapshot) => {
                updateDashboardStats();
                updateTeamRankings();
            });
            
            database.ref('analytics/onlinePlayers').on('value', (snapshot) => {
                updateOnlineCount();
            });
            
            database.ref('analytics/totalVisits').on('value', (snapshot) => {
                updateVisitCounters();
            });
        }
        
        async function updateDashboardStats() {
            try {
                const resultsSnapshot = await database.ref('resultados').once('value');
                const results = resultsSnapshot.val();
                
                const gameStartsSnapshot = await database.ref('gameStarts').once('value');
                const gameStarts = gameStartsSnapshot.val();
                
                if (results) {
                    const resultsArray = Object.values(results);
                    const totalPlayers = resultsArray.length;
                    const totalGames = gameStarts ? Object.keys(gameStarts).length : 0;
                    const avgScore = resultsArray.reduce((sum, r) => sum + r.puntaje, 0) / totalPlayers;
                    const maxLevel = Math.max(...resultsArray.map(r => r.nivel));
                    
                    const today = new Date().toDateString();
                    const playersToday = resultsArray.filter(r => {
                        const resultDate = new Date(r.timestamp || 0).toDateString();
                        return resultDate === today;
                    }).length;
                    
                    document.getElementById('totalJugadores').textContent = totalPlayers || 0;
                    document.getElementById('totalPartidas').textContent = totalGames || 0;
                    document.getElementById('promedioScore').textContent = Math.round(avgScore * 10) / 10 || 0;
                    document.getElementById('nivelMaximo').textContent = maxLevel || 0;
                    document.getElementById('jugadoresHoy').textContent = playersToday || 0;
                } else {
                    document.getElementById('totalJugadores').textContent = '0';
                    document.getElementById('totalPartidas').textContent = '0';
                    document.getElementById('promedioScore').textContent = '0';
                    document.getElementById('nivelMaximo').textContent = '0';
                    document.getElementById('jugadoresHoy').textContent = '0';
                }
            } catch (error) {
                console.error('Error loading stats:', error);
                document.getElementById('totalJugadores').textContent = '-';
                document.getElementById('totalPartidas').textContent = '-';
                document.getElementById('promedioScore').textContent = '-';
                document.getElementById('nivelMaximo').textContent = '-';
                document.getElementById('jugadoresHoy').textContent = '-';
            }
        }
        
        async function updateTeamRankings() {
            try {
                const snapshot = await database.ref('resultados').once('value');
                const results = snapshot.val();
                
                const container = document.getElementById('teamRankings');
                
                if (!results) {
                    container.innerHTML = '<div class="loading">No hay datos a√∫n. ¬°S√© el primero en jugar!</div>';
                    return;
                }
                
                const resultsArray = Object.values(results);
                
                // Agrupar por equipo y obtener mejor resultado por jugador
                const teamPlayers = {
                    A: new Map(),
                    B: new Map(),
                    C: new Map(),
                    INDIVIDUAL: new Map()
                };
                
                resultsArray.forEach(result => {
                    const team = result.grupo;
                    if (teamPlayers[team]) {
                        const existing = teamPlayers[team].get(result.cedula);
                        if (!existing || result.puntaje > existing.puntaje) {
                            teamPlayers[team].set(result.cedula, result);
                        }
                    }
                });
                
                // Calcular estad√≠sticas por equipo
                const teamStats = {};
                Object.keys(teamPlayers).forEach(team => {
                    const players = Array.from(teamPlayers[team].values());
                    teamStats[team] = {
                        players: players.length,
                        avgScore: players.length > 0 ? 
                            Math.round((players.reduce((sum, p) => sum + p.puntaje, 0) / players.length) * 10) / 10 : 0,
                        maxLevel: players.length > 0 ? 
                            Math.max(...players.map(p => p.nivel)) : 0
                    };
                });
                
                // Generar HTML
                container.innerHTML = '';
                
                ['A', 'B', 'C', 'INDIVIDUAL'].forEach(teamName => {
                    const stats = teamStats[teamName];
                    const teamSection = document.createElement('div');
                    teamSection.className = `team-section team-${teamName.toLowerCase()}`;
                    
                    const displayName = teamName === 'INDIVIDUAL' ? 'INDIVIDUAL' : `GRUPO ${teamName}`;
                    
                    teamSection.innerHTML = `
                        <div class="team-header">
                            <div class="team-name">${displayName}</div>
                            <div class="team-stats">
                                <span>üë• ${stats.players}</span>
                                <span>üèÜ ${stats.avgScore} pts</span>
                                <span>üìà Nv.${stats.maxLevel}</span>
                            </div>
                        </div>
                    `;
                    
                    container.appendChild(teamSection);
                });
                
            } catch (error) {
                console.error('Error loading team rankings:', error);
                document.getElementById('teamRankings').innerHTML = '<div class="loading">Error cargando datos</div>';
            }
        }
        
        async function updateVisitCounters() {
            try {
                const totalSnapshot = await database.ref('analytics/totalVisits').once('value');
                const totalVisits = totalSnapshot.val() || 0;
                
                const today = new Date().toDateString();
                const todaySnapshot = await database.ref(`analytics/dailyVisits/${today}`).once('value');
                const visitsToday = todaySnapshot.val() || 0;
                
                document.getElementById('visitCount').textContent = totalVisits.toLocaleString();
                document.getElementById('visitasHoy').textContent = visitsToday;
            } catch (error) {
                console.error('Error updating visit counters:', error);
                document.getElementById('visitCount').textContent = '-';
                document.getElementById('visitasHoy').textContent = '-';
            }
        }
        
        async function updateOnlineCount() {
            try {
                const snapshot = await database.ref('analytics/onlinePlayers').once('value');
                const onlinePlayers = snapshot.val();
                
                if (onlinePlayers) {
                    const count = Object.keys(onlinePlayers).length;
                    document.getElementById('onlinePlayers').textContent = count;
                } else {
                    document.getElementById('onlinePlayers').textContent = '0';
                }
            } catch (error) {
                console.error('Error updating online count:', error);
                document.getElementById('onlinePlayers').textContent = '-';
            }
        }
        
        function updateLastUpdate() {
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('es-UY');
        }
        
        // Admin functions
        function verifyAdmin() {
            const password = document.getElementById('adminPassword').value;
            if (password === ADMIN_PASSWORD) {
                isAdminAuthenticated = true;
                document.getElementById('adminData').style.display = 'block';
                loadAdminData();
            } else {
                alert('Contrase√±a incorrecta');
            }
        }
        
        async function loadAdminData() {
            try {
                const resultsSnapshot = await database.ref('resultados').once('value');
                const results = resultsSnapshot.val();
                
                const gameStartsSnapshot = await database.ref('gameStarts').once('value');
                const gameStarts = gameStartsSnapshot.val();
                
                let html = '<h4>üìä Resumen de Actividad</h4>';
                
                if (results) {
                    const resultsArray = Object.values(results);
                    const gameStartsArray = gameStarts ? Object.values(gameStarts) : [];
                    
                    const completedGames = gameStartsArray.filter(g => g.completado).length;
                    const completionRate = gameStartsArray.length > 0 ? 
                        Math.round((completedGames / gameStartsArray.length) * 100) : 0;
                    
                    html += `
                        <p>Partidas iniciadas: ${gameStartsArray.length}</p>
                        <p>Partidas completadas: ${completedGames}</p>
                        <p>Tasa de finalizaci√≥n: ${completionRate}%</p>
                        <h4 style="margin-top: 20px;">üìã √öltimos 20 resultados:</h4>
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
                                <thead>
                                    <tr style="background: rgba(59, 130, 246, 0.2);">
                                        <th style="padding: 8px; border: 1px solid rgba(59, 130, 246, 0.3);">Fecha</th>
                                        <th style="padding: 8px; border: 1px solid rgba(59, 130, 246, 0.3);">Nombre</th>
                                        <th style="padding: 8px; border: 1px solid rgba(59, 130, 246, 0.3);">Pseud√≥nimo</th>
                                        <th style="padding: 8px; border: 1px solid rgba(59, 130, 246, 0.3);">C√©dula</th>
                                        <th style="padding: 8px; border: 1px solid rgba(59, 130, 246, 0.3);">Grupo</th>
                                        <th style="padding: 8px; border: 1px solid rgba(59, 130, 246, 0.3);">Puntaje</th>
                                        <th style="padding: 8px; border: 1px solid rgba(59, 130, 246, 0.3);">Nivel</th>
                                        <th style="padding: 8px; border: 1px solid rgba(59, 130, 246, 0.3);">Intento</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    // Ordenar por timestamp descendente
                    resultsArray.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                    
                    resultsArray.slice(0, 20).forEach(result => {
                        const date = result.timestamp ? 
                            new Date(result.timestamp).toLocaleString('es-UY') : 'N/A';
                        
                        html += `
                            <tr>
                                <td style="padding: 8px; border: 1px solid rgba(59, 130, 246, 0.3);">${date}</td>
                                <td style="padding: 8px; border: 1px solid rgba(59, 130, 246, 0.3);">${result.nombre}</td>
                                <td style="padding: 8px; border: 1px solid rgba(59, 130, 246, 0.3);">${result.pseudonimo}</td>
                                <td style="padding: 8px; border: 1px solid rgba(59, 130, 246, 0.3);">${result.cedula}</td>
                                <td style="padding: 8px; border: 1px solid rgba(59, 130, 246, 0.3);">${result.grupo}</td>
                                <td style="padding: 8px; border: 1px solid rgba(59, 130, 246, 0.3);">${result.puntaje}</td>
                                <td style="padding: 8px; border: 1px solid rgba(59, 130, 246, 0.3);">${result.nivel}</td>
                                <td style="padding: 8px; border: 1px solid rgba(59, 130, 246, 0.3);">${result.intento || 1}</td>
                            </tr>
                        `;
                    });
                    
                    html += '</tbody></table></div>';
                } else {
                    html += '<p>No hay datos disponibles a√∫n.</p>';
                }
                
                document.getElementById('adminTable').innerHTML = html;
                
            } catch (error) {
                console.error('Error loading admin data:', error);
                document.getElementById('adminTable').innerHTML = '<p>Error cargando datos administrativos.</p>';
            }
        }
        
        async function exportAdminData() {
            try {
                const resultsSnapshot = await database.ref('resultados').once('value');
                const results = resultsSnapshot.val();
                
                if (!results) {
                    alert('No hay datos para exportar');
                    return;
                }
                
                const resultsArray = Object.values(results);
                
                // Crear CSV
                let csv = 'Fecha,Nombre,Pseudonimo,Cedula,Grupo,Puntaje,Nivel,Intento,EsMiembroForo\n';
                
                resultsArray.forEach(result => {
                    const date = result.timestamp ? 
                        new Date(result.timestamp).toLocaleString('es-UY') : 'N/A';
                    const esMiembro = result.esForoMiembro ? 'SI' : 'NO';
                    
                    csv += `"${date}","${result.nombre}","${result.pseudonimo}","${result.cedula}","${result.grupo}",${result.puntaje},${result.nivel},${result.intento || 1},"${esMiembro}"\n`;
                });
                
                // Descargar archivo
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `cardiologia_game_export_${new Date().toISOString().split('T')[0]}.csv`;
                link.click();
                
            } catch (error) {
                console.error('Error exporting data:', error);
                alert('Error al exportar datos');
            }
        }
        
        async function clearAllData() {
            if (!confirm('¬øEst√°s seguro de que quieres eliminar TODOS los datos?')) {
                return;
            }
            
            if (!confirm('Esta acci√≥n es IRREVERSIBLE. ¬øEst√°s completamente seguro?')) {
                return;
            }
            
            const confirmText = prompt('Escribe "BORRAR TODO" para confirmar:');
            if (confirmText !== 'BORRAR TODO') {
                alert('Operaci√≥n cancelada');
                return;
            }
            
            try {
                await database.ref('resultados').remove();
                await database.ref('jugadores').remove();
                await database.ref('equipos').remove();
                await database.ref('gameStarts').remove();
                await database.ref('analytics/dailyVisits').remove();
                await database.ref('analytics/totalVisits').set(0);
                
                alert('Todos los datos han sido eliminados');
                location.reload();
            } catch (error) {
                console.error('Error clearing data:', error);
                alert('Error al eliminar datos');
            }
        }
        
        function handleMissingLogos() {
            const logos = ['logo-ccu', 'logo-uac'];
            logos.forEach(logoId => {
                const img = document.getElementById(logoId);
                img.onerror = function() {
                    this.style.display = 'none';
                    this.nextElementSibling.style.display = 'none';
                };
            });
        }
        
        // Inicializaci√≥n
        window.addEventListener('load', async function() {
            try {
                // Registrar visita
                await recordVisit();
                
                // Tracking de jugador online
                await trackOnlinePlayer();
                
                // Configurar listeners de Firebase
                setupFirebaseListeners();
                
                // Cargar dashboard inicial
                loadDashboard();
                
                // Manejar logos faltantes
                handleMissingLogos();
                
                // Actualizar contadores peri√≥dicamente
                setInterval(() => {
                    updateLastUpdate();
                }, 60000); // Cada minuto
                
                console.log('‚úÖ Juego de Cardiolog√≠a - Sistema completo activo');
                console.log('üìä Grupos del foro validados:', Object.keys(validForumMembers).length, 'c√©dulas');
                
            } catch (error) {
                console.error('Error en inicializaci√≥n:', error);
                
                // Si falla Firebase, mostrar datos por defecto
                document.getElementById('totalJugadores').textContent = '0';
                document.getElementById('totalPartidas').textContent = '0';
                document.getElementById('promedioScore').textContent = '0';
                document.getElementById('nivelMaximo').textContent = '0';
                document.getElementById('jugadoresHoy').textContent = '0';
                document.getElementById('visitasHoy').textContent = '0';
                document.getElementById('visitCount').textContent = '-';
                document.getElementById('onlinePlayers').textContent = '-';
                
                document.getElementById('teamRankings').innerHTML = '<div class="loading">Error de conexi√≥n. Verifica tu internet.</div>';
            }
        });
    </script>
</body>
</html>